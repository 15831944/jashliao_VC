#include <stdio.h>

/* 從檔案讀入數個位元 */
int readData(unsigned char *data,int len,FILE *fp)
{
    return fread(data,len,sizeof(char),fp);
}

/* 將4位元組的數值資料從檔案讀入 */
int getLong(FILE *fp)
{
    unsigned char buf[16];

    readData(buf,4,fp);
    return (buf[0]<<24) |(buf[1]<<16) | (buf[2]<<8) | buf[3];
}

/* ------------------------------------------------------- */

static int bits=0;
static int bdata=0;

/* 位元輸入處理的初始化 */
int fgetBitInit()
{
    bits=0;
    bdata=0;
    return 0;
}

/* 輸入1位元 */
int fgetBit(FILE *fp)
{
    unsigned char bbuf;
    int val;

    if(bits==0) {
        readData(&bbuf,1,fp);
        bdata=bbuf;
    }
    val=(bdata>>7)&1;
    bdata=(bdata<<1) & 0xff;
    bits++;
    if(bits>=8) {
        bits=0;
        bdata=0;
    }
    return val;
}

/* 威爾編碼的解析 */
int getValue(FILE *fp)
{
    int bit;
    int i,cnt;
    int val;

    cnt=0;
    while(fgetBit(fp)==1) {
        cnt++;
    }
    cnt+=2;
    val=0;
    for(i=0;i<cnt;i++) {
        bit=fgetBit(fp)<<i;
        val|=bit;
    }
    return val;
}

/* main函數 */
int main(int ac,char *av[])
{
    FILE *fp;
    int i,size;

    if ((fp = fopen(av[1],"rb"))==NULL)
        return 6;

    size=getLong(fp);

    fgetBitInit();
    for(i=0;i<size;i++) {
        int rd_data;
        rd_data=getValue(fp);
        printf("%c",rd_data);
    }
    fclose(fp);
    return 0;
}
