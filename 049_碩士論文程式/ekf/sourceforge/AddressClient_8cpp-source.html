<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DSACSS Operational Code: AddressClient.cpp Source File</title>
<link href="doxygen.css" tppabs="http://dsacss.sourceforge.net/doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<h1>AddressClient.cpp</h1><a href="AddressClient_8cpp.html" tppabs="http://dsacss.sourceforge.net/AddressClient_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 
00008 <span class="preprocessor">#include "<a class="code" href="AddressClient_8h.html" tppabs="http://dsacss.sourceforge.net/AddressClient_8h.html">Comm/AddressClient.h</a>"</span>
00009 
00010 <span class="preprocessor">#include &lt;string&gt;</span>
00011 
<a name="l00012"></a><a class="code" href="classAddressClient.html#AddressClienta0" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta0">00012</a> <a class="code" href="classAddressClient.html#AddressClienta0" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta0">AddressClient::AddressClient</a> (<span class="keyword">const</span> ACE_INET_Addr &amp;addrServer)
00013         : m_addrServer(addrServer),
00014           m_bindingMutex(),
00015           m_bindings(),
00016           m_pendingReplyMutex(),
00017           m_pendingReplyQueue(m_pendingReplyMutex),
00018           m_notificationID(-1),
00019           m_pingMutex(),
00020           m_pingCondition(m_pingMutex),
00021           m_timeout(0,0)
00022 {
00023         <a class="code" href="classAddressClient.html#AddressClientr2" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr2">m_socket</a>.open(ACE_INET_Addr());
00024 }
00025 
00026 
00027 
<a name="l00028"></a><a class="code" href="classAddressClient.html#AddressClienta1" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta1">00028</a> <a class="code" href="classAddressClient.html#AddressClienta1" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta1">AddressClient::~AddressClient</a> (<span class="keywordtype">void</span>)
00029 {
00030         <a class="code" href="classAddressClient.html#AddressClientr2" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr2">m_socket</a>.close();
00031 }
00032 
00033 
<a name="l00034"></a><a class="code" href="classAddressClient.html#AddressClienta2" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta2">00034</a> <span class="keywordtype">int</span> <a class="code" href="classAddressClient.html#AddressClienta2" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta2">AddressClient::RegisterWithReactor</a>(ACE_Reactor &amp;theReactor)
00035 {
00036         <span class="keywordtype">int</span> retVal = theReactor.register_handler (<span class="keyword">this</span>,
00037                 ACE_Event_Handler::READ_MASK);
00038                 
00039         <span class="keywordflow">if</span> (retVal == -1)
00040         {
00041                 ACE_ERROR ((LM_ERROR, <span class="stringliteral">"(%N:%l) %p\n"</span>, <span class="stringliteral">"register_handler"</span>));
00042         }
00043 
00044         <span class="keywordflow">return</span> retVal;
00045 }
00046 
00047 
<a name="l00048"></a><a class="code" href="classAddressClient.html#AddressClienta3" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta3">00048</a> <span class="keywordtype">int</span> <a class="code" href="classAddressClient.html#AddressClienta3" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta3">AddressClient::RemoveFromReactor</a>(ACE_Reactor &amp;theReactor, <span class="keywordtype">bool</span> immediate)
00049 {
00050         <span class="keywordflow">if</span> (!immediate)
00051         {
00052                 <a class="code" href="classAddressClient.html#AddressClienta7" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta7">RemoveServerCallback</a>();
00053         }
00054 
00055         <span class="keywordtype">int</span> retVal = theReactor.remove_handler (<span class="keyword">this</span>,
00056                 ACE_Event_Handler::READ_MASK);
00057                 
00058         <span class="keywordflow">if</span> (retVal == -1)
00059                 ACE_ERROR ((LM_ERROR, <span class="stringliteral">"(%N:%l) %p\n"</span>, <span class="stringliteral">"remove_handler"</span>));
00060 
00061         <span class="keywordflow">return</span> retVal;
00062 }
00063 
00064 
00065 
<a name="l00066"></a><a class="code" href="classAddressClient.html#AddressClienta4" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta4">00066</a> <span class="keywordtype">void</span> <a class="code" href="classAddressClient.html#AddressClienta4" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta4">AddressClient::SetTimeout</a>(<span class="keyword">const</span> ACE_Time_Value &amp;tv)
00067 {
00068         <a class="code" href="classAddressClient.html#AddressClientr10" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr10">m_timeout</a> = tv;
00069 }
00070 
00071 
00072 
<a name="l00073"></a><a class="code" href="classAddressClient.html#AddressClienta5" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta5">00073</a> <span class="keywordtype">int</span> <a class="code" href="classAddressClient.html#AddressClienta5" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta5">AddressClient::PingServer</a>()
00074 {
00075         <span class="comment">//</span>
00076         <span class="comment">// Unlike other commands that use the m_timeout member to determine</span>
00077         <span class="comment">// how long to wait, PingServer() always waits two seconds.  This should</span>
00078         <span class="comment">// be plenty of time and prevents deadlock when m_timeout is zero (wait</span>
00079         <span class="comment">// forever).</span>
00080         <span class="keyword">static</span> <span class="keyword">const</span> ACE_Time_Value PING_TIMEOUT(1,0);
00081 
00082         <span class="comment">//</span>
00083         <span class="comment">// Acquire the mutex to lock out other callers.</span>
00084         ACE_Guard&lt;ACE_Thread_Mutex&gt; g(<a class="code" href="classAddressClient.html#AddressClientr8" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr8">m_pingMutex</a>);
00085 
00086         <span class="comment">//</span>
00087         <span class="comment">// Try to send the ping command to the address server.</span>
00088         <span class="keywordtype">int</span> retVal = this-&gt;<a class="code" href="classAddressClient.html#AddressClientr2" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr2">m_socket</a>.send(<span class="stringliteral">"PING"</span>, 4, <a class="code" href="classAddressClient.html#AddressClientr0" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr0">m_addrServer</a>);
00089         <span class="keywordflow">if</span> (retVal == -1)
00090         {
00091                 ACE_ERROR_RETURN((LM_ERROR, <span class="stringliteral">"(%N:%l) %p\n"</span>,<span class="stringliteral">"send"</span>), -1);
00092         }
00093 
00094         <span class="comment">//</span>
00095         <span class="comment">// Set the deadline for one second from now.</span>
00096         ACE_Time_Value deadline = ACE_OS::gettimeofday() + PING_TIMEOUT;
00097 
00098         <span class="comment">//</span>
00099         <span class="comment">// Return 0 if handle_input() reports an "ACK" response,</span>
00100         <span class="comment">// -1 if we timeout or experience an error.</span>
00101         <span class="keywordflow">return</span> <a class="code" href="classAddressClient.html#AddressClientr9" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr9">m_pingCondition</a>.wait(&amp;deadline);
00102 }
00103 
00104 
00105 
<a name="l00106"></a><a class="code" href="classAddressClient.html#AddressClienta6" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta6">00106</a> <span class="keywordtype">int</span> <a class="code" href="classAddressClient.html#AddressClienta6" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta6">AddressClient::RegisterServerCallback</a>()
00107 {
00108         <span class="comment">//</span>
00109         <span class="comment">// If we are already registered, don't try to register again.</span>
00110         <span class="keywordflow">if</span> (<a class="code" href="classAddressClient.html#AddressClientr7" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr7">m_notificationID</a> != -1)
00111         {
00112                 <span class="keywordflow">return</span> -1;
00113         }
00114 
00115         <span class="comment">//</span>
00116         <span class="comment">// First, make sure the server is there so we don't deadlock.</span>
00117         <span class="keywordtype">int</span> status = -1;
00118         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; status == -1 &amp;&amp; i &lt; 1; ++i)
00119         {
00120                 status = <a class="code" href="classAddressClient.html#AddressClienta5" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta5">PingServer</a>();
00121         }
00122 
00123         <span class="comment">//</span>
00124         <span class="comment">// If we can't get an answer from the server, then give up.</span>
00125         <span class="keywordflow">if</span> (status == -1)
00126         {
00127                 ACE_ERROR_RETURN((LM_ERROR,
00128                         <span class="stringliteral">"(%N:%l) RegisterServerCallback failed because the address server"</span>
00129                         <span class="stringliteral">" won't respond.\n"</span>), -1);
00130         }
00131 
00132         <span class="comment">//</span>
00133         <span class="comment">// Send the command and wait for reply.</span>
00134         std::string theReply;
00135         status = <a class="code" href="classAddressClient.html#AddressClientb0" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientb0">SendCommand</a>(<span class="stringliteral">"ADD_NOTIFY"</span>, theReply);
00136 
00137         <span class="comment">//</span>
00138         <span class="comment">// Try to get our id from the reply.</span>
00139         u_int myID;
00140         <span class="keywordflow">if</span> (status == -1 || sscanf(theReply.c_str(), <span class="stringliteral">"YOU_ARE %u"</span>, &amp;myID) != 1)
00141         {
00142                 <span class="keywordflow">return</span> -1;
00143         }
00144 
00145         <span class="comment">//</span>
00146         <span class="comment">// Store our id.</span>
00147         <a class="code" href="classAddressClient.html#AddressClientr7" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr7">m_notificationID</a> = myID;
00148 
00149         <span class="keywordflow">return</span> 0;
00150 }
00151 
00152 
00153 
<a name="l00154"></a><a class="code" href="classAddressClient.html#AddressClienta7" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta7">00154</a> <span class="keywordtype">int</span> <a class="code" href="classAddressClient.html#AddressClienta7" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta7">AddressClient::RemoveServerCallback</a>()
00155 {
00156         <span class="comment">//</span>
00157         <span class="comment">// If we're aren't registered, then don't try to remove.</span>
00158         <span class="keywordflow">if</span> (<a class="code" href="classAddressClient.html#AddressClientr7" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr7">m_notificationID</a> == -1)
00159         {
00160                 <span class="keywordflow">return</span> -1;
00161         }
00162 
00163         <span class="comment">//</span>
00164         <span class="comment">// First, make sure the server is there so we don't deadlock.</span>
00165         <span class="keywordtype">int</span> status = -1;
00166         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; status == -1 &amp;&amp; i &lt; 5; ++i)
00167         {
00168                 status = <a class="code" href="classAddressClient.html#AddressClienta5" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta5">PingServer</a>();
00169         }
00170 
00171         <span class="comment">//</span>
00172         <span class="comment">// If we can't get an answer from the server, then give up.</span>
00173         <span class="keywordflow">if</span> (status == -1)
00174         {
00175                 ACE_ERROR_RETURN((LM_WARNING,
00176                         <span class="stringliteral">"(%N:%l) RemoveServerCallback failed because the address server"</span>
00177                         <span class="stringliteral">" won't respond.\n"</span>), -1);
00178         }
00179 
00180         <span class="comment">//</span>
00181         <span class="comment">// We'll be sending the "REMOVE_NOTIFY" command with our ID.</span>
00182         u_int id = <a class="code" href="classAddressClient.html#AddressClientr7" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr7">m_notificationID</a>;
00183         <span class="keywordtype">char</span> sendBuf[32];
00184         sprintf(sendBuf, <span class="stringliteral">"REMOVE_NOTIFY %u"</span>, id);
00185 
00186         <span class="comment">//</span>
00187         <span class="comment">// Send the command to the address server and wait for the reply.</span>
00188         std::string theReply;
00189         status = <a class="code" href="classAddressClient.html#AddressClientb0" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientb0">SendCommand</a>(sendBuf, theReply);
00190 
00191         <span class="comment">//</span>
00192         <span class="comment">// If the command failed, return an error.</span>
00193         <span class="keywordflow">if</span> (status == -1 || theReply != <span class="stringliteral">"OK"</span>)
00194         {
00195                 <span class="keywordflow">return</span> -1;
00196         }
00197 
00198         <span class="comment">//</span>
00199         <span class="comment">// Clear our id.</span>
00200         m_notificationID = -1;
00201 
00202         <span class="keywordflow">return</span> 0;
00203 }
00204 
00205 
<a name="l00206"></a><a class="code" href="classAddressClient.html#AddressClienta8" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta8">00206</a> <span class="keywordtype">int</span> <a class="code" href="classAddressClient.html#AddressClienta8" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta8">AddressClient::ClearServerCallbacks</a>()
00207 {
00208         <span class="keywordtype">int</span> retVal = -1;
00209 
00210         std::string theReply;
00211         retVal = <a class="code" href="classAddressClient.html#AddressClientb0" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientb0">SendCommand</a>(<span class="stringliteral">"CLEAR_NOTIFY"</span>, theReply);
00212 
00213         <span class="keywordflow">if</span> (theReply == <span class="stringliteral">"OK"</span>)
00214         {
00215                 <a class="code" href="classAddressClient.html#AddressClientr7" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr7">m_notificationID</a> = -1;
00216                 retVal = 0;
00217         }
00218 
00219         <span class="keywordflow">return</span> retVal;
00220 }
00221 
00222 
00223 
<a name="l00224"></a><a class="code" href="classAddressClient.html#AddressClienta9" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta9">00224</a> <span class="keywordtype">int</span> <a class="code" href="classAddressClient.html#AddressClienta9" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta9">AddressClient::GetBindings</a>(u_int dest, <a class="code" href="classAddressClient.html#AddressClientw0" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientw0">AddrList_t</a> &amp;theList)
00225 {
00226 
00227         <span class="comment">//</span>
00228         <span class="comment">// Try to get the binding from the cache.</span>
00229         {
00230                 ACE_Guard&lt;ACE_Thread_Mutex&gt; g(<a class="code" href="classAddressClient.html#AddressClientr3" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr3">m_bindingMutex</a>);
00231 
00232                 BindMap_t::iterator it = <a class="code" href="classAddressClient.html#AddressClientr4" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr4">m_bindings</a>.find(dest);
00233 
00234                 <span class="keywordflow">if</span> (it != <a class="code" href="classAddressClient.html#AddressClientr4" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr4">m_bindings</a>.end())
00235                 {
00236                         theList = it-&gt;second;
00237                         <span class="keywordflow">return</span> 0;
00238                 }
00239         }
00240 
00241         
00242         <span class="comment">//</span>
00243         <span class="comment">// We didn't get the binding from the cache. Try to get it</span>
00244         <span class="comment">// from the address server (and write it to the cache at the</span>
00245         <span class="comment">// same time).</span>
00246         <span class="comment">//</span>
00247         <span class="comment">// Send a "GET" command to the address server.</span>
00248         <span class="keywordtype">char</span> sendBuf[25];
00249         sprintf(sendBuf, <span class="stringliteral">"GET %u"</span>, dest);
00250         
00251         std::string theReply;
00252         <span class="keywordflow">if</span> (<a class="code" href="classAddressClient.html#AddressClientb0" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientb0">SendCommand</a>(sendBuf, theReply) == -1)
00253         {
00254                 <span class="keywordflow">return</span> -1;
00255         }
00256         
00257         
00258         <span class="keywordflow">if</span> (theReply == <span class="stringliteral">"NAK"</span>)
00259         {
00260                 <span class="keywordflow">return</span> -1;
00261         }
00262         
00263         theList.clear();
00264         
00265         <span class="comment">//</span>
00266         <span class="comment">// Iterate through the reply and fill the vector with the bindings.</span>
00267         <span class="keywordflow">if</span> (theReply.size() &gt; 0)
00268         {
00269                 <span class="comment">//</span>
00270                 <span class="comment">// Scan backward through the comma-separated entries.</span>
00271                 size_t comma = theReply.find_last_of(<span class="charliteral">','</span>);
00272                 
00273                 <span class="keywordflow">while</span> (comma != std::string::npos)
00274                 {
00275                         <span class="comment">//</span>
00276                         <span class="comment">// The binding is everything following the comma.</span>
00277                         <span class="keyword">const</span> <span class="keywordtype">char</span> *binding = theReply.c_str() + (comma + 1);
00278                         
00279                         <span class="comment">//</span>
00280                         <span class="comment">// Store the binding</span>
00281                         theList.push_back(ACE_INET_Addr(binding));
00282                         
00283                         <span class="comment">//</span>
00284                         <span class="comment">// Remove the comma and everything following it.</span>
00285                         theReply.erase(comma);
00286                         
00287                         <span class="comment">//</span>
00288                         <span class="comment">// Prepare for next iteration.</span>
00289                         comma = theReply.find_last_of(<span class="charliteral">','</span>);
00290                 }
00291                 
00292                 <span class="comment">// Store the final binding.</span>
00293                 theList.push_back(ACE_INET_Addr(theReply.c_str()));
00294         }
00295         
00296         {
00297                 ACE_Guard&lt;ACE_Thread_Mutex&gt; g(<a class="code" href="classAddressClient.html#AddressClientr3" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr3">m_bindingMutex</a>);
00298                 
00299                 <span class="comment">//</span>
00300                 <span class="comment">// Insert an entry into the bindings and assign the list into it.</span>
00301                 <span class="comment">// By passing an empty address list and then</span>
00302                 <span class="comment">// assigning it, we save one copy construction.</span>
00303                 BindMap_t::iterator it = <a class="code" href="classAddressClient.html#AddressClientr4" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr4">m_bindings</a>.insert( <a class="code" href="classAddressClient.html#AddressClientx1" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientx1">BindValue_t</a>(dest, <a class="code" href="classAddressClient.html#AddressClientw0" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientw0">AddrList_t</a>()) ).first;
00304                 it-&gt;second = theList;
00305         }
00306 
00307         <span class="keywordflow">return</span> 0;
00308 }
00309 
00310 
00311 
<a name="l00312"></a><a class="code" href="classAddressClient.html#AddressClienta10" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta10">00312</a> <span class="keywordtype">int</span> <a class="code" href="classAddressClient.html#AddressClienta10" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta10">AddressClient::AddBinding</a>(u_int id, <span class="keyword">const</span> <span class="keywordtype">char</span> *binding)
00313 {
00314         <span class="keywordtype">int</span> retVal = -1;
00315 
00316         <span class="keywordtype">char</span> sendBuf[25];
00317         sprintf(sendBuf, <span class="stringliteral">"ADD %u %s"</span>, id, binding);
00318 
00319         std::string theReply;
00320         <span class="keywordflow">if</span> (<a class="code" href="classAddressClient.html#AddressClientb0" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientb0">SendCommand</a>(sendBuf, theReply) == -1)
00321         {
00322                 <span class="keywordflow">return</span> -1;
00323         }
00324 
00325         <span class="keywordflow">if</span> (theReply == <span class="stringliteral">"OK"</span>)
00326         {
00327                 retVal = 0;
00328         }
00329 
00330         <span class="keywordflow">return</span> retVal;
00331 }
00332 
00333 
00334 
<a name="l00335"></a><a class="code" href="classAddressClient.html#AddressClienta11" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta11">00335</a> <span class="keywordtype">int</span> <a class="code" href="classAddressClient.html#AddressClienta11" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta11">AddressClient::RemoveBinding</a>(u_int id, <span class="keyword">const</span> <span class="keywordtype">char</span> *binding)
00336 {
00337         <span class="keywordtype">int</span> retVal = -1;
00338 
00339         <span class="keywordtype">char</span> sendBuf[25];
00340         sprintf(sendBuf, <span class="stringliteral">"REMOVE %u %s"</span>, id, binding);
00341 
00342         std::string theReply;
00343         <span class="keywordflow">if</span> (<a class="code" href="classAddressClient.html#AddressClientb0" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientb0">SendCommand</a>(sendBuf, theReply) == -1)
00344         {
00345                 <span class="keywordflow">return</span> -1;
00346         }
00347 
00348         <span class="keywordflow">if</span> (theReply == <span class="stringliteral">"OK"</span>)
00349         {
00350                 retVal = 0;
00351         }
00352 
00353         <span class="keywordflow">return</span> retVal;
00354 }
00355 
00356 
00357 
<a name="l00358"></a><a class="code" href="classAddressClient.html#AddressClienta12" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta12">00358</a> <span class="keywordtype">int</span> <a class="code" href="classAddressClient.html#AddressClienta12" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta12">AddressClient::ClearBindings</a>()
00359 {
00360         <span class="keywordtype">int</span> retVal = -1;
00361 
00362         std::string theReply;
00363         <span class="keywordflow">if</span> (<a class="code" href="classAddressClient.html#AddressClientb0" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientb0">SendCommand</a>(<span class="stringliteral">"CLEAR_BINDINGS"</span>, theReply) == -1)
00364         {
00365                 <span class="keywordflow">return</span> -1;
00366         }
00367 
00368         <span class="keywordflow">if</span> (theReply == <span class="stringliteral">"OK"</span>)
00369         {
00370                 retVal = 0;
00371         }
00372 
00373         <span class="keywordflow">return</span> retVal;
00374 }
00375 
00376 
00377 
00378 
<a name="l00379"></a><a class="code" href="classAddressClient.html#AddressClienta14" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta14">00379</a> ACE_HANDLE <a class="code" href="classAddressClient.html#AddressClienta14" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta14">AddressClient::get_handle</a> (<span class="keywordtype">void</span>)<span class="keyword"> const</span>
00380 <span class="keyword"></span>{
00381         <span class="keywordflow">return</span> this-&gt;<a class="code" href="classAddressClient.html#AddressClientr2" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr2">m_socket</a>.get_handle ();
00382 }
00383 
00384 
00385 
<a name="l00386"></a><a class="code" href="classAddressClient.html#AddressClienta13" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta13">00386</a> <span class="keywordtype">int</span> <a class="code" href="classAddressClient.html#AddressClienta13" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta13">AddressClient::handle_input</a> (ACE_HANDLE)
00387 {
00388         ACE_INET_Addr remoteAddr;
00389 
00390         <span class="keywordtype">int</span> len = <a class="code" href="classAddressClient.html#AddressClientr2" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr2">m_socket</a>.recv(<a class="code" href="classAddressClient.html#AddressClientr1" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr1">m_buf</a>, <span class="keyword">sizeof</span>(<a class="code" href="classAddressClient.html#AddressClientr1" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr1">m_buf</a>)-1, remoteAddr);
00391 
00392         <span class="comment">//</span>
00393         <span class="comment">// If the receive call failed, report the error and</span>
00394         <span class="comment">// return -1.</span>
00395         <span class="comment">// NOTE: A return value of -1 means the AddressClient is </span>
00396         <span class="comment">// deregistered with the Reactor.</span>
00397         <span class="keywordflow">if</span> (len == -1)
00398         {
00399                 ACE_ERROR_RETURN((LM_ERROR, <span class="stringliteral">"(%N:%l) %p\n"</span>, <span class="stringliteral">"recv"</span>), -1);
00400         }
00401 
00402         <span class="comment">//</span>
00403         <span class="comment">// Null-terminate the received string.</span>
00404         m_buf[len] = <span class="charliteral">'\0'</span>;
00405 
00406         <span class="comment">//</span>
00407         <span class="comment">// This object address is needed for "CHANGED" commands.</span>
00408         u_int objAddr;
00409 
00410         <span class="comment">//</span>
00411         <span class="comment">// If the received message is "CHANGED_ALL" then all the cached</span>
00412         <span class="comment">// bindings are invalidated.</span>
00413         <span class="keywordflow">if</span> (strncmp(<span class="stringliteral">"CHANGED_ALL"</span>, m_buf, 11) == 0)
00414         {
00415                 ACE_DEBUG((LM_INFO,
00416                         <span class="stringliteral">"(%N:%l) Address server changed. Clearing cache.\n"</span>));
00417 
00418                 ACE_Guard&lt;ACE_Thread_Mutex&gt; g(<a class="code" href="classAddressClient.html#AddressClientr3" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr3">m_bindingMutex</a>);
00419                 
00420                 <span class="comment">//</span>
00421                 <span class="comment">// Clear all the bindings.</span>
00422                 <a class="code" href="classAddressClient.html#AddressClientr4" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr4">m_bindings</a>.clear();
00423         }
00424         <span class="comment">//</span>
00425         <span class="comment">// If the received message is "CHANGED" then the cached bindings</span>
00426         <span class="comment">// with the given object address are invalidated.</span>
00427         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sscanf(m_buf, <span class="stringliteral">"CHANGED %u"</span>, &amp;objAddr) == 1)
00428         {
00429                 ACE_DEBUG((LM_INFO,
00430                         <span class="stringliteral">"(%N:%l) Address server changed. Clearing entries for %u.\n"</span>,
00431                         objAddr));
00432 
00433                 ACE_Guard&lt;ACE_Thread_Mutex&gt; g(<a class="code" href="classAddressClient.html#AddressClientr3" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr3">m_bindingMutex</a>);
00434                 
00435                 <span class="comment">//</span>
00436                 <span class="comment">// If we have bindings for this address, remove them.</span>
00437                 <a class="code" href="classAddressClient.html#AddressClientr4" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr4">m_bindings</a>.erase(objAddr);
00438         }
00439         <span class="comment">//</span>
00440         <span class="comment">// If the message is "ACK", then someone pinged the server and wants to</span>
00441         <span class="comment">// know its alive. Tell them it is.</span>
00442         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(<span class="stringliteral">"ACK"</span>, m_buf, 3) == 0)
00443         {
00444                 ACE_Guard&lt;ACE_Thread_Mutex&gt; g(<a class="code" href="classAddressClient.html#AddressClientr8" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr8">m_pingMutex</a>);
00445 
00446                 <a class="code" href="classAddressClient.html#AddressClientr9" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr9">m_pingCondition</a>.broadcast();
00447         }
00448         <span class="comment">//</span>
00449         <span class="comment">// Otherwise, assume the command is solicited. Route it to the</span>
00450         <span class="comment">// first pending reader.</span>
00451         <span class="keywordflow">else</span> 
00452         {
00453                 ACE_Guard&lt;ACE_Thread_Mutex&gt; g(<a class="code" href="classAddressClient.html#AddressClientr6" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr6">m_pendingReplyQueue</a>.<a class="code" href="classReplyQueue.html#ReplyQueuea13" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea13">GetMutex</a>());
00454 
00455                 <span class="keywordflow">if</span> (<a class="code" href="classAddressClient.html#AddressClientr6" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr6">m_pendingReplyQueue</a>.<a class="code" href="classReplyQueue.html#ReplyQueuea5" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea5">IsEmpty_i</a>())
00456                 {
00457                         ACE_ERROR((LM_WARNING, <span class="stringliteral">"Got spurious message: %s\n"</span>, m_buf));
00458                 }
00459                 <span class="keywordflow">else</span>
00460                 {
00461                         std::string buf(m_buf);
00462                         <a class="code" href="classAddressClient.html#AddressClientr6" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr6">m_pendingReplyQueue</a>.<a class="code" href="classReplyQueue.html#ReplyQueuea11" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea11">SetReply_i</a>(buf);
00463                 }
00464         }
00465 
00466         <span class="keywordflow">return</span> 0;
00467 }
00468 
00469 
00470 
<a name="l00471"></a><a class="code" href="classAddressClient.html#AddressClientb0" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientb0">00471</a> <span class="keywordtype">int</span> <a class="code" href="classAddressClient.html#AddressClientb0" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientb0">AddressClient::SendCommand</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *str, std::string &amp;reply)
00472 {
00473         <span class="comment">//</span>
00474         <span class="comment">// A place to hold the result of method calls.</span>
00475         <span class="keywordtype">int</span> status = -1;
00476 
00477         {
00478                 ACE_Guard&lt;ACE_Thread_Mutex&gt; g(<a class="code" href="classAddressClient.html#AddressClientr6" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr6">m_pendingReplyQueue</a>.<a class="code" href="classReplyQueue.html#ReplyQueuea13" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea13">GetMutex</a>());
00479 
00480                 <span class="comment">//</span>
00481                 <span class="comment">// Try to send the command over the network.</span>
00482                 status = this-&gt;<a class="code" href="classAddressClient.html#AddressClientr2" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr2">m_socket</a>.send(str, strlen(str), <a class="code" href="classAddressClient.html#AddressClientr0" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr0">m_addrServer</a>);
00483                 <span class="keywordflow">if</span> (status == -1)
00484                 {
00485                         ACE_ERROR_RETURN((LM_ERROR, <span class="stringliteral">"(%N:%l) %p\n"</span>,<span class="stringliteral">"send"</span>), -1);
00486                 }       
00487                 
00488                 <span class="comment">//</span>
00489                 <span class="comment">// If we have no timeout, wait indefinitely for the reply to arrive.</span>
00490                 <span class="keywordflow">if</span> (<a class="code" href="classAddressClient.html#AddressClientr10" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr10">m_timeout</a> == ACE_Time_Value::zero)
00491                 {
00492                         status = <a class="code" href="classAddressClient.html#AddressClientr6" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr6">m_pendingReplyQueue</a>.<a class="code" href="classReplyQueue.html#ReplyQueuea7" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea7">GetReply_i</a>(reply);
00493                 }
00494                 <span class="comment">//</span>
00495                 <span class="comment">// Otherwise, wait until either the reply arrives or the timeout</span>
00496                 <span class="comment">// expires.</span>
00497                 <span class="keywordflow">else</span>
00498                 {
00499                         ACE_Time_Value deadline = ACE_OS::gettimeofday() + <a class="code" href="classAddressClient.html#AddressClientr10" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr10">m_timeout</a>;
00500                         status = <a class="code" href="classAddressClient.html#AddressClientr6" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientr6">m_pendingReplyQueue</a>.<a class="code" href="classReplyQueue.html#ReplyQueuea7" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea7">GetReply_i</a>(reply, &amp;deadline);
00501                 }
00502         }
00503 
00504         <span class="comment">//</span>
00505         <span class="comment">// If we failed to get the semaphore for any reason, log the error</span>
00506         <span class="comment">// and return failure.</span>
00507         <span class="keywordflow">if</span> (status == -1)
00508         {
00509                 <span class="comment">//</span>
00510                 <span class="comment">// If the command failed due to timeout, log a more descriptive</span>
00511                 <span class="comment">// error.  Other errors get the system-defined error message.</span>
00512                 <span class="keywordflow">if</span> (ACE_OS::last_error() == ETIME)
00513                 {
00514                         ACE_ERROR_RETURN((LM_ERROR,
00515                                 <span class="stringliteral">"(%N:%l) Reply to command '%s' timed out.\n"</span>, str), -1);
00516                 }
00517                 <span class="keywordflow">else</span>
00518                 {
00519                         ACE_ERROR_RETURN((LM_ERROR, <span class="stringliteral">"(%N:%l) %p\n"</span>, <span class="stringliteral">"acquire"</span>), -1);
00520                 }
00521         }
00522 
00523         <span class="keywordflow">return</span> 0;
00524 }
00525 
00526 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jun 15 11:49:53 2004 for DSACSS Operational Code by
<a href="javascript:if(confirm('http://www.doxygen.org/index.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.doxygen.org/index.html'" tppabs="http://www.doxygen.org/index.html">
<img src="doxygen.png" tppabs="http://dsacss.sourceforge.net/doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
