<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DSACSS Operational Code: CommFactory.cpp Source File</title>
<link href="doxygen.css" tppabs="http://dsacss.sourceforge.net/doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<h1>CommFactory.cpp</h1><a href="CommFactory_8cpp.html" tppabs="http://dsacss.sourceforge.net/CommFactory_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 
00008 <span class="preprocessor">#include "<a class="code" href="CommFactory_8h.html" tppabs="http://dsacss.sourceforge.net/CommFactory_8h.html">CommFactory.h</a>"</span>
00009 
00010 <span class="preprocessor">#include "ace/INET_Addr.h"</span>
00011 <span class="preprocessor">#include "ace/Reactor.h"</span>
00012 <span class="preprocessor">#include "ace/TP_Reactor.h"</span>
00013 <span class="preprocessor">#include "<a class="code" href="SystemProperties_8h.html" tppabs="http://dsacss.sourceforge.net/SystemProperties_8h.html">Utils/SystemProperties.h</a>"</span>
00014 
00015 <span class="preprocessor">#include "<a class="code" href="AddressServer_8h.html" tppabs="http://dsacss.sourceforge.net/AddressServer_8h.html">Comm/AddressServer.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="MessageServer_8h.html" tppabs="http://dsacss.sourceforge.net/MessageServer_8h.html">Comm/MessageServer.h</a>"</span>
00017 
00018 <span class="preprocessor">#include &lt;string&gt;</span>
00019 
00020 
<a name="l00021"></a><a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactorya0" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactorya0">00021</a> <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactorya0" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactorya0">PropertyBasedCommFactory::PropertyBasedCommFactory</a>()
00022         : m_pReactor(NULL),
00023           m_pReactorThread(NULL),
00024           m_pAddressClient(NULL),
00025           m_pAddressServer(NULL),
00026           m_pMessageServer(NULL)
00027 {
00028 }
00029 
00030 
00031 
<a name="l00032"></a><a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactorya1" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactorya1">00032</a> <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactorya0" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactorya0">PropertyBasedCommFactory::PropertyBasedCommFactory</a>(<a class="code" href="classSystemProperties.html" tppabs="http://dsacss.sourceforge.net/classSystemProperties.html">SystemProperties</a> &amp;props,
00033                                                                         <span class="keyword">const</span> <span class="keywordtype">char</span> *mySection)
00034         : m_pReactor(NULL),
00035           m_pReactorThread(NULL),
00036           m_pAddressClient(NULL),
00037           m_pAddressServer(NULL),
00038           m_pMessageServer(NULL)
00039 {
00040                 <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactorya3" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactorya3">Open</a>(props, mySection);
00041 }
00042 
00043 
00044 
<a name="l00045"></a><a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactorya2" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactorya2">00045</a> <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactorya2" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactorya2">PropertyBasedCommFactory::~PropertyBasedCommFactory</a>()
00046 {
00047         <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactorya4" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactorya4">Close</a>();
00048 }
00049 
00050 
00051 
<a name="l00052"></a><a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactorya3" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactorya3">00052</a> <span class="keywordtype">int</span> <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactorya3" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactorya3">PropertyBasedCommFactory::Open</a>(<a class="code" href="classSystemProperties.html" tppabs="http://dsacss.sourceforge.net/classSystemProperties.html">SystemProperties</a> &amp;props,
00053                                                                         <span class="keyword">const</span> <span class="keywordtype">char</span> *mySection)
00054 {
00055         <span class="comment">//</span>
00056         <span class="comment">// If we already have a message server then return -1</span>
00057         <span class="comment">// -- we're already open.</span>
00058         <span class="keywordflow">if</span> (<a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp4" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp4">m_pMessageServer</a> != NULL)
00059         {
00060                 <span class="keywordflow">return</span> -1;
00061         }
00062 
00063         <span class="comment">//</span>
00064         <span class="comment">// The defaults before properties are applied.</span>
00065         u_int                   numReactorThreads               = 2;
00066         std::string             addrServerHost                  = ACE_DEFAULT_MULTICAST_ADDR;
00067         u_int                   addrServerPort                  = ACE_DEFAULT_MULTICAST_PORT;
00068         u_int                   addrServerTimeout               = 0;
00069         <span class="keywordtype">bool</span>                    addrServerAutoDetect    = <span class="keyword">true</span>;
00070         <span class="keywordtype">bool</span>                    spawnAddrServer                 = <span class="keyword">false</span>;
00071         std::string             addrServerIface                 = <span class="stringliteral">""</span>;
00072         <span class="keywordtype">bool</span>                    addrServerLoopback              = <span class="keyword">false</span>;
00073         u_int                   addrServerTTL                   = 1;
00074 
00075         <a class="code" href="classSystemProperties.html#SystemPropertiesw0" tppabs="http://dsacss.sourceforge.net/classSystemProperties.html#SystemPropertiesw0">SystemProperties::SectionKey_t</a>                  csSection;
00076 
00077         <span class="comment">//</span>
00078         <span class="comment">// Find the section.</span>
00079         <span class="keywordtype">int</span> status = props.<a class="code" href="classSystemProperties.html#SystemPropertiesa22" tppabs="http://dsacss.sourceforge.net/classSystemProperties.html#SystemPropertiesa22">GetSectionKey</a>(mySection, csSection);
00080         <span class="keywordflow">if</span> (status == -1)
00081         {
00082                 ACE_ERROR((LM_WARNING, <span class="stringliteral">"(%N:%l) Section '%s' of system properties is missing. Using defaults.\n"</span>,
00083                         mySection));
00084         }
00085         <span class="keywordflow">else</span>
00086         {
00087                 std::string tmpString;
00088                 <a class="code" href="classSystemProperties.html#SystemPropertiesw1" tppabs="http://dsacss.sourceforge.net/classSystemProperties.html#SystemPropertiesw1">SystemProperties::Valuetype_t</a> vt;
00089                 
00090                 <span class="comment">//</span>
00091                 <span class="comment">// Try to get the number of reactor threads from the properties.</span>
00092                 <span class="keywordflow">if</span> (props.find_value(csSection, <span class="stringliteral">"NumReactorThreads"</span>,vt) == 0)
00093                 {
00094                         props.<a class="code" href="classSystemProperties.html#SystemPropertiesa3" tppabs="http://dsacss.sourceforge.net/classSystemProperties.html#SystemPropertiesa3">GetIntegerEntry</a>(csSection, <span class="stringliteral">"NumReactorThreads"</span>,
00095                                                                         numReactorThreads);
00096                 }
00097                 
00098                 <span class="comment">//</span>
00099                 <span class="comment">// Try to retrieve the IP address of the address server from properties.</span>
00100                 <span class="keywordflow">if</span> (props.find_value(csSection, <span class="stringliteral">"AddrServerHost"</span>,vt) == 0)
00101                 {
00102                         <span class="keywordflow">if</span> (props.<a class="code" href="classSystemProperties.html#SystemPropertiesa2" tppabs="http://dsacss.sourceforge.net/classSystemProperties.html#SystemPropertiesa2">GetStringEntry</a>(csSection, <span class="stringliteral">"AddrServerHost"</span>, tmpString) == 0
00103                                         &amp;&amp; tmpString != <span class="stringliteral">"DEFAULT"</span>)
00104                         {
00105                                 addrServerHost = tmpString;
00106                         }
00107                 }
00108                 
00109                 <span class="comment">//</span>
00110                 <span class="comment">// Try to retrieve the port number of the address server from</span>
00111                 <span class="comment">// properties.</span>
00112                 <span class="keywordflow">if</span> (props.find_value(csSection, <span class="stringliteral">"AddrServerPort"</span>,vt) == 0)
00113                 {
00114                         <span class="keywordflow">if</span> (
00115                                 vt != SystemProperties::STRING
00116                                 || (props.<a class="code" href="classSystemProperties.html#SystemPropertiesa2" tppabs="http://dsacss.sourceforge.net/classSystemProperties.html#SystemPropertiesa2">GetStringEntry</a>(csSection, <span class="stringliteral">"AddrServerPort"</span>, tmpString) == 0
00117                                         &amp;&amp; tmpString != <span class="stringliteral">"DEFAULT"</span>)
00118                                 )
00119                         {
00120                                 props.<a class="code" href="classSystemProperties.html#SystemPropertiesa3" tppabs="http://dsacss.sourceforge.net/classSystemProperties.html#SystemPropertiesa3">GetIntegerEntry</a>(csSection, <span class="stringliteral">"AddrServerPort"</span>, addrServerPort);
00121                         }
00122                 }
00123                 
00124                 <span class="comment">//</span>
00125                 <span class="comment">// See if the address server auto detect option is specified.</span>
00126                 <span class="keywordflow">if</span> (props.find_value(csSection, <span class="stringliteral">"AddrServerTimeout"</span>,vt) == 0)
00127                 {
00128                         props.<a class="code" href="classSystemProperties.html#SystemPropertiesa3" tppabs="http://dsacss.sourceforge.net/classSystemProperties.html#SystemPropertiesa3">GetIntegerEntry</a>(csSection, <span class="stringliteral">"AddrServerTimeout"</span>,
00129                                                                          addrServerTimeout);
00130                 }
00131 
00132                 <span class="comment">//</span>
00133                 <span class="comment">// See if the address server auto detect option is specified.</span>
00134                 <span class="keywordflow">if</span> (props.find_value(csSection, <span class="stringliteral">"AddrServerAutoDetect"</span>,vt) == 0)
00135                 {
00136                         props.<a class="code" href="classSystemProperties.html#SystemPropertiesa6" tppabs="http://dsacss.sourceforge.net/classSystemProperties.html#SystemPropertiesa6">GetBooleanEntry</a>(csSection, <span class="stringliteral">"AddrServerAutoDetect"</span>, 
00137                                                                         addrServerAutoDetect);
00138                 }
00139 
00140                 <span class="comment">//</span>
00141                 <span class="comment">// See if the user specified what to do for an address server.</span>
00142                 <span class="keywordflow">if</span> (props.find_value(csSection, <span class="stringliteral">"SpawnAddrServer"</span>,vt) == 0)
00143                 {
00144                         <span class="comment">//</span>
00145                         <span class="comment">// See if we should spawn an address server.</span>
00146                         props.<a class="code" href="classSystemProperties.html#SystemPropertiesa6" tppabs="http://dsacss.sourceforge.net/classSystemProperties.html#SystemPropertiesa6">GetBooleanEntry</a>(csSection, <span class="stringliteral">"SpawnAddrServer"</span>, 
00147                                                                         spawnAddrServer);
00148                 }
00149                         
00150                 <span class="comment">//</span>
00151                 <span class="comment">// If we might spawn an address server, try to get the properties</span>
00152                 <span class="comment">// to do so.</span>
00153                 <span class="keywordflow">if</span> (spawnAddrServer || addrServerAutoDetect)
00154                 {
00155                         <span class="comment">//</span>
00156                         <span class="comment">// Check to see if a multicast interface was specified.</span>
00157                         <span class="keywordflow">if</span> (props.find_value(csSection, <span class="stringliteral">"AddrServerInterface"</span>,vt) == 0)
00158                         {
00159                                 props.<a class="code" href="classSystemProperties.html#SystemPropertiesa2" tppabs="http://dsacss.sourceforge.net/classSystemProperties.html#SystemPropertiesa2">GetStringEntry</a>(csSection, <span class="stringliteral">"AddrServerInterface"</span>,
00160                                                                          addrServerIface);
00161                         }
00162                         
00163                         <span class="comment">//</span>
00164                         <span class="comment">// Check to see if loopback is to be enabled.</span>
00165                         <span class="keywordflow">if</span> (props.find_value(csSection, <span class="stringliteral">"AddrServerLoopback"</span>,vt) == 0)
00166                         {
00167                                 props.<a class="code" href="classSystemProperties.html#SystemPropertiesa6" tppabs="http://dsacss.sourceforge.net/classSystemProperties.html#SystemPropertiesa6">GetBooleanEntry</a>(csSection, <span class="stringliteral">"AddrServerLoopback"</span>,
00168                                                                                  addrServerLoopback);
00169                         }
00170                         
00171                         <span class="comment">//</span>
00172                         <span class="comment">// Check to see if TTL is to be enabled.</span>
00173                         <span class="keywordflow">if</span> (props.find_value(csSection, <span class="stringliteral">"AddrServerTTL"</span>,vt) == 0)
00174                         {
00175                                 props.<a class="code" href="classSystemProperties.html#SystemPropertiesa3" tppabs="http://dsacss.sourceforge.net/classSystemProperties.html#SystemPropertiesa3">GetIntegerEntry</a>(csSection, <span class="stringliteral">"AddrServerTTL"</span>,
00176                                                                                  addrServerTTL);
00177                         }
00178                 }
00179         }
00180 
00181         <span class="comment">//</span>
00182         <span class="comment">// Instantiate the thread pool reactor.</span>
00183         <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp0" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp0">m_pReactor</a> = <span class="keyword">new</span> ACE_Reactor(<span class="keyword">new</span> ACE_TP_Reactor(), 1);
00184 
00185 
00186         <span class="comment">//</span>
00187         <span class="comment">// Spawn the reactor's threads.</span>
00188         <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp1" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp1">m_pReactorThread</a> = <span class="keyword">new</span> <a class="code" href="classReactorThread.html" tppabs="http://dsacss.sourceforge.net/classReactorThread.html">ReactorThread</a>(<a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp0" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp0">m_pReactor</a>, numReactorThreads);
00189 
00190 
00191         <span class="comment">//</span>
00192         <span class="comment">// Construct the address server's IP address.</span>
00193         ACE_INET_Addr   aservAddr(addrServerPort, addrServerHost.c_str());
00194 
00195         <span class="comment">//</span>
00196         <span class="comment">// Instantiate the AddressClient.</span>
00197         <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp2" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp2">m_pAddressClient</a> = <span class="keyword">new</span> <a class="code" href="classAddressClient.html" tppabs="http://dsacss.sourceforge.net/classAddressClient.html">AddressClient</a>(aservAddr);
00198 
00199         <span class="comment">//</span>
00200         <span class="comment">// If the timeout was specified, then set it.</span>
00201         <span class="keywordflow">if</span> (addrServerTimeout != 0)
00202         {
00203                 <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp2" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp2">m_pAddressClient</a>-&gt;<a class="code" href="classAddressClient.html#AddressClienta4" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta4">SetTimeout</a>(ACE_Time_Value(addrServerTimeout));
00204         }
00205 
00206         <span class="comment">//</span>
00207         <span class="comment">// Register the address client with the reactor.</span>
00208         <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp2" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp2">m_pAddressClient</a>-&gt;<a class="code" href="classAddressClient.html#AddressClienta2" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta2">RegisterWithReactor</a>(*<a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp0" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp0">m_pReactor</a>);
00209 
00210 
00211         <span class="comment">//</span>
00212         <span class="comment">// If auto-detect, then use the address client to ping the address</span>
00213         <span class="comment">// server. If not found after 5 pings, then plan to construct an address</span>
00214         <span class="comment">// server locally.</span>
00215         <span class="keywordflow">if</span> (addrServerAutoDetect)
00216         {
00217                 <span class="keywordtype">int</span> status = -1;
00218                 <span class="keywordtype">int</span> i;
00219                 <span class="keywordflow">for</span> (i = 1; status == -1 &amp;&amp; i &lt;= 5; ++i)
00220                 {
00221                         ACE_DEBUG((LM_INFO,
00222                                 <span class="stringliteral">"(%N:%l) Addr Server auto detect try %d...\n"</span>, i));
00223 
00224                         status = <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp2" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp2">m_pAddressClient</a>-&gt;<a class="code" href="classAddressClient.html#AddressClienta5" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta5">PingServer</a>();
00225 
00226                         <span class="keywordflow">if</span> (status == -1)
00227                                 ACE_DEBUG((LM_INFO, <span class="stringliteral">"(%N:%l) Addr Server not found.\n"</span>, i));
00228                         <span class="keywordflow">else</span>
00229                                 ACE_DEBUG((LM_INFO, <span class="stringliteral">"(%N:%l) Addr Server found.\n"</span>, i));
00230                 }
00231 
00232                 spawnAddrServer = (status == -1);
00233                 
00234                 <span class="keywordflow">if</span> (spawnAddrServer)
00235                         ACE_DEBUG((LM_INFO,
00236                                 <span class="stringliteral">"(%N:%l) Auto detect didn't find an address server."</span>
00237                                 <span class="stringliteral">" Spawning a local one.\n"</span>));           
00238         }
00239 
00240         <span class="comment">//</span>
00241         <span class="comment">// If the Address Server is to be spawned, do it.</span>
00242         <span class="keywordflow">if</span> (spawnAddrServer)
00243         {
00244                 <span class="comment">//</span>
00245                 <span class="comment">// Construct the address server with or without a specified</span>
00246                 <span class="comment">// multicast interface.</span>
00247                 <span class="keywordflow">if</span> (addrServerIface == <span class="stringliteral">""</span>)
00248                 {
00249                         <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp3" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp3">m_pAddressServer</a> = <span class="keyword">new</span> <a class="code" href="classAddressServer.html" tppabs="http://dsacss.sourceforge.net/classAddressServer.html">AddressServer</a>(aservAddr);
00250                 }
00251                 <span class="keywordflow">else</span>
00252                 {
00253                         <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp3" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp3">m_pAddressServer</a> = <span class="keyword">new</span> <a class="code" href="classAddressServer.html" tppabs="http://dsacss.sourceforge.net/classAddressServer.html">AddressServer</a>(aservAddr,
00254                                 addrServerIface.c_str());
00255                 }
00256 
00257                 <span class="comment">//</span>
00258                 <span class="comment">// Set the multicast loopback state.</span>
00259                 <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp3" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp3">m_pAddressServer</a>-&gt;<a class="code" href="classAddressServer.html#AddressServera3" tppabs="http://dsacss.sourceforge.net/classAddressServer.html#AddressServera3">SetLoopbackEnable</a>(addrServerLoopback);
00260 
00261                 <span class="comment">//</span>
00262                 <span class="comment">// Set the multicast TTL</span>
00263                 <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp3" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp3">m_pAddressServer</a>-&gt;<a class="code" href="classAddressServer.html#AddressServera4" tppabs="http://dsacss.sourceforge.net/classAddressServer.html#AddressServera4">SetTimeToLive</a>(addrServerTTL);
00264 
00265                 <span class="comment">//</span>
00266                 <span class="comment">// Attach the address server to the reactor.</span>
00267                 <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp3" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp3">m_pAddressServer</a>-&gt;<a class="code" href="classAddressServer.html#AddressServera5" tppabs="http://dsacss.sourceforge.net/classAddressServer.html#AddressServera5">RegisterWithReactor</a>(*<a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp0" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp0">m_pReactor</a>);
00268         }
00269 
00270         <span class="comment">//</span>
00271         <span class="comment">// Instantiate the message server and give it a pointer</span>
00272         <span class="comment">// to the address client.  The factory keeps ownership of</span>
00273         <span class="comment">// the address client, however.</span>
00274         <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp4" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp4">m_pMessageServer</a> = <span class="keyword">new</span> <a class="code" href="classMessageServer.html" tppabs="http://dsacss.sourceforge.net/classMessageServer.html">MessageServer</a>(<a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp2" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp2">m_pAddressClient</a>, <span class="keyword">false</span>);
00275 
00276         <span class="comment">//</span>
00277         <span class="comment">// Attach the message server to the reactor.</span>
00278         <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp4" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp4">m_pMessageServer</a>-&gt;<a class="code" href="classMessageServer.html#MessageServera3" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServera3">RegisterWithReactor</a>(*<a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp0" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp0">m_pReactor</a>);
00279 
00280         
00281         <span class="comment">//</span>
00282         <span class="comment">// Set up the address server callback mechanism. Note that this</span>
00283         <span class="comment">// must be done after the reactor's threads are started.</span>
00284         <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp4" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp4">m_pMessageServer</a>-&gt;<a class="code" href="classMessageServer.html#MessageServera5" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServera5">GetAddressClient</a>()-&gt;<a class="code" href="classAddressClient.html#AddressClienta6" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta6">RegisterServerCallback</a>();
00285 
00286         <span class="keywordflow">return</span> 0;
00287 }
00288 
00289 
00290 
<a name="l00291"></a><a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactorya4" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactorya4">00291</a> <span class="keywordtype">int</span> <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactorya4" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactorya4">PropertyBasedCommFactory::Close</a>()
00292 {
00293         <span class="comment">//</span>
00294         <span class="comment">// If the message server is already NULL, then</span>
00295         <span class="comment">// return -1 -- we're already closed or closing.</span>
00296         <span class="keywordflow">if</span> (<a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp4" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp4">m_pMessageServer</a> == NULL)
00297         {
00298                 <span class="keywordflow">return</span> -1;
00299         }
00300 
00301         <span class="comment">//</span>
00302         <span class="comment">// If the address server is local, then make reactor deregistrations</span>
00303         <span class="comment">// immediate.  This means no attempt will be made to deregister</span>
00304         <span class="comment">// notifications or bindings from the address server.  The address</span>
00305         <span class="comment">// server is getting destroyed now anyway.</span>
00306         <span class="keywordtype">bool</span> immediateShutdown = (<a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp3" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp3">m_pAddressServer</a> != NULL);
00307 
00308         <span class="comment">//</span>
00309         <span class="comment">// Shut down the message server first.</span>
00310         <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp4" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp4">m_pMessageServer</a>-&gt;<a class="code" href="classMessageServer.html#MessageServera4" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServera4">RemoveFromReactor</a>(*<a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp0" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp0">m_pReactor</a>, immediateShutdown);
00311         <span class="keyword">delete</span> <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp4" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp4">m_pMessageServer</a>;
00312         <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp4" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp4">m_pMessageServer</a> = NULL;
00313 
00314         <span class="comment">//</span>
00315         <span class="comment">// Next, shut down the address client.</span>
00316         <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp2" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp2">m_pAddressClient</a>-&gt;<a class="code" href="classAddressClient.html#AddressClienta3" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClienta3">RemoveFromReactor</a>(*<a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp0" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp0">m_pReactor</a>, immediateShutdown);
00317         <span class="keyword">delete</span> <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp2" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp2">m_pAddressClient</a>;
00318         <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp2" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp2">m_pAddressClient</a> = NULL;
00319 
00320         <span class="comment">//</span>
00321         <span class="comment">// Shut down the address server (if any).</span>
00322         <span class="keywordflow">if</span> (<a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp3" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp3">m_pAddressServer</a> != NULL)
00323         {
00324                 <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp3" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp3">m_pAddressServer</a>-&gt;<a class="code" href="classAddressServer.html#AddressServera6" tppabs="http://dsacss.sourceforge.net/classAddressServer.html#AddressServera6">RemoveFromReactor</a>(*<a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp0" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp0">m_pReactor</a>);
00325 
00326                 <span class="keyword">delete</span> <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp3" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp3">m_pAddressServer</a>;
00327                 <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp3" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp3">m_pAddressServer</a> = NULL;
00328         }
00329 
00330         <span class="comment">//</span>
00331         <span class="comment">// Delete the reactor thread object. This will cause the reactor</span>
00332         <span class="comment">// reactor to stop handling events. The destructor won't return until </span>
00333         <span class="comment">// all the threads finish.</span>
00334         <span class="keyword">delete</span> <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp1" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp1">m_pReactorThread</a>;
00335         <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp1" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp1">m_pReactorThread</a> = NULL;
00336 
00337         <span class="comment">//</span>
00338         <span class="comment">// Finally, delete the reactor.</span>
00339         <span class="keyword">delete</span> <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp0" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp0">m_pReactor</a>;
00340         <a class="code" href="classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp0" tppabs="http://dsacss.sourceforge.net/classPropertyBasedCommFactory.html#PropertyBasedCommFactoryp0">m_pReactor</a> = NULL;
00341 
00342         <span class="keywordflow">return</span> 0;
00343 }
00344 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jun 15 11:49:53 2004 for DSACSS Operational Code by
<a href="javascript:if(confirm('http://www.doxygen.org/index.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.doxygen.org/index.html'" tppabs="http://www.doxygen.org/index.html">
<img src="doxygen.png" tppabs="http://dsacss.sourceforge.net/doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
