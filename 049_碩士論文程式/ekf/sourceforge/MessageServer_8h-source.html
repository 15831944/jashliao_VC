<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DSACSS Operational Code: MessageServer.h Source File</title>
<link href="doxygen.css" tppabs="http://dsacss.sourceforge.net/doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<h1>MessageServer.h</h1><a href="MessageServer_8h.html" tppabs="http://dsacss.sourceforge.net/MessageServer_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 
00008 <span class="preprocessor">#ifndef MESSAGE_SERVER_H</span>
00009 <span class="preprocessor"></span><span class="preprocessor">#define MESSAGE_SERVER_H</span>
00010 <span class="preprocessor"></span>
00011 <span class="preprocessor">#include "ace/INET_Addr.h"</span>
00012 <span class="preprocessor">#include "ace/SOCK_Dgram.h"</span>
00013 <span class="preprocessor">#include "ace/Reactor.h"</span>
00014 
00015 <span class="preprocessor">#include &lt;map&gt;</span>
00016 
00017 <span class="preprocessor">#include "<a class="code" href="AddressClient_8h.html" tppabs="http://dsacss.sourceforge.net/AddressClient_8h.html">Comm/AddressClient.h</a>"</span>
00018 
00019 <span class="keyword">class </span><a class="code" href="classMessageClient.html" tppabs="http://dsacss.sourceforge.net/classMessageClient.html">MessageClient</a>;
00020 
00021 
00022 <span class="comment">//</span>
00023 <span class="comment">// This class manages incoming and outgoing network messages.  Message clients</span>
00024 <span class="comment">// send outgoing messages through this class, and incoming messages</span>
00025 <span class="comment">// are read in this class and dispatched to the respective message clients.</span>
<a name="l00026"></a><a class="code" href="classMessageServer.html" tppabs="http://dsacss.sourceforge.net/classMessageServer.html">00026</a> <span class="keyword">class </span><a class="code" href="classMessageServer.html" tppabs="http://dsacss.sourceforge.net/classMessageServer.html">MessageServer</a> : <span class="keyword">public</span> ACE_Event_Handler
00027 {
00028 <span class="keyword">public</span>:
00029         <span class="comment">//</span>
00030         <span class="comment">// MessageClients may call RegisterClient() and RemoveClient()</span>
00031         <span class="comment">// even though those methods are not public.</span>
<a name="l00032"></a><a class="code" href="classMessageServer.html#MessageServern0" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServern0">00032</a>         <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classMessageClient.html" tppabs="http://dsacss.sourceforge.net/classMessageClient.html">MessageClient</a>;
00033 
00034         <span class="comment">//</span>
00035         <span class="comment">// Constructs a Message server.  Given the IP address of the </span>
00036         <span class="comment">// AddressServer, this constructor instantiates</span>
00037         <span class="comment">// an AddressClient as a child of this MessageServer as well.</span>
00038         <span class="comment">// The address client will be registered with the reactor</span>
00039         <span class="comment">// when RegisterWithReactor() is called for this object.</span>
00040         <span class="comment">// The message server's UDP port will be opened with the</span>
00041         <span class="comment">// specified local IP address.</span>
00042         <span class="comment">// Note that the message server will not be useful until</span>
00043         <span class="comment">// RegisterWithReactor() is called.</span>
00044         <span class="keyword">explicit</span> <a class="code" href="classMessageServer.html#MessageServera0" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServera0">MessageServer</a> (<span class="keyword">const</span> ACE_INET_Addr &amp;addrServer,
00045                 <span class="keyword">const</span> ACE_INET_Addr &amp;localAddr=ACE_INET_Addr());
00046 
00047         <span class="comment">//</span>
00048         <span class="comment">// Constructs a Message server.  This constructor instantiates</span>
00049         <span class="comment">// a MessageServer and connects it to the supplied AddressClient.</span>
00050         <span class="comment">// If the "takeOwnership" flag is set, it is assumed that</span>
00051         <span class="comment">// the supplied client is to be registered and deregistered</span>
00052         <span class="comment">// to/from the reactor, and deleted from the MessageServer's</span>
00053         <span class="comment">// destructor as if it were allocated by the MessageServer itself.</span>
00054         <span class="comment">// If the "take ownership" flag is false, then the AddressClient</span>
00055         <span class="comment">// will simply be used by the MessageServer and never registered,</span>
00056         <span class="comment">// deregistered, or destroyed.</span>
00057         <span class="comment">// The message server's UDP port will be opened with the</span>
00058         <span class="comment">// specified local IP address.</span>
00059         <span class="comment">// Note that the message server will not be useful until</span>
00060         <span class="comment">// RegisterWithReactor() is called for the MessageServer and,</span>
00061         <span class="comment">// if the AddressClient is not owned, for the AddressClient as well.</span>
00062         <span class="keyword">explicit</span> <a class="code" href="classMessageServer.html#MessageServera0" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServera0">MessageServer</a> (<a class="code" href="classAddressClient.html" tppabs="http://dsacss.sourceforge.net/classAddressClient.html">AddressClient</a> *addrClient,
00063                 <span class="keywordtype">bool</span> takeOwnership = <span class="keyword">false</span>,
00064                 <span class="keyword">const</span> ACE_INET_Addr &amp;localAddr=ACE_INET_Addr());
00065 
00066         <span class="comment">//</span>
00067         <span class="comment">// Destroys the message server. RemoveFromReactor() should have</span>
00068         <span class="comment">// been called before destruction. If the MessageServer owns</span>
00069         <span class="comment">// its AddressClient, then the AddressClient will be destroyed</span>
00070         <span class="comment">// as well.</span>
00071         <a class="code" href="classMessageServer.html#MessageServera2" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServera2">~MessageServer</a> (<span class="keywordtype">void</span>);
00072         
00073         <span class="comment">//</span>
00074         <span class="comment">// Registers the MessageServer with a reactor.  If the MessageServer</span>
00075         <span class="comment">// owns its AddressClient, the address client will be registered with</span>
00076         <span class="comment">// the reactor as well. Once registered, the message server can be used</span>
00077         <span class="comment">// to route messages among MessageClients.</span>
00078         <span class="comment">// Returns 0 on success or -1 on failure.</span>
00079         <span class="keywordtype">int</span> <a class="code" href="classMessageServer.html#MessageServera3" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServera3">RegisterWithReactor</a>(ACE_Reactor &amp;theReactor);
00080 
00081         <span class="comment">//</span>
00082         <span class="comment">// Removes the MessageServer from a reactor.  If the MessageServer</span>
00083         <span class="comment">// owns its AddressClient, the address client will be removed from</span>
00084         <span class="comment">// the reactor as well. Once removed, the message server can no longer be</span>
00085         <span class="comment">// used to route messages among MessageClients.</span>
00086         <span class="comment">// Returns 0 on success or -1 on failure.</span>
00087         <span class="keywordtype">int</span> <a class="code" href="classMessageServer.html#MessageServera4" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServera4">RemoveFromReactor</a>(ACE_Reactor &amp;theReactor, <span class="keywordtype">bool</span> immediate = <span class="keyword">false</span>);
00088 
00089         <span class="comment">//</span>
00090         <span class="comment">// Provides access to the MessageServer's AddressClient.</span>
00091         <span class="comment">// Returns a pointer to the AddressClient.</span>
<a name="l00092"></a><a class="code" href="classMessageServer.html#MessageServera5" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServera5">00092</a>         <a class="code" href="classAddressClient.html" tppabs="http://dsacss.sourceforge.net/classAddressClient.html">AddressClient</a> *         <a class="code" href="classMessageServer.html#MessageServera5" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServera5">GetAddressClient</a>() { <span class="keywordflow">return</span> <a class="code" href="classMessageServer.html#MessageServerp2" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerp2">m_pAddrClient</a>; }
00093 
00094         
00095         <span class="comment">//</span>
00096         <span class="comment">// Implementation of the handle_input() method derived from</span>
00097         <span class="comment">// ACE_Event_Handler.  This method routes incoming messages to the</span>
00098         <span class="comment">// MessageServer's clients.</span>
00099         <span class="keyword">virtual</span> <span class="keywordtype">int</span>                     <a class="code" href="classMessageServer.html#MessageServera6" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServera6">handle_input</a> (ACE_HANDLE fd);   
00100 
00101         <span class="comment">//</span>
00102         <span class="comment">// Implementation of the get_handle() method derived from</span>
00103         <span class="comment">// ACE_Event_Handler.  This method returns a handle to the MessageServer's</span>
00104         <span class="comment">// UDP socket.</span>
00105         <span class="keyword">virtual</span> ACE_HANDLE      <a class="code" href="classMessageServer.html#MessageServera7" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServera7">get_handle</a> (<span class="keywordtype">void</span>) <span class="keyword">const</span>;
00106 
00107         <span class="comment">//</span>
00108         <span class="comment">// Routes a message to other MessageServers.  MessageClients call this</span>
00109         <span class="comment">// method when they want to transmit a message.  The IP addresses</span>
00110         <span class="comment">// bound to the destination ID are retrieved from the AddressServer and</span>
00111         <span class="comment">// the message is sent to each of those IP addresses with a header.</span>
00112         <span class="comment">// Returns 0 if all message transmissions succeed, -1 otherwise.</span>
00113         <span class="keywordtype">int</span> <a class="code" href="classMessageServer.html#MessageServera8" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServera8">SendMessage</a>(u_int originator, <span class="keyword">const</span> <span class="keywordtype">void</span> *msg, size_t len, u_int dest);
00114 
00115 <span class="keyword">protected</span>:
00116         <span class="comment">//</span>
00117         <span class="comment">// This is the header that is pre-pended to all outgoing messages.</span>
00118         <span class="comment">// It contains a magic number that allows determination of endianness</span>
00119         <span class="comment">// and fields to route and verify the integrity of the message.</span>
<a name="l00120"></a><a class="code" href="structMessageServer_1_1MsgHdr.html" tppabs="http://dsacss.sourceforge.net/structMessageServer_1_1MsgHdr.html">00120</a>         <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structMessageServer_1_1MsgHdr.html" tppabs="http://dsacss.sourceforge.net/structMessageServer_1_1MsgHdr.html">MsgHdr</a>
00121         {
00122                 <span class="comment">//</span>
00123                 <span class="comment">// This is the big-endian interpretation of the characters</span>
00124                 <span class="comment">// "MESG"  If the sender and receiver don't have the same endianness,</span>
00125                 <span class="comment">// this magic number will be reversed on the receiver side.</span>
00126                 <span class="keyword">enum</span> { <a class="code" href="structMessageServer_1_1MsgHdr.html#MessageServer_1_1MsgHdrw1MessageServer_1_1MsgHdrw0" tppabs="http://dsacss.sourceforge.net/structMessageServer_1_1MsgHdr.html#MessageServer_1_1MsgHdrw1MessageServer_1_1MsgHdrw0">MAGIC_NUMBER</a> = 0x4D455347 };
00127 
00128                 <span class="comment">//</span>
00129                 <span class="comment">// Constructs a message header and initializes the magic number.</span>
<a name="l00130"></a><a class="code" href="structMessageServer_1_1MsgHdr.html#MessageServer_1_1MsgHdra0" tppabs="http://dsacss.sourceforge.net/structMessageServer_1_1MsgHdr.html#MessageServer_1_1MsgHdra0">00130</a>                 <a class="code" href="structMessageServer_1_1MsgHdr.html#MessageServer_1_1MsgHdra0" tppabs="http://dsacss.sourceforge.net/structMessageServer_1_1MsgHdr.html#MessageServer_1_1MsgHdra0">MsgHdr</a>() : <a class="code" href="structMessageServer_1_1MsgHdr.html#MessageServer_1_1MsgHdro0" tppabs="http://dsacss.sourceforge.net/structMessageServer_1_1MsgHdr.html#MessageServer_1_1MsgHdro0">m_magicNumber</a>(<a class="code" href="structMessageServer_1_1MsgHdr.html#MessageServer_1_1MsgHdrw1MessageServer_1_1MsgHdrw0" tppabs="http://dsacss.sourceforge.net/structMessageServer_1_1MsgHdr.html#MessageServer_1_1MsgHdrw1MessageServer_1_1MsgHdrw0">MAGIC_NUMBER</a>) {}
00131 
00132                 <span class="comment">//</span>
00133                 <span class="comment">// The magic number that identifies this block as a message and</span>
00134                 <span class="comment">// shows its endianness.</span>
<a name="l00135"></a><a class="code" href="structMessageServer_1_1MsgHdr.html#MessageServer_1_1MsgHdro0" tppabs="http://dsacss.sourceforge.net/structMessageServer_1_1MsgHdr.html#MessageServer_1_1MsgHdro0">00135</a>                 u_int <a class="code" href="structMessageServer_1_1MsgHdr.html#MessageServer_1_1MsgHdro0" tppabs="http://dsacss.sourceforge.net/structMessageServer_1_1MsgHdr.html#MessageServer_1_1MsgHdro0">m_magicNumber</a>;
00136                 <span class="comment">//</span>
00137                 <span class="comment">// The client ID to which this message is destined.</span>
<a name="l00138"></a><a class="code" href="structMessageServer_1_1MsgHdr.html#MessageServer_1_1MsgHdro1" tppabs="http://dsacss.sourceforge.net/structMessageServer_1_1MsgHdr.html#MessageServer_1_1MsgHdro1">00138</a>                 u_int <a class="code" href="structMessageServer_1_1MsgHdr.html#MessageServer_1_1MsgHdro1" tppabs="http://dsacss.sourceforge.net/structMessageServer_1_1MsgHdr.html#MessageServer_1_1MsgHdro1">m_destination</a>;
00139                 <span class="comment">//</span>
00140                 <span class="comment">// The length of the data following this header.</span>
<a name="l00141"></a><a class="code" href="structMessageServer_1_1MsgHdr.html#MessageServer_1_1MsgHdro2" tppabs="http://dsacss.sourceforge.net/structMessageServer_1_1MsgHdr.html#MessageServer_1_1MsgHdro2">00141</a>                 u_int <a class="code" href="structMessageServer_1_1MsgHdr.html#MessageServer_1_1MsgHdro2" tppabs="http://dsacss.sourceforge.net/structMessageServer_1_1MsgHdr.html#MessageServer_1_1MsgHdro2">m_msgLength</a>;
00142         } <a class="code" href="structMessageServer_1_1MsgHdr.html" tppabs="http://dsacss.sourceforge.net/structMessageServer_1_1MsgHdr.html">MsgHdr_t</a>;
00143 
00144         <span class="comment">//</span>
00145         <span class="comment">// The data structure used to keep track of the clients and</span>
00146         <span class="comment">// their IDs.</span>
<a name="l00147"></a><a class="code" href="classMessageServer.html#MessageServerx1" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerx1">00147</a>         <span class="keyword">typedef</span> std::multimap&lt;u_int, MessageClient *&gt;   <a class="code" href="classMessageServer.html#MessageServerx1" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerx1">ClientMap_t</a>;
00148         <span class="comment">//</span>
00149         <span class="comment">// The internal structure that holds a single client/ID pair.</span>
<a name="l00150"></a><a class="code" href="classMessageServer.html#MessageServerx2" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerx2">00150</a>         <span class="keyword">typedef</span> ClientMap_t::value_type                                 <a class="code" href="classMessageServer.html#MessageServerx2" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerx2">ClientValue_t</a>;
00151 
00152 <span class="keyword">protected</span>:
00153         <span class="comment">//</span>
00154         <span class="comment">// Maps a client to receive messages with a given ID.</span>
00155         <span class="comment">// Note that this method will fail if the client is already</span>
00156         <span class="comment">// registered for the given ID.</span>
00157         <span class="comment">// This method is normally only called from MessageClient::Register().</span>
00158         <span class="comment">// Returns 0 on success and -1 on failure.</span>
00159         <span class="keywordtype">int</span> <a class="code" href="classMessageServer.html#MessageServerb0" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerb0">RegisterClient</a>(u_int id, <a class="code" href="classMessageClient.html" tppabs="http://dsacss.sourceforge.net/classMessageClient.html">MessageClient</a> *client);
00160 
00161         <span class="comment">//</span>
00162         <span class="comment">// Removes a client mapping for a given ID.</span>
00163         <span class="comment">// The client will no longer receive messages with this ID.</span>
00164         <span class="comment">// Note that this method will fail if the client is not registered</span>
00165         <span class="comment">// for the given ID.</span>
00166         <span class="comment">// This method is normally only called from MessageClient::Deregister().</span>
00167         <span class="comment">// Returns 0 on success and -1 on failure.</span>
00168         <span class="keywordtype">int</span> <a class="code" href="classMessageServer.html#MessageServerb1" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerb1">RemoveClient</a>(u_int id, <a class="code" href="classMessageClient.html" tppabs="http://dsacss.sourceforge.net/classMessageClient.html">MessageClient</a> *client);
00169 
00170         <span class="comment">//</span>
00171         <span class="comment">// Implementation method that removes a MessageClient from </span>
00172         <span class="comment">// the client map.  It is called as part of RemoveClient()</span>
00173         <span class="comment">// or any time a MessageClient returns -1 from</span>
00174         <span class="comment">// MessageClient::ReceiveMessage().</span>
00175         <span class="comment">// Note that this method is not synchronized (it acquires no mutexes).</span>
00176         <span class="comment">// It depends on the calling method to ensure synchronicity.</span>
00177         <span class="comment">// Returns an iterator pointing to the element immediately following</span>
00178         <span class="comment">// the removed one in the client map.</span>
00179         ClientMap_t::iterator <a class="code" href="classMessageServer.html#MessageServerb2" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerb2">RemoveClient_i</a>(ClientMap_t::iterator it);
00180 
00181 <span class="keyword">protected</span>:
<a name="l00182"></a><a class="code" href="classMessageServer.html#MessageServerx3" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerx3">00182</a>         <span class="keyword">typedef</span> <a class="code" href="classAddressClient.html#AddressClientw0" tppabs="http://dsacss.sourceforge.net/classAddressClient.html#AddressClientw0">AddressClient::AddrList_t</a>                               <a class="code" href="classMessageServer.html#MessageServerx3" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerx3">AddrList_t</a>;
00183 
<a name="l00184"></a><a class="code" href="classMessageServer.html#MessageServerp0" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerp0">00184</a>         ACE_Thread_Mutex                                                                <a class="code" href="classMessageServer.html#MessageServerp0" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerp0">m_clientMutex</a>;
<a name="l00185"></a><a class="code" href="classMessageServer.html#MessageServerp1" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerp1">00185</a>         <a class="code" href="classMessageServer.html#MessageServerx1" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerx1">ClientMap_t</a>                                                                             <a class="code" href="classMessageServer.html#MessageServerp1" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerp1">m_clients</a>;
00186 
<a name="l00187"></a><a class="code" href="classMessageServer.html#MessageServerp2" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerp2">00187</a>         <a class="code" href="classAddressClient.html" tppabs="http://dsacss.sourceforge.net/classAddressClient.html">AddressClient</a>                                                                   *<a class="code" href="classMessageServer.html#MessageServerp2" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerp2">m_pAddrClient</a>;
<a name="l00188"></a><a class="code" href="classMessageServer.html#MessageServerp3" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerp3">00188</a>         <span class="keywordtype">bool</span>                                                                                    <a class="code" href="classMessageServer.html#MessageServerp3" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerp3">m_addrClientOwned</a>;
00189 
<a name="l00190"></a><a class="code" href="classMessageServer.html#MessageServerp4" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerp4">00190</a>         ACE_INET_Addr                                                                   <a class="code" href="classMessageServer.html#MessageServerp4" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerp4">m_localAddr</a>;
00191                 
00192 <span class="keyword">private</span>:
<a name="l00193"></a><a class="code" href="classMessageServer.html#MessageServerr0" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerr0">00193</a>         ACE_SOCK_Dgram                                                                  <a class="code" href="classMessageServer.html#MessageServerr0" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerr0">m_socket</a>;
<a name="l00194"></a><a class="code" href="classMessageServer.html#MessageServerr1" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerr1">00194</a>         <span class="keywordtype">char</span>                                                                                    <a class="code" href="classMessageServer.html#MessageServerr1" tppabs="http://dsacss.sourceforge.net/classMessageServer.html#MessageServerr1">m_buf</a>[BUFSIZ];
00195 };
00196 
00197 
00198 
00199 <span class="preprocessor">#endif // MESSAGE_SERVER_H</span>
00200 <span class="preprocessor"></span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jun 15 11:49:54 2004 for DSACSS Operational Code by
<a href="javascript:if(confirm('http://www.doxygen.org/index.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.doxygen.org/index.html'" tppabs="http://www.doxygen.org/index.html">
<img src="doxygen.png" tppabs="http://dsacss.sourceforge.net/doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
