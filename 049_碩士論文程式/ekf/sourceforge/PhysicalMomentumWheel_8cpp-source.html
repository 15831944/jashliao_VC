<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DSACSS Operational Code: PhysicalMomentumWheel.cpp Source File</title>
<link href="doxygen.css" tppabs="http://dsacss.sourceforge.net/doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<h1>PhysicalMomentumWheel.cpp</h1><a href="PhysicalMomentumWheel_8cpp.html" tppabs="http://dsacss.sourceforge.net/PhysicalMomentumWheel_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 
00008 
00010 
00011 
00012 
00013 <span class="preprocessor">#include "<a class="code" href="PhysicalMomentumWheel_8h.html" tppabs="http://dsacss.sourceforge.net/PhysicalMomentumWheel_8h.html">PhysicalMomentumWheel.h</a>"</span>
00014 <span class="preprocessor">#include "utils/Time.h"</span>
00015 <span class="preprocessor">#include &lt;fstream.h&gt;</span>
00016 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
00017 
00019 <span class="comment">// Construction/Destruction</span>
00021 <span class="comment"></span>
<a name="l00022"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela0" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela0">00022</a> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela0" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela0">PhysicalMomentumWheel::PhysicalMomentumWheel</a>()
00023 {
00024         pthread_mutex_init(&amp;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>, NULL);
00025         
00026         <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a> = -1;
00027         <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr15" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr15">TCflag</a> = 1;
00028         <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr16" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr16">BiasFlag</a> = 0;
00029         <span class="comment">//With WheelHistory far from implementation, members vars are used to store last state info</span>
00030         <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr7" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr7">LAST_VEL</a> = 0.0;
00031         <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> = 0.0;
00032         <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr9" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr9">LAST_ERR</a> = 0.0;
00033         <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr10" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr10">LAST_VOLT</a> = 25.0;
00034         <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr0" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr0">m_CurrentWheelSpeed</a> = 0.0;
00035         
00036         <span class="comment">//Set SmartMotor 3430 physical limits</span>
00037         <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr3" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr3">m_MaxWheelTorque</a> = 1023;
00038         <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr4" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr4">m_MinWheelTorque</a> = -<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr3" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr3">m_MaxWheelTorque</a>;
00039         <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr11" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr11">m_MaxTorqueStep</a> = 700;
00040 
00041 }
00042 
<a name="l00043"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela1" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela1">00043</a> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela1" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela1">PhysicalMomentumWheel::~PhysicalMomentumWheel</a>()
00044 {
00045 
00046         <span class="comment">//Deinitialize();</span>
00047 
00048 }
00049 
00051 <span class="comment">//  Facilitators</span>
00053 <span class="comment"></span>
00054 
00055 <span class="comment">/*** PID controller to set momentum wheel angular velocity.  Runs in a separate thread created by </span>
00056 <span class="comment">*       by the CommandWheelSpeed() function.  THis function is a friend to the PhyicalMomentumWheel class.</span>
00057 <span class="comment">*       Once created it will run indefinitely until either a new speed is requested or the end of the program </span>
00058 <span class="comment">*       is reached.</span>
00059 <span class="comment">*</span>
00060 <span class="comment">*       This controller has gain scheduling based on the magnitude of the velocity change desired.  It</span>
00061 <span class="comment">*       also places limits on large changes in torque and limits the upper value of torque in order</span>
00062 <span class="comment">*       to protect the motor and its components.*/</span>
<a name="l00063"></a><a class="code" href="PhysicalMomentumWheel_8cpp.html#a0" tppabs="http://dsacss.sourceforge.net/PhysicalMomentumWheel_8cpp.html#a0">00063</a>  <span class="keywordtype">void</span>* <a class="code" href="PhysicalMomentumWheel_8cpp.html#a0" tppabs="http://dsacss.sourceforge.net/PhysicalMomentumWheel_8cpp.html#a0">RunPIDController</a>(<span class="keywordtype">void</span>* arg)
00064 {
00065         <a class="code" href="classPhysicalMomentumWheel.html" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html">PhysicalMomentumWheel</a> *wheel = (<a class="code" href="classPhysicalMomentumWheel.html" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html">PhysicalMomentumWheel</a>*) arg;
00066         <span class="keywordtype">double</span> J = 0.04; <span class="comment">//</span>
00067         <span class="keywordtype">double</span> c = 555.56;<span class="comment">//unit conversion factor = 1 machine torque unit/0.0018 N-m</span>
00068         <span class="keywordtype">double</span> pi = 3.1415926535897;
00069         <span class="keywordtype">double</span> timestep = 1000.0;
00070         <span class="keywordtype">double</span> velocity;
00071         <span class="keywordtype">double</span> desiredV;
00072         <span class="keywordtype">double</span> error;
00073         <span class="keywordtype">double</span> Kp;
00074         <span class="keywordtype">double</span> Ki;
00075         <span class="keywordtype">double</span> Kd;
00076         <span class="keywordtype">double</span> torque;
00077         <span class="keywordtype">double</span> TorqueChange;
00078         <span class="keyword">static</span> <span class="keywordtype">char</span> *torqueCommand = <span class="keyword">new</span> <span class="keywordtype">char</span>[80];
00079         usleep(15000);
00080         <span class="keywordflow">while</span> (1)
00081         {
00082                 pthread_testcancel();
00083 
00084                 pthread_mutex_lock(&amp;wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00085                 velocity = wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr0" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr0">m_CurrentWheelSpeed</a>/2.0/pi;
00086                 desiredV = wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr2" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr2">m_DesiredWheelSpeed</a>/2.0/pi;<span class="comment">//desired velocity in RPS</span>
00087                 pthread_mutex_unlock(&amp;wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00088                 error = desiredV - velocity;<span class="comment">//current error in RPS</span>
00089         
00090                 <span class="comment">// Define gains</span>
00091                 Kp = 9.65*J/c;
00092         
00093                 Ki = 0.0000055;
00094                 <span class="keywordflow">if</span> (fabs(error) &gt;= 25 | fabs(desiredV) &gt;= 25){
00095                         Ki = 0.0000013;
00096                 }
00097                 
00098                 Kd = 0.96*(fabs(error)*0.009029 + 1.92)*J/c; <span class="comment">//linear regression equation</span>
00099                 <span class="keywordflow">if</span> (fabs(error) &gt;= 25 | fabs(desiredV) &gt;= 25){ 
00100                         Kd = 2.14*J/c;
00101                 }
00102         
00103         
00104                 TorqueChange = c*(Kp*error + Kd*(error - wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr9" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr9">LAST_ERR</a>)/timestep + Ki*error*timestep);
00105         
00106                 torque = wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> + TorqueChange;
00107 
00108                 <span class="comment">//Limit Excessive Torques changes</span>
00109                 <span class="keywordflow">if</span> (abs((<span class="keywordtype">int</span>) wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> - torque) &gt; wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr11" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr11">m_MaxTorqueStep</a>  &amp;&amp; torque != 0)
00110                 {
00111                         <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>) wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> &gt;= 0 &amp;&amp; (<span class="keywordtype">int</span>) wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> &lt; torque){
00112                                 torque = (<span class="keywordtype">int</span>) wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> + 300;}
00113                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>) wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> &gt;= 0 &amp;&amp; (<span class="keywordtype">int</span>) wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> &gt; torque){
00114                                 torque = (<span class="keywordtype">int</span>) wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> - 300;}
00115                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>) wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> &lt; 0 &amp;&amp; (<span class="keywordtype">int</span>) wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> &lt; torque){
00116                                 torque = (<span class="keywordtype">int</span>) wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> + 300;}
00117                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>) wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> &lt; 0 &amp;&amp; (<span class="keywordtype">int</span>) wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> &gt; torque){
00118                                 torque = (<span class="keywordtype">int</span>) wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> - 300;}
00119                 }
00120 
00121                 <span class="comment">// Cap maximum torque values</span>
00122                 <span class="keywordflow">if</span> (abs(torque) &gt; wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr3" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr3">m_MaxWheelTorque</a>)
00123                 {
00124                         torque = (<span class="keywordtype">int</span>) wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a>;
00125                 }
00126 
00127                 sprintf(torqueCommand, <span class="stringliteral">"T%d\n\n"</span>, torque);
00128                 <a class="code" href="common_8c.html#a1" tppabs="http://dsacss.sourceforge.net/common_8c.html#a1">say</a>(wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, torqueCommand);
00129 
00130                 pthread_testcancel();
00131 
00132                 usleep(850000);
00133                 <span class="comment">/*      This loop allows for the motor to spin up with the current torque before another</span>
00134 <span class="comment">                *       torque is applied. The allowable magnitude of spin up error is variable.  When the</span>
00135 <span class="comment">                *       current wheel velocity is far away from the desired velocity, the error is large allowing</span>
00136 <span class="comment">                *       for a faster spin up.  When the current velocity is close to the desired, the maximum error</span>
00137 <span class="comment">                *       is small to all for more precise control. A break from the loop is provided for when</span>
00138 <span class="comment">                *       the velocity error is very small, to keep from looping for an excessive amount of time.*/</span>
00139                 <span class="comment">/*double spinuperror = wheel-&gt;LAST_VEL - velocity;</span>
00140 <span class="comment">                while (fabs(spinuperror) &gt; (fabs(error)/15)) {</span>
00141 <span class="comment">                        wheel-&gt;LAST_VEL = velocity;</span>
00142 <span class="comment">                        usleep(20000);</span>
00143 <span class="comment">                        pthread_mutex_lock(&amp;wheel-&gt;m_Mutex);</span>
00144 <span class="comment">                        velocity = wheel-&gt;m_CurrentWheelSpeed/2.0/pi;</span>
00145 <span class="comment">                        pthread_mutex_unlock(&amp;wheel-&gt;m_Mutex);</span>
00146 <span class="comment">                        spinuperror = wheel-&gt;LAST_VEL - velocity;</span>
00147 <span class="comment">                        error = desiredV - velocity;</span>
00148 <span class="comment">                        if (fabs(error)&lt;0.05){ break;}</span>
00149 <span class="comment">                        pthread_testcancel();</span>
00150 <span class="comment">                }</span>
00151 <span class="comment">                */</span>
00152                 wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr7" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr7">LAST_VEL</a> = velocity;
00153                 wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr9" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr9">LAST_ERR</a> = error;
00154                 wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> = torque;
00155                 pthread_testcancel();
00156         }
00157         <span class="keywordflow">return</span> arg;
00158 }
00159 
00160 <span class="comment">//Velocity by Position</span>
00161 <span class="comment">/*  This function determines the velocity of the wheel by differentiating</span>
00162 <span class="comment">        the position reported by the wheel.  The function asks the wheel for its</span>
00163 <span class="comment">        position and then gets the time of day at which the measurement is reported.</span>
00164 <span class="comment">        The code then delays for a small time and asks for the position and gets</span>
00165 <span class="comment">        the time again.  The velocity is then calculated by dividing the change</span>
00166 <span class="comment">        in position byt he change in time.  The return value is the velocity in</span>
00167 <span class="comment">        rev/sec.</span>
00168 <span class="comment"></span>
00169 <span class="comment">        9/22/03 - Now will be run in its own thread.  Passed a pointer to 'this'.</span>
00170 <span class="comment">        Runs indefinitely until program ens or explicitly canceled.  Stores the</span>
00171 <span class="comment">        the latest velocity and time data in the private members of the PMW.</span>
00172 <span class="comment">*/</span>
00173 <span class="comment">//ofstream outfile("Position.txt", ios::out);</span>
00174 
<a name="l00175"></a><a class="code" href="PhysicalMomentumWheel_8cpp.html#a1" tppabs="http://dsacss.sourceforge.net/PhysicalMomentumWheel_8cpp.html#a1">00175</a> <span class="keywordtype">void</span>* <a class="code" href="PhysicalMomentumWheel_8cpp.html#a1" tppabs="http://dsacss.sourceforge.net/PhysicalMomentumWheel_8cpp.html#a1">QueryWheelSpeed</a>(<span class="keywordtype">void</span>* arg)
00176 {
00177         <a class="code" href="classPhysicalMomentumWheel.html" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html">PhysicalMomentumWheel</a> *wheel = (<a class="code" href="classPhysicalMomentumWheel.html" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html">PhysicalMomentumWheel</a>*) arg;
00178         <span class="keywordtype">int</span> pos1 = 0;
00179         <span class="keywordtype">int</span> pos2 = 0;
00180         <span class="keywordtype">double</span> dt;
00181         <span class="keywordtype">double</span> tic;
00182         <span class="comment">//double toc;</span>
00183         <span class="keywordtype">double</span> timeStamp;
00184         <span class="keywordtype">char</span> *posString = <span class="keyword">new</span> <span class="keywordtype">char</span>[80];
00185         <span class="keywordtype">char</span> *posString2 = <span class="keyword">new</span> <span class="keywordtype">char</span>[80];
00186         <span class="keywordtype">double</span> velocity;
00187         <span class="keywordtype">int</span> readdelay =50000;
00188         <span class="keywordtype">char</span> *RPCommand = <span class="keyword">new</span> <span class="keywordtype">char</span>[80];
00189         <span class="comment">//double epoch = Now();</span>
00190         
00191         <span class="keywordflow">while</span> (1)
00192         {
00193                 dt = 0.0;
00194                 usleep(750000);
00195                 pthread_testcancel();
00196                 <span class="comment">//clear serial port buffer</span>
00197                 <span class="keywordtype">char</span>* clear = <span class="keyword">new</span> <span class="keywordtype">char</span>[80];
00198                 pthread_mutex_lock(&amp;wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00199                 <span class="keywordflow">while</span>( !<a class="code" href="common_8c.html#a2" tppabs="http://dsacss.sourceforge.net/common_8c.html#a2">hear</a>(wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, clear, 79, 0, 3333, <span class="charliteral">'c'</span>));
00200 
00201                 <span class="comment">//begin commanding and reading</span>
00202                 sprintf(RPCommand, <span class="stringliteral">"RP\n"</span>);
00203         
00204                 <a class="code" href="common_8c.html#a1" tppabs="http://dsacss.sourceforge.net/common_8c.html#a1">say</a>(wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, RPCommand);
00205                 tic=Now();
00206                 usleep(readdelay/4);
00207                 <a class="code" href="common_8c.html#a2" tppabs="http://dsacss.sourceforge.net/common_8c.html#a2">hear</a>(wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, clear, 25, 0, 10000, <span class="charliteral">'\n'</span>);
00208 
00209                 <a class="code" href="common_8c.html#a2" tppabs="http://dsacss.sourceforge.net/common_8c.html#a2">hear</a>(wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, posString, 15, 0, 10000, <span class="charliteral">'\r'</span>);
00210         
00211                 pos1 = atoi(posString);
00212         
00213                 pthread_testcancel();
00214                 usleep(readdelay);
00215                 
00216                 <span class="comment">//position2</span>
00217                 <a class="code" href="common_8c.html#a1" tppabs="http://dsacss.sourceforge.net/common_8c.html#a1">say</a>(wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, RPCommand);
00218                 
00219                 usleep(readdelay/4);
00220                 dt = Now()-tic;
00221                 timeStamp = Now();
00222                 
00223                 <a class="code" href="common_8c.html#a2" tppabs="http://dsacss.sourceforge.net/common_8c.html#a2">hear</a>(wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, clear, 25, 0, 10000, <span class="charliteral">'\n'</span>);
00224                 <a class="code" href="common_8c.html#a2" tppabs="http://dsacss.sourceforge.net/common_8c.html#a2">hear</a>(wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, posString2, 15, 0, 10000, <span class="charliteral">'\r'</span>);
00225                 
00226                 pthread_mutex_unlock(&amp;wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00227         
00228                 pos2 = atoi(posString2);
00229                 velocity = ((pos2 - pos1)/(dt))*2*3.14159/4000.0;<span class="comment">// rad/sec =&gt; 2pi rad/4000 ct</span>
00230 
00231                 <span class="comment">//outfile &lt;&lt; dt &lt;&lt; "   " &lt;&lt; pos1 &lt;&lt; "   " &lt;&lt; timeStamp - epoch &lt;&lt; "   " &lt;&lt; pos2 &lt;&lt; "   " &lt;&lt; velocity &lt;&lt; " " &lt;&lt; clear &lt;&lt; " " &lt;&lt; posString2 &lt;&lt; endl;</span>
00232                 
00233                 pthread_mutex_lock(&amp;wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00234                 wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr0" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr0">m_CurrentWheelSpeed</a> = velocity;
00235                 wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr1" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr1">m_VelocityTime</a> = timeStamp;      
00236                 pthread_mutex_unlock(&amp;wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00237                 pthread_testcancel();
00238         }
00239         <span class="keywordflow">return</span> arg;
00240 }
00241 
00242 <span class="comment">//ofstream of("NEG.txt", ios::out);</span>
<a name="l00243"></a><a class="code" href="PhysicalMomentumWheel_8cpp.html#a2" tppabs="http://dsacss.sourceforge.net/PhysicalMomentumWheel_8cpp.html#a2">00243</a>  <span class="keywordtype">void</span>* <a class="code" href="PhysicalMomentumWheel_8cpp.html#a2" tppabs="http://dsacss.sourceforge.net/PhysicalMomentumWheel_8cpp.html#a2">RunTorqueController</a>(<span class="keywordtype">void</span>* arg)
00244 {
00245         <a class="code" href="classPhysicalMomentumWheel.html" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html">PhysicalMomentumWheel</a> *wheel = (<a class="code" href="classPhysicalMomentumWheel.html" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html">PhysicalMomentumWheel</a>*) arg;
00246         <span class="keywordtype">double</span> I = 0.075;
00247         <span class="keywordtype">double</span> w1;
00248         <span class="keywordtype">double</span> w2;
00249         <span class="keywordtype">double</span> wss;
00250         <span class="keywordtype">double</span> desTor = 0;
00251         <span class="keywordtype">double</span> deltat = 0.5;
00252         <span class="keywordtype">double</span> C;
00253         C = 0.000001906374*pow(deltat,5) - 0.00012550397*pow(deltat,4) + 0.0032678612*pow(deltat,3) - 0.043053012550397*pow(deltat,4) + 0.0032678612*pow(deltat,3) - 0.0957*pow(deltat,2) + 0.3024019105*deltat + 0.00429944309;
00254         <span class="keywordtype">int</span> negflag = 1;
00255         <span class="keywordtype">double</span> k = 1; <span class="comment">// proportional gain (to tune function to supply torques closer to actual N-m)</span>
00256         <span class="keywordtype">double</span> knt = 0.5; <span class="comment">//negative time gain</span>
00257         <span class="keywordtype">double</span> kpa = 1.12;<span class="comment">//positive augmentation gain</span>
00258         <span class="keywordtype">double</span> kps = 7;<span class="comment">//positive steady state</span>
00259         <span class="keywordtype">double</span> minT = 0.03;<span class="comment">//torque threshold</span>
00260         <span class="comment">//of &lt;&lt; "Wheel   desTor   wss    w2    w1    neglag?" &lt;&lt; endl;</span>
00261         <span class="keywordflow">while</span>(1){
00262                 pthread_testcancel();
00263                 pthread_mutex_lock(&amp;wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00264                 desTor = k*wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr6" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr6">m_DesiredWheelTorque</a>;
00265                 w1 = -wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr0" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr0">m_CurrentWheelSpeed</a>;
00266                 <span class="keywordflow">if</span>(fabs(w1) &gt; 200){
00267                         w1 = wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr7" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr7">LAST_VEL</a>;
00268                 }
00269                 pthread_mutex_unlock(&amp;wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00270                 
00271                 <span class="comment">//k = fabs(desTor)/.3; // proportional gain (to tune function to supply torques closer to actual N-m)</span>
00272                 <span class="comment">//desTor = k*desTor;</span>
00273                 
00274                 w2 = w1 + (desTor)*deltat/I;
00275         
00276                 wss = (w2 + (C-1)*w1)/C;
00277                 
00278                 pthread_testcancel();
00279         <span class="comment">/*</span>
00280 <span class="comment">                if(fabs(wss)&lt;fabs(w1) &amp;&amp; wss*w1 &gt; 0){</span>
00281 <span class="comment">                        deltat = -0.0844/(-0.1744+(desTor/(I*-(w1))));</span>
00282 <span class="comment">                        w2 = w1 + (desTor)*deltat/I;</span>
00283 <span class="comment">                        //sleept = 310000;</span>
00284 <span class="comment">                        wheel-&gt;CommandSystemTorque(-w1/fabs(w1)*0.0018);</span>
00285 <span class="comment">                }</span>
00286 <span class="comment">        */</span>
00287                 <span class="keywordflow">if</span>(fabs(w2)&lt;fabs(w1) &amp;&amp; fabs(desTor)&gt;(k*minT))
00288                 {
00289                         wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela3" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela3">CommandSystemTorque</a>(-w1/fabs(w1)*0.0018);
00290                         usleep((<span class="keywordtype">int</span>) (deltat*1000000*fabs(desTor)*knt));
00291                         negflag = 0;
00292                         <span class="comment">//of &lt;&lt; wheel-&gt;m_DaisyChainPort[3] &lt;&lt; " " &lt;&lt; desTor &lt;&lt; " " &lt;&lt; wss &lt;&lt; " " &lt;&lt; w2 &lt;&lt; " " &lt;&lt; w1 &lt;&lt; endl;</span>
00293                 }
00294         
00295                 pthread_testcancel();
00296                 <span class="comment">//of &lt;&lt; wheel-&gt;m_DaisyChainPort[3] &lt;&lt; " " &lt;&lt; desTor &lt;&lt; " " &lt;&lt; wss &lt;&lt; " " &lt;&lt; w2 &lt;&lt; " " &lt;&lt; w1 &lt;&lt; " " &lt;&lt; negflag &lt;&lt; endl;</span>
00297                 wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela4" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela4">CommandWheelSpeed</a>(wss);<span class="comment">//+20*wss/fabs(wss));</span>
00298                 <span class="keywordflow">if</span>(fabs(desTor) &lt; minT){
00299                         usleep((<span class="keywordtype">int</span>) (deltat*1000000));
00300                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(negflag){
00301                         wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela4" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela4">CommandWheelSpeed</a>(wss*kpa + kps*wss/fabs(wss));
00302                         usleep((<span class="keywordtype">int</span>) (deltat*1000000));
00303                 } <span class="keywordflow">else</span>{
00304                         usleep((<span class="keywordtype">int</span>) (deltat*1000000 - deltat*1000000*fabs(desTor)*knt));
00305                 }
00306                 wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela4" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela4">CommandWheelSpeed</a>(w2);
00307 
00308                 negflag = 1;
00309                 pthread_mutex_lock(&amp;wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00310                 wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr7" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr7">LAST_VEL</a> = w1;
00311                 pthread_mutex_unlock(&amp;wheel-&gt;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00312                 pthread_testcancel();
00313         }
00314 }
00315 
00316 
<a name="l00317"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela2" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela2">00317</a> <span class="keywordtype">void</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela2" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela2">PhysicalMomentumWheel::CommandWheelTorque</a>(<span class="keywordtype">double</span> _wheelTorque)
00318 {
00319         <span class="keywordflow">if</span>(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr15" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr15">TCflag</a>){
00320                 <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela8">StartTorqueController</a>();
00321                 <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr15" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr15">TCflag</a> = 0;
00322         }
00323         pthread_mutex_lock(&amp;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00324         <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr6" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr6">m_DesiredWheelTorque</a> = _wheelTorque;
00325         pthread_mutex_unlock(&amp;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00326 
00327 }
00328 
<a name="l00329"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela3" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela3">00329</a> <span class="keywordtype">void</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela3" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela3">PhysicalMomentumWheel::CommandSystemTorque</a>(<span class="keywordtype">double</span> wheelTorque)
00330 {
00331         <span class="comment">//Old-Skool command a Pork in Tower mode function.</span>
00332         pthread_mutex_lock(&amp;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00333         <span class="comment">//Torque input a double in n-m  </span>
00334         wheelTorque = -wheelTorque/0.0018;
00335         wheelTorque = round(wheelTorque);
00336         <span class="keywordtype">int</span> torque;
00337         torque = (<span class="keywordtype">int</span>) wheelTorque;
00338         <span class="comment">//Limit Excessive Torques changes</span>
00339         <span class="keywordflow">if</span> (abs((<span class="keywordtype">int</span>)<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> - torque) &gt; <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr11" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr11">m_MaxTorqueStep</a>  &amp;&amp; torque != 0)
00340         {
00341                 <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>) <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> &gt;= 0 &amp;&amp; (<span class="keywordtype">int</span>) <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> &lt; torque){
00342                         torque = (<span class="keywordtype">int</span>) <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> + 600;}
00343                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>) <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> &gt;= 0 &amp;&amp; (<span class="keywordtype">int</span>) <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> &gt; torque){
00344                         torque = (<span class="keywordtype">int</span>) <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> - 600;}
00345                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>) <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> &lt; 0 &amp;&amp; (<span class="keywordtype">int</span>) <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> &lt; torque){
00346                         torque = (<span class="keywordtype">int</span>) <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> + 600;}
00347                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>) LAST_TOR &lt; 0 &amp;&amp; (int) LAST_TOR &gt; torque){
00348                         torque = (<span class="keywordtype">int</span>) <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a> - 600;}
00349         }
00350 
00351         <span class="comment">// Cap maximum torque values</span>
00352         <span class="keywordflow">if</span> (abs(torque) &gt; <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr3" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr3">m_MaxWheelTorque</a>)
00353         {
00354                 torque = (<span class="keywordtype">int</span>) <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr8">LAST_TOR</a>;
00355         }
00356 
00357         <span class="keyword">static</span> <span class="keywordtype">char</span> *torqueCommand = <span class="keyword">new</span> <span class="keywordtype">char</span>[80];
00358         sprintf(torqueCommand, <span class="stringliteral">"T%d\n\n"</span>, torque);
00359         <a class="code" href="common_8c.html#a1" tppabs="http://dsacss.sourceforge.net/common_8c.html#a1">say</a>(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, torqueCommand);
00360 
00361         <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr5" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr5">m_CurrentWheelTorque</a> = wheelTorque;
00362         
00363         <span class="comment">//LAST_TOR = power ;</span>
00364 
00365         pthread_mutex_unlock(&amp;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00366 }
00367 
<a name="l00368"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela4" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela4">00368</a> <span class="keywordtype">void</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela4" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela4">PhysicalMomentumWheel::CommandWheelSpeed</a>(<span class="keywordtype">double</span> desiredWheelSpeed)
00369 {
00370         <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr2" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr2">m_DesiredWheelSpeed</a> = -desiredWheelSpeed;
00371         <span class="comment">//pthread_cancel(m_PIDThreadID);</span>
00372         <span class="comment">//pthread_mutex_unlock(&amp;m_Mutex);</span>
00373         <span class="comment">//pthread_create(&amp;m_PIDThreadID, NULL, RunPIDController, (void*) this);</span>
00374 
00375         <span class="keywordtype">double</span> volts;
00376         volts = <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela24" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela24">GetVolts</a>();
00377         <span class="keywordflow">if</span>(volts &lt; 20){
00378                 volts = <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr10" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr10">LAST_VOLT</a>;
00379         }
00380         <span class="keywordtype">double</span> wov;
00381         wov = -desiredWheelSpeed/volts;
00382         
00383         <span class="keywordtype">double</span> dpower;
00384         <span class="keywordflow">if</span>(wov &lt;= -1){
00385                 dpower = 157.3206*wov + 118.4970;
00386         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(wov &gt;= 1){
00387                 dpower = 142.0809*wov - 48.8663;
00388         } <span class="keywordflow">else</span> {
00389                 dpower = 79.5061*wov + 20.1199;
00390         }
00391 
00392         <span class="keywordtype">int</span> power;
00393         power = (<span class="keywordtype">int</span>) round(dpower); 
00394         <span class="comment">//of &lt;&lt; m_DaisyChainPort[3] &lt;&lt; " " &lt;&lt; desiredWheelSpeed &lt;&lt; " " &lt;&lt; volts &lt;&lt; " " &lt;&lt; dpower &lt;&lt; " " &lt;&lt; power &lt;&lt; endl;       </span>
00395         <span class="keyword">static</span> <span class="keywordtype">char</span> *torqueCommand = <span class="keyword">new</span> <span class="keywordtype">char</span>[80];
00396         sprintf(torqueCommand, <span class="stringliteral">"T%d\n\n"</span>, power);
00397         pthread_mutex_lock(&amp;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00398         <a class="code" href="common_8c.html#a1" tppabs="http://dsacss.sourceforge.net/common_8c.html#a1">say</a>(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, torqueCommand);
00399         pthread_mutex_unlock(&amp;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00400         <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr10" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr10">LAST_VOLT</a> = volts;
00401         
00402 }
00403 
<a name="l00404"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela6" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela6">00404</a> <span class="keywordtype">void</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela6" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela6">PhysicalMomentumWheel::StartSpeedQuery</a>()
00405 {
00406         pthread_create(&amp;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr19" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr19">m_SpeedThreadID</a>, NULL, <a class="code" href="PhysicalMomentumWheel_8cpp.html#a1" tppabs="http://dsacss.sourceforge.net/PhysicalMomentumWheel_8cpp.html#a1">QueryWheelSpeed</a>, (<span class="keywordtype">void</span>*) <span class="keyword">this</span>);
00407 }
00408 
<a name="l00409"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela8">00409</a> <span class="keywordtype">void</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela8" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela8">PhysicalMomentumWheel::StartTorqueController</a>()
00410 {
00411         pthread_create(&amp;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr20" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr20">m_TorqueThreadID</a>, NULL, <a class="code" href="PhysicalMomentumWheel_8cpp.html#a2" tppabs="http://dsacss.sourceforge.net/PhysicalMomentumWheel_8cpp.html#a2">RunTorqueController</a>, (<span class="keywordtype">void</span>*) <span class="keyword">this</span>);
00412 }
00413 
<a name="l00414"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela7" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela7">00414</a> <span class="keywordtype">void</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela7" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela7">PhysicalMomentumWheel::StopSpeedQuery</a>()
00415 {
00416         pthread_cancel(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr19" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr19">m_SpeedThreadID</a>);
00417         pthread_mutex_unlock(&amp;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00418 }
00419 
<a name="l00420"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela5" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela5">00420</a> <span class="keywordtype">void</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela5" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela5">PhysicalMomentumWheel::StopPID</a>()
00421 {
00422         pthread_cancel(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr18" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr18">m_PIDThreadID</a>);
00423         pthread_mutex_unlock(&amp;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00424 }
00425 
<a name="l00426"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela9" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela9">00426</a> <span class="keywordtype">int</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela9" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela9">PhysicalMomentumWheel::Stop</a>()
00427 {
00428         <span class="keywordtype">int</span> errval;
00429         <span class="keywordtype">int</span> errval2;
00430         <span class="comment">//errval = pthread_cancel(m_PIDThreadID);</span>
00431         errval = pthread_cancel(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr19" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr19">m_SpeedThreadID</a>);
00432         errval2 = pthread_cancel(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr20" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr20">m_TorqueThreadID</a>);
00433         <span class="comment">//cout &lt;&lt; "in Stop, errval2: " &lt;&lt; errval2 &lt;&lt; endl;</span>
00434         pthread_mutex_unlock(&amp;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00435         <span class="comment">//CommandSystemTorque(0.002);</span>
00436         <span class="keywordtype">char</span> *testCommand;
00437         testCommand = <span class="keyword">new</span> <span class="keywordtype">char</span>[80];
00438         sprintf(testCommand, <span class="stringliteral">"Z\n\n"</span>);
00439         <a class="code" href="common_8c.html#a1" tppabs="http://dsacss.sourceforge.net/common_8c.html#a1">say</a>(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, testCommand);
00440         <span class="keywordflow">return</span> 0;
00441 }
00442 
00443 
00444 
00445 
<a name="l00446"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela10" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela10">00446</a> <span class="keywordtype">int</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela10" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela10">PhysicalMomentumWheel::Initialize</a>()
00447 {
00448         pthread_mutex_lock(&amp;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00449         
00450         <span class="keywordtype">char</span> *stringPort;
00451         stringPort = (<span class="keywordtype">char</span> *)malloc(80);
00452         
00453         <span class="keywordflow">if</span> (<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a> &lt; 0) { <span class="comment">// g_fd has NOT been set yet, then init the daisychain</span>
00454           sprintf(stringPort,<span class="stringliteral">"/dev/tty%s"</span>,<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr17" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr17">m_DaisyChainPort</a>.c_str());
00455         
00456 
00457           <a class="code" href="common_8c.html#a0" tppabs="http://dsacss.sourceforge.net/common_8c.html#a0">init_serial</a>(stringPort,B9600,&amp;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>);
00458           <span class="comment">//init_serial(stringPort,B38400,&amp;m_fd);               </span>
00459 
00460           cout &lt;&lt; stringPort &lt;&lt; <span class="stringliteral">"   fd: "</span> &lt;&lt; <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a> &lt;&lt; endl;
00461         
00462           <span class="keywordtype">char</span> *testCommand;
00463           testCommand = <span class="keyword">new</span> <span class="keywordtype">char</span>[80];
00464 
00465           sprintf(testCommand, <span class="stringliteral">"Z\n\n"</span>);
00466           <a class="code" href="common_8c.html#a1" tppabs="http://dsacss.sourceforge.net/common_8c.html#a1">say</a>(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, testCommand);
00467           usleep(1500000);
00468           
00469           sprintf(testCommand, <span class="stringliteral">"ECHO\n\n"</span>);
00470           <a class="code" href="common_8c.html#a1" tppabs="http://dsacss.sourceforge.net/common_8c.html#a1">say</a>(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, testCommand);
00471           usleep(1500000);
00472 
00473           sprintf(testCommand, <span class="stringliteral">"MT\n\n"</span>);
00474           <a class="code" href="common_8c.html#a1" tppabs="http://dsacss.sourceforge.net/common_8c.html#a1">say</a>(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, testCommand);
00475           usleep(1500000);
00476 
00477 <span class="comment">/*</span>
00478 <span class="comment">          sprintf(testCommand, "%c%s\x0D", 0x80, "Z");</span>
00479 <span class="comment">          say(m_fd, testCommand); </span>
00480 <span class="comment">          usleep(500000);</span>
00481 <span class="comment">        </span>
00482 <span class="comment">          sprintf(testCommand, "%c%s\x0D", 0x80, "SADDR1");</span>
00483 <span class="comment">          say(m_fd, testCommand); </span>
00484 <span class="comment">                </span>
00485 <span class="comment"></span>
00486 <span class="comment">          usleep(       500000);</span>
00487 <span class="comment">          sprintf(testCommand, "%c%s\x0D", 0x81, "ECHO");</span>
00488 <span class="comment">          say(m_fd, testCommand); </span>
00489 <span class="comment">          usleep(500000);</span>
00490 <span class="comment"></span>
00491 <span class="comment">          sprintf(testCommand, "%c%s\x0D", 0x81, "SLEEP");</span>
00492 <span class="comment">          say(m_fd, testCommand); </span>
00493 <span class="comment">          usleep(500000);</span>
00494 <span class="comment"></span>
00495 <span class="comment">          sprintf(testCommand, "%c%s\x0D", 0x80, "SADDR2");</span>
00496 <span class="comment">          say(m_fd, testCommand); </span>
00497 <span class="comment">          usleep(500000);</span>
00498 <span class="comment"></span>
00499 <span class="comment">          sprintf(testCommand, "%c%s\x0D", 0x82, "ECHO");</span>
00500 <span class="comment">          say(m_fd, testCommand); </span>
00501 <span class="comment">          usleep(500000);</span>
00502 <span class="comment"></span>
00503 <span class="comment">          sprintf(testCommand, "%c%s\x0D", 0x82, "SLEEP");</span>
00504 <span class="comment">          say(m_fd, testCommand); </span>
00505 <span class="comment">          usleep(500000);</span>
00506 <span class="comment"></span>
00507 <span class="comment">          sprintf(testCommand, "%c%s\x0D", 0x80, "SADDR3");</span>
00508 <span class="comment">          say(m_fd, testCommand); </span>
00509 <span class="comment">          usleep(500000);</span>
00510 <span class="comment"></span>
00511 <span class="comment">          sprintf(testCommand, "%c%s\x0D", 0x83, "ECHO");</span>
00512 <span class="comment">          say(m_fd, testCommand); </span>
00513 <span class="comment">          usleep(500000);</span>
00514 <span class="comment">        </span>
00515 <span class="comment">          sprintf(testCommand, "%c%s\x0D", 0x82, "WAKE");</span>
00516 <span class="comment">          say(m_fd, testCommand); </span>
00517 <span class="comment">          usleep(500000);</span>
00518 <span class="comment"></span>
00519 <span class="comment">          sprintf(testCommand, "%c%s\x0D", 0x81, "WAKE");</span>
00520 <span class="comment">          say(m_fd, testCommand); </span>
00521 <span class="comment">          usleep(500000);</span>
00522 <span class="comment"></span>
00523 <span class="comment">          sprintf(testCommand, "%c%s\x0D", 0x81, "MT");</span>
00524 <span class="comment">          say(m_fd, testCommand); </span>
00525 <span class="comment">          usleep(500000);</span>
00526 <span class="comment"></span>
00527 <span class="comment">          sprintf(testCommand, "%c%s\x0D", 0x82, "MT"); </span>
00528 <span class="comment">          say(m_fd, testCommand); </span>
00529 <span class="comment">          usleep(500000);</span>
00530 <span class="comment"></span>
00531 <span class="comment">          sprintf(testCommand, "%c%s\x0D", 0x83, "MT");</span>
00532 <span class="comment">          say(m_fd, testCommand); </span>
00533 <span class="comment">          usleep(500000);</span>
00534 <span class="comment">*/</span>
00535 
00536         
00537           <span class="keywordtype">char</span>* read = <span class="keyword">new</span> <span class="keywordtype">char</span>[128];
00538           
00539           <a class="code" href="common_8c.html#a2" tppabs="http://dsacss.sourceforge.net/common_8c.html#a2">hear</a>(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, read, 127, 0, 10000, <span class="charliteral">'\r'</span>); 
00540           
00541 
00542           cout &lt;&lt; <span class="stringliteral">"\nWheels Initialized"</span> &lt;&lt; endl;
00543           
00544         } 
00545 
00546         pthread_mutex_unlock(&amp;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00547         
00548           <span class="keywordflow">if</span>(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr16" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr16">BiasFlag</a>){
00549                 <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela4" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela4">CommandWheelSpeed</a>(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr21" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr21">m_BiasSpeed</a>);
00550           }
00551         <span class="keywordflow">return</span> 0;
00552 }
00553 
00554 
<a name="l00555"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela11" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela11">00555</a> <span class="keywordtype">int</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela11" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela11">PhysicalMomentumWheel::Deinitialize</a>() {
00556         cout &lt;&lt; <span class="stringliteral">"Serial Port Closing:\n"</span>;
00557         close(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>);
00558         <span class="keywordflow">return</span> 0;
00559 }
00560 
00562 <span class="comment">// Mutators</span>
00564 <span class="comment"></span>
<a name="l00565"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela12" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela12">00565</a> <span class="keywordtype">void</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela12" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela12">PhysicalMomentumWheel::SetWheelTorqueLimits</a>(<span class="keyword">const</span> <span class="keywordtype">double</span>&amp; minWheelTorque, <span class="keyword">const</span> <span class="keywordtype">double</span>&amp; maxWheelTorque)
00566 {
00567     <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr3" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr3">m_MaxWheelTorque</a> = maxWheelTorque;
00568     <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr4" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr4">m_MinWheelTorque</a> = minWheelTorque;
00569 }
00570 
00571 
<a name="l00572"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela13" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela13">00572</a> <span class="keywordtype">void</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela13" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela13">PhysicalMomentumWheel::SetMaxTorqueStep</a>(<span class="keywordtype">double</span> maxTorqueStep)
00573 {
00574     <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr11" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr11">m_MaxTorqueStep</a> = maxTorqueStep;
00575 }
00576 
<a name="l00577"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela14">00577</a> <span class="keywordtype">void</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela14">PhysicalMomentumWheel::SetWheelAddress</a>(<span class="keywordtype">int</span> WheelAddress)
00578 {
00579         <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr12" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr12">m_WheelAddress</a> = 0x80 + WheelAddress;
00580 }
00581 
<a name="l00582"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela15" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela15">00582</a> <span class="keywordtype">void</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela15" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela15">PhysicalMomentumWheel::SetDaisyChainNumber</a>(<span class="keywordtype">int</span> DaisyChainNumber)
00583 {
00584         <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr13" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr13">m_DaisyChainNumber</a> = DaisyChainNumber;
00585 
00586 }
00587 
<a name="l00588"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela16" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela16">00588</a> <span class="keywordtype">void</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela16" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela16">PhysicalMomentumWheel::SetDaisyChainPort</a>(string DaisyChainPort)
00589 {
00590         <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr17" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr17">m_DaisyChainPort</a> = DaisyChainPort;
00591 }
00592 
<a name="l00593"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela17" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela17">00593</a> <span class="keywordtype">void</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela17" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela17">PhysicalMomentumWheel::SetBiasSpeed</a>(<span class="keywordtype">double</span> BiasSpeed)
00594 {
00595         <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr21" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr21">m_BiasSpeed</a> = BiasSpeed;
00596         <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr16" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr16">BiasFlag</a> = 1;
00597 }
00598 
00600 <span class="comment">// Inspectors</span>
00602 <span class="comment"></span>
<a name="l00603"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela18" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela18">00603</a> <span class="keywordtype">void</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela18" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela18">PhysicalMomentumWheel::GetWheelSpeed</a>(<span class="keywordtype">double</span>&amp; Speed, <span class="keywordtype">double</span>&amp; measTime)
00604 {
00605         pthread_mutex_lock(&amp;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00606         Speed = -<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr0" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr0">m_CurrentWheelSpeed</a>;
00607         measTime = <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr1" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr1">m_VelocityTime</a>;
00608         pthread_mutex_unlock(&amp;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00609 }
00610     
00611 
<a name="l00612"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela19" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela19">00612</a> <span class="keywordtype">double</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela19" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela19">PhysicalMomentumWheel::QueryWheelTorque</a>()
00613 {
00614         pthread_mutex_lock(&amp;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00615         <span class="comment">//Clear Buffer</span>
00616         <span class="keyword">static</span> <span class="keywordtype">char</span> *clear = <span class="keyword">new</span> <span class="keywordtype">char</span>[80];
00617         <a class="code" href="common_8c.html#a2" tppabs="http://dsacss.sourceforge.net/common_8c.html#a2">hear</a>(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, clear, 79, 0, 3333, <span class="charliteral">'\r'</span>);
00618         
00619         <span class="comment">//Send command  </span>
00620         <span class="keyword">static</span> <span class="keywordtype">char</span> *RTCommand = <span class="keyword">new</span> <span class="keywordtype">char</span>[80];
00621         sprintf(RTCommand, <span class="stringliteral">"RT\n\n"</span>);
00622         <a class="code" href="common_8c.html#a1" tppabs="http://dsacss.sourceforge.net/common_8c.html#a1">say</a>(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, RTCommand);
00623 
00624         <span class="keyword">static</span> <span class="keywordtype">char</span> *torqueString = <span class="keyword">new</span> <span class="keywordtype">char</span>[80];
00625         <a class="code" href="common_8c.html#a2" tppabs="http://dsacss.sourceforge.net/common_8c.html#a2">hear</a>(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, torqueString, 20, 0, 10000, <span class="charliteral">'\r'</span>);
00626         
00627         <span class="keywordtype">double</span> Wtorque = atoi(torqueString+3) * 0.0018;<span class="comment">//0.018 N-m per machine torque unit</span>
00628         
00629         <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr5" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr5">m_CurrentWheelTorque</a> = Wtorque;
00630         
00631         <span class="keyword">delete</span> clear;
00632         <span class="keyword">delete</span> RTCommand;
00633         
00634         pthread_mutex_unlock(&amp;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00635         <span class="keywordflow">return</span> Wtorque;
00636 }
00637 
00638 
<a name="l00639"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela20" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela20">00639</a> <span class="keywordtype">void</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela20" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela20">PhysicalMomentumWheel::GetWheelTorqueLimits</a>(<span class="keywordtype">double</span>&amp; minWheelTorque, <span class="keywordtype">double</span>&amp; maxWheelTorque)
00640 {
00641     maxWheelTorque = <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr3" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr3">m_MaxWheelTorque</a>;
00642     minWheelTorque = <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr4" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr4">m_MinWheelTorque</a>;
00643     <span class="keywordflow">return</span>;
00644 }
00645 
00646 
<a name="l00647"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela21" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela21">00647</a> <span class="keywordtype">void</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela21" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela21">PhysicalMomentumWheel::GetMaxTorqueStep</a>(<span class="keywordtype">double</span>&amp; maxTorqueStep)
00648 {
00649     maxTorqueStep = <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr11" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr11">m_MaxTorqueStep</a>;
00650     <span class="keywordflow">return</span>;
00651 }
00652 
<a name="l00653"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela22">00653</a> <span class="keywordtype">int</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela22">PhysicalMomentumWheel::GetWheelFD</a>()
00654 {
00655         <span class="keywordflow">return</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>;
00656 }
00657 
<a name="l00658"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela23" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela23">00658</a> <span class="keywordtype">double</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela23" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela23">PhysicalMomentumWheel::GetAmps</a>()
00659 {
00660         <span class="keywordtype">char</span> *ampString = <span class="keyword">new</span> <span class="keywordtype">char</span>[80];
00661         <span class="keywordtype">double</span> mamps;
00662         <span class="keywordtype">double</span> amps;
00663         <span class="comment">//clear serial port buffer</span>
00664         <span class="keywordtype">char</span>* clear = <span class="keyword">new</span> <span class="keywordtype">char</span>[80];
00665         pthread_mutex_lock(&amp;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00666         <span class="keywordflow">while</span>( !<a class="code" href="common_8c.html#a2" tppabs="http://dsacss.sourceforge.net/common_8c.html#a2">hear</a>(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, clear, 79, 0, 3333, <span class="charliteral">'c'</span>));
00667 
00668         <span class="keywordtype">char</span> *VarCommand = <span class="keyword">new</span> <span class="keywordtype">char</span>[80];
00669         sprintf(VarCommand, <span class="stringliteral">"a=UIA\rRa\n"</span>);
00670         <a class="code" href="common_8c.html#a1" tppabs="http://dsacss.sourceforge.net/common_8c.html#a1">say</a>(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, VarCommand);
00671         usleep(10000);
00672         <a class="code" href="common_8c.html#a2" tppabs="http://dsacss.sourceforge.net/common_8c.html#a2">hear</a>(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, clear, 25, 0, 10000, <span class="charliteral">'\n'</span>);
00673 
00674         <a class="code" href="common_8c.html#a2" tppabs="http://dsacss.sourceforge.net/common_8c.html#a2">hear</a>(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, ampString, 15, 0, 10000, <span class="charliteral">'\r'</span>);
00675         pthread_mutex_unlock(&amp;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00676 
00677         mamps = atoi(ampString);
00678         amps = mamps/100;
00679         
00680         <span class="keywordflow">return</span> amps;
00681 }
00682 
<a name="l00683"></a><a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela24" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela24">00683</a> <span class="keywordtype">double</span> <a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheela24" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheela24">PhysicalMomentumWheel::GetVolts</a>()
00684 {
00685         <span class="keywordtype">char</span> *voltString = <span class="keyword">new</span> <span class="keywordtype">char</span>[80];
00686         <span class="keywordtype">double</span> mvolts;
00687         <span class="keywordtype">double</span> volts;
00688         <span class="comment">//clear serial port buffer</span>
00689         <span class="keywordtype">char</span>* clear = <span class="keyword">new</span> <span class="keywordtype">char</span>[80];
00690         pthread_mutex_lock(&amp;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00691         <span class="keywordflow">while</span>( !<a class="code" href="common_8c.html#a2" tppabs="http://dsacss.sourceforge.net/common_8c.html#a2">hear</a>(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, clear, 79, 0, 3333, <span class="charliteral">'c'</span>));
00692         <span class="keywordtype">char</span> *VarCommand = <span class="keyword">new</span> <span class="keywordtype">char</span>[80];
00693         sprintf(VarCommand, <span class="stringliteral">"b=UJA\rRb\n"</span>);
00694         <a class="code" href="common_8c.html#a1" tppabs="http://dsacss.sourceforge.net/common_8c.html#a1">say</a>(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, VarCommand);
00695         usleep(15000);
00696         <a class="code" href="common_8c.html#a2" tppabs="http://dsacss.sourceforge.net/common_8c.html#a2">hear</a>(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, clear, 25, 0, 10000, <span class="charliteral">'\n'</span>);
00697         <a class="code" href="common_8c.html#a2" tppabs="http://dsacss.sourceforge.net/common_8c.html#a2">hear</a>(<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr14">m_fd</a>, voltString, 15, 0, 10000, <span class="charliteral">'\r'</span>);
00698         pthread_mutex_unlock(&amp;<a class="code" href="classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22" tppabs="http://dsacss.sourceforge.net/classPhysicalMomentumWheel.html#PhysicalMomentumWheelr22">m_Mutex</a>);
00699 
00700         mvolts = atoi(voltString);
00701         volts = mvolts/10;
00702         
00703         <span class="keywordflow">return</span> volts;
00704 }
00705 <span class="comment">// Do not change the comments below - they will be added automatically by CVS</span>
00706 <span class="comment">/*****************************************************************************</span>
00707 <span class="comment">*       $Log: PhysicalMomentumWheel.cpp,v $</span>
00708 <span class="comment">*       Revision 1.33  2004/05/11 20:18:08  bstreetman</span>
00709 <span class="comment">*       Vast improvements to torque controller</span>
00710 <span class="comment">*       </span>
00711 <span class="comment">*       Revision 1.32  2004/04/19 15:00:43  bstreetman</span>
00712 <span class="comment">*       Fixed a config and a shutdown bug</span>
00713 <span class="comment">*       </span>
00714 <span class="comment">*       Revision 1.31  2004/03/18 18:08:17  bstreetman</span>
00715 <span class="comment">*       Further Fixes on the torque controller</span>
00716 <span class="comment">*       </span>
00717 <span class="comment">*       Revision 1.25  2004/03/15 21:58:31  bstreetman</span>
00718 <span class="comment">*       Fixed a multible multi-thread issue.</span>
00719 <span class="comment">*       </span>
00720 <span class="comment">*       Revision 1.24  2004/03/04 23:13:09  bstreetman</span>
00721 <span class="comment">*       Big changes! new functions and functionality.  FUnctions: GetVolts() -- get motor voltage.  GetAmps() -- ge current used by motors.  GetWheelFD() -- get the wheel comm file descriptor.  SetBiasSpeed() -- Set the bias speed used in momentum wheel mode.  SetSystemTorque() -- old style torque function, used mainly by me.  friend RUnTorqueCOntroller() -- new torque controller, runs in a separate thread.  StartTorqueController() -- spawns torque thread, called internally.  Other Changes:  config parameters -- added BiasSpeed confige parameter, sets bias speed and commands the wheel to go there.  SetWheelSpeed() -- no more PID controller, uses a function created by the data i took.  SetWHeelTorque() -- happens in a better way now based on tons of data and hdot = g.</span>
00722 <span class="comment">******************************************************************************/</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jun 15 11:49:54 2004 for DSACSS Operational Code by
<a href="javascript:if(confirm('http://www.doxygen.org/index.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.doxygen.org/index.html'" tppabs="http://www.doxygen.org/index.html">
<img src="doxygen.png" tppabs="http://dsacss.sourceforge.net/doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
