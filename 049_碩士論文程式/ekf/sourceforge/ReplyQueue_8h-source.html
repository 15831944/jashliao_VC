<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DSACSS Operational Code: ReplyQueue.h Source File</title>
<link href="doxygen.css" tppabs="http://dsacss.sourceforge.net/doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<h1>ReplyQueue.h</h1><a href="ReplyQueue_8h.html" tppabs="http://dsacss.sourceforge.net/ReplyQueue_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 
00008 <span class="preprocessor">#ifndef REPLY_QUEUE_H</span>
00009 <span class="preprocessor"></span><span class="preprocessor">#define REPLY_QUEUE_H</span>
00010 <span class="preprocessor"></span>
00011 <span class="preprocessor">#include "ace/Log_Msg.h"</span>
00012 <span class="preprocessor">#include "ace/Synch_T.h"</span>
00013 
00014 <span class="preprocessor">#include &lt;list&gt;</span>
00015 
00016 <span class="comment">//</span>
00017 <span class="comment">// Forward declaration of the PendingReply class. This forward declaration</span>
00018 <span class="comment">// is needed for the declaration of ReplyQueue.</span>
00019 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T, ACE_SYNCH_DECL&gt;
00020 <span class="keyword">class </span><a class="code" href="classPendingReply.html" tppabs="http://dsacss.sourceforge.net/classPendingReply.html">PendingReply</a>;
00021 
00022 <span class="comment">//</span>
00023 <span class="comment">// This class encapsulates a synchronized queue through which solicited</span>
00024 <span class="comment">// data (replies) are passed between threads.</span>
00025 <span class="comment">//</span>
00026 <span class="comment">// Command threads follow this sequence of execution:</span>
00027 <span class="comment">//   (1) Acquire the queue's mutex exactly one time. Mutex acquisition must</span>
00028 <span class="comment">//       NOT be recursive. (VERY IMPORTANT).</span>
00029 <span class="comment">//   (2) Schedule some sort of input from another thread</span>
00030 <span class="comment">//   (3) Call GetReply(), which will block until error or the result is ready</span>
00031 <span class="comment">//   (4) Release the queue's mutex</span>
00032 <span class="comment">//</span>
00033 <span class="comment">// Reply threads follow this sequence of execution:</span>
00034 <span class="comment">//   (1) Generate data or read data from the network</span>
00035 <span class="comment">//   (2) The thread may or may not acquire the queue's mutex. In this thread</span>
00036 <span class="comment">//       acquisition may be recursive if the operating system supports it.</span>
00037 <span class="comment">//       In any event, SetReply() will acquire the mutex as part of its</span>
00038 <span class="comment">//       operation.</span>
00039 <span class="comment">//   (3) Call SetReply() to pass the data to the command thread(s).</span>
00040 <span class="comment">//   (4) Release the queue's mutex if the thread had previously acquired it.</span>
00041 <span class="comment">//</span>
00042 <span class="comment">// Multiple threads can wait in GetReply() and will receive replies</span>
00043 <span class="comment">// in FIFO order. This is possible because GetReply() temporarily</span>
00044 <span class="comment">// relinquishes the mutex as part of its operation.</span>
00045 <span class="comment">//</span>
00046 <span class="comment">// If the waiter times out before data is received, it is removed from</span>
00047 <span class="comment">// the queue.  Note that this could be problematic if a reply arrives</span>
00048 <span class="comment">// after the deadline.  Waiters should set a deadline only if they are</span>
00049 <span class="comment">// certain that missing a deadline means no reply will be coming.</span>
00050 <span class="comment">//</span>
00051 <span class="comment">// Any reply type for which the assignment operator is defined is allowed.</span>
00052 <span class="comment">// Reply types that don't support the assignment operator may be used</span>
00053 <span class="comment">// by specializing the Assign() method for your type.</span>
00054 <span class="comment">//</span>
00055 <span class="comment">// Examples of how to instantiate one of these queues:</span>
00056 <span class="comment">//</span>
00057 <span class="comment">//    A synchronized queue with string reply types:</span>
00058 <span class="comment">//       ReplyQueue&lt;std::string, ACE_MT_SYNCH&gt; foo;</span>
00059 <span class="comment">//</span>
00060 <span class="comment">//    An unsynchronized queue with integer reply types:</span>
00061 <span class="comment">//       ReplyQueue&lt;int, ACE_NULL_SYNCH&gt;       foo;</span>
00062 <span class="comment">//</span>
00063 <span class="comment">//    A queue with system-default synchronization and unspecified reply type:</span>
00064 <span class="comment">//       ReplyQueue&lt;void *, ACE_SYNCH&gt;         foo;</span>
00065 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T, ACE_SYNCH_DECL&gt;
<a name="l00066"></a><a class="code" href="classReplyQueue.html" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html">00066</a> <span class="keyword">class </span><a class="code" href="classReplyQueue.html" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html">ReplyQueue</a>
00067 {
00068 <span class="keyword">public</span>:
00069         <span class="comment">//</span>
00070         <span class="comment">// Constructs a reply queue with the specified mutex.</span>
00071         <a class="code" href="classReplyQueue.html#ReplyQueuea0" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea0">ReplyQueue</a>(ACE_SYNCH_MUTEX_T &amp;myMutex);
00072         
00073         <span class="comment">//</span>
00074         <span class="comment">// Destroys a reply queue. It calls Close() to ensure all waiters</span>
00075         <span class="comment">// are released.</span>
00076         <a class="code" href="classReplyQueue.html#ReplyQueuea1" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea1">~ReplyQueue</a>();
00077 
00078         <span class="comment">//</span>
00079         <span class="comment">// Closes the queue. The queue is cleared and all waiters are freed</span>
00080         <span class="comment">// with an error code. Any subsequent calls to GetReply() or SetReply()</span>
00081         <span class="comment">// will fail as well.</span>
00082         <span class="comment">//</span>
00083         <span class="comment">// If acquireMutex is false, then the method will not acquire its own</span>
00084         <span class="comment">// mutex. Do this only if the mutex is already externally acquired.</span>
00085         <span class="comment">//</span>
00086         <span class="comment">// Returns 0 on success or -1 if already closed.</span>
00087         <span class="keywordtype">int</span> <a class="code" href="classReplyQueue.html#ReplyQueuea2" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea2">Close</a>(<span class="keywordtype">bool</span> acquireMutex=<span class="keyword">true</span>);
00088 
00089         <span class="comment">//</span>
00090         <span class="comment">// Closes the queue. The queue is cleared and all waiters are freed</span>
00091         <span class="comment">// with an error code. Any subsequent calls to GetReply() or SetReply()</span>
00092         <span class="comment">// will fail as well.</span>
00093         <span class="comment">//</span>
00094         <span class="comment">// If acquireMutex is false, then the method will not acquire its own</span>
00095         <span class="comment">// mutex. Do this only if the mutex is already externally acquired.</span>
00096         <span class="comment">//</span>
00097         <span class="comment">// Returns 0 on success or -1 if already closed.</span>
00098         <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="classReplyQueue.html#ReplyQueuea3" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea3">Close_i</a>();
00099 
00100         <span class="comment">//</span>
00101         <span class="comment">// Indicates whether there are any threads currently waiting for a reply.</span>
00102         <span class="comment">//</span>
00103         <span class="comment">// If acquireMutex is false, then the method will not acquire its own</span>
00104         <span class="comment">// mutex. Do this only if the mutex is already externally acquired.</span>
00105         <span class="comment">//</span>
00106         <span class="comment">// Returns true if there are waiters, false otherwise.</span>
00107         <span class="keywordtype">bool</span> <a class="code" href="classReplyQueue.html#ReplyQueuea4" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea4">IsEmpty</a>(<span class="keywordtype">bool</span> acquireMutex=<span class="keyword">false</span>);
00108 
00109         <span class="comment">//</span>
00110         <span class="comment">// Indicates whether there are any threads currently waiting for a reply.</span>
00111         <span class="comment">//</span>
00112         <span class="comment">// This method makes no attempt to acquire its own mutex. The mutex should</span>
00113         <span class="comment">// be externally acquired before calling this method.</span>
00114         <span class="comment">//</span>
00115         <span class="comment">// Returns true if there are waiters, false otherwise.</span>
00116         <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="classReplyQueue.html#ReplyQueuea5" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea5">IsEmpty_i</a>();
00117         
00118         <span class="comment">//</span>
00119         <span class="comment">// Blocks the calling thread until the deadline expires or</span>
00120         <span class="comment">// until a reply is sent received from the queue.</span>
00121         <span class="comment">// If a reply is enqueued before the deadline, its value</span>
00122         <span class="comment">// will be assigned to the "theReply" argument.</span>
00123         <span class="comment">// Note that the deadline argument is an absolute time -- not a relative</span>
00124         <span class="comment">// one. For example, if you want a 10 second timeout, you should compute</span>
00125         <span class="comment">// your deadline by calling ACE_OS::gettimeofday() and adding 10 seconds</span>
00126         <span class="comment">// to the result.</span>
00127         <span class="comment">// Passing a NULL pointer in the deadline argument means "wait forever".</span>
00128         <span class="comment">//</span>
00129         <span class="comment">// NOTE: You must acquire the queue's mutex exactly once when calling</span>
00130         <span class="comment">// this method. Acquiring the mutex more than once (i.e. recursively)</span>
00131         <span class="comment">// will result in a deadlock!</span>
00132         <span class="comment">//</span>
00133         <span class="comment">// Do not acquire the mutex externally before calling this method with</span>
00134         <span class="comment">// acquireMutex==true.</span>
00135         <span class="comment">//</span>
00136         <span class="comment">// If acquireMutex is false, then the method will not acquire its own</span>
00137         <span class="comment">// mutex. Do this only if the mutex is already externally acquired once.</span>
00138         <span class="comment">//</span>
00139         <span class="comment">// Returns 0 if the reply was successfully retrieved, -1 otherwise.</span>
00140         <span class="keywordtype">int</span> <a class="code" href="classReplyQueue.html#ReplyQueuea6" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea6">GetReply</a>(T &amp;theReply, <span class="keyword">const</span> ACE_Time_Value *deadline, <span class="keywordtype">bool</span> acquireMutex=<span class="keyword">false</span>);
00141         
00142         <span class="comment">//</span>
00143         <span class="comment">// Blocks the calling thread until the deadline expires or</span>
00144         <span class="comment">// until a reply is sent received from the queue.</span>
00145         <span class="comment">// If a reply is enqueued before the deadline, its value</span>
00146         <span class="comment">// will be assigned to the "theReply" argument.</span>
00147         <span class="comment">// Note that the deadline argument is an absolute time -- not a relative</span>
00148         <span class="comment">// one. For example, if you want a 10 second timeout, you should compute</span>
00149         <span class="comment">// your deadline by calling ACE_OS::gettimeofday() and adding 10 seconds</span>
00150         <span class="comment">// to the result.</span>
00151         <span class="comment">// Passing a NULL pointer in the deadline argument means "wait forever".</span>
00152         <span class="comment">//</span>
00153         <span class="comment">// NOTE: You must acquire the queue's mutex exactly once before calling</span>
00154         <span class="comment">// this method. Acquiring the mutex more than once (i.e. recursively)</span>
00155         <span class="comment">// will result in a deadlock! If you don't acquire the mutex before</span>
00156         <span class="comment">// calling, the method will fail.</span>
00157         <span class="comment">//</span>
00158         <span class="comment">// This method makes no attempt to acquire its own mutex. The mutex should</span>
00159         <span class="comment">// be externally acquired once before calling this method.</span>
00160         <span class="comment">//</span>
00161         <span class="comment">// Returns 0 if the reply was successfully retrieved, -1 otherwise.</span>
00162         <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="classReplyQueue.html#ReplyQueuea7" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea7">GetReply_i</a>(T &amp;theReply, <span class="keyword">const</span> ACE_Time_Value *deadline);
00163 
00164         <span class="comment">//</span>
00165         <span class="comment">// Blocks the calling thread until a reply is sent received from the queue.</span>
00166         <span class="comment">// The reply is assigned to the "theReply" argument.</span>
00167         <span class="comment">//</span>
00168         <span class="comment">// NOTE: You must acquire the queue's mutex exactly once before calling</span>
00169         <span class="comment">// this method. Acquiring the mutex more than once (i.e. recursively)</span>
00170         <span class="comment">// will result in a deadlock! If you don't acquire the mutex before</span>
00171         <span class="comment">// calling, the method will fail.</span>
00172         <span class="comment">//</span>
00173         <span class="comment">// If acquireMutex is false, then the method will not acquire its own</span>
00174         <span class="comment">// mutex. Do this only if the mutex is already externally acquired.</span>
00175         <span class="comment">//</span>
00176         <span class="comment">// Returns 0 if the reply was successfully retrieved, -1 otherwise.</span>
00177         <span class="keywordtype">int</span> <a class="code" href="classReplyQueue.html#ReplyQueuea6" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea6">GetReply</a>(T &amp;theReply, <span class="keywordtype">bool</span> acquireMutex=<span class="keyword">false</span>);
00178 
00179 
00180         <span class="comment">//</span>
00181         <span class="comment">// Blocks the calling thread until a reply is sent received from the queue.</span>
00182         <span class="comment">// The reply is assigned to the "theReply" argument.</span>
00183         <span class="comment">//</span>
00184         <span class="comment">// NOTE: You must acquire the queue's mutex exactly once before calling</span>
00185         <span class="comment">// this method. Acquiring the mutex more than once (i.e. recursively)</span>
00186         <span class="comment">// will result in a deadlock! If you don't acquire the mutex before</span>
00187         <span class="comment">// calling, the method will fail.</span>
00188         <span class="comment">//</span>
00189         <span class="comment">// This method makes no attempt to acquire its own mutex. The mutex should</span>
00190         <span class="comment">// be externally acquired before calling this method.</span>
00191         <span class="comment">//</span>
00192         <span class="comment">// Returns 0 if the reply was successfully retrieved, -1 otherwise.</span>
00193         <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="classReplyQueue.html#ReplyQueuea7" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea7">GetReply_i</a>(T &amp;theReply);
00194 
00195 
00196         <span class="comment">//</span>
00197         <span class="comment">// Sends a reply to the next waiter in GetReply().</span>
00198         <span class="comment">// This method should only be called when a GetReply() call is pending.</span>
00199         <span class="comment">// It will free the next GetReply() waiter and give them the "theReply"</span>
00200         <span class="comment">// argument.</span>
00201         <span class="comment">//</span>
00202         <span class="comment">// If acquireMutex is false, then the method will not acquire its own</span>
00203         <span class="comment">// mutex. Do this only if the mutex is already externally acquired.</span>
00204         <span class="comment">//</span>
00205         <span class="comment">// Returns 0 on success and -1 on failure.</span>
00206         <span class="keywordtype">int</span> <a class="code" href="classReplyQueue.html#ReplyQueuea10" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea10">SetReply</a>(T &amp;theReply, <span class="keywordtype">bool</span> acquireMutex=<span class="keyword">true</span>);
00207 
00208         <span class="comment">//</span>
00209         <span class="comment">// Sends a reply to the next waiter in GetReply().</span>
00210         <span class="comment">// This method should only be called when a GetReply() call is pending.</span>
00211         <span class="comment">// It will free the next GetReply() waiter and give them the "theReply"</span>
00212         <span class="comment">// argument.</span>
00213         <span class="comment">//</span>
00214         <span class="comment">// This method makes no attempt to acquire its own mutex. The mutex should</span>
00215         <span class="comment">// be externally acquired before calling this method.</span>
00216         <span class="comment">//</span>
00217         <span class="comment">// Returns 0 on success and -1 on failure.</span>
00218         <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="classReplyQueue.html#ReplyQueuea11" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea11">SetReply_i</a>(T &amp;theReply);
00219 
00220         <span class="comment">//</span>
00221         <span class="comment">// Assigns the value of "from" to the object "to".</span>
00222         <span class="comment">// Returns a reference to "to".</span>
00223         <span class="comment">// This method exists solely to support partial template</span>
00224         <span class="comment">// specialization.</span>
<a name="l00225"></a><a class="code" href="classReplyQueue.html#ReplyQueuea12" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea12">00225</a>         <span class="keyword">inline</span> T &amp; <a class="code" href="classReplyQueue.html#ReplyQueuea12" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea12">Assign_i</a>(T &amp; from, T &amp; to) { <span class="keywordflow">return</span> to = from; }
00226 
00227         <span class="comment">//</span>
00228         <span class="comment">// Returns a reference to this queue's mutex. Use this method</span>
00229         <span class="comment">// if you wish to synchonize other objects with this queue.</span>
<a name="l00230"></a><a class="code" href="classReplyQueue.html#ReplyQueuea13" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea13">00230</a>         <span class="keyword">inline</span> ACE_SYNCH_MUTEX_T &amp; <a class="code" href="classReplyQueue.html#ReplyQueuea13" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea13">GetMutex</a>() { <span class="keywordflow">return</span> <a class="code" href="classReplyQueue.html#ReplyQueuep1" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep1">m_replyQueueMutex</a>; }
00231         
00232 <span class="keyword">protected</span>:
00233         
00234         <span class="comment">//</span>
00235         <span class="comment">// The PendingReply type corresponding to this template</span>
00236         <span class="comment">// instantiation.</span>
<a name="l00237"></a><a class="code" href="classReplyQueue.html#ReplyQueuex0" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuex0">00237</a>         <span class="keyword">typedef</span> <a class="code" href="classPendingReply.html" tppabs="http://dsacss.sourceforge.net/classPendingReply.html">PendingReply&lt;T, ACE_SYNCH_USE&gt;</a>  <a class="code" href="classPendingReply.html" tppabs="http://dsacss.sourceforge.net/classPendingReply.html">PENDING_REPLY</a>;
00238         <span class="comment">//</span>
00239         <span class="comment">// The data type of the queue holding PendingReply's.</span>
<a name="l00240"></a><a class="code" href="classReplyQueue.html#ReplyQueuex1" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuex1">00240</a>         <span class="keyword">typedef</span> std::list&lt;PENDING_REPLY *&gt;              <a class="code" href="classReplyQueue.html#ReplyQueuex1" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuex1">QUEUE_TYPE</a>;
00241         
00242         <span class="comment">//</span>
00243         <span class="comment">// The queue that holds PendingReply's.</span>
<a name="l00244"></a><a class="code" href="classReplyQueue.html#ReplyQueuep0" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep0">00244</a>         <a class="code" href="classReplyQueue.html#ReplyQueuex1" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuex1">QUEUE_TYPE</a>                                                              <a class="code" href="classReplyQueue.html#ReplyQueuep0" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep0">m_replyQueue</a>;
00245 
00246         <span class="comment">//</span>
00247         <span class="comment">// The mutex type that synchronizes this queue. If the synch</span>
00248         <span class="comment">// type is ACE_NULL_SYNCH, then this mutex is a functionless</span>
00249         <span class="comment">// dummy object.</span>
<a name="l00250"></a><a class="code" href="classReplyQueue.html#ReplyQueuep1" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep1">00250</a>         ACE_SYNCH_MUTEX_T &amp;                                             <a class="code" href="classReplyQueue.html#ReplyQueuep1" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep1">m_replyQueueMutex</a>;
00251 
00252         <span class="comment">//</span>
00253         <span class="comment">// A flag that indicates whether the queue is closed. </span>
<a name="l00254"></a><a class="code" href="classReplyQueue.html#ReplyQueuep2" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep2">00254</a>         <span class="keywordtype">bool</span>                                                                    <a class="code" href="classReplyQueue.html#ReplyQueuep2" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep2">m_closed</a>;
00255 };
00256 
00257 
00258 <span class="comment">//</span>
00259 <span class="comment">// This class encapsulates a reply that is waiting in a ReplyQueue.</span>
00260 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T, ACE_SYNCH_DECL&gt;
<a name="l00261"></a><a class="code" href="classPendingReply.html" tppabs="http://dsacss.sourceforge.net/classPendingReply.html">00261</a> <span class="keyword">class </span><a class="code" href="classPendingReply.html" tppabs="http://dsacss.sourceforge.net/classPendingReply.html">PendingReply</a>
00262 {
00263 <span class="keyword">public</span>:
00264         <span class="comment">//</span>
00265         <span class="comment">// The ReplyQueue type that holds this PendingReply type.</span>
<a name="l00266"></a><a class="code" href="classPendingReply.html#PendingReplyw0" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplyw0">00266</a>         <span class="keyword">typedef</span> <a class="code" href="classReplyQueue.html" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html">ReplyQueue&lt;T, ACE_SYNCH_USE&gt;</a> <a class="code" href="classReplyQueue.html" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html">REPLY_QUEUE</a>;
00267 
00268         <span class="comment">//</span>
00269         <span class="comment">// The ReplyQueue, being a friend of this class, is allowed</span>
00270         <span class="comment">// to access this class's protected and private members.</span>
00271         <span class="comment">// We don't use the typedef in the friend declaration</span>
00272         <span class="comment">// because some (namely MSVC++) compilers can't handle it.</span>
<a name="l00273"></a><a class="code" href="classPendingReply.html#PendingReplyn0" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplyn0">00273</a>         <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classReplyQueue.html" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html">ReplyQueue</a>&lt;T, ACE_SYNCH_USE&gt;;
00274         
00275         <span class="comment">//</span>
00276         <span class="comment">// Constructs a PendingReply. The "theReply" argument is a reference to</span>
00277         <span class="comment">// the object that will be set by PendingQueue::SetReply().  The "myMutex"</span>
00278         <span class="comment">// argument is a reference to the PendingQueue's mutex.</span>
<a name="l00279"></a><a class="code" href="classPendingReply.html#PendingReplya0" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplya0">00279</a>         <a class="code" href="classPendingReply.html#PendingReplya0" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplya0">PendingReply</a>(T &amp; theReply, ACE_SYNCH_MUTEX_T &amp;myMutex)
00280                 : <a class="code" href="classPendingReply.html#PendingReplyp0" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplyp0">m_condition</a>(myMutex), <a class="code" href="classPendingReply.html#PendingReplyp1" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplyp1">m_isEnqueued</a>(false), <a class="code" href="classPendingReply.html#PendingReplyp2" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplyp2">m_theReply</a>(theReply) {}
00281 
00282         <span class="comment">//</span>
00283         <span class="comment">// Destroys a PendingReply.</span>
<a name="l00284"></a><a class="code" href="classPendingReply.html#PendingReplya1" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplya1">00284</a>         <a class="code" href="classPendingReply.html#PendingReplya1" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplya1">~PendingReply</a>() {}
00285         
00286 <span class="keyword">protected</span>:
00287         <span class="comment">//</span>
00288         <span class="comment">// The condition variable used to signal PendingQueue::GetReply() </span>
00289         <span class="comment">// on success or failure.</span>
<a name="l00290"></a><a class="code" href="classPendingReply.html#PendingReplyp0" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplyp0">00290</a>         ACE_SYNCH_CONDITION_T   <a class="code" href="classPendingReply.html#PendingReplyp0" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplyp0">m_condition</a>;
00291 
00292         <span class="comment">//</span>
00293         <span class="comment">// Indicates whether this object is currently enqueued in the PendingQueue.</span>
00294         <span class="comment">// This is important when determining the validity of PendingQueue's</span>
00295         <span class="comment">// internal iterators.</span>
<a name="l00296"></a><a class="code" href="classPendingReply.html#PendingReplyp1" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplyp1">00296</a>         <span class="keywordtype">bool</span>                                    <a class="code" href="classPendingReply.html#PendingReplyp1" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplyp1">m_isEnqueued</a>;
00297 
00298         <span class="comment">//</span>
00299         <span class="comment">// A reference to the object that will be set by a successful call to</span>
00300         <span class="comment">// PendingQueue::SetReply().  The object is provided by the caller of</span>
00301         <span class="comment">// PendingQueue::GetReply().</span>
<a name="l00302"></a><a class="code" href="classPendingReply.html#PendingReplyp2" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplyp2">00302</a>         T &amp;                                             <a class="code" href="classPendingReply.html#PendingReplyp2" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplyp2">m_theReply</a>;
00303 };
00304 
00305 
00306 
00307 
00308 
00309 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T, ACE_SYNCH_DECL&gt;
<a name="l00310"></a><a class="code" href="classReplyQueue.html#ReplyQueuea0" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea0">00310</a> <a class="code" href="classReplyQueue.html#ReplyQueuea0" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea0">ReplyQueue&lt;T, ACE_SYNCH_USE&gt;::ReplyQueue</a>(ACE_SYNCH_MUTEX_T &amp;myMutex)
00311                 : m_replyQueueMutex(myMutex),
00312                   m_closed(false)
00313 {
00314 }
00315 
00316 
00317 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T, ACE_SYNCH_DECL&gt;
<a name="l00318"></a><a class="code" href="classReplyQueue.html#ReplyQueuea1" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea1">00318</a> <a class="code" href="classReplyQueue.html#ReplyQueuea1" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea1">ReplyQueue&lt;T, ACE_SYNCH_USE&gt;::~ReplyQueue</a>()
00319 {
00320         <a class="code" href="classReplyQueue.html#ReplyQueuea3" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea3">Close_i</a>();
00321 }
00322 
00323 
00324 
00325 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T, ACE_SYNCH_DECL&gt;
<a name="l00326"></a><a class="code" href="classReplyQueue.html#ReplyQueuea2" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea2">00326</a> <span class="keywordtype">int</span> <a class="code" href="classReplyQueue.html#ReplyQueuea2" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea2">ReplyQueue&lt;T, ACE_SYNCH_USE&gt;::Close</a>(<span class="keywordtype">bool</span> acquireMutex)
00327 {
00328         <span class="keywordflow">if</span> (acquireMutex)
00329         {
00330                 ACE_Guard&lt;ACE_SYNCH_MUTEX_T&gt; g(<a class="code" href="classReplyQueue.html#ReplyQueuep1" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep1">m_replyQueueMutex</a>);
00331 
00332                 <span class="keywordflow">return</span> <a class="code" href="classReplyQueue.html#ReplyQueuea3" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea3">Close_i</a>();
00333         }
00334 
00335         <span class="keywordflow">return</span> <a class="code" href="classReplyQueue.html#ReplyQueuea3" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea3">Close_i</a>();
00336 }
00337 
00338 
00339         
00340 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T, ACE_SYNCH_DECL&gt;
<a name="l00341"></a><a class="code" href="classReplyQueue.html#ReplyQueuea3" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea3">00341</a> <span class="keywordtype">int</span> <a class="code" href="classReplyQueue.html#ReplyQueuea3" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea3">ReplyQueue&lt;T, ACE_SYNCH_USE&gt;::Close_i</a>()
00342 {
00343         <span class="comment">//</span>
00344         <span class="comment">// Double-check idiom. Ensure that the queue wasn't closed</span>
00345         <span class="comment">// while we were waiting to acquire the mutex.</span>
00346         <span class="keywordflow">if</span> (<a class="code" href="classReplyQueue.html#ReplyQueuep2" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep2">m_closed</a>)
00347                 <span class="keywordflow">return</span> -1;
00348                 
00349         <span class="comment">//</span>
00350         <span class="comment">// Mark the queue as closed.</span>
00351         <a class="code" href="classReplyQueue.html#ReplyQueuep2" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep2">m_closed</a> = <span class="keyword">true</span>;
00352                 
00353         <span class="comment">//</span>
00354         <span class="comment">// Iterate through the queue and release all the</span>
00355         <span class="comment">// waiters. They'll see the queue is closed and return an error.</span>
00356         <span class="keyword">typename</span> QUEUE_TYPE::iterator   i = <a class="code" href="classReplyQueue.html#ReplyQueuep0" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep0">m_replyQueue</a>.begin(),
00357                 end = <a class="code" href="classReplyQueue.html#ReplyQueuep0" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep0">m_replyQueue</a>.end();
00358         
00359         <span class="comment">//</span>
00360         <span class="comment">// A place to hold the results of system calls.</span>
00361         <span class="keywordtype">int</span> status = 0;
00362 
00363         <span class="comment">//</span>
00364         <span class="comment">// Mark all the PendingReplies as no longer enqueued and signal</span>
00365         <span class="comment">// all the waiters.  The "status" variable collects any errors.</span>
00366         <span class="keywordflow">for</span> (; i != end; ++i)
00367         {
00368                 (*i)-&gt;m_isEnqueued = <span class="keyword">false</span>;
00369                 status |= (*i)-&gt;m_condition.broadcast();
00370         }
00371                 
00372         <span class="comment">//</span>
00373         <span class="comment">// Clear out the queue. Its contents are now invalid.</span>
00374         <a class="code" href="classReplyQueue.html#ReplyQueuep0" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep0">m_replyQueue</a>.clear();
00375 
00376         <span class="comment">//</span>
00377         <span class="comment">// Return 0 on success or -1 if signaling any waiters failed.</span>
00378         <span class="keywordflow">return</span> status;
00379 }
00380 
00381 
00382 
00383 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T, ACE_SYNCH_DECL&gt;
<a name="l00384"></a><a class="code" href="classReplyQueue.html#ReplyQueuea4" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea4">00384</a> <span class="keywordtype">bool</span> <a class="code" href="classReplyQueue.html#ReplyQueuea4" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea4">ReplyQueue&lt;T, ACE_SYNCH_USE&gt;::IsEmpty</a>(<span class="keywordtype">bool</span> acquireMutex)
00385 {
00386         <span class="keywordflow">if</span> (acquireMutex)
00387         {
00388                 <span class="comment">//</span>
00389                 <span class="comment">// Don't bother acquiring the mutex if the queue is already closed. Just </span>
00390                 <span class="comment">// report that it's empty (which it must be).</span>
00391                 <span class="keywordflow">if</span> (<a class="code" href="classReplyQueue.html#ReplyQueuep2" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep2">m_closed</a>)
00392                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00393 
00394                 ACE_Guard&lt;ACE_SYNCH_MUTEX_T&gt; g(<a class="code" href="classReplyQueue.html#ReplyQueuep1" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep1">m_replyQueueMutex</a>);
00395 
00396                 <span class="keywordflow">return</span> <a class="code" href="classReplyQueue.html#ReplyQueuea5" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea5">IsEmpty_i</a>();
00397         }
00398 
00399         <span class="keywordflow">return</span> this-&gt;<a class="code" href="classReplyQueue.html#ReplyQueuea5" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea5">IsEmpty_i</a>();
00400         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00401 }
00402 
00403 
00404 
00405 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T, ACE_SYNCH_DECL&gt;
<a name="l00406"></a><a class="code" href="classReplyQueue.html#ReplyQueuea5" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea5">00406</a> <span class="keywordtype">bool</span> <a class="code" href="classReplyQueue.html#ReplyQueuea5" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea5">ReplyQueue&lt;T, ACE_SYNCH_USE&gt;::IsEmpty_i</a>()
00407 {
00408         <span class="keywordflow">return</span> <a class="code" href="classReplyQueue.html#ReplyQueuep0" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep0">m_replyQueue</a>.empty();
00409 }
00410 
00411 
00412 
00413 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T, ACE_SYNCH_DECL&gt;
<a name="l00414"></a><a class="code" href="classReplyQueue.html#ReplyQueuea6" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea6">00414</a> <span class="keywordtype">int</span> <a class="code" href="classReplyQueue.html#ReplyQueuea6" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea6">ReplyQueue&lt;T, ACE_SYNCH_USE&gt;::GetReply</a>(T &amp;theReply, <span class="keyword">const</span> ACE_Time_Value *deadline, <span class="keywordtype">bool</span> acquireMutex)
00415 {
00416         <span class="keywordflow">if</span> (acquireMutex)
00417         {
00418                 <span class="comment">//</span>
00419                 <span class="comment">// Don't bother acquiring the mutex if the queue is already closed. Just </span>
00420                 <span class="comment">// report failure.</span>
00421                 <span class="keywordflow">if</span> (<a class="code" href="classReplyQueue.html#ReplyQueuep2" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep2">m_closed</a>)
00422                         <span class="keywordflow">return</span> -1;
00423 
00424                 ACE_Guard&lt;ACE_SYNCH_MUTEX_T&gt; g(<a class="code" href="classReplyQueue.html#ReplyQueuep1" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep1">m_replyQueueMutex</a>);
00425 
00426                 <span class="keywordflow">return</span> <a class="code" href="classReplyQueue.html#ReplyQueuea7" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea7">GetReply_i</a>(theReply, deadline);
00427         }
00428 
00429         <span class="keywordflow">return</span> <a class="code" href="classReplyQueue.html#ReplyQueuea7" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea7">GetReply_i</a>(theReply, deadline);
00430 }
00431 
00432 
00433 
00434 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T, ACE_SYNCH_DECL&gt;
<a name="l00435"></a><a class="code" href="classReplyQueue.html#ReplyQueuea7" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea7">00435</a> <span class="keywordtype">int</span> <a class="code" href="classReplyQueue.html#ReplyQueuea7" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea7">ReplyQueue&lt;T, ACE_SYNCH_USE&gt;::GetReply_i</a>(T &amp;theReply, <span class="keyword">const</span> ACE_Time_Value *deadline)
00436 {
00437         <span class="comment">//</span>
00438         <span class="comment">// Check to make sure the queue isn't closed already.</span>
00439         <span class="keywordflow">if</span> (<a class="code" href="classReplyQueue.html#ReplyQueuep2" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep2">m_closed</a>)
00440         {
00441                 ACE_ERROR_RETURN((LM_ERROR,
00442                         <span class="stringliteral">"(%N:%l) Attempt to get a reply from a closed queue.\n"</span>),
00443                         -1);
00444         }
00445 
00446         <span class="comment">//</span>
00447         <span class="comment">// Construct a PendingReply so we can put it in the queue.</span>
00448         <span class="comment">// Do this before acquiring the mutex so we don't make other threads</span>
00449         <span class="comment">// wait through construction.</span>
00450         <a class="code" href="classPendingReply.html" tppabs="http://dsacss.sourceforge.net/classPendingReply.html">PENDING_REPLY</a> replyObj(theReply, <a class="code" href="classReplyQueue.html#ReplyQueuep1" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep1">m_replyQueueMutex</a>);
00451         
00452         <span class="comment">//</span>
00453         <span class="comment">// Mark the PendingReply as residing on the queue, and then add it to</span>
00454         <span class="comment">// the queue.</span>
00455         replyObj.<a class="code" href="classPendingReply.html#PendingReplyp1" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplyp1">m_isEnqueued</a> = <span class="keyword">true</span>;
00456         <span class="keyword">typename</span> QUEUE_TYPE::iterator it = <a class="code" href="classReplyQueue.html#ReplyQueuep0" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep0">m_replyQueue</a>.insert(<a class="code" href="classReplyQueue.html#ReplyQueuep0" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep0">m_replyQueue</a>.end(), &amp;replyObj);
00457         
00458         <span class="comment">//</span>
00459         <span class="comment">// Wait until signaled by a SetReply() call or until the deadline passes.</span>
00460         <span class="comment">// Note that m_replyQueueMutex is relinquished during the time we are </span>
00461         <span class="comment">// waiting.  Its re-acquired on return from wait().</span>
00462         <span class="keywordtype">int</span> status = replyObj.<a class="code" href="classPendingReply.html#PendingReplyp0" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplyp0">m_condition</a>.wait(deadline);
00463         
00464         <span class="comment">//</span>
00465         <span class="comment">// If m_isEnqueued is still set, then remove the object from the queue</span>
00466         <span class="comment">// now. Since the queue is an STL list, the previously-recorded iterator</span>
00467         <span class="comment">// is still valid.</span>
00468         <span class="keywordflow">if</span> (replyObj.<a class="code" href="classPendingReply.html#PendingReplyp1" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplyp1">m_isEnqueued</a>)
00469         {
00470                 <a class="code" href="classReplyQueue.html#ReplyQueuep0" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep0">m_replyQueue</a>.erase(it);
00471         }
00472         
00473         <span class="comment">//</span>
00474         <span class="comment">// If wait() failed, then this whole call failed.</span>
00475         <span class="comment">// Check with the ACE logger to see what the last error was.</span>
00476         <span class="comment">// It the failure was something other than a timeout, then log the</span>
00477         <span class="comment">// error. Timeout is a failure, but it isn't really an "error".</span>
00478         <span class="keywordflow">if</span> (status == -1 &amp;&amp; ACE_Log_Msg::last_error_adapter() != ETIME)
00479         {
00480                 ACE_ERROR((LM_ERROR, <span class="stringliteral">"(%N:%l) %p\n"</span>, <span class="stringliteral">"acquire"</span>));
00481         }
00482         <span class="comment">//</span>
00483         <span class="comment">// If the queue is closed at this point then we didn't get a value. Log a</span>
00484         <span class="comment">// warning to aid in debugging and return -1.</span>
00485         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classReplyQueue.html#ReplyQueuep2" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep2">m_closed</a>)
00486         {
00487                 status = -1;
00488                 ACE_ERROR((LM_WARNING,
00489                         <span class="stringliteral">"(%N:%l) GetReply() failed because reply queue was closed before a response was set.\n"</span>));
00490         }
00491 
00492         <span class="keywordflow">return</span> status;
00493 }
00494 
00495 
00496 
00497 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T, ACE_SYNCH_DECL&gt;
<a name="l00498"></a><a class="code" href="classReplyQueue.html#ReplyQueuea8" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea8">00498</a> <span class="keywordtype">int</span> <a class="code" href="classReplyQueue.html#ReplyQueuea6" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea6">ReplyQueue&lt;T, ACE_SYNCH_USE&gt;::GetReply</a>(T &amp;theReply, <span class="keywordtype">bool</span> acquireMutex)
00499 {
00500         <span class="keywordflow">if</span> (acquireMutex)
00501         {
00502                 <span class="comment">//</span>
00503                 <span class="comment">// Don't bother acquiring the mutex if the queue is already closed. Just </span>
00504                 <span class="comment">// report failure.</span>
00505                 <span class="keywordflow">if</span> (<a class="code" href="classReplyQueue.html#ReplyQueuep2" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep2">m_closed</a>)
00506                         <span class="keywordflow">return</span> -1;
00507 
00508                 ACE_Guard&lt;ACE_SYNCH_MUTEX_T&gt; g(<a class="code" href="classReplyQueue.html#ReplyQueuep1" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep1">m_replyQueueMutex</a>);
00509 
00510                 <span class="keywordflow">return</span> <a class="code" href="classReplyQueue.html#ReplyQueuea7" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea7">GetReply_i</a>(theReply);
00511         }
00512 
00513         <span class="keywordflow">return</span> <a class="code" href="classReplyQueue.html#ReplyQueuea7" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea7">GetReply_i</a>(theReply);
00514 }
00515 
00516 
00517 
00518 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T, ACE_SYNCH_DECL&gt;
<a name="l00519"></a><a class="code" href="classReplyQueue.html#ReplyQueuea9" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea9">00519</a> <span class="keywordtype">int</span> <a class="code" href="classReplyQueue.html#ReplyQueuea7" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea7">ReplyQueue&lt;T, ACE_SYNCH_USE&gt;::GetReply_i</a>(T &amp;theReply)
00520 {
00521         <span class="comment">//</span>
00522         <span class="comment">// Check to make sure the queue isn't closed already.</span>
00523         <span class="keywordflow">if</span> (<a class="code" href="classReplyQueue.html#ReplyQueuep2" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep2">m_closed</a>)
00524         {
00525                 ACE_ERROR_RETURN((LM_ERROR,
00526                         <span class="stringliteral">"(%N:%l) Attempt to get a reply from a closed queue.\n"</span>),
00527                         -1);
00528         }
00529 
00530         <span class="comment">//</span>
00531         <span class="comment">// Construct a PendingReply so we can put it in the queue.</span>
00532         <span class="comment">// Do this before acquiring the mutex so we don't make other threads</span>
00533         <span class="comment">// wait through construction.</span>
00534         <a class="code" href="classPendingReply.html" tppabs="http://dsacss.sourceforge.net/classPendingReply.html">PENDING_REPLY</a> replyObj(theReply, <a class="code" href="classReplyQueue.html#ReplyQueuep1" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep1">m_replyQueueMutex</a>);
00535                         
00536         <span class="comment">//</span>
00537         <span class="comment">// Mark the PendingReply as residing on the queue, and then add it to</span>
00538         <span class="comment">// the queue.</span>
00539         replyObj.<a class="code" href="classPendingReply.html#PendingReplyp1" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplyp1">m_isEnqueued</a> = <span class="keyword">true</span>;
00540         <span class="keyword">typename</span> QUEUE_TYPE::iterator it = <a class="code" href="classReplyQueue.html#ReplyQueuep0" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep0">m_replyQueue</a>.insert(<a class="code" href="classReplyQueue.html#ReplyQueuep0" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep0">m_replyQueue</a>.end(), &amp;replyObj);
00541         
00542         <span class="comment">//</span>
00543         <span class="comment">// Wait until signaled by a SetReply() call or until an error occurs.</span>
00544         <span class="comment">// Note that m_replyQueueMutex is relinquished during the time we are </span>
00545         <span class="comment">// waiting.  Its re-acquired on return from wait().</span>
00546         <span class="keywordtype">int</span> status = replyObj.<a class="code" href="classPendingReply.html#PendingReplyp0" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplyp0">m_condition</a>.wait();
00547         
00548         <span class="comment">//</span>
00549         <span class="comment">// If m_isEnqueued is still set, then remove the object from the queue</span>
00550         <span class="comment">// now. Since the queue is an STL list, the previously-recorded iterator</span>
00551         <span class="comment">// is still valid.</span>
00552         <span class="keywordflow">if</span> (replyObj.<a class="code" href="classPendingReply.html#PendingReplyp1" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplyp1">m_isEnqueued</a>)
00553         {
00554                 <a class="code" href="classReplyQueue.html#ReplyQueuep0" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep0">m_replyQueue</a>.erase(it);
00555         }
00556         
00557         <span class="comment">//</span>
00558         <span class="comment">// If wait() failed, then this whole call failed. Log an error message.</span>
00559         <span class="keywordflow">if</span> (status == -1)
00560         {
00561                 ACE_ERROR((LM_ERROR, <span class="stringliteral">"(%N:%l) %p\n"</span>, <span class="stringliteral">"LOCK::acquire"</span>));
00562         }
00563         <span class="comment">//</span>
00564         <span class="comment">// If the queue is closed at this point then we didn't get a value. Log a</span>
00565         <span class="comment">// warning to aid in debugging and return -1.</span>
00566         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classReplyQueue.html#ReplyQueuep2" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep2">m_closed</a>)
00567         {
00568                 status = -1;
00569                 ACE_ERROR((LM_WARNING,
00570                         <span class="stringliteral">"(%N:%l) GetReply() failed because reply queue was closed before a response was set.\n"</span>));
00571         }
00572         
00573         <span class="keywordflow">return</span> status;
00574 }
00575 
00576 
00577 
00578 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T, ACE_SYNCH_DECL&gt;
<a name="l00579"></a><a class="code" href="classReplyQueue.html#ReplyQueuea10" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea10">00579</a> <span class="keywordtype">int</span> <a class="code" href="classReplyQueue.html#ReplyQueuea10" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea10">ReplyQueue&lt;T, ACE_SYNCH_USE&gt;::SetReply</a>(T &amp;theReply, <span class="keywordtype">bool</span> acquireMutex)
00580 {
00581         <span class="keywordflow">if</span> (acquireMutex)
00582         {
00583                 <span class="comment">//</span>
00584                 <span class="comment">// Don't bother acquiring the mutex if the queue is already closed. Just </span>
00585                 <span class="comment">// report failure.</span>
00586                 <span class="keywordflow">if</span> (<a class="code" href="classReplyQueue.html#ReplyQueuep2" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep2">m_closed</a>)
00587                         <span class="keywordflow">return</span> -1;
00588 
00589                 ACE_Guard&lt;ACE_SYNCH_MUTEX_T&gt; g(<a class="code" href="classReplyQueue.html#ReplyQueuep1" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep1">m_replyQueueMutex</a>);
00590 
00591                 <span class="keywordflow">return</span> <a class="code" href="classReplyQueue.html#ReplyQueuea11" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea11">SetReply_i</a>(theReply);
00592         }
00593 
00594         <span class="keywordflow">return</span> <a class="code" href="classReplyQueue.html#ReplyQueuea11" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea11">SetReply_i</a>(theReply);
00595 }
00596 
00597 
00598 
00599 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T, ACE_SYNCH_DECL&gt;
<a name="l00600"></a><a class="code" href="classReplyQueue.html#ReplyQueuea11" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea11">00600</a> <span class="keywordtype">int</span> <a class="code" href="classReplyQueue.html#ReplyQueuea11" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea11">ReplyQueue&lt;T, ACE_SYNCH_USE&gt;::SetReply_i</a>(T &amp;theReply)
00601 {
00602         <span class="comment">//</span>
00603         <span class="comment">// A place to hold the status of system calls.</span>
00604         <span class="keywordtype">int</span> status = -1;
00605 
00606         <span class="comment">//</span>
00607         <span class="comment">// If the queue is already closed the log an error and return -1.</span>
00608         <span class="keywordflow">if</span> (<a class="code" href="classReplyQueue.html#ReplyQueuep2" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep2">m_closed</a>)
00609         {
00610                 ACE_ERROR_RETURN((LM_ERROR,
00611                         <span class="stringliteral">"(%N:%l) Attempt to get a reply from a closed queue.\n"</span>),
00612                         -1);
00613         }
00614         
00615         <span class="comment">//</span>
00616         <span class="comment">// If the queue is empty, then someone called this method in error.</span>
00617         <span class="comment">// Log an error and return -1.</span>
00618         <span class="keywordflow">if</span> (<a class="code" href="classReplyQueue.html#ReplyQueuep0" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep0">m_replyQueue</a>.empty())
00619         {
00620                 ACE_ERROR_RETURN((LM_ERROR,
00621                         <span class="stringliteral">"(%N:%l) Attempt to set a reply when none are pending.\n"</span>), -1);
00622         }
00623         <span class="keywordflow">else</span>
00624         {
00625                 <span class="comment">//</span>
00626                 <span class="comment">// Get the next PendingReply and mark it as no longer enqueued.</span>
00627                 <a class="code" href="classPendingReply.html" tppabs="http://dsacss.sourceforge.net/classPendingReply.html">PENDING_REPLY</a> * replyObj = <a class="code" href="classReplyQueue.html#ReplyQueuep0" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep0">m_replyQueue</a>.front();
00628                 replyObj-&gt;<a class="code" href="classPendingReply.html#PendingReplyp1" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplyp1">m_isEnqueued</a> = <span class="keyword">false</span>;
00629                 <a class="code" href="classReplyQueue.html#ReplyQueuep0" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuep0">m_replyQueue</a>.pop_front();
00630 
00631                 <span class="comment">//</span>
00632                 <span class="comment">// Assigns the value of theReply to replyObj-&gt;m_theReply</span>
00633                 <a class="code" href="classReplyQueue.html#ReplyQueuea12" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea12">Assign_i</a>(theReply, replyObj-&gt;<a class="code" href="classPendingReply.html#PendingReplyp2" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplyp2">m_theReply</a>);
00634                 
00635                 <span class="comment">//</span>
00636                 <span class="comment">// Notify the waiter that their reply is ready.</span>
00637                 status = replyObj-&gt;<a class="code" href="classPendingReply.html#PendingReplyp0" tppabs="http://dsacss.sourceforge.net/classPendingReply.html#PendingReplyp0">m_condition</a>.signal();
00638                 
00639                 <span class="comment">//</span>
00640                 <span class="comment">// If notification failed, then log a message.</span>
00641                 <span class="keywordflow">if</span> (status == -1)
00642                 {
00643                         ACE_ERROR((LM_ERROR,
00644                                 <span class="stringliteral">"(%N:%l) %p\n"</span>, <span class="stringliteral">"ACE_Condition&lt;&gt;::signal"</span>));
00645                 }
00646         }
00647         
00648         <span class="keywordflow">return</span> status;
00649 }
00650 
00651 <span class="preprocessor">#if 0</span>
00652 <span class="preprocessor"></span><span class="comment">//</span>
00653 <span class="comment">// The following class is used to test compilation. It is not intended to be used.</span>
00654 <span class="keyword">namespace</span>
00655 <span class="keyword"></span>{
00656         <span class="keyword">class </span>ReplyQueueTester
00657         {
00658                 <span class="keywordtype">void</span> TestCompilation()
00659                 {
00660                         <a class="code" href="classReplyQueue.html" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html">ReplyQueue&lt;int, ACE_MT_SYNCH&gt;</a>   foo1;
00661                         <a class="code" href="classReplyQueue.html" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html">ReplyQueue&lt;int, ACE_NULL_SYNCH&gt;</a> foo2;
00662                         <a class="code" href="classReplyQueue.html" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html">ReplyQueue&lt;int, ACE_SYNCH&gt;</a>              foo3;
00663                         
00664                         
00665                         ACE_Thread_Mutex        &amp;m1 = foo1.<a class="code" href="classReplyQueue.html#ReplyQueuea13" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea13">GetMutex</a>();
00666                         ACE_Null_Mutex          &amp;m2 = foo2.<a class="code" href="classReplyQueue.html#ReplyQueuea13" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea13">GetMutex</a>();
00667                         ACE_SYNCH_MUTEX         &amp;m3 = foo3.<a class="code" href="classReplyQueue.html#ReplyQueuea13" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea13">GetMutex</a>();
00668                         
00669                         <span class="keywordtype">int</span>                                     status,
00670                                                                 arg;
00671                         
00672                         ACE_Time_Value          tv = ACE_OS::gettimeofday()
00673                                                                                 + ACE_Time_Value(10,0);
00674                         
00675                         status = foo1.<a class="code" href="classReplyQueue.html#ReplyQueuea6" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea6">GetReply</a>(arg, &amp;tv);
00676                         status = foo2.<a class="code" href="classReplyQueue.html#ReplyQueuea6" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea6">GetReply</a>(arg, &amp;tv);
00677                         status = foo3.<a class="code" href="classReplyQueue.html#ReplyQueuea6" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea6">GetReply</a>(arg, &amp;tv);
00678                         ;
00679                         status = foo1.<a class="code" href="classReplyQueue.html#ReplyQueuea6" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea6">GetReply</a>(arg);
00680                         status = foo2.<a class="code" href="classReplyQueue.html#ReplyQueuea6" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea6">GetReply</a>(arg);
00681                         status = foo3.<a class="code" href="classReplyQueue.html#ReplyQueuea6" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea6">GetReply</a>(arg);
00682                         
00683                         status = foo1.<a class="code" href="classReplyQueue.html#ReplyQueuea10" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea10">SetReply</a>(status);
00684                         status = foo2.<a class="code" href="classReplyQueue.html#ReplyQueuea10" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea10">SetReply</a>(status);
00685                         status = foo3.<a class="code" href="classReplyQueue.html#ReplyQueuea10" tppabs="http://dsacss.sourceforge.net/classReplyQueue.html#ReplyQueuea10">SetReply</a>(status);
00686                 }
00687         };
00688 }
00689 <span class="preprocessor">#endif // 0</span>
00690 <span class="preprocessor"></span>
00691 <span class="preprocessor">#endif // REPLY_QUEUE_H</span>
00692 <span class="preprocessor"></span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jun 15 11:49:54 2004 for DSACSS Operational Code by
<a href="javascript:if(confirm('http://www.doxygen.org/index.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.doxygen.org/index.html'" tppabs="http://www.doxygen.org/index.html">
<img src="doxygen.png" tppabs="http://dsacss.sourceforge.net/doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
