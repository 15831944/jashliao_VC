<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DSACSS Operational Code: VehicleComm.cpp Source File</title>
<link href="doxygen.css" tppabs="http://dsacss.sourceforge.net/doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<h1>VehicleComm.cpp</h1><a href="VehicleComm_8cpp.html" tppabs="http://dsacss.sourceforge.net/VehicleComm_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 
00008 
00009 <span class="preprocessor">#include "<a class="code" href="VehicleComm_8h.html" tppabs="http://dsacss.sourceforge.net/VehicleComm_8h.html">VehicleComm.h</a>"</span>
00010 
00011 <span class="preprocessor">#include "ace/Synch.h"</span>
00012 <span class="preprocessor">#include "ace/SOCK_Dgram_Mcast.h"</span>
00013 <span class="preprocessor">#include "ace/SOCK_Dgram.h"</span>
00014 
00015 <span class="keyword">using</span> <a class="code" href="namespaceSystemDefs.html#a0" tppabs="http://dsacss.sourceforge.net/namespaceSystemDefs.html#a0">SystemDefs::VehicleID_t</a>;
00016 
<a name="l00017"></a><a class="code" href="classVehicleComm.html#VehicleComma0" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleComma0">00017</a> <a class="code" href="classVehicleComm.html#VehicleComma0" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleComma0">VehicleComm::VehicleComm</a>()
00018         : m_pMySocket(NULL),
00019           m_pMyConfig(NULL)
00020 {
00021 }
00022 
<a name="l00023"></a><a class="code" href="classVehicleComm.html#VehicleComma1" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleComma1">00023</a> <a class="code" href="classVehicleComm.html#VehicleComma0" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleComma0">VehicleComm::VehicleComm</a>(<a class="code" href="classVehicleNetConfig.html" tppabs="http://dsacss.sourceforge.net/classVehicleNetConfig.html">VehicleNetConfig</a> *myConfig)
00024         : m_pMySocket(NULL),
00025           m_pMyConfig(NULL)
00026 {
00027         this-&gt;<a class="code" href="classVehicleComm.html#VehicleComma3" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleComma3">Connect</a>(myConfig);
00028 }
00029 
<a name="l00030"></a><a class="code" href="classVehicleComm.html#VehicleComma2" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleComma2">00030</a> <a class="code" href="classVehicleComm.html#VehicleComma2" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleComma2">VehicleComm::~VehicleComm</a>()
00031 {
00032         <span class="keyword">delete</span> <a class="code" href="classVehicleComm.html#VehicleCommp0" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleCommp0">m_pMySocket</a>;
00033         <span class="keyword">delete</span> <a class="code" href="classVehicleComm.html#VehicleCommp1" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleCommp1">m_pMyConfig</a>;
00034 }
00035 
<a name="l00036"></a><a class="code" href="classVehicleComm.html#VehicleComma3" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleComma3">00036</a> <span class="keywordtype">int</span> <a class="code" href="classVehicleComm.html#VehicleComma3" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleComma3">VehicleComm::Connect</a>(<a class="code" href="classVehicleNetConfig.html" tppabs="http://dsacss.sourceforge.net/classVehicleNetConfig.html">VehicleNetConfig</a> *myConfig)
00037 {
00038         <a class="code" href="classVehicleComm.html#VehicleCommp1" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleCommp1">m_pMyConfig</a> = myConfig;
00039 
00040         <span class="keywordflow">if</span> (<a class="code" href="classVehicleComm.html#VehicleCommp0" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleCommp0">m_pMySocket</a>!= NULL)
00041         {
00042                 ACE_DEBUG((LM_INFO, <span class="stringliteral">"Reconnecting VehicleComm -- deleting old socket.\n"</span>));
00043                 <span class="keyword">delete</span> <a class="code" href="classVehicleComm.html#VehicleCommp0" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleCommp0">m_pMySocket</a>;
00044         }
00045 
00046         <a class="code" href="classVehicleComm.html#VehicleCommp0" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleCommp0">m_pMySocket</a>=<span class="keyword">new</span> ACE_SOCK_Dgram_Mcast;
00047 
00048         <span class="keywordflow">if</span> (<a class="code" href="classVehicleComm.html#VehicleCommp0" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleCommp0">m_pMySocket</a>-&gt;subscribe(<a class="code" href="classVehicleComm.html#VehicleCommp1" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleCommp1">m_pMyConfig</a>-&gt;<a class="code" href="classVehicleNetConfig.html#VehicleNetConfiga4" tppabs="http://dsacss.sourceforge.net/classVehicleNetConfig.html#VehicleNetConfiga4">GetMulticastAddress</a>(), 1, <a class="code" href="classVehicleComm.html#VehicleCommp1" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleCommp1">m_pMyConfig</a>-&gt;<a class="code" href="classVehicleNetConfig.html#VehicleNetConfiga5" tppabs="http://dsacss.sourceforge.net/classVehicleNetConfig.html#VehicleNetConfiga5">GetMulticastInterface</a>()))
00049         {
00050                 ACE_ERROR((LM_ERROR, <span class="stringliteral">"(%N:%l): %p"</span>, <span class="stringliteral">"subscribe"</span>));
00051         }
00052 
00053         {
00054                 u_char arg = <a class="code" href="classVehicleComm.html#VehicleCommp1" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleCommp1">m_pMyConfig</a>-&gt;<a class="code" href="classVehicleNetConfig.html#VehicleNetConfiga6" tppabs="http://dsacss.sourceforge.net/classVehicleNetConfig.html#VehicleNetConfiga6">MulticastLoopbackEnabled</a>();
00055                 ACE_SOCK * pSocket = static_cast&lt;ACE_SOCK *&gt;(<a class="code" href="classVehicleComm.html#VehicleCommp0" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleCommp0">m_pMySocket</a>);
00056                 <span class="keywordtype">int</span> status;
00057                 
00058                 status = pSocket-&gt;set_option(IPPROTO_IP, IP_MULTICAST_LOOP,
00059                         &amp;arg, <span class="keyword">sizeof</span>(arg));
00060                 <span class="keywordflow">if</span> (status &lt; 0)
00061                         ACE_ERROR_RETURN((LM_NOTICE, <span class="stringliteral">"(%N:%l): set_option: %p"</span>), -2);
00062                 
00063                 arg = <a class="code" href="classVehicleComm.html#VehicleCommp1" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleCommp1">m_pMyConfig</a>-&gt;<a class="code" href="classVehicleNetConfig.html#VehicleNetConfiga7" tppabs="http://dsacss.sourceforge.net/classVehicleNetConfig.html#VehicleNetConfiga7">MulticastTimeToLive</a>();
00064                 status = pSocket-&gt;set_option(IPPROTO_IP, IP_MULTICAST_TTL,
00065                         &amp;arg, <span class="keyword">sizeof</span>(arg));
00066                 <span class="keywordflow">if</span> (status &lt; 0)
00067                         ACE_ERROR_RETURN((LM_INFO, <span class="stringliteral">"(%N:%l): set_option: %p"</span>), -2);
00068         }
00069 
00070         <span class="keywordflow">return</span> 0;
00071 }
00072 
<a name="l00073"></a><a class="code" href="classVehicleComm.html#VehicleComma4" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleComma4">00073</a> <span class="keywordtype">int</span> <a class="code" href="classVehicleComm.html#VehicleComma4" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleComma4">VehicleComm::SendMessage</a>(VehicleID_t destID, <span class="keywordtype">void</span> *pMessage, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> msgLength)
00074 {
00075         <span class="keywordflow">if</span> (destID == SystemDefs::BROADCAST_ID)
00076                 <span class="keywordflow">return</span> this-&gt;<a class="code" href="classVehicleComm.html#VehicleComma5" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleComma5">BroadcastMessage</a>(pMessage, msgLength);
00077 
00078         <span class="keyword">const</span> ACE_INET_Addr &amp;destAddr = <a class="code" href="classVehicleComm.html#VehicleCommp1" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleCommp1">m_pMyConfig</a>-&gt;<a class="code" href="classVehicleNetConfig.html#VehicleNetConfiga8" tppabs="http://dsacss.sourceforge.net/classVehicleNetConfig.html#VehicleNetConfiga8">GetVehicleAddress</a>(destID);
00079 
00080         ACE_SOCK_Dgram * pSocket = static_cast&lt;ACE_SOCK_Dgram *&gt;(<a class="code" href="classVehicleComm.html#VehicleCommp0" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleCommp0">m_pMySocket</a>);
00081 
00082         <span class="keywordtype">int</span> status = pSocket-&gt;send(pMessage, msgLength, destAddr);
00083         <span class="keywordflow">if</span> (status &lt; 0)
00084         {
00085         ACE_ERROR((LM_ERROR, <span class="stringliteral">"(%N:%l): send: %p"</span>));
00086         }
00087 
00088         <span class="keywordflow">return</span> status;
00089 }
00090 
<a name="l00091"></a><a class="code" href="classVehicleComm.html#VehicleComma5" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleComma5">00091</a> <span class="keywordtype">int</span> <a class="code" href="classVehicleComm.html#VehicleComma5" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleComma5">VehicleComm::BroadcastMessage</a>(<span class="keywordtype">void</span> *pMessage, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> msgLength)
00092 {
00093         <span class="keywordtype">int</span> status = <a class="code" href="classVehicleComm.html#VehicleCommp0" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleCommp0">m_pMySocket</a>-&gt;send(pMessage, msgLength);
00094         <span class="keywordflow">if</span> (status &lt; 0)
00095         {
00096         ACE_ERROR((LM_ERROR, <span class="stringliteral">"(%N:%l): send: %p"</span>));
00097         }
00098 
00099         <span class="keywordflow">return</span> status;
00100 }
00101 
00102 
<a name="l00103"></a><a class="code" href="classVehicleComm.html#VehicleComma6" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleComma6">00103</a> <span class="keywordtype">int</span> <a class="code" href="classVehicleComm.html#VehicleComma6" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleComma6">VehicleComm::GetMessage</a>(<span class="keywordtype">void</span> *pMessage, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxMsgLength)
00104 {
00105         ACE_INET_Addr whoFromAddr;
00106         <span class="keywordtype">int</span> status = this-&gt;<a class="code" href="classVehicleComm.html#VehicleComma6" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleComma6">GetMessage</a>(pMessage, maxMsgLength, whoFromAddr);
00107 
00108         <span class="keywordflow">return</span> status;
00109 }
00110 
00111 
<a name="l00112"></a><a class="code" href="classVehicleComm.html#VehicleComma7" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleComma7">00112</a> <span class="keywordtype">int</span> <a class="code" href="classVehicleComm.html#VehicleComma6" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleComma6">VehicleComm::GetMessage</a>(<span class="keywordtype">void</span> *pMessage, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxMsgLength, VehicleID_t &amp;srcID)
00113 {
00114         ACE_INET_Addr whoFromAddr;
00115         <span class="keywordtype">int</span> status = this-&gt;<a class="code" href="classVehicleComm.html#VehicleComma6" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleComma6">GetMessage</a>(pMessage, maxMsgLength, whoFromAddr);
00116 
00117         <span class="keywordflow">if</span> (status &gt;= 0)
00118         {
00119                 srcID = <a class="code" href="classVehicleComm.html#VehicleCommp1" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleCommp1">m_pMyConfig</a>-&gt;<a class="code" href="classVehicleNetConfig.html#VehicleNetConfiga9" tppabs="http://dsacss.sourceforge.net/classVehicleNetConfig.html#VehicleNetConfiga9">VehicleAddressToID</a>(whoFromAddr);
00120         }
00121 
00122         <span class="keywordflow">return</span> status;
00123 }
00124 
<a name="l00125"></a><a class="code" href="classVehicleComm.html#VehicleCommb0" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleCommb0">00125</a> <span class="keywordtype">int</span> <a class="code" href="classVehicleComm.html#VehicleComma6" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleComma6">VehicleComm::GetMessage</a>(<span class="keywordtype">void</span> *pMessage, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxMsgLength, ACE_INET_Addr &amp;whoFrom)
00126 {
00127         <span class="keywordtype">int</span> status = <a class="code" href="classVehicleComm.html#VehicleCommp0" tppabs="http://dsacss.sourceforge.net/classVehicleComm.html#VehicleCommp0">m_pMySocket</a>-&gt;recv(pMessage, maxMsgLength, whoFrom);
00128         <span class="keywordflow">if</span> (status &lt; 0)
00129         {
00130         ACE_ERROR((LM_ERROR, <span class="stringliteral">"(%N:%l): recv: %p"</span>));
00131         }
00132 
00133         <span class="keywordflow">return</span> status;
00134 }
00135 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jun 15 11:49:55 2004 for DSACSS Operational Code by
<a href="javascript:if(confirm('http://www.doxygen.org/index.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.doxygen.org/index.html'" tppabs="http://www.doxygen.org/index.html">
<img src="doxygen.png" tppabs="http://dsacss.sourceforge.net/doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
