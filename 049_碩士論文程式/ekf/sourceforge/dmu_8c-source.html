<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DSACSS Operational Code: dmu.c Source File</title>
<link href="doxygen.css" tppabs="http://dsacss.sourceforge.net/doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<h1>dmu.c</h1><a href="dmu_8c.html" tppabs="http://dsacss.sourceforge.net/dmu_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#include "<a class="code" href="satctl_8h.html" tppabs="http://dsacss.sourceforge.net/satctl_8h.html">satctl.h</a>"</span>
00002 <span class="preprocessor">#include "<a class="code" href="dmu_8h-1.html" tppabs="http://dsacss.sourceforge.net/dmu_8h.html">dmu.h</a>"</span>
00003 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
00004 
00005 <span class="comment">/* Global variables for MT scope */</span>
00006 
00007 <span class="comment">/* DMU Data Conversion Factors</span>
00008 <span class="comment"> * The first group needs to be set in dmuInit or during the setup/config</span>
00009 <span class="comment"> * stage of a finished application, but accessed in the DMU polling</span>
00010 <span class="comment"> * function, which is actually a signal handler (using the current</span>
00011 <span class="comment"> * realtime timer setup).</span>
00012 <span class="comment"> */</span>
<a name="l00013"></a><a class="code" href="dmu_8c.html#a0" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a0">00013</a> <span class="keywordtype">int</span> <a class="code" href="dmu_8c.html#a0" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a0">dmufd</a>;              <span class="comment">/* fd to the open DMU serial port */</span>
<a name="l00014"></a><a class="code" href="dmu_8c.html#a1" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a1">00014</a> <span class="keywordtype">char</span> *<a class="code" href="dmu_8c.html#a1" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a1">dmudata</a>;          <span class="comment">/* DMU raw data buffer */</span>
<a name="l00015"></a><a class="code" href="dmu_8c.html#a2" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a2">00015</a> <span class="keywordtype">char</span> *<a class="code" href="dmu_8c.html#a2" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a2">cmd</a>;              <span class="comment">/* DMU cmd string buffer */</span>
<a name="l00016"></a><a class="code" href="dmu_8c.html#a3" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a3">00016</a> <span class="keywordtype">float</span> <a class="code" href="dmu_8c.html#a3" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a3">bias</a>[7];          <span class="comment">/* DMU channel biases */</span>
<a name="l00017"></a><a class="code" href="dmu_8c.html#a4" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a4">00017</a> <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="dmu_8c.html#a4" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a4">stepSize</a> = <a class="code" href="dmu_8h-1.html#a0" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a0">ADCV_REF</a>/4095.0; <span class="comment">/* ADC voltage stepsize */</span>
00018 
00019 <span class="comment">/* Shared memory objects</span>
00020 <span class="comment"> * The next group is for sharing data between the two main threads</span>
00021 <span class="comment"> * of the finished app.  One thread will read data from the DMU at</span>
00022 <span class="comment"> * a rate as close as possible (using timers) to the commanded rate,</span>
00023 <span class="comment"> * while the rest of the app will run in the other thread.</span>
00024 <span class="comment"> */</span>
<a name="l00025"></a><a class="code" href="dmu_8c.html#a5" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a5">00025</a> <a class="code" href="structadat__t.html" tppabs="http://dsacss.sourceforge.net/structadat__t.html">adat_t</a> *<a class="code" href="dmu_8c.html#a5" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a5">sh_attdat</a>;      <span class="comment">/* Shared attitude data */</span>
<a name="l00026"></a><a class="code" href="dmu_8c.html#a6" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a6">00026</a> <span class="keywordtype">int</span> <a class="code" href="dmu_8c.html#a6" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a6">sh_nextw</a>, <a class="code" href="dmu_8c.html#a7" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a7">sh_nextr</a>; <span class="comment">/* Next shared data write and read indexes */</span>
<a name="l00027"></a><a class="code" href="dmu_8c.html#a8" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a8">00027</a> <span class="keywordtype">long</span> <a class="code" href="dmu_8c.html#a8" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a8">sh_serial</a>;         <span class="comment">/* Shared data serial number */</span>
<a name="l00028"></a><a class="code" href="dmu_8c.html#a9" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a9">00028</a> <span class="keywordtype">int</span> <a class="code" href="dmu_8c.html#a9" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a9">rrate</a>;              <span class="comment">/* Commanded read rate */</span>
00029 
<a name="l00030"></a><a class="code" href="dmu_8c.html#a10" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a10">00030</a> <span class="keywordtype">int</span> <a class="code" href="dmu_8c.html#a10" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a10">dmuInit</a>(<span class="keywordtype">long</span> maxBufferSize, <span class="keywordtype">int</span> rate, <span class="keywordtype">int</span> flags) {
00031   <span class="keywordtype">int</span> fds[2];
00032   pid_t rpid;
00033   FILE *rfp;
00034   <span class="keywordtype">int</span> i;
00035   pthread_t daq_thr;
00036 
00037   <span class="comment">// Flags are not currently used.</span>
00038   <span class="comment">// This was originally coded around 5/02.  The prototype was</span>
00039   <span class="comment">//   substantially updated with new args (it used to have just rate)</span>
00040   <span class="comment">//   around 7/8/02,but the actual code changes were never made.</span>
00041   <span class="comment">//   maxBufferSize implemented 3/4/03.</span>
00042 
00043   <span class="keywordflow">if</span> (maxBufferSize == 0) maxBufferSize = 1024;
00044   <a class="code" href="dmu_8c.html#a5" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a5">sh_attdat</a> = (<a class="code" href="structadat__t.html" tppabs="http://dsacss.sourceforge.net/structadat__t.html">adat_t</a> *)malloc(<span class="keyword">sizeof</span>(<a class="code" href="structadat__t.html" tppabs="http://dsacss.sourceforge.net/structadat__t.html">adat_t</a>) * maxBufferSize);
00045   <a class="code" href="dmu_8c.html#a8" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a8">sh_serial</a> = 0;
00046   <a class="code" href="dmu_8c.html#a6" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a6">sh_nextw</a> = <a class="code" href="dmu_8c.html#a7" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a7">sh_nextr</a> = 0;
00047   <a class="code" href="dmu_8c.html#a9" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a9">rrate</a> = rate;
00048 
00049   <span class="keywordflow">if</span> (pthread_create(&amp;daq_thr, NULL, <a class="code" href="dmu_8c.html#a11" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a11">_daq</a>, NULL)) {
00050     perror(<span class="stringliteral">"pthread_create()"</span>);
00051     <span class="comment">// commented out because couldnt find "errlog"</span>
00052     <span class="comment">//errlog("dmuInit(): pthread_create() failed to create DMU read thread.\n");</span>
00053     <span class="keywordflow">return</span>(-1);
00054   }
00055 
00056   <span class="comment">/* This is the parent process. */</span>
00057   <span class="keywordflow">return</span>(0);
00058 }
00059 
00060 
00061 <span class="comment">/* This is the child process, where all the fun stuff happens... */</span>
00062 
<a name="l00063"></a><a class="code" href="dmu_8c.html#a11" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a11">00063</a> <span class="keywordtype">void</span>* <a class="code" href="dmu_8c.html#a11" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a11">_daq</a>(<span class="keywordtype">void</span>* nada) {
00064   <span class="keyword">struct </span>timeval rp_tv;
00065   <span class="keyword">struct </span>itimerval rptimer;
00066   <span class="keywordtype">int</span> i;
00067   
00068   <span class="comment">/* First, let's initialize the DMU... */</span>
00069 
00070   <a class="code" href="common_8c.html#a0" tppabs="http://dsacss.sourceforge.net/common_8c.html#a0">init_serial</a>(<a class="code" href="satctl_8h.html#a29" tppabs="http://dsacss.sourceforge.net/satctl_8h.html#a29">DMU_PORT</a>, B19200, &amp;<a class="code" href="dmu_8c.html#a0" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a0">dmufd</a>);        <span class="comment">/* Initialize the port */</span>
00071   <a class="code" href="dmu_8c.html#a2" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a2">cmd</a> = (<span class="keywordtype">char</span> *)malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>)*6);         <span class="comment">/* Setup the command string */</span>
00072   sprintf(<a class="code" href="dmu_8c.html#a2" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a2">cmd</a>, <span class="stringliteral">"!0RA%c"</span>, 6);
00073   <a class="code" href="dmu_8c.html#a1" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a1">dmudata</a> = (<span class="keywordtype">char</span> *)malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>)*20);    <span class="comment">/* Setup the data buffer */</span>
00074 
00075   <span class="comment">/* Next, we setup the period timer */</span>
00076   rp_tv.tv_sec = 0;             <span class="comment">/* 0 seconds */</span>
00077   rp_tv.tv_usec = 1000000/<a class="code" href="dmu_8c.html#a9" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a9">rrate</a>;        <span class="comment">/* 10^6 / rate microseconds-&gt;</span>
00078 <span class="comment">                                 * 10^6 usec/sec * 1/rate sec/read -&gt;</span>
00079 <span class="comment">                                 * sec's cancel -&gt; 10^6/rate usec/read */</span>
00080   <span class="keywordflow">if</span> (rp_tv.tv_usec &lt; 12500) {
00081     rp_tv.tv_usec = 1;
00082   } <span class="keywordflow">else</span> {
00083     rp_tv.tv_usec -= 12500;
00084   }
00085   rptimer.it_interval =
00086     rptimer.it_value = rp_tv;   <span class="comment">/* Set rptimer to rp_tv and reset to rp_tv */</span>
00087 
00088   <span class="keywordflow">for</span> (i = 0; i &lt;= 6; i++) <a class="code" href="dmu_8c.html#a3" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a3">bias</a>[i] = <a class="code" href="dmu_8h-1.html#a12" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a12">BIAS_DFLT</a>;  <span class="comment">/* Init bias settings */</span>
00089   <span class="comment">/* Then enter the tuned values (this should be done in dynamic or</span>
00090 <span class="comment">   * perhaps even automatic configuration at some point. */</span>
00091   <a class="code" href="dmu_8c.html#a3" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a3">bias</a>[<a class="code" href="dmu_8h-1.html#a5" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a5">XQRS</a>] = 2.467;
00092   <a class="code" href="dmu_8c.html#a3" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a3">bias</a>[<a class="code" href="dmu_8h-1.html#a6" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a6">YQRS</a>] = 2.520;
00093   <a class="code" href="dmu_8c.html#a3" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a3">bias</a>[<a class="code" href="dmu_8h-1.html#a7" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a7">ZQRS</a>] = 2.515;
00094   <a class="code" href="dmu_8c.html#a3" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a3">bias</a>[<a class="code" href="dmu_8h-1.html#a8" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a8">XACC</a>] = 2.423;
00095   <a class="code" href="dmu_8c.html#a3" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a3">bias</a>[<a class="code" href="dmu_8h-1.html#a9" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a9">YACC</a>] = 2.540;
00096   <a class="code" href="dmu_8c.html#a3" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a3">bias</a>[<a class="code" href="dmu_8h-1.html#a10" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a10">ZACC</a>] = 3.690;
00097   <a class="code" href="dmu_8c.html#a3" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a3">bias</a>[<a class="code" href="dmu_8h-1.html#a11" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a11">TSEN</a>] = <a class="code" href="dmu_8h-1.html#a4" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a4">TS_OFFSET</a>;
00098 
00099   <span class="comment">/* Start the timer */</span>
00100   setitimer(ITIMER_REAL, &amp;rptimer, NULL);
00101   signal(SIGALRM, <a class="code" href="dmu_8c.html#a12" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a12">polldmu</a>);     <span class="comment">/* Set the sighandler */</span>
00102   <span class="keywordflow">while</span>(1)                      <span class="comment">/* And loop forever */</span>
00103     sleep(5);
00104 }
00105 
00106 <span class="comment">/* This is our SIGALRM handler.  It WILL be called every 10^6/rate usec,</span>
00107 <span class="comment"> * +- 10 usec max.  If the write()'s and/or read()'s fail repeatedly</span>
00108 <span class="comment"> * (they're non-blocking and will just loop) enough that the timer</span>
00109 <span class="comment"> * expires again before this function finishes, we have a loop counter</span>
00110 <span class="comment"> * that will add the timer reset value to our deltat calculation so that</span>
00111 <span class="comment"> * when we do get data, it will have the right age.</span>
00112 <span class="comment"> *</span>
00113 <span class="comment"> * The danger here is that if we the timer expires during a read() or</span>
00114 <span class="comment"> * write() loop, we'll have sent half a command, or our read data will</span>
00115 <span class="comment"> * be permanently misaligned.  If this gets to be a problem, we may need</span>
00116 <span class="comment"> * to go to blocking read()'s.  We simply cannot afford to catch a signal</span>
00117 <span class="comment"> * midway through a read() loop, because since the data is all numeric</span>
00118 <span class="comment"> * and includes no sentinel values, any misalignment will be noncorrectable.</span>
00119 <span class="comment"> *</span>
00120 <span class="comment"> * A possible workaround without doing blocking read()'s (which would</span>
00121 <span class="comment"> * mean we couldn't count the signal) would be to simply change the signal</span>
00122 <span class="comment"> * disposition for the duration of the function to either SIGIGN or</span>
00123 <span class="comment"> * perhaps even a different handler that would only increment the loop count.</span>
00124 <span class="comment"> */</span>
<a name="l00125"></a><a class="code" href="dmu_8c.html#a12" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a12">00125</a> <span class="keywordtype">void</span> <a class="code" href="dmu_8c.html#a12" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a12">polldmu</a>(<span class="keywordtype">int</span> sig) {
00126   <span class="keyword">static</span> <span class="keywordtype">int</span> tbw,               <span class="comment">/* Total bytes written */</span>
00127         tbr,                    <span class="comment">/* Total bytes read */</span>
00128         inloop,                 <span class="comment">/* Status variable set upon entering a loop */</span>
00129         lc=0,                   <span class="comment">/* Loop counter */</span>
00130         curchan,                <span class="comment">/* Current channel */</span>
00131         i, hob, lob;
00132   <span class="keyword">static</span> <span class="keywordtype">long</span> deltat,           <span class="comment">/* Total deltat from last read */</span>
00133         curts,                  <span class="comment">/* Current timestamp */</span>
00134         lastts;                 <span class="comment">/* Last timestamp */</span>
00135   <span class="keyword">static</span> <span class="keywordtype">float</span> adVolts[7],
00136         temp,
00137         xRate, yRate, zRate,
00138         xAcc, yAcc, zAcc;
00139   <span class="keyword">static</span> <span class="keyword">struct </span>timeval tod;
00140 
00141   lc++;         <span class="comment">/* Increment the loop counter.  This way, if the timer</span>
00142 <span class="comment">                 * expires before we finish handling the data, we'll know,</span>
00143 <span class="comment">                 * and at least we can calculate a correct deltat when we</span>
00144 <span class="comment">                 * do get that far.</span>
00145 <span class="comment">                 */</span>
00146   <span class="keywordflow">for</span> (tbw = 0; tbw &lt; 5; )              <span class="comment">/* Loop the write until the entire */</span>
00147     tbw += write(<a class="code" href="dmu_8c.html#a0" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a0">dmufd</a>, <a class="code" href="dmu_8c.html#a2" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a2">cmd</a>, 5);        <span class="comment">/* command is written */</span>
00148 
00149   <span class="keywordflow">for</span> (tbr = 0; tbr &lt; 14; )               <span class="comment">/* Loop the read until we get a */</span>
00150     tbr += read(<a class="code" href="dmu_8c.html#a0" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a0">dmufd</a>, <a class="code" href="dmu_8c.html#a1" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a1">dmudata</a>+tbr, 14-tbr); <span class="comment">/* full set of 14 data bytes */</span>
00151 
00152   gettimeofday(&amp;tod, NULL);             <span class="comment">/* Get the timer value */</span>
00153   curts = tod.tv_usec;                  <span class="comment">/* Fetch the usec element.  This is</span>
00154 <span class="comment">                                         * the raw timestamp for this data. */</span>
00155   deltat = curts - lastts;              <span class="comment">/* Calc deltat.  lc should be &gt;= 1 */</span>
00156   <span class="keywordflow">if</span> (deltat &lt; 0) deltat += 1000000;
00157 
00158   <span class="comment">/* Calc individual channel values */</span>
00159   <span class="comment">/* This is where we were screwing up the upper-half of the data range because</span>
00160 <span class="comment">   * we didn't account for the fact that the implicit cast from char to int</span>
00161 <span class="comment">   * interprets the bits using 8-bit 2's complement notation, meaning the range</span>
00162 <span class="comment">   * is -127 to 127, and not 0 to 255.  Thus, 0-127 are mapped as-is, while</span>
00163 <span class="comment">   * 128-255 get mapped to -127-(-1).  A cleaner solution than the one implemented</span>
00164 <span class="comment">   * may be to do a byte-wise copy from &amp;dmudata[i] to &amp;some_int to sidestep the</span>
00165 <span class="comment">   * issues of typecasting, like perhaps:</span>
00166 <span class="comment">   * memcpy(&amp;some_int, &amp;(dmudata[i]), 2) OR</span>
00167 <span class="comment">   * memcpy((void *)(1+&amp;some_int), &amp;(dmudata[i]), 1);</span>
00168 <span class="comment">   * memcpy(&amp;some_int, &amp;(dmudata[i+1]), 1);</span>
00169 <span class="comment">   * But what's here works, so it's staying for now.</span>
00170 <span class="comment">   */</span>
00171   <span class="keywordflow">for</span> (i = 0, curchan = 6; i &lt; 14; i+=2, curchan--) {
00172     <span class="keywordflow">if</span> (<a class="code" href="dmu_8c.html#a1" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a1">dmudata</a>[i] &lt; 0)
00173         hob = <a class="code" href="dmu_8c.html#a1" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a1">dmudata</a>[i] + 255;
00174     <span class="keywordflow">else</span>
00175         hob = <a class="code" href="dmu_8c.html#a1" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a1">dmudata</a>[i];
00176     <span class="keywordflow">if</span> (<a class="code" href="dmu_8c.html#a1" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a1">dmudata</a>[i+1] &lt; 0)
00177         lob = <a class="code" href="dmu_8c.html#a1" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a1">dmudata</a>[i+1] + 255;
00178     <span class="keywordflow">else</span>
00179         lob = <a class="code" href="dmu_8c.html#a1" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a1">dmudata</a>[i+1];
00180     adVolts[curchan] = (256 * hob + lob) * <a class="code" href="dmu_8c.html#a4" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a4">stepSize</a>;
00181     <a class="code" href="dmu_8c.html#a1" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a1">dmudata</a>[i] = <a class="code" href="dmu_8c.html#a1" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a1">dmudata</a>[i+1] = 0;                  <span class="comment">/* Then clear buffer */</span>
00182   }
00183 
00184   <span class="comment">/* Calculate data values... */</span>
00185   xRate = (-1)*(adVolts[<a class="code" href="dmu_8h-1.html#a5" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a5">XQRS</a>] - <a class="code" href="dmu_8c.html#a3" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a3">bias</a>[<a class="code" href="dmu_8h-1.html#a5" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a5">XQRS</a>]) / <a class="code" href="dmu_8h-1.html#a1" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a1">RATE_SF</a>;
00186   yRate = (-1)*(adVolts[<a class="code" href="dmu_8h-1.html#a6" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a6">YQRS</a>] - <a class="code" href="dmu_8c.html#a3" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a3">bias</a>[<a class="code" href="dmu_8h-1.html#a6" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a6">YQRS</a>]) / <a class="code" href="dmu_8h-1.html#a1" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a1">RATE_SF</a>;
00187   zRate = (-1)*(adVolts[<a class="code" href="dmu_8h-1.html#a7" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a7">ZQRS</a>] - <a class="code" href="dmu_8c.html#a3" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a3">bias</a>[<a class="code" href="dmu_8h-1.html#a7" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a7">ZQRS</a>]) / <a class="code" href="dmu_8h-1.html#a1" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a1">RATE_SF</a>;
00188   xAcc = ((adVolts[<a class="code" href="dmu_8h-1.html#a8" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a8">XACC</a>] - <a class="code" href="dmu_8c.html#a3" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a3">bias</a>[<a class="code" href="dmu_8h-1.html#a8" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a8">XACC</a>]) / <a class="code" href="dmu_8h-1.html#a2" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a2">ACC_SF</a> * <a class="code" href="dmu_8h-1.html#a13" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a13">G</a>);
00189   yAcc = ((adVolts[<a class="code" href="dmu_8h-1.html#a9" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a9">YACC</a>] - <a class="code" href="dmu_8c.html#a3" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a3">bias</a>[<a class="code" href="dmu_8h-1.html#a9" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a9">YACC</a>]) / <a class="code" href="dmu_8h-1.html#a2" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a2">ACC_SF</a> * <a class="code" href="dmu_8h-1.html#a13" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a13">G</a>);
00190   zAcc = ((adVolts[<a class="code" href="dmu_8h-1.html#a10" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a10">ZACC</a>] - <a class="code" href="dmu_8c.html#a3" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a3">bias</a>[<a class="code" href="dmu_8h-1.html#a10" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a10">ZACC</a>]) / <a class="code" href="dmu_8h-1.html#a2" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a2">ACC_SF</a> * <a class="code" href="dmu_8h-1.html#a13" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a13">G</a>);
00191   temp = adVolts[<a class="code" href="dmu_8h-1.html#a11" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a11">TSEN</a>] / <a class="code" href="dmu_8h-1.html#a3" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a3">TEMP_SF</a> - <a class="code" href="dmu_8c.html#a3" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a3">bias</a>[<a class="code" href="dmu_8h-1.html#a11" tppabs="http://dsacss.sourceforge.net/dmu_8h.html#a11">TSEN</a>];
00192 
00193   <span class="comment">/* Put the data in the shared mem space... */</span>
00194   <a class="code" href="dmu_8c.html#a5" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a5">sh_attdat</a>[<a class="code" href="dmu_8c.html#a6" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a6">sh_nextw</a>].xrate = xRate;
00195   <a class="code" href="dmu_8c.html#a5" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a5">sh_attdat</a>[<a class="code" href="dmu_8c.html#a6" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a6">sh_nextw</a>].yrate = yRate;
00196   <a class="code" href="dmu_8c.html#a5" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a5">sh_attdat</a>[<a class="code" href="dmu_8c.html#a6" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a6">sh_nextw</a>].zrate = zRate;
00197   <a class="code" href="dmu_8c.html#a5" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a5">sh_attdat</a>[<a class="code" href="dmu_8c.html#a6" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a6">sh_nextw</a>].xaccel = xAcc;
00198   <a class="code" href="dmu_8c.html#a5" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a5">sh_attdat</a>[<a class="code" href="dmu_8c.html#a6" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a6">sh_nextw</a>].yaccel = yAcc;
00199   <a class="code" href="dmu_8c.html#a5" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a5">sh_attdat</a>[<a class="code" href="dmu_8c.html#a6" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a6">sh_nextw</a>].zaccel = zAcc;
00200   <a class="code" href="dmu_8c.html#a5" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a5">sh_attdat</a>[<a class="code" href="dmu_8c.html#a6" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a6">sh_nextw</a>].temp = temp;
00201   <a class="code" href="dmu_8c.html#a5" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a5">sh_attdat</a>[<a class="code" href="dmu_8c.html#a6" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a6">sh_nextw</a>].deltat = deltat;
00202   <a class="code" href="dmu_8c.html#a5" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a5">sh_attdat</a>[<a class="code" href="dmu_8c.html#a6" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a6">sh_nextw</a>].serial = <a class="code" href="dmu_8c.html#a8" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a8">sh_serial</a>;
00203   <span class="keywordflow">if</span> (<a class="code" href="dmu_8c.html#a6" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a6">sh_nextw</a>==1022) <a class="code" href="dmu_8c.html#a6" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a6">sh_nextw</a>=0;
00204     <span class="keywordflow">else</span> <a class="code" href="dmu_8c.html#a6" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a6">sh_nextw</a>++;
00205   <a class="code" href="dmu_8c.html#a8" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a8">sh_serial</a>++;
00206   
00207   <span class="comment">/* Whew!  We made it.  Let's reset the loop counter and update the</span>
00208 <span class="comment">   * timestamps and return.</span>
00209 <span class="comment">   */</span>
00210   lc = 0;
00211   lastts = curts;
00212   <span class="keywordflow">return</span>;
00213 }
00214 
00215 
<a name="l00216"></a><a class="code" href="dmu_8c.html#a13" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a13">00216</a> <span class="keywordtype">int</span> <a class="code" href="dmu_8c.html#a13" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a13">dmuReadData</a>(<a class="code" href="structadat__t.html" tppabs="http://dsacss.sourceforge.net/structadat__t.html">adat_t</a> **accData, <span class="keywordtype">int</span> maxsets) {
00217   <span class="keyword">static</span> <span class="keywordtype">int</span> i,
00218         ind;
00219   <span class="keyword">static</span> <span class="keyword">struct </span>timeval rtmr;
00220 
00221   <span class="keywordflow">if</span> (<a class="code" href="dmu_8c.html#a7" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a7">sh_nextr</a> &lt; 1023)                  <span class="comment">// We haven't reached the end, so ...</span>
00222     ind = <a class="code" href="dmu_8c.html#a7" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a7">sh_nextr</a>;                     <span class="comment">// the index is the nextread ptr</span>
00223   <span class="keywordflow">else</span>
00224     ind = <a class="code" href="dmu_8c.html#a7" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a7">sh_nextr</a> - 1023;              <span class="comment">// Else, it rolls back around</span>
00225 
00226   <span class="comment">//  Now, we run the loop until we get to the nextwrite ptr (the ptr</span>
00227   <span class="comment">//   that points to the sharedmem address where the next data will go.</span>
00228   <span class="keywordflow">for</span> (i = 0; i &lt; maxsets &amp;&amp; ind != <a class="code" href="dmu_8c.html#a6" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a6">sh_nextw</a>; i++) {
00229     <span class="keywordflow">if</span> ((<a class="code" href="dmu_8c.html#a7" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a7">sh_nextr</a> + i) &lt; 1023)
00230       ind = <a class="code" href="dmu_8c.html#a7" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a7">sh_nextr</a> + i;
00231     <span class="keywordflow">else</span>
00232       ind = <a class="code" href="dmu_8c.html#a7" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a7">sh_nextr</a> + i - 1023;
00233 <span class="comment">/*</span>
00234 <span class="comment">    printf("%d -&gt; %d\t", ind, i);</span>
00235 <span class="comment">    fflush(stdout);</span>
00236 <span class="comment">*/</span>
00237     (*accData)[i].xrate = <a class="code" href="dmu_8c.html#a5" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a5">sh_attdat</a>[ind].<a class="code" href="structadat__t.html#adat__to0" tppabs="http://dsacss.sourceforge.net/structadat__t.html#adat__to0">xrate</a>;
00238     (*accData)[i].yrate = <a class="code" href="dmu_8c.html#a5" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a5">sh_attdat</a>[ind].<a class="code" href="structadat__t.html#adat__to1" tppabs="http://dsacss.sourceforge.net/structadat__t.html#adat__to1">yrate</a>;
00239     (*accData)[i].zrate = <a class="code" href="dmu_8c.html#a5" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a5">sh_attdat</a>[ind].<a class="code" href="structadat__t.html#adat__to2" tppabs="http://dsacss.sourceforge.net/structadat__t.html#adat__to2">zrate</a>;
00240     (*accData)[i].xaccel = <a class="code" href="dmu_8c.html#a5" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a5">sh_attdat</a>[ind].<a class="code" href="structadat__t.html#adat__to3" tppabs="http://dsacss.sourceforge.net/structadat__t.html#adat__to3">xaccel</a>;
00241     (*accData)[i].yaccel = <a class="code" href="dmu_8c.html#a5" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a5">sh_attdat</a>[ind].<a class="code" href="structadat__t.html#adat__to4" tppabs="http://dsacss.sourceforge.net/structadat__t.html#adat__to4">yaccel</a>;
00242     (*accData)[i].zaccel = <a class="code" href="dmu_8c.html#a5" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a5">sh_attdat</a>[ind].<a class="code" href="structadat__t.html#adat__to5" tppabs="http://dsacss.sourceforge.net/structadat__t.html#adat__to5">zaccel</a>;
00243     (*accData)[i].temp = <a class="code" href="dmu_8c.html#a5" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a5">sh_attdat</a>[ind].<a class="code" href="structadat__t.html#adat__to6" tppabs="http://dsacss.sourceforge.net/structadat__t.html#adat__to6">temp</a>;
00244     (*accData)[i].deltat = <a class="code" href="dmu_8c.html#a5" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a5">sh_attdat</a>[ind].<a class="code" href="structadat__t.html#adat__to7" tppabs="http://dsacss.sourceforge.net/structadat__t.html#adat__to7">deltat</a>;
00245   }
00246   <a class="code" href="dmu_8c.html#a7" tppabs="http://dsacss.sourceforge.net/dmu_8c.html#a7">sh_nextr</a> = ind++;
00247   <span class="keywordflow">if</span> (i) <span class="keywordflow">return</span>(i-1);
00248     <span class="keywordflow">else</span> <span class="keywordflow">return</span>(0);
00249 }
00250 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jun 15 11:49:54 2004 for DSACSS Operational Code by
<a href="javascript:if(confirm('http://www.doxygen.org/index.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.doxygen.org/index.html'" tppabs="http://www.doxygen.org/index.html">
<img src="doxygen.png" tppabs="http://dsacss.sourceforge.net/doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
