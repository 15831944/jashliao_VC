<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>nurbs.cpp Source File</title>
<link href="doxygen.css" tppabs="http://libnurbs.sourceforge.net/docs/doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html" tppabs="http://libnurbs.sourceforge.net/docs/index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html" tppabs="http://libnurbs.sourceforge.net/docs/hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html" tppabs="http://libnurbs.sourceforge.net/docs/annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html" tppabs="http://libnurbs.sourceforge.net/docs/files.html">File List</a> &nbsp; <a class="qindex" href="functions.html" tppabs="http://libnurbs.sourceforge.net/docs/functions.html">Compound Members</a> &nbsp; </center>
<hr><h1>nurbs.cpp</h1><div class="fragment"><pre>00001 <font class="comment">/*=====================================================================</font>
00002 <font class="comment">        File: nurbs.cpp</font>
00003 <font class="comment">     Purpose:       </font>
00004 <font class="comment">    Revision: $Id: nurbs.cpp,v 1.5 2003/01/27 11:37:36 philosophil Exp $</font>
00005 <font class="comment">      Author: Philippe Lavoie          (3 Oct, 1996)</font>
00006 <font class="comment"> Modified by: </font>
00007 <font class="comment"></font>
00008 <font class="comment"> Copyright notice:</font>
00009 <font class="comment">          Copyright (C) 1996-1997 Philippe Lavoie</font>
00010 <font class="comment"> </font>
00011 <font class="comment">          This library is free software; you can redistribute it and/or</font>
00012 <font class="comment">          modify it under the terms of the GNU Library General Public</font>
00013 <font class="comment">          License as published by the Free Software Foundation; either</font>
00014 <font class="comment">          version 2 of the License, or (at your option) any later version.</font>
00015 <font class="comment"> </font>
00016 <font class="comment">          This library is distributed in the hope that it will be useful,</font>
00017 <font class="comment">          but WITHOUT ANY WARRANTY; without even the implied warranty of</font>
00018 <font class="comment">          MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</font>
00019 <font class="comment">          Library General Public License for more details.</font>
00020 <font class="comment"> </font>
00021 <font class="comment">          You should have received a copy of the GNU Library General Public</font>
00022 <font class="comment">          License along with this library; if not, write to the Free</font>
00023 <font class="comment">          Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</font>
00024 <font class="comment">=====================================================================*/</font>
00025 <font class="preprocessor">#ifndef PLIB_NURBS_NURBS_SOURCE</font>
00026 <font class="preprocessor"></font><font class="preprocessor">#define PLIB_NURBS_NURBS_SOURCE</font>
00027 <font class="preprocessor"></font>
00028 <font class="preprocessor">#include &lt;nurbs.h&gt;</font>
00029 <font class="preprocessor">#include &lt;fstream&gt;</font>
00030 <font class="preprocessor">#include &lt;string.h&gt;</font>
00031 <font class="preprocessor">#include &lt;nurbsS.h&gt;</font>
00032 <font class="preprocessor">#include "integrate.h"</font>
00033 
00034 <font class="preprocessor">#include &lt;malloc.h&gt;</font>
00035 
00038 <font class="keyword">namespace </font>PLib {
00039 
00045 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l00046"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a0">00046</a> NurbsCurve&lt;T,N&gt;::NurbsCurve(): P(1),U(1),deg_(0)
00047 {
00048 }
00049 
00058 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l00059"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a1" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a1">00059</a> NurbsCurve&lt;T,N&gt;::NurbsCurve(<font class="keyword">const</font> NurbsCurve&lt;T,N&gt;&amp; nurb): 
00060   ParaCurve&lt;T,N&gt;(), P(nurb.P),U(nurb.U),deg_(nurb.deg_)
00061 {
00062 }
00063 
00075 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l00076"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a11" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a11">00076</a> <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::reset(<font class="keyword">const</font> Vector&lt; HPoint_nD&lt;T,N&gt; &gt;&amp; P1, <font class="keyword">const</font> Vector&lt;T&gt; &amp;U1, <font class="keywordtype">int</font> Degree) {
00077   <font class="keywordtype">int</font> nSize = P1.n() ;
00078   <font class="keywordtype">int</font> mSize = U1.n() ;
00079   deg_ = Degree ;
00080   <font class="keywordflow">if</font>(nSize != mSize-deg_-1){
00081 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
00082 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classNurbsSizeError.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classNurbsSizeError.html'" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsSizeError.html">NurbsSizeError</a>(P1.n(),U1.n(),Degree) ;
00083 <font class="preprocessor">#else</font>
00084 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"reset"</font>);
00085     err &lt;&lt; <font class="stringliteral">"Invalid input size for the control points and the knot vector when reseting a Nurbs Curve.\n"</font>;
00086     err &lt;&lt; nSize &lt;&lt; <font class="stringliteral">" control points  and "</font> &lt;&lt; mSize &lt;&lt; <font class="stringliteral">" knots\n"</font> ;
00087     err.fatal() ;
00088 <font class="preprocessor">#endif</font>
00089 <font class="preprocessor"></font>  }
00090   P.resize(P1.n()) ;
00091   U.resize(U1.n()) ;
00092   P = P1 ;
00093   U = U1 ;
00094 }
00095 
00108 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l00109"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a2" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a2">00109</a> NurbsCurve&lt;T,N&gt;::NurbsCurve(<font class="keyword">const</font> Vector&lt; HPoint_nD&lt;T,N&gt; &gt;&amp; P1, <font class="keyword">const</font> Vector&lt;T&gt; &amp;U1, <font class="keywordtype">int</font> Degree): P(P1), U(U1), deg_(Degree) 
00110 {
00111 
00112   <font class="keywordflow">if</font>(P.n() != U.n()-deg_-1){
00113 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
00114 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classNurbsSizeError.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classNurbsSizeError.html'" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsSizeError.html">NurbsSizeError</a>(P.n(),U.n(),deg_) ;
00115 <font class="preprocessor">#else</font>
00116 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"NurbsCurve(P1,U1,Degree)"</font>);
00117     err &lt;&lt; <font class="stringliteral">"Invalid input size for the control points and the knot vector.\n"</font>;
00118     err &lt;&lt; P.n() &lt;&lt; <font class="stringliteral">" control points  and "</font> &lt;&lt; U.n() &lt;&lt; <font class="stringliteral">" knots\n"</font> ;
00119     err.fatal() ;
00120 <font class="preprocessor">#endif</font>
00121 <font class="preprocessor"></font>  }
00122 }
00123 
00137 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l00138"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a3" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a3">00138</a> NurbsCurve&lt;T,N&gt;::NurbsCurve(<font class="keyword">const</font> Vector&lt; Point_nD&lt;T,N&gt; &gt;&amp; P1, <font class="keyword">const</font> Vector&lt;T&gt;&amp; W, <font class="keyword">const</font> Vector&lt;T&gt;&amp; U1, <font class="keywordtype">int</font> Degree): P(P1.n()), U(U1), deg_(Degree)
00139 {
00140   <font class="keywordtype">int</font> nSize = P1.n() ;
00141   <font class="keywordtype">int</font> mSize = U1.n() ;
00142 
00143   <font class="keywordflow">if</font>(nSize != mSize-deg_-1){
00144 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
00145 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classNurbsSizeError.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classNurbsSizeError.html'" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsSizeError.html">NurbsSizeError</a>(P.n(),U.n(),deg_) ;
00146 <font class="preprocessor">#else</font>
00147 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"NurbsCurve(P1,W,U1,Degree)"</font>) ;
00148     err &lt;&lt; <font class="stringliteral">"Invalid input size for the control points and the knot vector.\n"</font> ;
00149     err &lt;&lt; nSize &lt;&lt; <font class="stringliteral">" control points  and "</font> &lt;&lt; mSize &lt;&lt; <font class="stringliteral">" knots\n"</font> ;
00150     err.fatal() ;
00151 <font class="preprocessor">#endif</font>
00152 <font class="preprocessor"></font>  }
00153   <font class="keywordflow">if</font>(nSize != W.n()){
00154 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
00155 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>(nSize,W.n()) ;
00156 <font class="preprocessor">#else</font>
00157 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"NurbsCurve(P1,W,U1,Degree)"</font>) ;
00158     err &lt;&lt; <font class="stringliteral">"Size mismatched between the control points and the weights\n"</font> ;
00159     err &lt;&lt; <font class="stringliteral">"ControlPoints size = "</font> &lt;&lt; nSize &lt;&lt; <font class="stringliteral">", Weight size = "</font> &lt;&lt; W.n() &lt;&lt; endl ;
00160     err.fatal() ;
00161 <font class="preprocessor">#endif</font>
00162 <font class="preprocessor"></font>  }
00163 
00164   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = 0 ;i&lt;nSize;i++){
00165     <font class="keyword">const</font> Point_nD&lt;T,N&gt;&amp; pt = P1[i] ; <font class="comment">// This makes the SGI compiler happy</font>
00166     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> j=0;j&lt;N;j++)
00167       P[i].data[j] = pt.data[j] * W[i] ;
00168     P[i].w() = W[i] ;
00169   }
00170 }
00171 
00183 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l00184"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a12" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a12">00184</a> NurbsCurve&lt;T,N&gt;&amp; NurbsCurve&lt;T,N&gt;::operator=(<font class="keyword">const</font> NurbsCurve&lt;T,N&gt;&amp; curve) {
00185   <font class="keywordflow">if</font>(curve.U.n() != curve.P.n()+curve.deg_+1){
00186 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
00187 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classNurbsSizeError.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classNurbsSizeError.html'" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsSizeError.html">NurbsSizeError</a>(curve.P.n(),curve.U.n(),curve.deg_) ;
00188 <font class="preprocessor">#else</font>
00189 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"operator="</font>) ;
00190     err &lt;&lt; <font class="stringliteral">"Invalid assignment... the curve being assigned to isn't valid\n"</font> ;
00191     err.fatal() ;
00192 <font class="preprocessor">#endif</font>
00193 <font class="preprocessor"></font>  }
00194   deg_ = curve.deg_ ;
00195   U = curve.U ;
00196   P = curve.P ;
00197   <font class="keywordflow">if</font>(U.n()!=P.n()+deg_+1){
00198 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
00199 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classNurbsSizeError.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classNurbsSizeError.html'" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsSizeError.html">NurbsSizeError</a>(P.n(),U.n(),deg_) ;
00200 <font class="preprocessor">#else</font>
00201 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"operator="</font>) ;
00202     err &lt;&lt; <font class="stringliteral">"Error in assignment... couldn't assign properly the vectors\n"</font> ;
00203     err.fatal() ;
00204 <font class="preprocessor">#endif</font>
00205 <font class="preprocessor"></font>  }
00206   <font class="keywordflow">return</font> *<font class="keyword">this</font> ;
00207 }
00208 
00209 
00228 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l00229"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a113" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a113">00229</a> <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::drawImg(<a class="code" href="classPLib_1_1MatrixImage.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1MatrixImage.html">Image_UBYTE</a>&amp; Img,<font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> color,T step){
00230   Point_nD&lt;T,N&gt; a1,a2 ;
00231   T u_max = U[U.n()-1-deg_] ;
00232   <font class="keywordflow">if</font>(step&lt;=0)
00233     step = 0.01 ;
00234   a1 = this-&gt;<a class="code" href="classPLib_1_1ParaCurve.html#a3" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1ParaCurve.html#a3">pointAt</a>(U[deg_]) ;
00235   T u ;
00236   <font class="keywordtype">int</font> i1,j1,i2,j2 ;
00237   getCoordinates(a1,i1,j1,Img.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>(),Img.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1">cols</a>()) ;
00238   <font class="keywordflow">for</font>(u=U[deg_]+step ; u &lt; u_max+(step/2.0) ; u+=step){ <font class="comment">// the &lt;= u_max doesn't work</font>
00239     a2 = this-&gt;<a class="code" href="classPLib_1_1ParaCurve.html#a3" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1ParaCurve.html#a3">pointAt</a>(u) ;
00240     <font class="keywordflow">if</font>(!getCoordinates(a2,i2,j2,Img.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>(),Img.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1">cols</a>()))
00241       <font class="keywordflow">continue</font> ;
00242     Img.<a class="code" href="classPLib_1_1MatrixImage.html#a5" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1MatrixImage.html#a5">drawLine</a>(i1,j1,i2,j2,color) ;
00243     i1 = i2 ;
00244     j1 = j2 ;
00245   }
00246   a2 = this-&gt;<a class="code" href="classPLib_1_1ParaCurve.html#a3" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1ParaCurve.html#a3">pointAt</a>(U[P.n()]) ;
00247   <font class="keywordflow">if</font>(getCoordinates(a2,i2,j2,Img.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>(),Img.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1">cols</a>()))
00248      Img.<a class="code" href="classPLib_1_1MatrixImage.html#a5" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1MatrixImage.html#a5">drawLine</a>(i1,j1,i2,j2,color) ;
00249 }
00250 
00269 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l00270"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a114" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a114">00270</a> <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::drawImg(<a class="code" href="classPLib_1_1MatrixImage.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1MatrixImage.html">Image_Color</a>&amp; Img,<font class="keyword">const</font> Color&amp; color,T step){
00271   Point_nD&lt;T,N&gt; a1,a2 ;
00272   T u_max = U[U.n()-1-deg_] ;
00273   <font class="keywordflow">if</font>(step&lt;=0)
00274     step = 0.01 ;
00275   a1 = this-&gt;<a class="code" href="classPLib_1_1ParaCurve.html#a3" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1ParaCurve.html#a3">pointAt</a>(U[deg_]) ;
00276   <font class="keywordtype">int</font> i1,j1,i2,j2 ;
00277   getCoordinates(a1,i1,j1,Img.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>(),Img.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1">cols</a>()) ;
00278   T u ;
00279   <font class="keywordflow">for</font>(u=U[deg_]+step ; u &lt; u_max+(step/2.0) ; u+=step){ <font class="comment">// the &lt;= u_max doesn't work</font>
00280     a2 = this-&gt;<a class="code" href="classPLib_1_1ParaCurve.html#a3" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1ParaCurve.html#a3">pointAt</a>(u) ;
00281     <font class="keywordflow">if</font>(!getCoordinates(a2,i2,j2,Img.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>(),Img.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1">cols</a>()))
00282       <font class="keywordflow">continue</font> ;
00283     Img.<a class="code" href="classPLib_1_1MatrixImage.html#a5" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1MatrixImage.html#a5">drawLine</a>(i1,j1,i2,j2,color) ;
00284     i1 = i2 ;
00285     j1 = j2 ;
00286   }
00287   a2 = this-&gt;<a class="code" href="classPLib_1_1ParaCurve.html#a3" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1ParaCurve.html#a3">pointAt</a>(U[P.n()]) ;
00288   <font class="keywordflow">if</font>(getCoordinates(a2,i2,j2,Img.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>(),Img.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1">cols</a>()))
00289     Img.<a class="code" href="classPLib_1_1MatrixImage.html#a5" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1MatrixImage.html#a5">drawLine</a>(i1,j1,i2,j2,color) ;
00290 }
00291 
00312 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
00313 <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::drawAaImg(<a class="code" href="classPLib_1_1MatrixImage.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1MatrixImage.html">Image_Color</a>&amp; Img, <font class="keyword">const</font> Color&amp; color, <font class="keywordtype">int</font> precision, <font class="keywordtype">int</font> alpha){
00314   NurbsCurve&lt;T,3&gt; profile ;
00315 
00316   profile.makeCircle(Point_nD&lt;T,3&gt;(0,0,0),Point_nD&lt;T,3&gt;(1,0,0),Point_nD&lt;T,3&gt;(0,0,1),1.0,0,M_PI) ;
00317   <a class="code" href="classPLib_1_1NurbsCurve.html#a115" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a115">drawAaImg</a>(Img,color,profile,precision,alpha) ;
00318 }
00319 
00341 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l00342"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a116" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a116">00342</a> <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::drawAaImg(<a class="code" href="classPLib_1_1MatrixImage.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1MatrixImage.html">Image_Color</a>&amp; Img, <font class="keyword">const</font> Color&amp; color, <font class="keyword">const</font> NurbsCurve&lt;T,3&gt;&amp; profile, <font class="keywordtype">int</font> precision, <font class="keywordtype">int</font> alpha){
00343   Vector&lt; HPoint_nD&lt;T,3&gt; &gt; sPts(2) ;
00344   sPts[0] = sPts[1] = HPoint_nD&lt;T,3&gt;(1,1,1,1) ;
00345   Vector&lt;T&gt; sKnot(4) ;
00346   sKnot[0] = sKnot[1] = 0.0 ;
00347   sKnot[2] = sKnot[3] = 1.0 ;
00348   
00349   NurbsCurve&lt;T,3&gt; scaling(sPts,sKnot,1) ;  
00350 
00351   <a class="code" href="classPLib_1_1NurbsCurve.html#a115" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a115">drawAaImg</a>(Img,color,profile,scaling,precision,alpha) ;
00352 }
00353 
00384 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l00385"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a117" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a117">00385</a> NurbsSurface&lt;T,3&gt; NurbsCurve&lt;T,N&gt;::drawAaImg(<a class="code" href="classPLib_1_1MatrixImage.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1MatrixImage.html">Image_Color</a>&amp; Img, <font class="keyword">const</font> Color&amp; color, <font class="keyword">const</font> NurbsCurve&lt;T,3&gt;&amp; profile, <font class="keyword">const</font> NurbsCurve&lt;T,3&gt;&amp; scaling, <font class="keywordtype">int</font> precision, <font class="keywordtype">int</font> alpha){
00386   Matrix&lt;T&gt; addMatrix ;
00387   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_INT</a> nMatrix ;
00388 
00389   addMatrix.resize(Img.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>(),Img.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1">cols</a>()) ;
00390   nMatrix.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a8'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a8">resize</a>(Img.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>(),Img.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1">cols</a>()) ;
00391 
00392   <font class="keywordtype">int</font> i,j ;
00393 
00394   T du,dv ;
00395   <font class="comment">// compute a coarse distance for the curve</font>
00396   Point_nD&lt;T,N&gt; a,b,c ;
00397   a = <a class="code" href="classPLib_1_1ParaCurve.html#a3" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1ParaCurve.html#a3">pointAt</a>(0.0) ;
00398   b = <a class="code" href="classPLib_1_1ParaCurve.html#a3" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1ParaCurve.html#a3">pointAt</a>(0.5) ;
00399   c = <a class="code" href="classPLib_1_1ParaCurve.html#a3" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1ParaCurve.html#a3">pointAt</a>(1.0) ;
00400 
00401   T distance = norm(b-a) + norm(c-b) ;
00402 
00403   dv = distance*T(precision) ;
00404   dv = (U[U.n()-1]-U[0])/dv ;
00405 
00406   <font class="comment">// compute a coarse distance for the trajectory</font>
00407   Point_nD&lt;T,3&gt; a2,b2,c2 ;
00408   a2 = profile.pointAt(0.0) ;
00409   b2 = profile.pointAt(0.5) ;
00410   c2 = profile.pointAt(1.0) ;
00411   distance = norm(b2-a2) + norm(c2-b2) ;
00412   du = distance*T(precision) ;
00413   du = (profile.knot()[profile.knot().n()-1]-profile.knot()[0])/du ;
00414 
00415   NurbsSurface&lt;T,3&gt; drawCurve ;
00416   NurbsCurve&lt;T,3&gt; trajectory ; 
00417 
00418   to3D(*<font class="keyword">this</font>,trajectory) ; 
00419 
00420   drawCurve.sweep(trajectory,profile,scaling,P.n()-1) ;
00421 
00422   T u,v ;
00423 
00424   <font class="keywordflow">for</font>(u=U[0];u&lt;U[U.n()-1];u+=du)
00425     <font class="keywordflow">for</font>(v=profile.knot()[0];v&lt;profile.knot()[profile.knot().n()-1];v+=dv){
00426       Point_nD&lt;T,3&gt; p ;
00427       p = drawCurve.pointAt(u,v) ;
00428       <font class="keywordflow">if</font>(getCoordinates(p,i,j,Img.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>(),Img.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1">cols</a>())){
00429         addMatrix(i,j) += p.z() ;
00430         nMatrix(i,j) += 1 ;
00431       }
00432     }
00433 
00434   T maxP = 1.0 ;
00435   <font class="keywordflow">for</font>(i=0;i&lt;Img.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>();++i)
00436     <font class="keywordflow">for</font>(j=0;j&lt;Img.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1">cols</a>();++j){
00437       addMatrix(i,j) /= T(nMatrix(i,j)) ;
00438       <font class="keywordflow">if</font>(addMatrix(i,j)&gt;maxP)
00439         maxP = addMatrix(i,j) ;
00440     }
00441 
00442   <font class="keywordflow">for</font>(i=0;i&lt;Img.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>();++i)
00443     <font class="keywordflow">for</font>(j=0;j&lt;Img.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1">cols</a>();++j){
00444       <font class="keywordflow">if</font>(nMatrix(i,j)){
00445         <font class="keywordtype">double</font> mean = double(addMatrix(i,j))/double(maxP) ;
00446         <font class="keywordflow">if</font>(alpha){
00447           Img(i,j).r = (<font class="keywordtype">unsigned</font> <font class="keywordtype">char</font>)(mean*double(color.r)+(1.0-mean)*double(Img(i,j).r)) ;
00448           Img(i,j).g = (<font class="keywordtype">unsigned</font> <font class="keywordtype">char</font>)(mean*double(color.g)+(1.0-mean)*double(Img(i,j).g)) ;
00449           Img(i,j).b = (<font class="keywordtype">unsigned</font> <font class="keywordtype">char</font>)(mean*double(color.b)+(1.0-mean)*double(Img(i,j).b)) ;
00450         }
00451         <font class="keywordflow">else</font>{
00452           Img(i,j) = mean*color ;
00453         }
00454       }
00455     }
00456   <font class="keywordflow">return</font> drawCurve ;
00457 }
00458 
00470 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l00471"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a86" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a86">00471</a> <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::transform(<font class="keyword">const</font> MatrixRT&lt;T&gt;&amp; A){
00472   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=P.n()-1;i&gt;=0;--i)
00473     P[i] = A*P[i] ;
00474 }
00475 
00499 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l00500"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a13" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a13">00500</a> HPoint_nD&lt;T,N&gt; NurbsCurve&lt;T,N&gt;::operator()(T u)<font class="keyword"> const</font>{
00501   <font class="keyword">static</font> Vector&lt;T&gt; Nb ;
00502   <font class="keywordtype">int</font> span = <a class="code" href="classPLib_1_1NurbsCurve.html#a32" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a32">findSpan</a>(u) ;
00503 
00504   <a class="code" href="classPLib_1_1NurbsCurve.html#a28" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a28">basisFuns</a>(u,span,Nb) ;
00505   
00506   HPoint_nD&lt;T,N&gt; p(0) ;
00507   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=deg_;i&gt;=0;--i) {
00508     p += Nb[i] * P[span-deg_+i] ;
00509   }
00510   <font class="keywordflow">return</font> p ; 
00511 }
00512 
00536 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l00537"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a15" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a15">00537</a> HPoint_nD&lt;T,N&gt; NurbsCurve&lt;T,N&gt;::hpointAt(T u, <font class="keywordtype">int</font> span)<font class="keyword"> const</font>{
00538   <font class="keyword">static</font> Vector&lt;T&gt; Nb ;
00539 
00540   <a class="code" href="classPLib_1_1NurbsCurve.html#a28" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a28">basisFuns</a>(u,span,Nb) ;
00541   
00542   HPoint_nD&lt;T,N&gt; p(0,0,0,0) ;
00543   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=deg_;i&gt;=0;--i) {
00544     p += Nb[i] * P[span-deg_+i] ;
00545   }
00546   <font class="keywordflow">return</font> p ; 
00547 }
00548 
00565 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l00566"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a20" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a20">00566</a> Point_nD&lt;T,N&gt; NurbsCurve&lt;T,N&gt;::derive3D(T u, <font class="keywordtype">int</font> d)<font class="keyword"> const </font>{
00567   Vector&lt; Point_nD&lt;T,N&gt; &gt; ders ;
00568   <a class="code" href="classPLib_1_1NurbsCurve.html#a17" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a17">deriveAt</a>(u,d,ders) ;
00569   <font class="keywordflow">return</font> ders[d] ;
00570 }
00571 
00588 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l00589"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a21" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a21">00589</a> HPoint_nD&lt;T,N&gt; NurbsCurve&lt;T,N&gt;::derive(T u, <font class="keywordtype">int</font> d)<font class="keyword"> const </font>{
00590   Vector&lt; HPoint_nD&lt;T,N&gt; &gt; ders ;
00591   <a class="code" href="classPLib_1_1NurbsCurve.html#a16" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a16">deriveAtH</a>(u,d,ders) ;
00592   <font class="keywordflow">return</font> ders[d] ;
00593 }
00594 
00611 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l00612"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a16" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a16">00612</a> <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::deriveAtH(T u,<font class="keywordtype">int</font> d, Vector&lt; HPoint_nD&lt;T,N&gt; &gt;&amp; ders)<font class="keyword"> const</font>{
00613   <font class="keywordtype">int</font> du = minimum(d,deg_) ;
00614   <font class="keywordtype">int</font> span ;
00615   Matrix&lt;T&gt; derF(du+1,deg_+1) ;
00616   ders.resize(d+1) ;
00617 
00618   span = <a class="code" href="classPLib_1_1NurbsCurve.html#a32" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a32">findSpan</a>(u) ;
00619   <a class="code" href="classPLib_1_1NurbsCurve.html#a29" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a29">dersBasisFuns</a>(du,u,span,derF) ;
00620   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> k=du;k&gt;=0;--k){
00621     ders[k] = 0 ;
00622     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> j=deg_;j&gt;=0;--j){
00623       ders[k] += derF(k,j)*P[span-deg_+j] ;
00624     }
00625   }
00626 }
00627 
00643 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l00644"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a18" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a18">00644</a> <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::deriveAtH(T u, <font class="keywordtype">int</font> d, <font class="keywordtype">int</font> span, Vector&lt; HPoint_nD&lt;T,N&gt; &gt;&amp; ders)<font class="keyword"> const</font>{
00645   <font class="keywordtype">int</font> du = minimum(d,deg_) ;
00646   Matrix&lt;T&gt; derF(du+1,deg_+1) ;
00647   ders.resize(d+1) ;
00648 
00649   <a class="code" href="classPLib_1_1NurbsCurve.html#a29" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a29">dersBasisFuns</a>(du,u,span,derF) ;
00650   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> k=du;k&gt;=0;--k){
00651     ders[k] = 0 ;
00652     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> j=deg_;j&gt;=0;--j){
00653       ders[k] += derF(k,j)*P[span-deg_+j] ;
00654     }
00655   }
00656 }
00657 
00658 
00659 <font class="comment">// Setup the binomial coefficients into th matrix Bin</font>
00660 <font class="comment">// Bin(i,j) = (i  j)</font>
00661 <font class="comment">// The binomical coefficients are defined as follow</font>
00662 <font class="comment">//   (n)         n!</font>
00663 <font class="comment">//   (k)  =    k!(n-k)!       0&lt;=k&lt;=n</font>
00664 <font class="comment">// and the following relationship applies </font>
00665 <font class="comment">// (n+1)     (n)   ( n )</font>
00666 <font class="comment">// ( k ) =   (k) + (k-1)</font>
00685 <font class="comment"></font><font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
00686 <font class="keywordtype">void</font> binomialCoef(Matrix&lt;T&gt;&amp; Bin){
00687   <font class="keywordtype">int</font> n,k ;
00688   <font class="comment">// Setup the first line</font>
00689   Bin(0,0) = 1.0 ;
00690   <font class="keywordflow">for</font>(k=Bin.cols()-1;k&gt;0;--k)
00691     Bin(0,k) = 0.0 ;
00692   <font class="comment">// Setup the other lines</font>
00693   <font class="keywordflow">for</font>(n=0;n&lt;Bin.rows()-1;n++){
00694     Bin(n+1,0) = 1.0 ;
00695     <font class="keywordflow">for</font>(k=1;k&lt;Bin.cols();k++)
00696       <font class="keywordflow">if</font>(n+1&lt;k)
00697         Bin(n,k) = 0.0 ;
00698       <font class="keywordflow">else</font>
00699         Bin(n+1,k) = Bin(n,k) + Bin(n,k-1) ;
00700   }
00701 }
00702 
00714 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l00715"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a17" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a17">00715</a> <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::deriveAt(T u, <font class="keywordtype">int</font> d, Vector&lt; Point_nD&lt;T,N&gt; &gt;&amp; ders)<font class="keyword"> const</font>{
00716   Vector&lt; HPoint_nD&lt;T,N&gt; &gt; dersW ;
00717   <a class="code" href="classPLib_1_1NurbsCurve.html#a16" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a16">deriveAtH</a>(u,d,dersW) ;
00718   Point_nD&lt;T,N&gt; v ;
00719   <font class="keywordtype">int</font> k,i ;
00720   ders.resize(d+1) ;
00721   
00722   <font class="keyword">static</font> Matrix&lt;T&gt; Bin(1,1) ;
00723   <font class="keywordflow">if</font>(Bin.rows() != d+1){
00724     Bin.resize(d+1,d+1) ;
00725     binomialCoef(Bin) ;
00726   }
00727 
00728   <font class="comment">// Compute the derivative at the parmeter u</font>
00729 
00730   <font class="keywordflow">for</font>(k=0;k&lt;=d;k++){
00731     v.x() = dersW[k].x() ;
00732     v.y() = dersW[k].y() ;
00733     v.z() = dersW[k].z() ;
00734     <font class="keywordflow">for</font>(i=k ;i&gt;0 ;--i){
00735       v -= (Bin(k,i)*dersW[i].w())*ders[k-i] ;
00736     }
00737     ders[k] = v ;
00738     ders[k] /= dersW[0].w() ;
00739   }
00740 }
00741 
00754 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l00755"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a19" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a19">00755</a> <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::deriveAt(T u, <font class="keywordtype">int</font> d, <font class="keywordtype">int</font> span, Vector&lt; Point_nD&lt;T,N&gt; &gt;&amp; ders)<font class="keyword"> const</font>{
00756   Vector&lt; HPoint_nD&lt;T,N&gt; &gt; dersW ;
00757   <a class="code" href="classPLib_1_1NurbsCurve.html#a16" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a16">deriveAtH</a>(u,d,span,dersW) ;
00758   Point_nD&lt;T,N&gt; v ;
00759   <font class="keywordtype">int</font> k,i ;
00760   ders.resize(d+1) ;
00761   
00762   <font class="keyword">static</font> Matrix&lt;T&gt; Bin(1,1) ;
00763   <font class="keywordflow">if</font>(Bin.rows() != d+1){
00764     Bin.resize(d+1,d+1) ;
00765     binomialCoef(Bin) ;
00766   }
00767 
00768   <font class="comment">// Compute the derivative at the parmeter u</font>
00769 
00770   <font class="keywordflow">for</font>(k=0;k&lt;=d;k++){
00771     v.x() = dersW[k].x() ;
00772     v.y() = dersW[k].y() ;
00773     v.z() = dersW[k].z() ;
00774     <font class="keywordflow">for</font>(i=k ;i&gt;0 ;--i){
00775       v -= (Bin(k,i)*dersW[i].w())*ders[k-i];
00776     }
00777     ders[k] = v ;
00778     ders[k] /= dersW[0].w() ;
00779   }
00780 }
00781 
00798 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l00799"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a22" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a22">00799</a> Point_nD&lt;T,N&gt; NurbsCurve&lt;T,N&gt;::normal(T u, <font class="keyword">const</font> Point_nD&lt;T,N&gt;&amp; v)<font class="keyword"> const</font>{
00800   <font class="keywordflow">return</font> crossProduct(firstDn(u),v) ;
00801 }
00802 
00839 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> D&gt;
<a name="l00840"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a27" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a27">00840</a> T NurbsCurve&lt;T,D&gt;::basisFun(T u, <font class="keywordtype">int</font> i, <font class="keywordtype">int</font> p)<font class="keyword"> const</font>{
00841   T Nip ;
00842   T saved,Uleft,Uright,temp ;
00843   
00844   <font class="keywordflow">if</font>(p&lt;1)
00845     p = deg_ ;
00846 
00847   <font class="keywordflow">if</font>((i==0 &amp;&amp; u == U[0]) ||
00848      (i == U.n()-p-2 &amp;&amp; u==U[U.n()-1])){
00849     Nip = 1.0 ;
00850     <font class="keywordflow">return</font> Nip ;
00851   }
00852   <font class="keywordflow">if</font>(u&lt;U[i] || u&gt;=U[i+p+1]){
00853     Nip = 0.0 ;
00854     <font class="keywordflow">return</font> Nip;
00855   }
00856   T* N = (T*) alloca((p+1)*<font class="keyword">sizeof</font>(T)) ; <font class="comment">// Vector&lt;T&gt; N(p+1) ;</font>
00857   
00858 
00859   <font class="keywordtype">int</font> j ;
00860   <font class="keywordflow">for</font>(j=p;j&gt;=0;--j){
00861     <font class="keywordflow">if</font>(u&gt;=U[i+j] &amp;&amp; u&lt;U[i+j+1]) 
00862       N[j] = 1.0 ;
00863     <font class="keywordflow">else</font>
00864       N[j] = 0.0 ;
00865   }
00866   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> k=1; k&lt;=p ; k++){
00867     <font class="keywordflow">if</font>(N[0] == 0.0)
00868       saved = 0.0 ;
00869     <font class="keywordflow">else</font>
00870       saved = ( (u-U[i])*N[0])/(U[i+k]-U[i]) ;
00871     <font class="keywordflow">for</font>(j=0;j&lt;p-k+1;j++){
00872       Uleft = U[i+j+1] ;
00873       Uright = U[i+j+k+1] ;
00874       <font class="keywordflow">if</font>(N[j+1]==0.0){
00875         N[j] = saved ;
00876         saved = 0.0 ;
00877       }
00878       <font class="keywordflow">else</font> {
00879         temp = N[j+1]/(Uright-Uleft) ;
00880         N[j] = saved+(Uright-u)*temp ;
00881         saved = (u-Uleft)*temp ;
00882       }
00883     }
00884   }
00885   Nip = N[0] ;
00886 
00887   <font class="keywordflow">return</font> Nip ;  
00888 }
00889 
00890 <font class="comment">// it returns the matrix ders, where ders(n+1,deg+1) and the C'(u) = ders(1,span-deg+j) ;</font>
00891 
00911 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l00912"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a29" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a29">00912</a> <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::dersBasisFuns(<font class="keywordtype">int</font> n,T u, <font class="keywordtype">int</font> span, Matrix&lt;T&gt;&amp; ders)<font class="keyword"> const </font>{
00913   T* left = (T*) alloca(2*(deg_+1)*<font class="keyword">sizeof</font>(T)) ;
00914   T* right = &amp;left[deg_+1] ;
00915   
00916   Matrix&lt;T&gt; ndu(deg_+1,deg_+1) ;
00917   T saved,temp ;
00918   <font class="keywordtype">int</font> j,r ;
00919 
00920   ders.resize(n+1,deg_+1) ;
00921 
00922   ndu(0,0) = 1.0 ;
00923   <font class="keywordflow">for</font>(j=1; j&lt;= deg_ ;j++){
00924     left[j] = u-U[span+1-j] ;
00925     right[j] = U[span+j]-u ;
00926     saved = 0.0 ;
00927     
00928     <font class="keywordflow">for</font>(r=0;r&lt;j ; r++){
00929       <font class="comment">// Lower triangle</font>
00930       ndu(j,r) = right[r+1]+left[j-r] ;
00931       temp = ndu(r,j-1)/ndu(j,r) ;
00932       <font class="comment">// Upper triangle</font>
00933       ndu(r,j) = saved+right[r+1] * temp ;
00934       saved = left[j-r] * temp ;
00935     }
00936 
00937     ndu(j,j) = saved ;
00938   }
00939 
00940   <font class="keywordflow">for</font>(j=deg_;j&gt;=0;--j)
00941     ders(0,j) = ndu(j,deg_) ;
00942 
00943   <font class="comment">// Compute the derivatives</font>
00944   Matrix&lt;T&gt; a(deg_+1,deg_+1) ;
00945   <font class="keywordflow">for</font>(r=0;r&lt;=deg_;r++){
00946     <font class="keywordtype">int</font> s1,s2 ;
00947     s1 = 0 ; s2 = 1 ; <font class="comment">// alternate rows in array a</font>
00948     a(0,0) = 1.0 ;
00949     <font class="comment">// Compute the kth derivative</font>
00950     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> k=1;k&lt;=n;k++){
00951       T d ;
00952       <font class="keywordtype">int</font> rk,pk,j1,j2 ;
00953       d = 0.0 ;
00954       rk = r-k ; pk = deg_-k ;
00955 
00956       <font class="keywordflow">if</font>(r&gt;=k){
00957         a(s2,0) = a(s1,0)/ndu(pk+1,rk) ;
00958         d = a(s2,0)*ndu(rk,pk) ;
00959       }
00960 
00961       <font class="keywordflow">if</font>(rk&gt;=-1){
00962         j1 = 1 ;
00963       }
00964       <font class="keywordflow">else</font>{
00965         j1 = -rk ;
00966       }
00967 
00968       <font class="keywordflow">if</font>(r-1 &lt;= pk){
00969         j2 = k-1 ;
00970       }
00971       <font class="keywordflow">else</font>{
00972         j2 = deg_-r ;
00973       }
00974 
00975       <font class="keywordflow">for</font>(j=j1;j&lt;=j2;j++){
00976         a(s2,j) = (a(s1,j)-a(s1,j-1))/ndu(pk+1,rk+j) ;
00977         d += a(s2,j)*ndu(rk+j,pk) ;
00978       }
00979       
00980       <font class="keywordflow">if</font>(r&lt;=pk){
00981         a(s2,k) = -a(s1,k-1)/ndu(pk+1,r) ;
00982         d += a(s2,k)*ndu(r,pk) ;
00983       }
00984       ders(k,r) = d ;
00985       j = s1 ; s1 = s2 ; s2 = j ; <font class="comment">// Switch rows</font>
00986     }
00987   }
00988 
00989   <font class="comment">// Multiply through by the correct factors</font>
00990   r = deg_ ;
00991   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> k=1;k&lt;=n;k++){
00992     <font class="keywordflow">for</font>(j=deg_;j&gt;=0;--j)
00993       ders(k,j) *= r ;
00994     r *= deg_-k ;
00995   }
00996 
00997 }
00998 
00999 <font class="comment">// Computes the non-zero basis functions into N of size deg+1</font>
01000 <font class="comment">// The following relationship applies   N[i] &lt;= N[span-deg+i]  for i = 0..deg</font>
01001 <font class="comment">// A2.1 on p68 of the Nurbs Book</font>
01045 <font class="comment"></font><font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> D&gt;
<a name="l01046"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a28" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a28">01046</a> <font class="keywordtype">void</font> NurbsCurve&lt;T,D&gt;::basisFuns(T u, <font class="keywordtype">int</font> i, Vector&lt;T&gt;&amp; N)<font class="keyword"> const</font>{
01047   T* left = (T*) alloca(2*(deg_+1)*<font class="keyword">sizeof</font>(T)) ;
01048   T* right = &amp;left[deg_+1] ;
01049   
01050   T temp,saved ;
01051    
01052   N.resize(deg_+1) ;
01053 
01054   N[0] = 1.0 ;
01055   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> j=1; j&lt;= deg_ ; j++){
01056     left[j] = u-U[i+1-j] ;
01057     right[j] = U[i+j]-u ;
01058     saved = 0.0 ;
01059     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> r=0 ; r&lt;j; r++){
01060       temp = N[r]/(right[r+1]+left[j-r]) ;
01061       N[r] = saved+right[r+1] * temp ;
01062       saved = left[j-r] * temp ;
01063     }
01064     N[j] = saved ;
01065   }
01066   
01067 }
01068 
01083 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l01084"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a32" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a32">01084</a> <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::findSpan(T u)<font class="keyword"> const</font>{
01085   <font class="keywordflow">if</font>(u&gt;=U[P.n()]) 
01086     <font class="keywordflow">return</font> P.n()-1 ;
01087   <font class="keywordflow">if</font>(u&lt;=U[deg_])
01088     <font class="keywordflow">return</font> deg_ ;
01089 
01090   <font class="keywordtype">int</font> low  = 0 ;
01091   <font class="keywordtype">int</font> high = P.n()+1 ; 
01092   <font class="keywordtype">int</font> mid = (low+high)/2 ;
01093 
01094   <font class="keywordflow">while</font>(u&lt;U[mid] || u&gt;= U[mid+1]){
01095     <font class="keywordflow">if</font>(u&lt;U[mid])
01096       high = mid ;
01097     <font class="keywordflow">else</font>
01098       low = mid ;
01099     mid = (low+high)/2 ;
01100   }
01101   <font class="keywordflow">return</font> mid ;
01102  
01103 }
01104 
01117 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l01118"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a35" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a35">01118</a> <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::findKnot(T u)<font class="keyword"> const</font>{
01119   <font class="keywordflow">if</font>(u==U[P.n()])
01120     <font class="keywordflow">return</font> P.n() ;
01121   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=deg_+1; i&lt;P.n() ; i++)
01122     <font class="keywordflow">if</font>(U[i]&gt;u){
01123       <font class="keywordflow">return</font> i-1 ;
01124     }
01125   <font class="keywordflow">return</font> -1 ;
01126 }
01127 
01128 
01138 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l01139"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a34" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a34">01139</a> <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::findMult(<font class="keywordtype">int</font> r)<font class="keyword"> const </font>{
01140   <font class="keywordtype">int</font> s=1 ;
01141   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=r;i&gt;deg_+1;--i)
01142     <font class="keywordflow">if</font>(U[i]&lt;=U[i-1])
01143       s++ ;
01144     <font class="keywordflow">else</font>
01145       <font class="keywordflow">return</font> s ;
01146   <font class="keywordflow">return</font> s ;
01147 }
01148 
01164 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l01165"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a33" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a33">01165</a> <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::findMultSpan(T u, <font class="keywordtype">int</font>&amp; r, <font class="keywordtype">int</font>&amp; s)<font class="keyword"> const </font>{
01166   r = <a class="code" href="classPLib_1_1NurbsCurve.html#a35" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a35">findKnot</a>(u) ;
01167   <font class="keywordflow">if</font>(u==U[r]){
01168     s = <a class="code" href="classPLib_1_1NurbsCurve.html#a34" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a34">findMult</a>(r) ;
01169   }
01170   <font class="keywordflow">else</font>
01171     s = 0 ;
01172 }
01173 
01186 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l01187"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">01187</a> <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::resize(<font class="keywordtype">int</font> n, <font class="keywordtype">int</font> Deg){
01188   deg_ = Deg ;
01189   P.resize(n) ;
01190   U.resize(n+deg_+1) ;
01191 }
01192 
01223 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l01224"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a45" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a45">01224</a> <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::leastSquares(<font class="keyword">const</font> Vector&lt; Point_nD&lt;T,N&gt; &gt;&amp; Q, <font class="keywordtype">int</font> degC, <font class="keywordtype">int</font> n){
01225   Vector&lt;T&gt; ub(Q.n()) ;
01226 
01227   <a class="code" href="classPLib_1_1NurbsCurve.html#k0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#k0">chordLengthParam</a>(Q,ub) ;
01228 
01229   <font class="keywordflow">return</font> <a class="code" href="classPLib_1_1NurbsCurve.html#a45" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a45">leastSquares</a>(Q,degC,n,ub) ;
01230 }
01231 
01261 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l01262"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a46" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a46">01262</a> <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::leastSquares(<font class="keyword">const</font> Vector&lt; Point_nD&lt;T,N&gt; &gt;&amp; Q, <font class="keywordtype">int</font> degC, <font class="keywordtype">int</font> n, <font class="keyword">const</font> Vector&lt;T&gt;&amp; ub){
01263   <font class="keywordtype">int</font> i,j;
01264   T d,a ;
01265 
01266   <font class="keywordflow">if</font>(ub.n() != Q.n()){
01267 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
01268 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>(ub.n(),Q.n()) ;
01269 <font class="preprocessor">#else</font>
01270 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"leastSquares"</font>);
01271     err &lt;&lt; <font class="stringliteral">"leastSquaresCurve\n"</font> ;
01272     err &lt;&lt; <font class="stringliteral">"ub size is different than Q's\n"</font> ;
01273     err.fatal() ;
01274 <font class="preprocessor">#endif</font>
01275 <font class="preprocessor"></font>  }
01276 
01277   deg_ = degC ;
01278   U.resize(n+deg_+1) ;
01279 
01280   <font class="comment">// Changing the method to generate a U compare to the one </font>
01281   <font class="comment">// described by Piegl and Tiller in the NURBS book (eq 9.69)</font>
01282 
01283   U.reset(1.0) ;
01284   d = (T)(Q.n())/(T)(n) ; 
01285   <font class="keywordflow">for</font>(j=0;j&lt;=deg_;++j)
01286     U[j] = 0 ;
01287 
01288   <font class="keywordflow">for</font>(j=1;j&lt;n-deg_;++j){
01289     U[deg_+j] = 0.0 ;
01290     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> k=j;k&lt;j+deg_;++k){
01291       i = (int)(k*d) ;
01292       a = T(k*d)-T(i) ;
01293       <font class="keywordtype">int</font> i2 = (int)((k-1)*d) ;
01294       U[deg_+j] += a*ub[i2]+(1-a)*ub[i] ;
01295       }
01296     U[deg_+j] /= deg_ ;
01297   }
01298 
01299   <font class="keywordflow">return</font> <a class="code" href="classPLib_1_1NurbsCurve.html#a45" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a45">leastSquares</a>(Q, degC, n, ub, U) ;
01300 }
01301 
01332 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l01333"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a47" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a47">01333</a> <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::leastSquaresH(<font class="keyword">const</font> Vector&lt; HPoint_nD&lt;T,N&gt; &gt;&amp; Q, <font class="keywordtype">int</font> degC, <font class="keywordtype">int</font> n, <font class="keyword">const</font> Vector&lt;T&gt;&amp; ub){
01334   <font class="keywordtype">int</font> i,j;
01335   T d,a ;
01336 
01337   <font class="keywordflow">if</font>(ub.n() != Q.n()){
01338 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
01339 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>(ub.n(),Q.n()) ;
01340 <font class="preprocessor">#else</font>
01341 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"leastSquares"</font>);
01342     err &lt;&lt; <font class="stringliteral">"leastSquaresCurve\n"</font> ;
01343     err &lt;&lt; <font class="stringliteral">"ub size is different than Q's\n"</font> ;
01344     err.fatal() ;
01345 <font class="preprocessor">#endif</font>
01346 <font class="preprocessor"></font>  }
01347 
01348   deg_ = degC ;
01349   U.resize(n+deg_+1) ;
01350 
01351   <font class="comment">// Changing the method to generate a U compare to the one </font>
01352   <font class="comment">// described by Piegl and Tiller in the NURBS book (eq 9.69)</font>
01353 
01354   U.reset(1.0) ;
01355   d = (T)(Q.n())/(T)(n) ; 
01356   <font class="keywordflow">for</font>(j=0;j&lt;=deg_;++j)
01357     U[j] = 0 ;
01358 
01359   <font class="keywordflow">for</font>(j=1;j&lt;n-deg_;++j){
01360     U[deg_+j] = 0.0 ;
01361     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> k=j;k&lt;j+deg_;++k){
01362       i = (int)(k*d) ;
01363       a = T(k*d)-T(i) ;
01364       <font class="keywordtype">int</font> i2 = (int)((k-1)*d) ;
01365       U[deg_+j] += a*ub[i2]+(1-a)*ub[i] ;
01366       }
01367     U[deg_+j] /= deg_ ;
01368   }
01369 
01370   <font class="keywordflow">return</font> <a class="code" href="classPLib_1_1NurbsCurve.html#a47" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a47">leastSquaresH</a>(Q, degC, n, ub, U) ;
01371 }
01372 
01405 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> D&gt;
<a name="l01406"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a48" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a48">01406</a> <font class="keywordtype">int</font> NurbsCurve&lt;T,D&gt;::leastSquares(<font class="keyword">const</font> Vector&lt; Point_nD&lt;T,D&gt; &gt;&amp; Q, <font class="keywordtype">int</font> degC, <font class="keywordtype">int</font> n, <font class="keyword">const</font> Vector&lt;T&gt;&amp; ub, <font class="keyword">const</font> Vector&lt;T&gt;&amp; knot){
01407   <font class="keywordtype">int</font> i,j,span;
01408   <font class="keyword">const</font> <font class="keywordtype">int</font>&amp; m=Q.n() ;
01409 
01410   <font class="keywordflow">if</font>(ub.n() != Q.n()){
01411 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
01412 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>(ub.n(),Q.n()) ;
01413 <font class="preprocessor">#else</font>
01414 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"leastSquares"</font>);
01415     err &lt;&lt; <font class="stringliteral">"leastSquaresCurve\n"</font> ;
01416     err &lt;&lt; <font class="stringliteral">"ub size is different than Q's\n"</font> ;
01417     err.fatal();
01418 <font class="preprocessor">#endif</font>
01419 <font class="preprocessor"></font>  }
01420 
01421   <font class="keywordflow">if</font>(<a class="code" href="classPLib_1_1NurbsCurve.html#a8" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a8">knot</a>.n() != n+degC+1){
01422 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
01423 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classNurbsSizeError.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classNurbsSizeError.html'" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsSizeError.html">NurbsSizeError</a>(n,<a class="code" href="classPLib_1_1NurbsCurve.html#a8" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a8">knot</a>.n(),degC) ;
01424 <font class="preprocessor">#else</font>
01425 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"leastSquares"</font>);
01426     err &lt;&lt; <font class="stringliteral">"The knot vector supplied doesn't have the proper size.\n"</font> ;
01427     err &lt;&lt; <font class="stringliteral">"It should be n+degC+1 = "</font> &lt;&lt; n+degC+1 &lt;&lt; <font class="stringliteral">" and it is "</font> &lt;&lt; <a class="code" href="classPLib_1_1NurbsCurve.html#a8" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a8">knot</a>.n() &lt;&lt; endl ;
01428     err.fatal() ;
01429 <font class="preprocessor">#endif</font>
01430 <font class="preprocessor"></font>  }
01431 
01432   deg_ = degC ;
01433 
01434   U = <a class="code" href="classPLib_1_1NurbsCurve.html#a8" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a8">knot</a> ;
01435 
01436   P.resize(n) ;
01437 
01438   Vector&lt; Point_nD&lt;T,D&gt; &gt; R(n),rk(m) ; 
01439   Vector&lt;T&gt; funs(deg_+1) ;
01440   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> N(m,n) ;
01441   R[0] = Q[0] ;
01442   R[n-1] = Q[m-1] ;
01443   N(0,0) = 1.0 ;
01444   N(m-1,n-1) = 1.0 ;
01445 
01446   <font class="comment">// Set up N </font>
01447   N(0,0) = 1.0 ;
01448   N(m-1,n-1) = 1.0 ;
01449 
01450   <font class="comment">//  for(i=1;i&lt;m-1;i++){</font>
01451   <font class="keywordflow">for</font>(i=0;i&lt;m;i++){
01452      span = <a class="code" href="classPLib_1_1NurbsCurve.html#a32" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a32">findSpan</a>(ub[i]) ;
01453      <a class="code" href="classPLib_1_1NurbsCurve.html#a28" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a28">basisFuns</a>(ub[i],span,funs);
01454      <font class="keywordflow">for</font>(j=0;j&lt;=deg_;++j){ <font class="comment">// BOOO</font>
01455        <font class="comment">//if(span-deg_+j&gt;0)</font>
01456          N(i,span-deg_+j) = (double)funs[j] ;
01457      }
01458      rk[i] = Q[i]-N(i,0)*Q[0]-N(i,n-1)*Q[m-1] ;  
01459 
01460   }
01461 
01462   <font class="comment">// Set up R</font>
01463   <font class="comment">//  for(i=1;i&lt;n-1;i++){</font>
01464   <font class="keywordflow">for</font>(i=0;i&lt;n;i++){
01465     R[i] = 0.0 ;
01466     <font class="comment">//    for(j=1;j&lt;m-1;j++)</font>
01467     <font class="keywordflow">for</font>(j=0;j&lt;m;j++)
01468       R[i] += N(j,i)*rk[j] ;
01469     <font class="keywordflow">if</font>(R[i].x()*R[i].x()&lt;1e-10 &amp;&amp; 
01470        R[i].y()*R[i].y()&lt;1e-10 &amp;&amp;
01471        R[i].z()*R[i].z()&lt;1e-10)
01472       <font class="keywordflow">return</font> 0 ; 
01473   }
01474 
01475   <font class="comment">// Solve      N^T*N*P = R</font>
01476 
01477   <font class="comment">// must check for the case where we want a curve of degree 1 having</font>
01478   <font class="comment">// only 2 points.</font>
01479   <font class="keywordflow">if</font>(n-2&gt;0){ 
01480     <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> X(n-2,D),B(n-2,D),Ns(m-2,n-2) ;
01481     <font class="keywordflow">for</font>(i=0;i&lt;B.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>();i++){
01482       <font class="keywordflow">for</font>(j=0;j&lt;D;j++)
01483         B(i,j) = (double)R[i+1].data[j] ;
01484     }
01485     Ns = N.<a class="code" href="classPLib_1_1Matrix.html#a8" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html#a8">get</a>(1,1,m-2,n-2) ;
01486     
01487     solve(transpose(Ns)*Ns,B,X) ;
01488 
01489     <font class="keywordflow">for</font>(i=0;i&lt;X.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>();i++){
01490       <font class="keywordflow">for</font>(j=0;j&lt;X.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1">cols</a>();j++)
01491         P[i+1].data[j] = (T)X(i,j) ;
01492       P[i+1].w() = 1.0 ;
01493     }
01494   }
01495   P[0] = Q[0] ;
01496   P[n-1] = Q[m-1] ;
01497   <font class="keywordflow">return</font> 1 ;
01498 }
01499 
01534 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> D&gt;
<a name="l01535"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a49" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a49">01535</a> <font class="keywordtype">int</font> NurbsCurve&lt;T,D&gt;::leastSquaresH(<font class="keyword">const</font> Vector&lt; HPoint_nD&lt;T,D&gt; &gt;&amp; Q, <font class="keywordtype">int</font> degC, <font class="keywordtype">int</font> n, <font class="keyword">const</font> Vector&lt;T&gt;&amp; ub, <font class="keyword">const</font> Vector&lt;T&gt;&amp; knot){
01536   <font class="keywordtype">int</font> i,j,span,m ;
01537 
01538   m = Q.n() ;
01539 
01540   <font class="keywordflow">if</font>(ub.n() != Q.n()){
01541 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
01542 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>(ub.n(),Q.n()) ;
01543 <font class="preprocessor">#else</font>
01544 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"leastSquares"</font>);
01545     err &lt;&lt; <font class="stringliteral">"leastSquaresCurve\n"</font> ;
01546     err &lt;&lt; <font class="stringliteral">"ub size is different than Q's\n"</font> ;
01547     err.fatal();
01548 <font class="preprocessor">#endif</font>
01549 <font class="preprocessor"></font>  }
01550 
01551   <font class="keywordflow">if</font>(<a class="code" href="classPLib_1_1NurbsCurve.html#a8" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a8">knot</a>.n() != n+degC+1){
01552 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
01553 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classNurbsSizeError.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classNurbsSizeError.html'" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsSizeError.html">NurbsSizeError</a>(n,<a class="code" href="classPLib_1_1NurbsCurve.html#a8" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a8">knot</a>.n(),degC) ;
01554 <font class="preprocessor">#else</font>
01555 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"leastSquares"</font>);
01556     err &lt;&lt; <font class="stringliteral">"The knot vector supplied doesn't have the proper size.\n"</font> ;
01557     err &lt;&lt; <font class="stringliteral">"It should be n+degC+1 = "</font> &lt;&lt; n+degC+1 &lt;&lt; <font class="stringliteral">" and it is "</font> &lt;&lt; <a class="code" href="classPLib_1_1NurbsCurve.html#a8" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a8">knot</a>.n() &lt;&lt; endl ;
01558     err.fatal() ;
01559 <font class="preprocessor">#endif</font>
01560 <font class="preprocessor"></font>  }
01561 
01562   deg_ = degC ;
01563 
01564   U = <a class="code" href="classPLib_1_1NurbsCurve.html#a8" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a8">knot</a> ;
01565 
01566   P.resize(n) ;
01567 
01568   Vector&lt; HPoint_nD&lt;T,D&gt; &gt; R(n),rk(m) ; 
01569   Vector&lt;T&gt; funs(deg_+1) ;
01570   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> N(m,n) ;
01571   R[0] = Q[0] ;
01572   R[n-1] = Q[m-1] ;
01573   N(0,0) = 1.0 ;
01574   N(m-1,n-1) = 1.0 ;
01575 
01576   <font class="comment">// Set up N </font>
01577   N(0,0) = 1.0 ;
01578   N(m-1,n-1) = 1.0 ;
01579 
01580   <font class="comment">//  for(i=1;i&lt;m-1;i++){</font>
01581   <font class="keywordflow">for</font>(i=0;i&lt;m;i++){
01582      span = <a class="code" href="classPLib_1_1NurbsCurve.html#a32" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a32">findSpan</a>(ub[i]) ;
01583      <a class="code" href="classPLib_1_1NurbsCurve.html#a28" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a28">basisFuns</a>(ub[i],span,funs);
01584      <font class="keywordflow">for</font>(j=0;j&lt;=deg_;j++){
01585        <font class="comment">//if(span-deg_+j&gt;0)</font>
01586          N(i,span-deg_+j) = (double)funs[j] ;
01587      }
01588      rk[i] = Q[i]-N(i,0)*Q[0]-N(i,n-1)*Q[m-1] ;  
01589 
01590   }
01591 
01592   <font class="comment">// Set up R</font>
01593   <font class="comment">//  for(i=1;i&lt;n-1;i++){</font>
01594   <font class="keywordflow">for</font>(i=0;i&lt;n;i++){
01595     R[i] = 0.0 ;
01596     <font class="comment">//    for(j=1;j&lt;m-1;j++)</font>
01597     <font class="keywordflow">for</font>(j=0;j&lt;m;j++)
01598       R[i] += N(j,i)*rk[j] ;
01599     <font class="keywordflow">if</font>(R[i].x()*R[i].x()&lt;1e-10 &amp;&amp; 
01600        R[i].y()*R[i].y()&lt;1e-10 &amp;&amp;
01601        R[i].z()*R[i].z()&lt;1e-10)
01602       <font class="keywordflow">return</font> 0 ; 
01603   }
01604 
01605   <font class="comment">// Solve      N^T*N*P = R</font>
01606 
01607   <font class="comment">// must check for the case where we want a curve of degree 1 having</font>
01608   <font class="comment">// only 2 points.</font>
01609   <font class="keywordflow">if</font>(n-2&gt;0){ 
01610     <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> X(n-2,D+1),B(n-2,D+1),Ns(m-2,n-2) ;
01611     <font class="keywordflow">for</font>(i=0;i&lt;B.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>();i++){
01612       <font class="keywordflow">for</font>(j=0;j&lt;D+1;j++)
01613         B(i,j) = (double)R[i+1].data[j] ;
01614     }
01615     Ns = N.<a class="code" href="classPLib_1_1Matrix.html#a8" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html#a8">get</a>(1,1,m-2,n-2) ;
01616     
01617     solve(transpose(Ns)*Ns,B,X) ;
01618     
01619     <font class="keywordflow">for</font>(i=0;i&lt;X.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>();i++){
01620       <font class="keywordflow">for</font>(j=0;j&lt;X.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1">cols</a>();j++)
01621         P[i+1].data[j] = (T)X(i,j) ;
01622       P[i+1].w() = 1.0 ;
01623     }
01624   }
01625   P[0] = Q[0] ;
01626   P[n-1] = Q[m-1] ;
01627   <font class="keywordflow">return</font> 1 ;
01628 }
01629 
01647 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l01648"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a36" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a36">01648</a> T NurbsCurve&lt;T,N&gt;::getRemovalBnd(<font class="keywordtype">int</font> r, <font class="keywordtype">int</font> s )<font class="keyword"> const</font>{
01649   Vector&lt; HPoint_nD&lt;T,N&gt; &gt; temp(U.rows()) ;
01650   <font class="keywordtype">int</font> ord = deg_+1 ;
01651   <font class="keywordtype">int</font> last = r-s ;
01652   <font class="keywordtype">int</font> first = r-deg_ ;
01653   <font class="keywordtype">int</font> off ; 
01654   <font class="keywordtype">int</font> i,j,ii,jj ;
01655   T alfi,alfj ;
01656   T u ;
01657 
01658   u = U[r] ;
01659 
01660   off = first-1;
01661   temp[0] = P[off] ;
01662   temp[last+1-off] = P[last+1] ;
01663 
01664   i=first ; j=last ;
01665   ii=1 ; jj=last-off ;
01666 
01667   <font class="keywordflow">while</font>(j-i&gt;0){
01668     alfi = (u-U[i])/(U[i+ord]-U[i]) ;
01669     alfj = (u-U[j])/(U[j+ord]-U[j]) ;
01670     temp[ii] = (P[i]-(1.0-alfi)*temp[ii-1])/alfi ; 
01671     temp[jj] = (P[j]-alfj*temp[jj+1])/(1.0-alfj) ;
01672     ++i ; ++ii ;
01673     --j ; --jj ;
01674   }
01675   <font class="keywordflow">if</font>(j-i&lt;0){
01676     <font class="keywordflow">return</font> distance3D(temp[ii-1],temp[jj+1]) ;
01677   }
01678   <font class="keywordflow">else</font>{
01679     alfi=(u-U[i])/(U[i+ord]-U[i]) ;
01680     <font class="keywordflow">return</font> distance3D(P[i],alfi*temp[ii+1]+(1.0-alfi)*temp[ii-1]) ;
01681   }
01682   
01683 }
01684 
01699 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l01700"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a37" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a37">01700</a> <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::removeKnot(<font class="keywordtype">int</font>  r, <font class="keywordtype">int</font> s, <font class="keywordtype">int</font> num)
01701 {
01702   <font class="keywordtype">int</font> m = U.n() ;
01703   <font class="keywordtype">int</font> ord = deg_+1 ;
01704   <font class="keywordtype">int</font> fout = (2*r-s-deg_)/2 ;
01705   <font class="keywordtype">int</font> last = r-s ;
01706   <font class="keywordtype">int</font> first = r-deg_ ;
01707   T alfi, alfj ;
01708   <font class="keywordtype">int</font> i,j,k,ii,jj,off ;
01709   T u ;
01710 
01711   Vector&lt; HPoint_nD&lt;T,N&gt; &gt; temp( 2*deg_+1 ) ;
01712 
01713   u = U[r] ;
01714 
01715   <font class="keywordflow">if</font>(num&lt;1){
01716 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
01717 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>() ;
01718 <font class="preprocessor">#else   </font>
01719 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"removeKnot"</font>);
01720     err &lt;&lt; <font class="stringliteral">"A knot can only be removed a positive number of times!\n"</font> ;
01721     err &lt;&lt; <font class="stringliteral">"num = "</font> &lt;&lt; num &lt;&lt; endl ;
01722     err.fatal() ;
01723 <font class="preprocessor">#endif</font>
01724 <font class="preprocessor"></font>  }
01725 
01726   <font class="keywordtype">int</font> t;
01727   <font class="keywordflow">for</font>(t=0;t&lt;num;++t){
01728     off = first-1 ;
01729     temp[0] = P[off] ;
01730     temp[last+1-off] = P[last+1] ;
01731     i = first; j = last ;
01732     ii = 1 ; jj = last-off ;
01733     <font class="keywordflow">while</font>(j-i &gt; t){
01734       alfi = (u-U[i])/(U[i+ord+t]-U[i]) ;
01735       alfj = (u-U[j-t])/(U[j+ord]-U[j-t]) ;
01736       temp[ii] = (P[i]-(1.0-alfi)*temp[ii-1])/alfi ;
01737       temp[jj] = (P[j]-alfj*temp[jj+1])/(1.0-alfj) ;
01738       ++i ; ++ii ;
01739       --j ; --jj ;
01740     }
01741     i = first ; j = last ;
01742     <font class="keywordflow">while</font>(j-i&gt;t){
01743       P[i] = temp[i-off] ;
01744       P[j] = temp[j-off] ;
01745       ++i; --j ;
01746     }
01747     --first ; ++last ;
01748   }
01749   <font class="keywordflow">if</font>(t==0) {
01750 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
01751 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsError.html">NurbsError</a>();
01752 <font class="preprocessor">#endif</font>
01753 <font class="preprocessor"></font>    cerr &lt;&lt; <font class="stringliteral">"Major error happening... t==0\n"</font> ;
01754     <font class="keywordflow">return</font> ;
01755   }
01756 
01757   <font class="keywordflow">for</font>(k=r+1; k&lt;m ; ++k)
01758     U[k-t] = U[k] ;
01759   j = fout ; i=j ; <font class="comment">// Pj thru Pi will be overwritten</font>
01760   <font class="keywordflow">for</font>(k=1; k&lt;t; k++)
01761     <font class="keywordflow">if</font>( (k%2) == 1)
01762       ++i ;
01763     <font class="keywordflow">else</font>
01764       --j ;
01765   <font class="keywordflow">for</font>(k=i+1; k&lt;P.n() ; k++) {<font class="comment">// Shift</font>
01766     P[j++] = P[k] ; 
01767   }
01768 
01769   <a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">resize</a>(P.n()-t,deg_) ;
01770 
01771   <font class="keywordflow">return</font> ;
01772 }
01773 
01774 
01786 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l01787"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a38" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a38">01787</a> <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::removeKnotsBound(<font class="keyword">const</font> Vector&lt;T&gt;&amp; ub,
01788                                     Vector&lt;T&gt;&amp; ek, T E){
01789   Vector&lt;T&gt; Br(U.n()) ;
01790   <a class="code" href="classPLib_1_1Vector.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Vector.html">Vector_INT</a> S(U.n()) ;
01791   <a class="code" href="classPLib_1_1Vector.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Vector.html">Vector_INT</a> Nl(U.n());
01792   <a class="code" href="classPLib_1_1Vector.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Vector.html">Vector_INT</a> Nr(U.n());
01793   Vector&lt;T&gt; NewError(ub.n()) ;
01794   Vector&lt;T&gt; temp(ub.n()) ;
01795   <font class="keywordtype">int</font> i,BrMinI ;
01796   <font class="keywordtype">int</font> r,s,Rstart,Rend,k ;
01797   T BrMin,u,Infinity=1e20 ;
01798 
01799   <font class="keywordflow">if</font>(ek.n() != ub.n()){
01800 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
01801 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>(ek.n(),ub.n());
01802 <font class="preprocessor">#else</font>
01803 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"removeKnotsBound"</font>);
01804     err &lt;&lt; <font class="stringliteral">"Error in removeKnotsBoundCurve\n"</font> ;
01805     err &lt;&lt; <font class="stringliteral">"The size of ub and ek mismatch\n"</font> ;
01806     err.fatal() ;
01807 <font class="preprocessor">#endif</font>
01808 <font class="preprocessor"></font>  }
01809 
01810   Br.reset(Infinity) ;
01811   S.<a class="code" href="classPLib_1_1BasicArray.html#a15" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a15">reset</a>(0) ;
01812   s = 1 ;
01813   <font class="keywordflow">for</font>(i=deg_+1;i&lt;P.n();i++){
01814     <font class="keywordflow">if</font>(U[i]&lt;U[i+1]){
01815       Br[i] = <a class="code" href="classPLib_1_1NurbsCurve.html#a36" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a36">getRemovalBnd</a>(i,s) ;
01816       S[i] = s ;
01817       s = 1 ;
01818     }
01819     <font class="keywordflow">else</font> {
01820       Br[i] = Infinity ;
01821       S[i] = 1 ;
01822       s++ ;
01823     }
01824   }
01825 
01826   
01827   <font class="comment">// This might NOT be ok</font>
01828   Nl[0] = 0 ;
01829   Nr.<a class="code" href="classPLib_1_1BasicArray.html#a15" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a15">reset</a>(ub.n()-1) ;
01830   <font class="keywordflow">for</font>(i=0;i&lt;ub.n();i++){
01831     <font class="keywordtype">int</font> span = <a class="code" href="classPLib_1_1NurbsCurve.html#a32" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a32">findSpan</a>(ub[i]);
01832     <font class="keywordflow">if</font>(!Nl[span]){
01833       Nl[span] = i ;
01834     }
01835     <font class="keywordflow">if</font>(i+1&lt;ub.n())
01836       Nr[span] = i+1 ;
01837   }
01838 
01839   <font class="comment">// set up N</font>
01840   <font class="keywordflow">while</font>(1) {
01841     BrMinI = Br.<a class="code" href="classPLib_1_1Vector.html#a15" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Vector.html#a15">minIndex</a>() ;
01842     BrMin = Br[BrMinI] ;
01843 
01844     <font class="keywordflow">if</font>(BrMin == Infinity)
01845       <font class="keywordflow">break</font> ;
01846 
01847     s = S[BrMinI] ;
01848     r = BrMinI ;
01849 
01850     <font class="comment">// Verify the Error for the affected range</font>
01851     Rstart = maximum(r-deg_,deg_+1) ;
01852     Rend = minimum(r+deg_-S[r+deg_]+1,P.n()-1) ;
01853     Rstart = Nl[Rstart] ;
01854     Rend = Nr[Rend] ;
01855 
01856     <font class="keywordtype">int</font> removable ;
01857     removable = 1 ;
01858     <font class="keywordflow">for</font>(i=Rstart;i&lt;=Rend ; i++){
01859       <font class="comment">// Using eqn 9.81, 9.83 and A2.4 to compute NewError[i]</font>
01860       T a ;
01861       s = S[r] ;
01862       <font class="keywordflow">if</font>((deg_+s)%2){
01863         u = ub[i] ;
01864         k = (deg_+s+1)/2 ;
01865         a = U[r]-U[r-k+1] ;
01866         a /= U[r-k+deg_+2]-U[r-k+1] ;
01867         NewError[i] = (1.0-a)*Br[r] * <a class="code" href="classPLib_1_1NurbsCurve.html#a27" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a27">basisFun</a>(u,r-k+1);
01868       }
01869       <font class="keywordflow">else</font>{
01870         u = ub[i] ;
01871         k = (deg_+s)/2 ;
01872         NewError[i] = Br[r] * <a class="code" href="classPLib_1_1NurbsCurve.html#a27" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a27">basisFun</a>(u,r-k);
01873       }
01874       temp[i] = NewError[i] + ek[i];
01875       <font class="keywordflow">if</font>(temp[i]&gt;E){
01876         removable = 0 ;
01877         Br[r] = Infinity ;
01878         <font class="keywordflow">break</font> ;
01879       }
01880     }
01881     <font class="keywordflow">if</font>(removable){
01882       <font class="comment">// Remove the knot</font>
01883       <a class="code" href="classPLib_1_1NurbsCurve.html#a37" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a37">removeKnot</a>(r,S[r],1) ;
01884 
01885       <font class="comment">// update the error</font>
01886       <font class="keywordflow">for</font>(i=Rstart; i&lt;=Rend ; i++)
01887         ek[i] = temp[i] ;
01888 
01889       <font class="comment">// Break if there is no more interior knot</font>
01890       <font class="keywordflow">if</font>(P.n()&lt;=deg_+1){
01891         <font class="keywordflow">break</font> ;
01892       }
01893 
01894       <font class="comment">// Update the new index range for some of the knots </font>
01895       Rstart = Nl[r-deg_-1] ;
01896       Rend = Nr[r-S[r]] ;
01897       <font class="keywordtype">int</font> span, oldspan ;
01898       oldspan = -1 ;
01899       <font class="keywordflow">for</font>(k=Rstart;k&lt;=Rend;k++){
01900         span = <a class="code" href="classPLib_1_1NurbsCurve.html#a32" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a32">findSpan</a>(ub[k]);
01901         <font class="keywordflow">if</font>(span != oldspan){
01902           Nl[span] = k ;
01903         }
01904         <font class="keywordflow">if</font>(k+1&lt;ub.n()) 
01905           Nr[span] = k+1 ; 
01906         oldspan = span ;
01907       }
01908       <font class="keywordflow">for</font>(k=r-S[r]+1;k&lt;Nl.<a class="code" href="classPLib_1_1BasicArray.html#a0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a0">n</a>()-1;k++){ 
01909         Nl[k] = Nl[k+1] ; 
01910         Nr[k] = Nr[k+1] ; 
01911       } 
01912       Nl.<a class="code" href="classPLib_1_1BasicArray.html#a9" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a9">resize</a>(Nl.<a class="code" href="classPLib_1_1BasicArray.html#a0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a0">n</a>()-1) ; <font class="comment">// Shrink Nl </font>
01913       Nr.<a class="code" href="classPLib_1_1BasicArray.html#a9" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a9">resize</a>(Nr.<a class="code" href="classPLib_1_1BasicArray.html#a0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a0">n</a>()-1) ; <font class="comment">// Shrink Nr</font>
01914       <font class="comment">// Update the new error bounds for some of the knots</font>
01915       Rstart = maximum(r-deg_,deg_+1) ;
01916       Rend = minimum(r+deg_-S[r]+1,P.n()) ;
01917       s = S[Rstart] ;
01918       <font class="keywordflow">for</font>(i=Rstart;i&lt;=Rend;i++){
01919         <font class="keywordflow">if</font>(U[i]&lt;U[i+1]){
01920           Br[i] = <a class="code" href="classPLib_1_1NurbsCurve.html#a36" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a36">getRemovalBnd</a>(i,s) ;
01921           S[i] = s ;
01922           s = 1;
01923         }
01924         <font class="keywordflow">else</font> {
01925           Br[i] = Infinity ;
01926           S[i] = 1 ;
01927           s++ ;
01928         }
01929       }
01930       <font class="keywordflow">for</font>(i=Rend+1;i&lt;Br.n()-1;i++){
01931         Br[i] = Br[i+1] ;
01932         S[i] = S[i+1] ;
01933       }
01934       Br.<a class="code" href="classPLib_1_1BasicArray.html#a9" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a9">resize</a>(Br.n()-1) ; <font class="comment">// Shrink Br</font>
01935     }
01936     <font class="keywordflow">else</font>{
01937       Br[r] = Infinity ;
01938     }
01939     
01940   }
01941 
01942 } 
01943  
01970 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l01971"></a><a class="code" href="classPLib_1_1NurbsCurve.html#k0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#k0">01971</a> T chordLengthParam(<font class="keyword">const</font> Vector&lt; Point_nD&lt;T,N&gt; &gt;&amp; Q, Vector&lt;T&gt; &amp;ub){
01972   <font class="keywordtype">int</font> i ;
01973   T d = T(0);
01974 
01975   ub.resize(Q.n()) ;
01976   ub[0] = 0 ; 
01977   <font class="keywordflow">for</font>(i=1;i&lt;ub.n();i++){
01978     d += norm(Q[i]-Q[i-1]) ;
01979   }
01980   <font class="keywordflow">if</font>(d&gt;0){
01981     <font class="keywordflow">for</font>(i=1;i&lt;ub.n()-1;++i){
01982       ub[i] = ub[i-1] + norm(Q[i]-Q[i-1])/d ;
01983     }
01984     ub[ub.n()-1] = 1.0 ; <font class="comment">// In case there is some addition round-off</font>
01985   }
01986   <font class="keywordflow">else</font>{
01987     <font class="keywordflow">for</font>(i=1;i&lt;ub.n()-1;++i)
01988       ub[i] = T(i)/T(ub.n()-1) ;
01989     ub[ub.n()-1] = 1.0 ;
01990   }
01991   <font class="keywordflow">return</font> d ;
01992 }
01993 
02020 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
02021 T chordLengthParamH(<font class="keyword">const</font> Vector&lt; HPoint_nD&lt;T,N&gt; &gt;&amp; Q, Vector&lt;T&gt; &amp;ub){
02022   <font class="keywordtype">int</font> i ;
02023   T d = 0.0 ;
02024 
02025   ub.resize(Q.n()) ;
02026   ub[0] = 0 ; 
02027   <font class="keywordflow">for</font>(i=1;i&lt;ub.n();i++){
02028     d += norm(Q[i]-Q[i-1]) ;
02029   }
02030   <font class="keywordflow">for</font>(i=1;i&lt;ub.n()-1;i++){
02031     ub[i] = ub[i-1] + norm(Q[i]-Q[i-1])/d ;
02032   }
02033   ub[ub.n()-1] = 1.0 ; <font class="comment">// In case there is some addition round-off</font>
02034   <font class="keywordflow">return</font> d ;
02035 }
02036 
02055 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
<a name="l02056"></a><a class="code" href="classPLib_1_1NurbsCurve.html#a55" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a55">02056</a> <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::globalApproxErrBnd(Vector&lt; Point_nD&lt;T,N&gt; &gt;&amp; Q, <font class="keywordtype">int</font> degC, T E){
02057   Vector&lt;T&gt; ub(Q.n()) ;
02058   <a class="code" href="classPLib_1_1NurbsCurve.html#k0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#k0">chordLengthParam</a>(Q,ub) ;
02059 
02060   <a class="code" href="classPLib_1_1NurbsCurve.html#a55" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a55">globalApproxErrBnd</a>(Q,ub,degC,E) ;
02061 }
02062 
02084 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
02085 <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::globalApproxErrBnd(Vector&lt; Point_nD&lt;T,N&gt; &gt;&amp; Q, Vector&lt;T&gt;&amp; ub, <font class="keywordtype">int</font> degC, T E){
02086   Vector&lt;T&gt; ek(Q.n()) ;
02087   Vector&lt;T&gt; Uh(Q.n()) ;
02088   NurbsCurve&lt;T,N&gt; tcurve ;
02089   <font class="keywordtype">int</font> i,j,degL ; 
02090 
02091   <font class="keywordflow">if</font>(ub.n() != Q.n()){
02092 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
02093 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>(ub.n(),Q.n()) ;
02094 <font class="preprocessor">#else</font>
02095 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"globalApproxErrBnd"</font>);
02096     err &lt;&lt; <font class="stringliteral">"The data vector and the parameter vectors are not of the same size!\n"</font> ;
02097     err &lt;&lt; <font class="stringliteral">"Q.n() = "</font> &lt;&lt; Q.n() &lt;&lt; <font class="stringliteral">", ub.n() = "</font> &lt;&lt; ub.n() &lt;&lt; endl ;
02098     err.fatal() ;
02099 <font class="preprocessor">#endif</font>
02100 <font class="preprocessor"></font>  }
02101 
02102   <a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">resize</a>(Q.n(),1) ;
02103 
02104   <font class="comment">// Initialize U</font>
02105   deg_ = 1 ;
02106   <font class="keywordflow">for</font>(i=0;i&lt;ub.n();i++){
02107     U[i+deg_] = ub[i] ;
02108   }
02109   U[0] = 0 ;
02110   U[U.n()-1] = 1.0 ;
02111   <font class="comment">// Initialize P</font>
02112   <font class="keywordflow">for</font>(i=0;i&lt;P.n();i++)
02113     P[i] = Q[i] ;
02114 
02115   <font class="keywordflow">for</font>(degL=1; degL&lt;=degC+1 ; degL++){
02116     <a class="code" href="classPLib_1_1NurbsCurve.html#a38" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a38">removeKnotsBound</a>(ub,ek,E) ;
02117 
02118     <font class="keywordflow">if</font>(degL==degC)
02119       <font class="keywordflow">break</font> ;
02120 
02121     <font class="keywordflow">if</font>(degL&lt;degC){
02122 
02123       <font class="comment">// Find the degree elevated knot vector</font>
02124       Uh.resize(U.n()*2) ;
02125 
02126       Uh[0] = U[0] ;
02127       j = 1 ;
02128       <font class="keywordflow">for</font>(i=1;i&lt;U.n();++i){
02129         <font class="keywordflow">if</font>(U[i]&gt;U[i-1])
02130           Uh[j++] = U[i-1] ;
02131         Uh[j++] = U[i] ;
02132       }
02133       Uh[j++] = U[U.n()-1] ;
02134       Uh.resize(j) ;
02135       tcurve = *<font class="keyword">this</font> ;
02136       <font class="keywordflow">if</font>(!<a class="code" href="classPLib_1_1NurbsCurve.html#a45" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a45">leastSquares</a>(Q,degL+1,Uh.n()-degL-1-1,ub,Uh)){
02137         *<font class="keyword">this</font> = tcurve ;
02138         degreeElevate(1);
02139       }
02140     }
02141     <font class="keywordflow">else</font>{
02142       tcurve = *<font class="keyword">this</font> ;
02143       <font class="keywordflow">if</font>(!<a class="code" href="classPLib_1_1NurbsCurve.html#a45" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a45">leastSquares</a>(Q,degL,P.n(),ub,U)){
02144         *<font class="keyword">this</font> = tcurve ;
02145       }
02146     }
02147 
02148 
02149     <font class="comment">// Project the points from curve to Q and update ek and ub</font>
02150     <font class="comment">//    for(i=0;i&lt;Q.n();i++){</font>
02151     <font class="keywordflow">for</font>(i=0;i&lt;Q.n();i++){
02152       T u_i ;
02153       Point_nD&lt;T,N&gt; r_i ;
02154       projectTo(Q[i],ub[i],u_i,r_i) ;
02155       ek[i] = norm(r_i-Q[i]) ;
02156       ub[i] = u_i ;
02157     }
02158   }
02159 }
02160 
02181 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
02182 <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::globalApproxErrBnd2(Vector&lt; Point_nD&lt;T,N&gt; &gt;&amp; Q,
02183                                        <font class="keywordtype">int</font> degC,
02184                                        T E){
02185   Vector&lt;T&gt; ub(Q.n()) ;
02186   Vector&lt;T&gt; ek(Q.n()) ;
02187   Vector&lt;T&gt; Uh(Q.n()) ;
02188   NurbsCurve&lt;T,N&gt; tcurve ;
02189   <font class="keywordtype">int</font> i,degL ; 
02190 
02191   <a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">resize</a>(Q.n(),1) ;
02192 
02193   <a class="code" href="classPLib_1_1NurbsCurve.html#k0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#k0">chordLengthParam</a>(Q,ub) ;
02194 
02195   <font class="comment">// Initialize U</font>
02196   deg_ = 1 ;
02197   <font class="keywordflow">for</font>(i=0;i&lt;ub.n();i++){
02198     U[i+deg_] = ub[i] ;
02199   }
02200   U[0] = 0 ;
02201   U[U.n()-1] = 1.0 ;
02202   <font class="comment">// Initialize P</font>
02203   <font class="keywordflow">for</font>(i=0;i&lt;P.n();i++)
02204     P[i] = Q[i] ;
02205 
02206   <font class="keywordflow">for</font>(degL=1; degL&lt;degC ; degL++){
02207     degreeElevate(1);
02208 
02209     <font class="comment">// Project the points from curve to Q and update ek and ub</font>
02210     <font class="comment">//    for(i=0;i&lt;Q.n();i++){</font>
02211     <font class="keywordflow">for</font>(i=0;i&lt;Q.n();i++){
02212       T u_i ;
02213       Point_nD&lt;T,N&gt; r_i ;
02214       projectTo(Q[i],ub[i],u_i,r_i) ;
02215       ek[i] = norm(r_i-Q[i]) ;
02216       ub[i] = u_i ;
02217     }
02218     <a class="code" href="classPLib_1_1NurbsCurve.html#a38" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a38">removeKnotsBound</a>(ub,ek,E) ;    
02219   }
02220 }
02221 
02241 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
02242 <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::globalApproxErrBnd3(Vector&lt; Point_nD&lt;T,N&gt; &gt;&amp; Q,<font class="keywordtype">int</font> degC,T E){
02243   <font class="comment">//NurbsCurve&lt;T,N&gt; tCurve(1) ;</font>
02244   Vector&lt;T&gt; ub(Q.n()) ;
02245   Vector&lt;T&gt; ek(Q.n()) ;
02246   <font class="keywordtype">int</font> i ; 
02247 
02248   <a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">resize</a>(Q.n(),1) ;
02249 
02250   <a class="code" href="classPLib_1_1NurbsCurve.html#k0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#k0">chordLengthParam</a>(Q,ub) ;
02251 
02252   <font class="comment">// Initialize U</font>
02253   deg_ = 1 ;
02254   <font class="keywordflow">for</font>(i=0;i&lt;ub.n();i++){
02255     U[i+deg_] = ub[i] ;
02256   }
02257   U[0] = 0 ;
02258   U[U.n()-1] = 1.0 ;
02259 
02260   <font class="comment">// Initialize P</font>
02261   <font class="keywordflow">for</font>(i=0;i&lt;P.n();i++)
02262     P[i] = Q[i] ;
02263   
02264   <font class="comment">//removeKnotsBoundCurve(curve,ub,ek,E/10.0,curve) ;</font>
02265   degreeElevate(degC-1) ;
02266   <a class="code" href="classPLib_1_1NurbsCurve.html#a38" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a38">removeKnotsBound</a>(ub,ek,E) ;
02267 }
02268 
02269 
02290 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
02291 <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::globalApproxErrBnd3(Vector&lt; Point_nD&lt;T,N&gt; &gt;&amp; Q, 
02292                                        <font class="keyword">const</font> Vector&lt;T&gt; &amp;ub,
02293                                        <font class="keywordtype">int</font> degC,
02294                                        T E){
02295   Vector&lt;T&gt; ek(Q.n()) ;
02296   <font class="keywordtype">int</font> i ; 
02297 
02298   <a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">resize</a>(Q.n(),1) ;
02299 
02300   <font class="comment">// Initialize U</font>
02301   deg_ = 1 ;
02302   <font class="keywordflow">for</font>(i=0;i&lt;ub.n();i++){
02303     U[i+deg_] = ub[i] ;
02304   }
02305   U[0] = 0 ;
02306   U[U.n()-1] = 1.0 ;
02307 
02308   <font class="comment">// Initialize P</font>
02309   <font class="keywordflow">for</font>(i=0;i&lt;P.n();i++)
02310     P[i] = Q[i] ;
02311     
02312   degreeElevate(degC-1) ;
02313   <a class="code" href="classPLib_1_1NurbsCurve.html#a38" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a38">removeKnotsBound</a>(ub,ek,E) ;
02314 }
02315 
02316 
02337 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
02338 <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::projectTo(<font class="keyword">const</font> Point_nD&lt;T,N&gt;&amp; p, T guess, T&amp; u, Point_nD&lt;T,N&gt;&amp; r, T e1, T e2,<font class="keywordtype">int</font> maxTry)<font class="keyword"> const</font>{
02339   T un ;
02340   T c1, c2;
02341   Vector&lt; Point_nD&lt;T,N&gt; &gt; Cd ;
02342   Point_nD&lt;T,N&gt; c, cd,cdd,best ;
02343   T best_e ;
02344   <font class="keywordtype">int</font> t = 0 ;
02345   u = guess ;
02346 
02347   <font class="keywordflow">if</font>(u&lt;U[0]) u = U[0] ;
02348   <font class="keywordflow">if</font>(u&gt;U[U.n()-1]) u = U[U.n()-1] ;
02349 
02350   best = <a class="code" href="classPLib_1_1ParaCurve.html#a3" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1ParaCurve.html#a3">pointAt</a>(u);
02351 
02352   <font class="keywordflow">while</font>(1) {
02353     ++t ;
02354     <font class="keywordflow">if</font>(t&gt;maxTry){
02355       r = best ;
02356       <font class="keywordflow">return</font> ;
02357     }
02358     c = <a class="code" href="classPLib_1_1ParaCurve.html#a3" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1ParaCurve.html#a3">pointAt</a>(u) ;
02359     <a class="code" href="classPLib_1_1NurbsCurve.html#a17" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a17">deriveAt</a>(u,2,Cd) ;
02360     cd = Cd[1] ;
02361     cdd = Cd[2] ;
02362     c1 = norm2(c-p) ;
02363 
02364     <font class="keywordflow">if</font>(t==0){
02365       best_e = c1+1;
02366     }
02367 
02368     <font class="keywordflow">if</font>(c1&lt;e1*e1){
02369       r = c ;
02370       <font class="keywordflow">return</font> ;
02371     }
02372     <font class="keywordflow">else</font>{
02373       <font class="keywordflow">if</font>(c1&lt;best_e){
02374         best = c;
02375         best_e = c1;
02376       }
02377     }
02378 
02379     c2 = norm((Point_nD&lt;T,N&gt;)(cd*(c-p))) ;
02380     <font class="comment">//c2 *= c2 ;</font>
02381     c2 /= norm(cd)*norm(c-p) ;
02382     <font class="comment">//if(c2&lt;e2*e2){</font>
02383     <font class="keywordflow">if</font>(c2&lt;e2){
02384       r =c ;
02385       <font class="keywordflow">return</font> ;
02386     }
02387     
02388     un = u- cd*(c-p)/(cdd*(c-p)+norm2(cd)) ;
02389     
02390     <font class="keywordflow">if</font>(un&lt;U[0]) un = U[0] ;
02391     <font class="keywordflow">if</font>(un&gt;U[U.n()-1]) un = U[U.n()-1] ;
02392 
02393     <font class="keywordflow">if</font>(norm2((un-u)*cd)&lt;e1*e1){
02394       r = c ;
02395       <font class="keywordflow">return</font> ;
02396     }
02397     u = un ;
02398   }
02399 }
02400 
02411 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
02412 <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::degreeElevate(<font class="keywordtype">int</font> t){
02413   <font class="keywordflow">if</font>(t&lt;=0){
02414     <font class="keywordflow">return</font> ;
02415   }
02416 
02417   NurbsCurve&lt;T,N&gt; c(*<font class="keyword">this</font>) ;
02418 
02419   <font class="keywordtype">int</font> i,j,k ;
02420   <font class="keywordtype">int</font> n = c.ctrlPnts().n()-1;
02421   <font class="keywordtype">int</font> p = c.deg_ ;
02422   <font class="keywordtype">int</font> m = n+p+1;
02423   <font class="keywordtype">int</font> ph = p+t ;
02424   <font class="keywordtype">int</font> ph2 = ph/2 ;
02425   Matrix&lt;T&gt; bezalfs(p+t+1,p+1) ; <font class="comment">// coefficients for degree elevating the Bezier segment</font>
02426   Vector&lt; HPoint_nD&lt;T,N&gt; &gt; bpts(p+1) ; <font class="comment">// pth-degree Bezier control points of the current segment</font>
02427   Vector&lt; HPoint_nD&lt;T,N&gt; &gt; ebpts(p+t+1) ; <font class="comment">// (p+t)th-degree Bezier control points of the  current segment</font>
02428   Vector&lt; HPoint_nD&lt;T,N&gt; &gt; Nextbpts(p-1) ; <font class="comment">// leftmost control points of the next Bezier segment</font>
02429   Vector&lt;T&gt; alphas(p-1) ; <font class="comment">// knot instertion alphas.</font>
02430 
02431   <font class="comment">// Compute the binomial coefficients</font>
02432   Matrix&lt;T&gt; Bin(ph+1,ph2+1) ;
02433   binomialCoef(Bin) ;
02434 
02435   <font class="comment">// Compute Bezier degree elevation coefficients</font>
02436   T inv,mpi ;
02437   bezalfs(0,0) = bezalfs(ph,p) = 1.0 ;
02438   <font class="keywordflow">for</font>(i=1;i&lt;=ph2;i++){
02439     inv= 1.0/Bin(ph,i) ;
02440     mpi = minimum(p,i) ;
02441     <font class="keywordflow">for</font>(j=maximum(0,i-t); j&lt;=mpi; j++){
02442       bezalfs(i,j) = inv*Bin(p,j)*Bin(t,i-j) ;
02443     }
02444   }
02445 
02446   <font class="keywordflow">for</font>(i=ph2+1;i&lt;ph ; i++){
02447     mpi = minimum(p,i) ;
02448     <font class="keywordflow">for</font>(j=maximum(0,i-t); j&lt;=mpi ; j++)
02449       bezalfs(i,j) = bezalfs(ph-i,p-j) ;
02450   }
02451 
02452   <a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">resize</a>(c.P.n()+c.P.n()*t,ph) ; <font class="comment">// Allocate more control points than necessary</font>
02453 
02454   <font class="keywordtype">int</font> mh = ph ;
02455   <font class="keywordtype">int</font> kind = ph+1 ;
02456   T ua = c.U[0] ;
02457   T ub = 0.0 ;
02458   <font class="keywordtype">int</font> r=-1 ; 
02459   <font class="keywordtype">int</font> oldr ;
02460   <font class="keywordtype">int</font> a = p ;
02461   <font class="keywordtype">int</font> b = p+1 ; 
02462   <font class="keywordtype">int</font> cind = 1 ;
02463   <font class="keywordtype">int</font> rbz,lbz = 1 ; 
02464   <font class="keywordtype">int</font> mul,save,s;
02465   T alf;
02466   <font class="keywordtype">int</font> first, last, kj ;
02467   T den,bet,gam,numer ;
02468 
02469   P[0] = c.P[0] ;
02470   <font class="keywordflow">for</font>(i=0; i &lt;= ph ; i++){
02471     U[i] = ua ;
02472   }
02473 
02474   <font class="comment">// Initialize the first Bezier segment</font>
02475 
02476   <font class="keywordflow">for</font>(i=0;i&lt;=p ;i++) 
02477     bpts[i] = c.P[i] ;
02478 
02479   <font class="keywordflow">while</font>(b&lt;m){ <font class="comment">// Big loop thru knot vector</font>
02480     i=b ;
02481     <font class="keywordflow">while</font>(b&lt;m &amp;&amp; c.U[b] &gt;= c.U[b+1]) <font class="comment">// for some odd reasons... == doesn't work</font>
02482       b++ ;
02483     mul = b-i+1 ; 
02484     mh += mul+t ;
02485     ub = c.U[b] ;
02486     oldr = r ;
02487     r = p-mul ;
02488     <font class="keywordflow">if</font>(oldr&gt;0)
02489       lbz = (oldr+2)/2 ;
02490     <font class="keywordflow">else</font>
02491       lbz = 1 ;
02492     <font class="keywordflow">if</font>(r&gt;0) 
02493       rbz = ph-(r+1)/2 ;
02494     <font class="keywordflow">else</font>
02495       rbz = ph ;
02496     <font class="keywordflow">if</font>(r&gt;0){ <font class="comment">// Insert knot to get Bezier segment</font>
02497       numer = ub-ua ;
02498       <font class="keywordflow">for</font>(k=p;k&gt;mul;k--){
02499         alphas[k-mul-1] = numer/(c.U[a+k]-ua) ;
02500       }
02501       <font class="keywordflow">for</font>(j=1;j&lt;=r;j++){
02502         save = r-j ; s = mul+j ;
02503         <font class="keywordflow">for</font>(k=p;k&gt;=s;k--){
02504           bpts[k] = alphas[k-s] * bpts[k]+(1.0-alphas[k-s])*bpts[k-1] ;
02505         }
02506         Nextbpts[save] = bpts[p] ;
02507       }
02508     }
02509     
02510     <font class="keywordflow">for</font>(i=lbz;i&lt;=ph;i++){ <font class="comment">// Degree elevate Bezier,  only the points lbz,...,ph are used</font>
02511       ebpts[i] = 0.0 ;
02512       mpi = minimum(p,i) ;
02513       <font class="keywordflow">for</font>(j=maximum(0,i-t); j&lt;=mpi ; j++)
02514         ebpts[i] += bezalfs(i,j)*bpts[j] ;
02515     }
02516 
02517     <font class="keywordflow">if</font>(oldr&gt;1){ <font class="comment">// Must remove knot u=c.U[a] oldr times</font>
02518       <font class="comment">// if(oldr&gt;2) // Alphas on the right do not change</font>
02519       <font class="comment">//        alfj = (ua-U[kind-1])/(ub-U[kind-1]) ;</font>
02520       first = kind-2 ; last = kind ;
02521       den = ub-ua ;
02522       bet = (ub-U[kind-1])/den ;
02523       <font class="keywordflow">for</font>(<font class="keywordtype">int</font> tr=1; tr&lt;oldr; tr++){ <font class="comment">// Knot removal loop</font>
02524         i = first ; j = last ;
02525         kj = j-kind+1 ;
02526         <font class="keywordflow">while</font>(j-i&gt;tr){ <font class="comment">// Loop and compute the new control points for one removal step</font>
02527           <font class="keywordflow">if</font>(i&lt;cind){
02528             alf=(ub-U[i])/(ua-U[i]) ;
02529             P[i] = alf*P[i] + (1.0-alf)*P[i-1] ;
02530           }
02531           <font class="keywordflow">if</font>( j&gt;= lbz){
02532             <font class="keywordflow">if</font>(j-tr &lt;= kind-ph+oldr){
02533               gam = (ub-U[j-tr])/den ;
02534               ebpts[kj] = gam*ebpts[kj] + (1.0-gam)*ebpts[kj+1] ;
02535             }
02536             <font class="keywordflow">else</font>{
02537               ebpts[kj] = bet*ebpts[kj]+(1.0-bet)*ebpts[kj+1] ;
02538             }
02539           }
02540           ++i ; --j; --kj ;
02541         }
02542         --first ; ++last ;
02543       }
02544     }
02545 
02546     <font class="keywordflow">if</font>(a!=p) <font class="comment">// load the knot u=c.U[a]</font>
02547       <font class="keywordflow">for</font>(i=0;i&lt;ph-oldr; i++){
02548         U[kind++] = ua ; 
02549       }
02550     <font class="keywordflow">for</font>(j=lbz; j&lt;=rbz ; j++) { <font class="comment">// load control points onto the curve</font>
02551       P[cind++] = ebpts[j] ; 
02552     }
02553 
02554     <font class="keywordflow">if</font>(b&lt;m){ <font class="comment">// Set up for next pass thru loop</font>
02555       <font class="keywordflow">for</font>(j=0;j&lt;r;j++)
02556         bpts[j] = Nextbpts[j] ;
02557       <font class="keywordflow">for</font>(j=r;j&lt;=p;j++)
02558         bpts[j] = c.P[b-p+j] ;
02559       a=b ; 
02560       b++ ;
02561       ua = ub ;
02562     }
02563     <font class="keywordflow">else</font>{
02564       <font class="keywordflow">for</font>(i=0;i&lt;=ph;i++)
02565         U[kind+i] = ub ;
02566     }
02567   }
02568   <a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">resize</a>(mh-ph,ph) ; <font class="comment">// Resize to the proper number of control points</font>
02569 }
02570 
02589 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
02590 <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::knotInsertion(T u, <font class="keywordtype">int</font> r,NurbsCurve&lt;T,N&gt;&amp; nc){
02591   <font class="comment">// Compute k and s      u = [ u_k , u_k+1)  with u_k having multiplicity s</font>
02592   <font class="keywordtype">int</font> k=0,s=0 ;
02593   <font class="keywordtype">int</font> i,j ;
02594   <font class="keywordtype">int</font> p = deg_ ;
02595 
02596   <font class="keywordflow">if</font>(u&lt;U[deg_] || u&gt;U[P.n()]){
02597 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
02598 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsError.html">NurbsError</a>();
02599 <font class="preprocessor">#else</font>
02600 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"knotInsertion"</font>);
02601     err &lt;&lt; <font class="stringliteral">"The parametric value isn't inside a valid range."</font> ; 
02602     err &lt;&lt; <font class="stringliteral">"The valid range is between "</font> &lt;&lt; U[deg_] &lt;&lt; <font class="stringliteral">" and "</font> &lt;&lt; U[P.n()] &lt;&lt; endl ;
02603     err.fatal();
02604 <font class="preprocessor">#endif</font>
02605 <font class="preprocessor"></font>  }
02606   
02607   <font class="keywordflow">for</font>(i=0;i&lt;U.n();i++){
02608     <font class="keywordflow">if</font>(U[i]&gt;u) {
02609       k = i-1 ;
02610       <font class="keywordflow">break</font> ;
02611     }
02612   }
02613 
02614   <font class="keywordflow">if</font>(u&lt;=U[k]){
02615     s = 1 ;
02616     <font class="keywordflow">for</font>(i=k;i&gt;deg_;i--){
02617       <font class="keywordflow">if</font>(U[i]&lt;=U[i-1])
02618         s++ ;
02619       <font class="keywordflow">else</font>
02620         <font class="keywordflow">break</font> ;
02621     }
02622   }
02623   <font class="keywordflow">else</font>{
02624     s=0 ;
02625   }
02626 
02627   <font class="keywordflow">if</font>((r+s)&gt;p+1)
02628     r = p+1-s ;
02629 
02630   <font class="keywordflow">if</font>(r&lt;=0)
02631     <font class="keywordflow">return</font> 0 ; 
02632 
02633   nc.resize(P.n()+r,deg_) ;
02634 
02635   <font class="comment">// Load new knot vector</font>
02636   <font class="keywordflow">for</font>(i=0;i&lt;=k;i++)
02637     nc.U[i] = U[i] ;
02638   <font class="keywordflow">for</font>(i=1;i&lt;=r;i++)
02639     nc.U[k+i] = u ;
02640   <font class="keywordflow">for</font>(i=k+1;i&lt;U.n(); i++)
02641     nc.U[i+r] = U[i] ;
02642 
02643   <font class="comment">// Save unaltered control points</font>
02644   Vector&lt; HPoint_nD&lt;T,N&gt; &gt; R(p+1) ;
02645 
02646   <font class="keywordflow">for</font>(i=0; i&lt;=k-p ; i++)
02647     nc.P[i] = P[i] ;
02648   <font class="keywordflow">for</font>(i=k-s ; i&lt; P.n() ; i++)
02649     nc.P[i+r] = P[i] ;
02650   <font class="keywordflow">for</font>(i=0; i&lt;=p-s; i++)
02651     R[i] = P[k-p+i] ;
02652 
02653   <font class="comment">// Insert the knot r times</font>
02654   <font class="keywordtype">int</font> L=0 ;
02655   T alpha ;
02656   <font class="keywordflow">for</font>(j=1; j&lt;=r ; j++){
02657     L = k-p+j ;
02658     <font class="keywordflow">for</font>(i=0;i&lt;=p-j-s;i++){
02659       alpha = (u-U[L+i])/(U[i+k+1]-U[L+i]) ;
02660       R[i] = alpha*R[i+1] + (1.0-alpha)*R[i] ;
02661     }
02662     nc.P[L] = R[0] ;
02663     <font class="keywordflow">if</font>(p-j-s &gt; 0)
02664       nc.P[k+r-j-s] = R[p-j-s] ;
02665   }
02666 
02667   <font class="comment">// Load remaining control points</font>
02668   <font class="keywordflow">for</font>(i=L+1; i&lt;k-s ; i++){
02669     nc.P[i] = R[i-L] ;
02670   }
02671   <font class="keywordflow">return</font> r ; 
02672 }
02673 
02684 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
02685 <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::refineKnotVector(<font class="keyword">const</font> Vector&lt;T&gt;&amp; X){
02686   <font class="keywordtype">int</font> n = P.n()-1 ;
02687   <font class="keywordtype">int</font> p = deg_ ;
02688   <font class="keywordtype">int</font> m = n+p+1 ;
02689   <font class="keywordtype">int</font> a,b ;
02690   <font class="keywordtype">int</font> r = X.n()-1 ;
02691 
02692   NurbsCurve&lt;T,N&gt; c(*<font class="keyword">this</font>) ;
02693 
02694   <a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">resize</a>(r+1+n+1,p) ;
02695 
02696   a = c.findSpan(X[0]) ;
02697   b = c.findSpan(X[r]) ;
02698   ++b ;
02699   <font class="keywordtype">int</font> j ;
02700   <font class="keywordflow">for</font>(j=0; j&lt;=a-p ; j++)
02701     P[j] = c.P[j] ;
02702   <font class="keywordflow">for</font>(j = b-1 ; j&lt;=n ; j++)
02703     P[j+r+1] = c.P[j] ;
02704   <font class="keywordflow">for</font>(j=0; j&lt;=a ; j++)
02705     U[j] = c.U[j] ;
02706   <font class="keywordflow">for</font>(j=b+p ; j&lt;=m ; j++)
02707     U[j+r+1] = c.U[j] ;
02708   <font class="keywordtype">int</font> i = b+p-1 ; 
02709   <font class="keywordtype">int</font> k = b+p+r ;
02710   <font class="keywordflow">for</font>(j=r; j&gt;=0 ; j--){
02711     <font class="keywordflow">while</font>(X[j] &lt;= c.U[i] &amp;&amp; i&gt;a){
02712       P[k-p-1] = c.P[i-p-1] ;
02713       U[k] = c.U[i] ;
02714       --k ;
02715       --i ;
02716     }
02717     P[k-p-1] = P[k-p] ;
02718     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> l=1; l&lt;=p ; l++){
02719       <font class="keywordtype">int</font> ind = k-p+l ;
02720       T alpha = U[k+l] - X[j] ;
02721       <font class="keywordflow">if</font>(alpha==0.0)
02722         P[ind-1] = P[ind] ;
02723       <font class="keywordflow">else</font>
02724         alpha /= U[k+l]-c.U[i-p+l] ;
02725       P[ind-1] = alpha*P[ind-1] + (1.0-alpha)*P[ind] ;
02726     }
02727     U[k] = X[j] ;
02728     --k ;
02729   }
02730 }
02731 
02743 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
02744 <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::globalInterp(<font class="keyword">const</font> Vector&lt; Point_nD&lt;T,N&gt; &gt;&amp; Q, <font class="keywordtype">int</font> d){
02745   Vector&lt;T&gt; ub ;
02746   <a class="code" href="classPLib_1_1NurbsCurve.html#k0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#k0">chordLengthParam</a>(Q,ub) ;
02747   globalInterp(Q,ub,d) ;
02748 }
02749 
02765 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> D&gt;
02766 <font class="keywordtype">void</font> NurbsCurve&lt;T,D&gt;::globalInterp(<font class="keyword">const</font> Vector&lt; Point_nD&lt;T,D&gt; &gt;&amp; Q, <font class="keyword">const</font> Vector&lt;T&gt;&amp; ub, <font class="keywordtype">int</font> d){
02767   <font class="keywordtype">int</font> i,j ;
02768 
02769   <font class="keywordflow">if</font>(d&lt;=0){
02770 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
02771 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>() ;
02772 <font class="preprocessor">#else</font>
02773 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"globalInterp"</font>);
02774     err &lt;&lt; <font class="stringliteral">"The degree specified is equal or smaller than 0\n"</font> ;
02775     err &lt;&lt; <font class="stringliteral">"deg = "</font> &lt;&lt; deg_ &lt;&lt; endl ;
02776     err.fatal() ;
02777 <font class="preprocessor">#endif</font>
02778 <font class="preprocessor"></font>  }
02779   <font class="keywordflow">if</font>(d&gt;=Q.n()){
02780 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
02781 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>() ;
02782 <font class="preprocessor">#else</font>
02783 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"globalInterp"</font>);
02784     err &lt;&lt; <font class="stringliteral">"The degree specified is greater then Q.n()+1\n"</font> ;
02785     err &lt;&lt; <font class="stringliteral">"Q.n() = "</font> &lt;&lt; Q.n() &lt;&lt; <font class="stringliteral">", and deg = "</font> &lt;&lt; deg_ &lt;&lt; endl ;
02786     err.warning() ;
02787     d = Q.n()-1 ;
02788 <font class="preprocessor">#endif</font>
02789 <font class="preprocessor"></font>  }
02790 
02791 
02792   <a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">resize</a>(Q.n(),d) ;
02793   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> A(Q.n(),Q.n()) ;
02794 
02795   knotAveraging(ub,d,U) ;
02796 
02797   <font class="comment">// Initialize the basis matrix A</font>
02798   Vector&lt;T&gt; N(deg_+1) ;
02799   
02800   <font class="keywordflow">for</font>(i=1;i&lt;Q.n()-1;i++){
02801     <font class="keywordtype">int</font> span = <a class="code" href="classPLib_1_1NurbsCurve.html#a32" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a32">findSpan</a>(ub[i]);
02802     <a class="code" href="classPLib_1_1NurbsCurve.html#a28" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a28">basisFuns</a>(ub[i],span,N) ;
02803     <font class="keywordflow">for</font>(j=0;j&lt;=deg_;j++) 
02804         A(i,span-deg_+j) = (double)N[j] ;
02805   }
02806   A(0,0)  = 1.0 ;
02807   A(Q.n()-1,Q.n()-1) = 1.0 ;
02808 
02809   <font class="comment">// Init matrix for LSE</font>
02810   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> qq(Q.n(),D) ;
02811   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> xx(Q.n(),D) ;
02812   <font class="keywordflow">for</font>(i=0;i&lt;Q.n();i++){
02813     <font class="keyword">const</font> Point_nD&lt;T,D&gt;&amp; qp = Q[i] ; <font class="comment">// this makes the SGI compiler happy</font>
02814     <font class="keywordflow">for</font>(j=0; j&lt;D;j++)
02815       qq(i,j) = (double)qp.data[j] ;
02816   }
02817 
02818   solve(A,qq,xx) ;
02819 
02820   <font class="comment">// Store the data</font>
02821   <font class="keywordflow">for</font>(i=0;i&lt;xx.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>();i++){
02822     <font class="keywordflow">for</font>(j=0;j&lt;D;j++)
02823       P[i].data[j] = (T)xx(i,j) ;
02824     P[i].w() = 1.0 ;
02825   }
02826 
02827 }
02828 
02858 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> nD&gt;
02859 <font class="keywordtype">void</font> NurbsCurve&lt;T,nD&gt;::globalInterpD(<font class="keyword">const</font> Vector&lt; Point_nD&lt;T,nD&gt; &gt;&amp; Q, <font class="keyword">const</font> Vector&lt; Point_nD&lt;T,nD&gt; &gt;&amp; D, <font class="keywordtype">int</font> d, <font class="keywordtype">int</font> unitD, T a){
02860   <font class="keywordtype">int</font> i,j,n ;
02861 
02862   <font class="keywordflow">if</font>(d&lt;=1){
02863 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
02864 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>() ;
02865 <font class="preprocessor">#else</font>
02866 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"globalInterpD"</font>);
02867     err &lt;&lt; <font class="stringliteral">"The degree specified is equal or smaller than 1\n"</font> ;
02868     err &lt;&lt; <font class="stringliteral">"deg = "</font> &lt;&lt; deg_ &lt;&lt; endl ;
02869     err.fatal() ;
02870 <font class="preprocessor">#endif</font>
02871 <font class="preprocessor"></font>  }
02872   <font class="keywordflow">if</font>(d&gt;=Q.n()){
02873 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
02874 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>() ;
02875 <font class="preprocessor">#else</font>
02876 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"globalInterpD"</font>);
02877     err &lt;&lt; <font class="stringliteral">"The degree specified is greater then Q.n()+1\n"</font> ;
02878     err &lt;&lt; <font class="stringliteral">"Q.n() = "</font> &lt;&lt; Q.n() &lt;&lt; <font class="stringliteral">", and deg = "</font> &lt;&lt; deg_ &lt;&lt; endl ;
02879     err.warning() ;
02880     d = Q.n()-1 ;
02881 <font class="preprocessor">#endif</font>
02882 <font class="preprocessor"></font>  }
02883   <font class="keywordflow">if</font>(a&lt;=0){
02884 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
02885 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>() ;
02886 <font class="preprocessor">#else</font>
02887 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"globalInterpD"</font>);
02888     err &lt;&lt; <font class="stringliteral">"The a value must be greater than 0\n"</font> ;
02889     err &lt;&lt; <font class="stringliteral">"It is presently "</font> &lt;&lt; a &lt;&lt; endl ;
02890     err.fatal() ;
02891 <font class="preprocessor">#endif</font>
02892 <font class="preprocessor"></font>  }
02893   <font class="keywordflow">if</font>(Q.n() != D.n()){
02894 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
02895 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>(Q.n(),D.n()) ;
02896 <font class="preprocessor">#else</font>
02897 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"globalInterpD"</font>) ;
02898     err &lt;&lt; <font class="stringliteral">"The number of points to interpolate is different than\n the number of derivative points.\n"</font> ;
02899     err &lt;&lt; <font class="stringliteral">"Q.n() = "</font> &lt;&lt; Q.n() &lt;&lt; <font class="stringliteral">", D.n() = "</font> &lt;&lt; D.n() &lt;&lt; endl ;
02900     err.fatal() ;
02901 <font class="preprocessor">#endif</font>
02902 <font class="preprocessor"></font>  }
02903 
02904   deg_ = d ;
02905   n = 2*Q.n() ; 
02906 
02907   <a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">resize</a>(n,deg_) ;
02908 
02909   Vector&lt;T&gt; ub(Q.n()) ;
02910 
02911   T chordLength ;
02912 
02913   chordLength = <a class="code" href="classPLib_1_1NurbsCurve.html#k0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#k0">chordLengthParam</a>(Q,ub) ;
02914 
02915   <font class="keywordflow">if</font>(unitD)
02916     chordLength *= a ;
02917 
02918   <font class="comment">// Setup up knot vector</font>
02919   <font class="keywordflow">switch</font>(deg_){
02920   <font class="keywordflow">case</font> 2:
02921     {
02922       <font class="keywordflow">for</font>(i=0;i&lt;=deg_;++i){
02923         U[i] = T(0) ; 
02924         U[U.n()-1-i] = T(1) ; 
02925       }
02926       <font class="keywordflow">for</font>(i=0;i&lt;ub.n()-1;++i){
02927         U[2*i+deg_] = ub[i] ;
02928         U[2*i+deg_+1] = (ub[i]+ub[i+1])/T(2) ;
02929       }
02930       <font class="keywordflow">break</font> ; 
02931     }
02932   <font class="keywordflow">case</font> 3: 
02933     {
02934       <font class="keywordflow">for</font>(i=0;i&lt;=deg_;++i){
02935         U[i] = T(0) ; 
02936         U[U.n()-1-i] = T(1) ; 
02937       }
02938       <font class="keywordflow">for</font>(i=1;i&lt;ub.n()-1;++i){
02939         U[deg_+2*i] = (2*ub[i]+ub[i+1])/T(3) ;
02940         U[deg_+2*i+1] = (ub[i]+2*ub[i+1])/T(3) ;
02941       }
02942       U[4] = ub[1]/T(2);
02943       U[U.n()-deg_-2] = (ub[ub.n()-1]+T(1))/T(2) ;
02944     }
02945   <font class="keywordflow">default</font>:
02946     {
02947       Vector&lt;T&gt; ub2(2*Q.n()) ; 
02948       <font class="keywordflow">for</font>(i=0;i&lt;ub.n()-1;++i){
02949         ub2[2*i] = ub[i] ;
02950         ub2[2*i+1] = (ub[i]+ub[i+1])/2.0 ;
02951       }
02952       
02953       ub2[ub2.n()-2] = (ub2[ub2.n()-1]+ub2[ub2.n()-3])/2.0 ;
02954       knotAveraging(ub2,deg_,U) ;
02955     }
02956   }
02957 
02958   <font class="comment">// Initialize the basis matrix A</font>
02959   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> A(n,n) ;
02960   Vector&lt;T&gt; N(deg_+1) ;
02961   Matrix&lt;T&gt; Nd(1,1) ;
02962 
02963   <font class="keywordflow">for</font>(i=1;i&lt;Q.n()-1;i++){
02964     <font class="keywordtype">int</font> span = <a class="code" href="classPLib_1_1NurbsCurve.html#a32" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a32">findSpan</a>(ub[i]);
02965     <a class="code" href="classPLib_1_1NurbsCurve.html#a28" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a28">basisFuns</a>(ub[i],span,N) ;
02966     <a class="code" href="classPLib_1_1NurbsCurve.html#a29" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a29">dersBasisFuns</a>(1,ub[i],span,Nd) ;
02967     <font class="keywordflow">for</font>(j=0;j&lt;=deg_;j++) {
02968         A(2*i,span-deg_+j) = (double)N[j] ;
02969         A(2*i+1,span-deg_+j) = (double)Nd(1,j) ;
02970     }
02971   }
02972   A(0,0)  = 1.0 ;
02973   A(1,0) = -1.0 ;
02974   A(1,1) = 1.0 ;
02975   A(A.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>()-2,A.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1">cols</a>()-2) = -1.0 ;
02976   A(A.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>()-2,A.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1">cols</a>()-1) = 1.0 ;
02977   A(A.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>()-1,A.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1">cols</a>()-1) = 1.0 ;
02978 
02979   <font class="comment">// Init matrix for LSE</font>
02980   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> qq(n,nD) ;
02981   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> xx(n,nD) ;
02982   <font class="keywordflow">for</font>(i=0;i&lt;Q.n();i++){
02983     <font class="keyword">const</font> Point_nD&lt;T,nD&gt;&amp; qp = Q[i] ; <font class="comment">// this makes the SGI compiler happy</font>
02984     <font class="keyword">const</font> Point_nD&lt;T,nD&gt;&amp; dp = D[i] ;
02985     <font class="keywordflow">for</font>(j=0; j&lt;nD;j++){
02986       qq(2*i,j) = (double)qp.data[j] ;
02987       qq(2*i+1,j) = (double)dp.data[j] ;
02988       <font class="keywordflow">if</font>(unitD)
02989         qq(2*i+1,j) *= chordLength ;
02990     }
02991   }
02992 
02993   T d0Factor = U[deg_+1]/deg_ ;
02994   T dnFactor = (1-U[U.n()-deg_-2])/deg_ ;
02995 
02996   <font class="comment">// the following three assignment must be made to make the SGI compiler</font>
02997   <font class="comment">// a happy compiler</font>
02998   <font class="keyword">const</font> Point_nD&lt;T,nD&gt;&amp; dp0 = D[0] ;
02999   <font class="keyword">const</font> Point_nD&lt;T,nD&gt;&amp; dpn = D[D.n()-1] ;
03000   <font class="keyword">const</font> Point_nD&lt;T,nD&gt;&amp; qpn = Q[Q.n()-1] ;
03001   <font class="keywordflow">for</font>(j=0;j&lt;nD;++j){
03002     qq(1,j) = d0Factor*double(dp0.data[j]) ;
03003     qq(A.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1">cols</a>()-2,j) = dnFactor*double(dpn.data[j]) ;
03004     <font class="keywordflow">if</font>(unitD){
03005       qq(1,j) *= chordLength ;
03006       qq(A.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1">cols</a>()-2,j) *= chordLength ;
03007     }
03008     qq(A.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1">cols</a>()-1,j) = double(qpn.data[j]) ;
03009   }
03010 
03011   <font class="keywordflow">if</font>(!solve(A,qq,xx)){
03012 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
03013 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsError.html">NurbsError</a>();
03014 <font class="preprocessor">#else</font>
03015 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"globablInterpD"</font>);
03016     err &lt;&lt; <font class="stringliteral">"The matrix couldn't not be solved properly. There is no valid"</font>
03017       <font class="stringliteral">" solutions for the input parameters you gave OR there is a "</font>
03018       <font class="stringliteral">" computational error (using double float might solve the problem)."</font>;
03019     err.warning();
03020 <font class="preprocessor">#endif</font>
03021 <font class="preprocessor"></font>  }
03022 
03023   <font class="comment">// Store the data</font>
03024   <font class="keywordflow">for</font>(i=0;i&lt;xx.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>();i++){
03025     <font class="keywordflow">for</font>(j=0;j&lt;nD;j++)
03026       P[i].data[j] = (T)xx(i,j) ;
03027     P[i].w() = 1.0 ;
03028   }
03029 
03030   P[0] = Q[0] ;
03031   P[P.n()-1] = Q[Q.n()-1] ;
03032 }
03033 
03047 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> D&gt;
03048 <font class="keywordtype">void</font> NurbsCurve&lt;T,D&gt;::globalInterpH(<font class="keyword">const</font> Vector&lt; HPoint_nD&lt;T,D&gt; &gt;&amp; Q, <font class="keywordtype">int</font> d){
03049   <font class="keywordtype">int</font> i,j ;
03050 
03051   <a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">resize</a>(Q.n(),d) ;
03052   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> A(Q.n(),Q.n()) ;
03053   Vector&lt;T&gt; ub(Q.n()) ;
03054 
03055   chordLengthParamH(Q,ub) ;
03056 
03057   <font class="comment">// Setup the Knot Vector for the curve</font>
03058   <font class="keywordflow">for</font>(i=0;i&lt;=deg_;i++)
03059     U[i] = 0 ;
03060   <font class="keywordflow">for</font>(i=P.n(); i&lt;U.n(); i++)
03061     U[i] = 1.0 ;
03062   <font class="keywordflow">for</font>(j=1; j&lt;Q.n()-deg_ ; j++){
03063     T t=0 ;
03064     <font class="keywordflow">for</font>(i=j; i&lt; j+deg_ ; i++)
03065       t += ub[i] ;
03066     U[j+deg_] = t/(T)deg_ ;
03067   }
03068   
03069   <font class="comment">// Initialize the basis matrix A</font>
03070   Vector&lt;T&gt; N(deg_+1) ;
03071 
03072   <font class="keywordflow">for</font>(i=1;i&lt;Q.n()-1;i++){
03073     <font class="keywordtype">int</font> span = <a class="code" href="classPLib_1_1NurbsCurve.html#a32" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a32">findSpan</a>(ub[i]);
03074     <a class="code" href="classPLib_1_1NurbsCurve.html#a28" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a28">basisFuns</a>(ub[i],span,N) ;
03075     <font class="keywordflow">for</font>(j=0;j&lt;=deg_;j++) 
03076         A(i,span-deg_+j) = (double)N[j] ;
03077   }
03078   A(0,0)  = 1.0 ;
03079   A(Q.n()-1,Q.n()-1) = 1.0 ;
03080 
03081   <font class="comment">// Init matrix for LSE</font>
03082   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> qq(Q.n(),D+1) ;
03083   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> xx(Q.n(),D+1) ;
03084   <font class="keywordflow">for</font>(i=0;i&lt;Q.n();i++)
03085     <font class="keywordflow">for</font>(j=0; j&lt;D+1;j++)
03086       qq(i,j) = (double)Q[i].data[j] ;
03087 
03088   solve(A,qq,xx) ;
03089 
03090   <font class="comment">// Store the data</font>
03091   <font class="keywordflow">for</font>(i=0;i&lt;xx.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>();i++){
03092     <font class="keywordflow">for</font>(j=0;j&lt;D+1;j++)
03093       P[i].data[j] = (T)xx(i,j) ;
03094   }
03095 
03096 }
03097 
03113 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> D&gt;
03114 <font class="keywordtype">void</font> NurbsCurve&lt;T,D&gt;::globalInterpH(<font class="keyword">const</font> Vector&lt; HPoint_nD&lt;T,D&gt; &gt;&amp; Q, <font class="keyword">const</font> Vector&lt;T&gt;&amp; Uc, <font class="keywordtype">int</font> d){
03115   <font class="keywordtype">int</font> i,j ;
03116 
03117   <a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">resize</a>(Q.n(),d) ;
03118   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> A(Q.n(),Q.n()) ;
03119   Vector&lt;T&gt; ub(Q.n()) ;
03120 
03121   <font class="keywordflow">if</font>(Uc.n() != U.n()){
03122 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
03123 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>(Uc.n(),U.n()) ;
03124 <font class="preprocessor">#else</font>
03125 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"globalInterp"</font>);
03126     err &lt;&lt; <font class="stringliteral">"Invalid dimension for the given Knot vector.\n"</font> ;
03127     err &lt;&lt; <font class="stringliteral">"U required = "</font> &lt;&lt; U.n() &lt;&lt; <font class="stringliteral">", U given = "</font> &lt;&lt; Uc.n() &lt;&lt; endl ;
03128     err.fatal() ;
03129 <font class="preprocessor">#endif</font>
03130 <font class="preprocessor"></font>  }
03131   U = Uc ;
03132   chordLengthParamH(Q,ub) ;
03133   
03134   <font class="comment">// Initialize the basis matrix A</font>
03135   Vector&lt;T&gt; N(deg_+1) ;
03136 
03137   <font class="keywordflow">for</font>(i=1;i&lt;Q.n()-1;i++){
03138     <font class="keywordtype">int</font> span = <a class="code" href="classPLib_1_1NurbsCurve.html#a32" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a32">findSpan</a>(ub[i]);
03139     <a class="code" href="classPLib_1_1NurbsCurve.html#a28" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a28">basisFuns</a>(ub[i],span,N) ;
03140     <font class="keywordflow">for</font>(j=0;j&lt;=deg_;j++) 
03141         A(i,span-deg_+j) = (double)N[j] ;
03142   }
03143   A(0,0)  = 1.0 ;
03144   A(Q.n()-1,Q.n()-1) = 1.0 ;
03145 
03146   <font class="comment">// Init matrix for LSE</font>
03147   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> qq(Q.n(),D+1) ;
03148   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> xx(Q.n(),D+1) ;
03149   <font class="keywordflow">for</font>(i=0;i&lt;Q.n();i++)
03150     <font class="keywordflow">for</font>(j=0; j&lt;D+1;j++)
03151       qq(i,j) = (double)Q[i].data[j] ;
03152 
03153   solve(A,qq,xx) ;
03154 
03155   <font class="comment">// Store the data</font>
03156   <font class="keywordflow">for</font>(i=0;i&lt;xx.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>();i++){
03157     <font class="keywordflow">for</font>(j=0;j&lt;D+1;j++)
03158       P[i].data[j] = (T)xx(i,j) ;
03159   }
03160 
03161 }
03162 
03182 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> D&gt;
03183 <font class="keywordtype">void</font> NurbsCurve&lt;T,D&gt;::globalInterpH(<font class="keyword">const</font> Vector&lt; HPoint_nD&lt;T,D&gt; &gt;&amp; Q, <font class="keyword">const</font> Vector&lt;T&gt;&amp; ub, <font class="keyword">const</font> Vector&lt;T&gt;&amp; Uc, <font class="keywordtype">int</font> d){
03184   <font class="keywordtype">int</font> i,j ;
03185 
03186   <a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">resize</a>(Q.n(),d) ;
03187   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> A(Q.n(),Q.n()) ;
03188 
03189   <font class="keywordflow">if</font>(Uc.n() != U.n()){
03190 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
03191 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>(Uc.n(),U.n()) ;
03192 <font class="preprocessor">#else</font>
03193 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"globalInterp"</font>);
03194     err &lt;&lt; <font class="stringliteral">"Invalid dimension for the given Knot vector.\n"</font> ;
03195     err &lt;&lt; <font class="stringliteral">"U required = "</font> &lt;&lt; U.n() &lt;&lt; <font class="stringliteral">", U given = "</font> &lt;&lt; Uc.n() &lt;&lt; endl ;
03196     err.fatal() ;
03197 <font class="preprocessor">#endif</font>
03198 <font class="preprocessor"></font>  }
03199   U = Uc ;
03200   
03201   <font class="comment">// Initialize the basis matrix A</font>
03202   Vector&lt;T&gt; N(deg_+1) ;
03203 
03204   <font class="keywordflow">for</font>(i=1;i&lt;Q.n()-1;i++){
03205     <font class="keywordtype">int</font> span = <a class="code" href="classPLib_1_1NurbsCurve.html#a32" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a32">findSpan</a>(ub[i]);
03206     <a class="code" href="classPLib_1_1NurbsCurve.html#a28" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a28">basisFuns</a>(ub[i],span,N) ;
03207     <font class="keywordflow">for</font>(j=0;j&lt;=deg_;j++) 
03208         A(i,span-deg_+j) = (double)N[j] ;
03209   }
03210   A(0,0)  = 1.0 ;
03211   A(Q.n()-1,Q.n()-1) = 1.0 ;
03212 
03213   <font class="comment">// Init matrix for LSE</font>
03214   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> qq(Q.n(),D+1) ;
03215   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> xx(Q.n(),D+1) ;
03216   <font class="keywordflow">for</font>(i=0;i&lt;Q.n();i++)
03217     <font class="keywordflow">for</font>(j=0; j&lt;D+1;j++)
03218       qq(i,j) = (double)Q[i].data[j] ;
03219 
03220   solve(A,qq,xx) ;
03221 
03222   <font class="comment">// Store the data</font>
03223   <font class="keywordflow">for</font>(i=0;i&lt;xx.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>();i++){
03224     <font class="keywordflow">for</font>(j=0;j&lt;D+1;j++)
03225       P[i].data[j] = (T)xx(i,j) ;
03226   }
03227 
03228 }
03229 
03230 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
03231 <font class="keyword">inline</font> T pow2(T a){
03232   <font class="keywordflow">return</font> a*a ;
03233 }
03234 
03254 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
03255 <font class="keywordtype">int</font> intersectLine(<font class="keyword">const</font> Point_nD&lt;T,N&gt;&amp; p1, <font class="keyword">const</font> Point_nD&lt;T,N&gt;&amp; t1, <font class="keyword">const</font> Point_nD&lt;T,N&gt;&amp; p2, <font class="keyword">const</font> Point_nD&lt;T,N&gt;&amp; t2, Point_nD&lt;T,N&gt;&amp; p){
03256   <font class="comment">// a line is written like </font>
03257   <font class="comment">// L(t) = Q + u*t</font>
03258   <font class="comment">// u is the parametric value P is a point in the line and T is the tangent</font>
03259   <font class="comment">// a plane is of the form</font>
03260   <font class="comment">// (X-P).v = 0 </font>
03261   <font class="comment">// where P is a point where the plane goes through and v is the normal to it</font>
03262   <font class="comment">// and X is (x,y,z)</font>
03263   <font class="comment">// solving for u</font>
03264 
03265   Point_nD&lt;T,N&gt; v,px ;
03266 
03267   <font class="comment">//px = crossProduct(t1,p1-p2) ;</font>
03268   <font class="comment">//v = crossProduct(px,t1) ;</font>
03269   px = crossProduct(t1,t2) ; 
03270   v = crossProduct(px,t1) ; 
03271   
03272   T t = (p1-p2)*v ;
03273   T vw = v*t2 ;
03274   <font class="keywordflow">if</font>(to2power(vw)&lt;1e-7)
03275     <font class="keywordflow">return</font> 0 ;
03276   t /= vw ;
03277   p = p2+(((p1-p2)*v)/vw)*t2 ;
03278   <font class="keywordflow">return</font> 1 ;
03279 }
03280 
03281 <font class="preprocessor">#ifdef HAVE_TEMPLATE_OF_TEMPLATE</font>
03282 <font class="preprocessor"></font><font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
03283 <font class="keywordtype">int</font> intersectLine(<font class="keyword">const</font> Point_nD&lt;T,2&gt;&amp; p1, <font class="keyword">const</font> Point_nD&lt;T,2&gt;&amp; t1, <font class="keyword">const</font> Point_nD&lt;T,2&gt;&amp; p2, <font class="keyword">const</font> Point_nD&lt;T,2&gt;&amp; t2, Point_nD&lt;T,2&gt;&amp; p){
03284   cout &lt;&lt; <font class="stringliteral">"PLEASE, DEFINE THIS FUNCTION\n"</font> ; 
03285 
03286   <font class="keywordflow">return</font> 1 ;
03287 }
03288 <font class="preprocessor">#else</font>
03289 <font class="preprocessor"></font>
03290 <font class="preprocessor">#ifdef TEMPLATE_SPECIALIZATION</font>
03291 <font class="preprocessor"></font>
03292 <font class="keyword">template</font> &lt;&gt;
03293 <font class="keywordtype">int</font> intersectLine(<font class="keyword">const</font> Point_nD&lt;float,2&gt;&amp; p1, <font class="keyword">const</font> Point_nD&lt;float,2&gt;&amp; t1, <font class="keyword">const</font> Point_nD&lt;float,2&gt;&amp; p2, <font class="keyword">const</font> Point_nD&lt;float,2&gt;&amp; t2, Point_nD&lt;float,2&gt;&amp; p){
03294   cout &lt;&lt; <font class="stringliteral">"PLEASE, DEFINE THIS FUNCTION\n"</font> ; 
03295 
03296   <font class="keywordflow">return</font> 1 ;
03297 }
03298 
03299 <font class="keyword">template</font> &lt;&gt;
03300 <font class="keywordtype">int</font> intersectLine(<font class="keyword">const</font> Point_nD&lt;double,2&gt;&amp; p1, <font class="keyword">const</font> Point_nD&lt;double,2&gt;&amp; t1, <font class="keyword">const</font> Point_nD&lt;double,2&gt;&amp; p2, <font class="keyword">const</font> Point_nD&lt;double,2&gt;&amp; t2, Point_nD&lt;double,2&gt;&amp; p){
03301   cout &lt;&lt; <font class="stringliteral">"PLEASE, DEFINE THIS FUNCTION\n"</font> ; 
03302 
03303   <font class="keywordflow">return</font> 1 ;
03304 }
03305 <font class="preprocessor">#endif //TEMPLATE_SPECIALIZATION</font>
03306 <font class="preprocessor"></font>
03307 <font class="preprocessor">#endif</font>
03308 <font class="preprocessor"></font>
03329 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
03330 <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::makeCircle(<font class="keyword">const</font> Point_nD&lt;T,N&gt;&amp; O, <font class="keyword">const</font> Point_nD&lt;T,N&gt;&amp; X, <font class="keyword">const</font> Point_nD&lt;T,N&gt;&amp; Y, T r, <font class="keywordtype">double</font> as, <font class="keywordtype">double</font> ae){
03331   <font class="keywordtype">double</font> theta,angle,dtheta ;
03332   <font class="keywordtype">int</font> narcs ;
03333   <font class="keywordflow">while</font>(ae&lt;as)
03334     ae += 2*M_PI ;
03335   theta = ae-as ;
03336   <font class="keywordflow">if</font>(theta&lt;=M_PI/2.0)   
03337     narcs = 1 ;
03338   <font class="keywordflow">else</font>{
03339     <font class="keywordflow">if</font>(theta&lt;=M_PI)
03340       narcs = 2 ;
03341     <font class="keywordflow">else</font>{
03342       <font class="keywordflow">if</font>(theta&lt;=1.5*M_PI)
03343         narcs = 3 ;
03344       <font class="keywordflow">else</font>
03345         narcs = 4 ;
03346     }
03347   }
03348   dtheta = theta/(double)narcs ;
03349   <font class="keywordtype">int</font> n = 2*narcs+1 ; <font class="comment">// n control points ;</font>
03350   <font class="keywordtype">double</font> w1 = cos(dtheta/2.0) ; <font class="comment">// dtheta/2.0 is base angle</font>
03351 
03352   Point_nD&lt;T,N&gt; P0,T0,P2,T2,P1 ;
03353   P0 = O + r*cos(as)*X + r*sin(as)*Y ; 
03354   T0 = -sin(as)*X + cos(as)*Y ; <font class="comment">// initialize start values</font>
03355   <a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">resize</a>(n,2) ;
03356   
03357   P[0] = P0 ;
03358   <font class="keywordtype">int</font> i ;
03359   <font class="keywordtype">int</font> index = 0 ;
03360   angle = as ;
03361   <font class="keywordflow">for</font>(i=1;i&lt;=narcs;++i){
03362     angle += dtheta ;
03363     P2 = O+ r*cos(angle)*X + r*sin(angle)*Y ;  
03364     P[index+2] = P2 ;
03365     T2 = -sin(angle)*X + cos(angle)*Y ;
03366     intersectLine(P0,T0,P2,T2,P1) ;
03367     P[index+1] = P1 ;
03368     P[index+1] *= w1 ;
03369     index += 2 ;
03370     <font class="keywordflow">if</font>(i&lt;narcs){
03371       P0 = P2 ;
03372       T0 = T2 ;
03373     }
03374   }
03375   <font class="keywordtype">int</font> j = 2*narcs+1 ; <font class="comment">// load the knot vector</font>
03376   <font class="keywordflow">for</font>(i=0;i&lt;3;++i){
03377       U[i] = 0.0 ;
03378       U[i+j] = 1.0 ;
03379   }
03380   <font class="keywordflow">switch</font>(narcs){
03381   <font class="keywordflow">case</font> 1: <font class="keywordflow">break</font> ;
03382   <font class="keywordflow">case</font> 2: 
03383     U[3] = U[4] = 0.5 ;
03384     <font class="keywordflow">break</font> ;
03385   <font class="keywordflow">case</font> 3:
03386     U[3] = U[4] = 1.0/3.0 ;
03387     U[5] = U[6] = 2.0/3.0 ;
03388     <font class="keywordflow">break</font> ;
03389   <font class="keywordflow">case</font> 4:
03390     U[3] = U[4] = 0.25 ;
03391     U[5] = U[6] = 0.50 ;  
03392     U[7] = U[8] = 0.75 ;
03393     <font class="keywordflow">break</font> ;    
03394   }
03395 }
03396 
03411 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
03412 <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::makeCircle(<font class="keyword">const</font> Point_nD&lt;T,N&gt;&amp; O, T r, <font class="keywordtype">double</font> as, <font class="keywordtype">double</font> ae){
03413   makeCircle(O,Point_nD&lt;T,N&gt;(1,0,0),Point_nD&lt;T,N&gt;(0,1,0),r,as,ae) ;
03414 }
03415 
03428 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
03429 <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::makeCircle(<font class="keyword">const</font> Point_nD&lt;T,N&gt;&amp; O, T r){
03430   <a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">resize</a>(9,2);
03431   U[0] = U[1] = U[2] = 0 ;
03432   U[3] = U[4] = 0.25 ;
03433   U[5] = U[6] = 0.50 ;  
03434   U[7] = U[8] = 0.75 ;
03435   U[9] = U[10] = U[11] = 1 ;
03436 
03437 
03438   <font class="keyword">const</font> T wm = T(0.707106781185) ;  <font class="comment">// sqrt(2)/2</font>
03439 
03440   P[0] = HPoint_nD&lt;T,N&gt;(r,0,0,1) ; 
03441   P[1] = HPoint_nD&lt;T,N&gt;(r*wm,r*wm,0,wm) ; 
03442   P[2] = HPoint_nD&lt;T,N&gt;(0,r,0,1) ; 
03443   P[3] = HPoint_nD&lt;T,N&gt;(-r*wm,r*wm,0,wm) ; 
03444   P[4] = HPoint_nD&lt;T,N&gt;(-r,0,0,1) ; 
03445   P[5] = HPoint_nD&lt;T,N&gt;(-r*wm,-r*wm,0,wm) ; 
03446   P[6] = HPoint_nD&lt;T,N&gt;(0,-r,0,1) ; 
03447   P[7] = HPoint_nD&lt;T,N&gt;(r*wm,-r*wm,0,wm) ; 
03448   P[8] = HPoint_nD&lt;T,N&gt;(r,0,0,1) ; 
03449 
03450   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=8;i&gt;=0;--i){
03451     P[i].x() += O.x() ; 
03452     P[i].y() += O.y() ; 
03453     P[i].z() += O.z() ; 
03454   }
03455 
03456 
03457   
03458 }
03459 
03476 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
03477 Vector&lt;T&gt; knotUnion(<font class="keyword">const</font> Vector&lt;T&gt;&amp; Ua, <font class="keyword">const</font> Vector&lt;T&gt;&amp; Ub) {
03478   Vector&lt;T&gt; U(Ua.n()+Ub.n()) ;
03479   <font class="keywordtype">int</font> done = 0 ;
03480   <font class="keywordtype">int</font> i,ia,ib ;  
03481   T t ;
03482 
03483   i = ia = ib = 0 ;
03484   <font class="keywordflow">while</font>(!done){
03485     <font class="keywordflow">if</font>(Ua[ia] == Ub[ib]){
03486       t = Ua[ia] ;
03487       ++ia ; ++ib ;
03488     }
03489     <font class="keywordflow">else</font>{
03490       <font class="keywordflow">if</font>(Ua[ia]&lt;Ub[ib]){
03491         t = Ua[ia] ;
03492         ++ia ;
03493       }
03494       <font class="keywordflow">else</font>{
03495         t = Ub[ib] ;
03496         ++ib ;
03497       }
03498     }
03499     U[i++] = t ;
03500     done = (ia&gt;=Ua.n() || ib&gt;=Ub.n()) ;
03501   }
03502   U.resize(i) ;
03503   <font class="keywordflow">return</font> U ;
03504 }
03505 
03518 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
03519 <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::mergeKnotVector(<font class="keyword">const</font> Vector&lt;T&gt; &amp;Um){
03520   <font class="keywordtype">int</font> i,ia,ib ;
03521   <font class="comment">// Find the knots to insert</font>
03522   Vector&lt;T&gt; I(Um.n()) ;
03523   <font class="keywordtype">int</font> done = 0 ;
03524   i = ia = ib = 0 ;
03525   <font class="keywordflow">while</font>(!done) {
03526     <font class="keywordflow">if</font>(Um[ib] == U[ia]){
03527       ++ib ; ++ia ;
03528     }
03529     <font class="keywordflow">else</font>{
03530       I[i++] = Um[ib] ;
03531       ib++ ;
03532     }
03533     done = (ia&gt;=U.n() || ib &gt;= Um.n()) ;
03534   }
03535   I.resize(i) ;
03536 
03537   <font class="keywordflow">if</font>(I.n()&gt;0){
03538     <font class="comment">// Refine the curve</font>
03539     refineKnotVector(I) ;
03540   }
03541 }
03542 
03543 
03557 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
03558 <font class="keywordtype">void</font> generateCompatibleCurves(NurbsCurveArray&lt;T,N&gt; &amp;ca){
03559   <font class="keywordtype">int</font> i;
03560   NurbsCurve&lt;T,N&gt; tc ;
03561 
03562   <font class="keywordflow">if</font>(ca.n()&lt;=1) <font class="comment">// Nothing to do... only 1 curve in the array</font>
03563     <font class="keywordflow">return</font> ;
03564 
03565   <font class="comment">// Increase all the curves to the highest degree</font>
03566   <font class="keywordtype">int</font> p = 1 ;
03567   <font class="keywordflow">for</font>(i=0;i&lt;ca.n();i++)
03568     <font class="keywordflow">if</font>(p&lt;ca[i].deg_)
03569       p = ca[i].deg_ ;
03570   <font class="keywordflow">for</font>(i=0;i&lt;ca.n();i++){
03571     ca[i].degreeElevate(p-ca[i].deg_);
03572   }
03573 
03574   <font class="comment">// Find a common Knot vector</font>
03575   Vector&lt;T&gt; Uc(ca[0].U) ;
03576   <font class="keywordflow">for</font>(i=1;i&lt;ca.n();i++){
03577     Uc = knotUnion(Uc,ca[i].U) ;
03578   }
03579 
03580   <font class="comment">// Refine the knot vectors</font>
03581   <font class="keywordflow">for</font>(i=0;i&lt;ca.n();i++)
03582     ca[i].mergeKnotVector(Uc) ;
03583 }
03584 
03595 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
03596 <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::read(ifstream &amp;fin){
03597   <font class="keywordflow">if</font>(!fin) {
03598     <font class="keywordflow">return</font> 0 ;
03599   }
03600   <font class="keywordtype">int</font> np,d;
03601   <font class="keywordtype">char</font> *type ;
03602   type = <font class="keyword">new</font> <font class="keywordtype">char</font>[3] ;
03603   <font class="keywordflow">if</font>(!fin.read(type,<font class="keyword">sizeof</font>(<font class="keywordtype">char</font>)*3)) { <font class="keyword">delete</font> []type ; <font class="keywordflow">return</font> 0 ;}
03604   <font class="keywordtype">int</font> r1 = strncmp(type,<font class="stringliteral">"nc3"</font>,3) ;
03605   <font class="keywordtype">int</font> r2 = strncmp(type,<font class="stringliteral">"nc4"</font>,3) ;
03606   <font class="keywordflow">if</font>(!(r1==0 || r2==0)) {
03607     <font class="keyword">delete</font> []type ;
03608     <font class="keywordflow">return</font> 0 ;
03609   }
03610   <font class="keywordtype">int</font> st ;
03611   <font class="keywordtype">char</font> stc ;
03612   <font class="keywordflow">if</font>(!fin.read((<font class="keywordtype">char</font>*)&amp;stc,<font class="keyword">sizeof</font>(<font class="keywordtype">char</font>))) { <font class="keyword">delete</font> []type ; <font class="keywordflow">return</font> 0 ;}
03613   <font class="keywordflow">if</font>(!fin.read((<font class="keywordtype">char</font>*)&amp;np,<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>))) { <font class="keyword">delete</font> []type ; <font class="keywordflow">return</font> 0 ;}
03614   <font class="keywordflow">if</font>(!fin.read((<font class="keywordtype">char</font>*)&amp;d,<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>))) { <font class="keyword">delete</font> []type ; <font class="keywordflow">return</font> 0 ;}
03615 
03616   st = stc - <font class="charliteral">'0'</font> ; 
03617   <font class="keywordflow">if</font>(st != <font class="keyword">sizeof</font>(T)){ <font class="comment">// not of the same type size</font>
03618     <font class="keyword">delete</font> []type ;
03619     <font class="keywordflow">return</font> 0 ; 
03620   }
03621 
03622   <a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">resize</a>(np,d) ;
03623   
03624   <font class="keywordflow">if</font>(!fin.read((<font class="keywordtype">char</font>*)U.memory(),<font class="keyword">sizeof</font>(T)*U.n())) { <font class="keyword">delete</font> []type ; <font class="keywordflow">return</font> 0 ;}
03625      
03626 
03627   T *p,*p2 ;
03628   <font class="keywordflow">if</font>(!r1){
03629     p = <font class="keyword">new</font> T[3*np] ;
03630     <font class="keywordflow">if</font>(!fin.read((<font class="keywordtype">char</font>*)p,<font class="keyword">sizeof</font>(T)*3*np)) { <font class="keyword">delete</font> []type ; <font class="keywordflow">return</font> 0 ;}
03631     p2 = p ;
03632     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=0;i&lt;np;i++){
03633       P[i].x() = *(p++) ;
03634       P[i].y() = *(p++) ;
03635       P[i].z() = *(p++) ;
03636       P[i].w() = 1.0 ;
03637     }
03638     <font class="keyword">delete</font> []p2 ;
03639   }
03640   <font class="keywordflow">else</font>{
03641     p = <font class="keyword">new</font> T[4*np] ;
03642     <font class="keywordflow">if</font>(!fin.read((<font class="keywordtype">char</font>*)p,<font class="keyword">sizeof</font>(T)*4*np)) { <font class="keyword">delete</font> []type ; <font class="keywordflow">return</font> 0 ;}
03643     p2 = p ;
03644     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=0;i&lt;np;i++){
03645       P[i].x() = *(p++) ;
03646       P[i].y() = *(p++) ;
03647       P[i].z() = *(p++) ;
03648       P[i].w() = *(p++) ;
03649     }
03650     <font class="keyword">delete</font> []p2 ;
03651   }
03652 
03653   <font class="keyword">delete</font> []type ;
03654   <font class="keywordflow">return</font> 1 ;
03655 }
03656 
03666 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
03667 <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::read(<font class="keyword">const</font> <font class="keywordtype">char</font>* filename){
03668   ifstream fin(filename) ;
03669   <font class="keywordflow">if</font>(!fin) {
03670     <font class="keywordflow">return</font> 0 ;
03671   }
03672   <font class="keywordflow">return</font> read(fin) ;
03673 }
03674 
03684 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
03685 <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::write(<font class="keyword">const</font> <font class="keywordtype">char</font>* filename)<font class="keyword"> const </font>{
03686   ofstream fout(filename) ;  
03687 
03688   <font class="keywordflow">if</font>(!fout)
03689     <font class="keywordflow">return</font> 0 ;
03690   <font class="keywordflow">return</font> write(fout) ;
03691 }
03692 
03702 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
03703 <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::write(ofstream &amp;fout)<font class="keyword"> const </font>{
03704   <font class="keywordflow">if</font>(!fout)
03705     <font class="keywordflow">return</font> 0 ;
03706   <font class="keywordtype">int</font> pn = P.n() ;
03707   <font class="keywordtype">char</font> st = <font class="charliteral">'0'</font> + <font class="keyword">sizeof</font>(T) ;
03708   <font class="keywordflow">if</font>(!fout.write((<font class="keywordtype">char</font>*)&amp;<font class="stringliteral">"nc4"</font>,<font class="keyword">sizeof</font>(<font class="keywordtype">char</font>)*3)) <font class="keywordflow">return</font> 0 ;
03709   <font class="keywordflow">if</font>(!fout.write((<font class="keywordtype">char</font>*)&amp;st,<font class="keyword">sizeof</font>(<font class="keywordtype">char</font>))) <font class="keywordflow">return</font> 0 ; 
03710   <font class="keywordflow">if</font>(!fout.write((<font class="keywordtype">char</font>*)&amp;pn,<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>))) <font class="keywordflow">return</font> 0 ;
03711   <font class="keywordflow">if</font>(!fout.write((<font class="keywordtype">char</font>*)&amp;deg_,<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>))) <font class="keywordflow">return</font> 0 ;
03712   <font class="keywordflow">if</font>(!fout.write((<font class="keywordtype">char</font>*)U.memory(),<font class="keyword">sizeof</font>(T)*U.n())) <font class="keywordflow">return</font> 0 ;
03713   
03714   T *p,*p2 ;
03715   p = <font class="keyword">new</font> T[P.n()*4] ;
03716   p2 = p ;
03717   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=0;i&lt;P.n();i++) {
03718     *p = P[i].x() ; p++ ;
03719     *p = P[i].y() ; p++ ;
03720     *p = P[i].z() ; p++ ;
03721     *p = P[i].w() ; p++ ;
03722   }
03723   <font class="keywordflow">if</font>(!fout.write((<font class="keywordtype">char</font>*)p2,<font class="keyword">sizeof</font>(T)*P.n()*4)) <font class="keywordflow">return</font> 0 ;
03724   <font class="keyword">delete</font> []p2 ;
03725   <font class="keywordflow">return</font> 1 ;
03726 }
03727 
03745 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
03746 <font class="keywordtype">void</font> nurbsBasisFuns(T u, <font class="keywordtype">int</font> span, <font class="keywordtype">int</font> deg, <font class="keyword">const</font> Vector&lt;T&gt;&amp; U, Vector&lt;T&gt;&amp; N) {
03747   <font class="comment">//Vector&lt;T&gt; left(deg+1), right(deg+1) ;</font>
03748   T* left = (T*) alloca(2*(deg+1)*<font class="keyword">sizeof</font>(T)) ;
03749   T* right = &amp;left[deg+1] ;
03750   
03751   T temp,saved ;
03752    
03753   N.resize(deg+1) ;
03754 
03755   N[0] = 1.0 ;
03756   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> j=1; j&lt;= deg ; j++){
03757     left[j] = u-U[span+1-j] ;
03758     right[j] = U[span+j]-u ;
03759     saved = 0.0 ;
03760     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> r=0 ; r&lt;j; r++){
03761       temp = N[r]/(right[r+1]+left[j-r]) ;
03762       N[r] = saved+right[r+1] * temp ;
03763       saved = left[j-r] * temp ;
03764     }
03765     N[j] = saved ;
03766   }
03767   
03768 }
03769 
03790 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
03791 <font class="keywordtype">void</font> nurbsDersBasisFuns(<font class="keywordtype">int</font> n,T u, <font class="keywordtype">int</font> span,  <font class="keywordtype">int</font> deg, <font class="keyword">const</font> Vector&lt;T&gt;&amp; U, Matrix&lt;T&gt;&amp; ders) {
03792   <font class="comment">//Vector&lt;T&gt; left(deg+1),right(deg+1) ;</font>
03793   T* left = (T*) alloca(2*(deg+1)*<font class="keyword">sizeof</font>(T)) ;
03794   T* right = &amp;left[deg+1] ;
03795   
03796   Matrix&lt;T&gt; ndu(deg+1,deg+1) ;
03797   T saved,temp ;
03798   <font class="keywordtype">int</font> j,r ;
03799 
03800   ders.resize(n+1,deg+1) ;
03801 
03802   ndu(0,0) = 1.0 ;
03803   <font class="keywordflow">for</font>(j=1; j&lt;= deg ;j++){
03804     left[j] = u-U[span+1-j] ;
03805     right[j] = U[span+j]-u ;
03806     saved = 0.0 ;
03807     
03808     <font class="keywordflow">for</font>(r=0;r&lt;j ; r++){
03809       <font class="comment">// Lower triangle</font>
03810       ndu(j,r) = right[r+1]+left[j-r] ;
03811       temp = ndu(r,j-1)/ndu(j,r) ;
03812       <font class="comment">// Upper triangle</font>
03813       ndu(r,j) = saved+right[r+1] * temp ;
03814       saved = left[j-r] * temp ;
03815     }
03816 
03817     ndu(j,j) = saved ;
03818   }
03819 
03820   <font class="keywordflow">for</font>(j=0;j&lt;=deg;j++)
03821     ders(0,j) = ndu(j,deg) ;
03822 
03823   <font class="comment">// Compute the derivatives</font>
03824   Matrix&lt;T&gt; a(deg+1,deg+1) ;
03825   <font class="keywordflow">for</font>(r=0;r&lt;=deg;r++){
03826     <font class="keywordtype">int</font> s1,s2 ;
03827     s1 = 0 ; s2 = 1 ; <font class="comment">// alternate rows in array a</font>
03828     a(0,0) = 1.0 ;
03829     <font class="comment">// Compute the kth derivative</font>
03830     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> k=1;k&lt;=n;k++){
03831       T d ;
03832       <font class="keywordtype">int</font> rk,pk,j1,j2 ;
03833       d = 0.0 ;
03834       rk = r-k ; pk = deg-k ;
03835 
03836       <font class="keywordflow">if</font>(r&gt;=k){
03837         a(s2,0) = a(s1,0)/ndu(pk+1,rk) ;
03838         d = a(s2,0)*ndu(rk,pk) ;
03839       }
03840 
03841       <font class="keywordflow">if</font>(rk&gt;=-1){
03842         j1 = 1 ;
03843       }
03844       <font class="keywordflow">else</font>{
03845         j1 = -rk ;
03846       }
03847 
03848       <font class="keywordflow">if</font>(r-1 &lt;= pk){
03849         j2 = k-1 ;
03850       }
03851       <font class="keywordflow">else</font>{
03852         j2 = deg-r ;
03853       }
03854 
03855       <font class="keywordflow">for</font>(j=j1;j&lt;=j2;j++){
03856         a(s2,j) = (a(s1,j)-a(s1,j-1))/ndu(pk+1,rk+j) ;
03857         d += a(s2,j)*ndu(rk+j,pk) ;
03858       }
03859       
03860       <font class="keywordflow">if</font>(r&lt;=pk){
03861         a(s2,k) = -a(s1,k-1)/ndu(pk+1,r) ;
03862         d += a(s2,k)*ndu(r,pk) ;
03863       }
03864       ders(k,r) = d ;
03865       j = s1 ; s1 = s2 ; s2 = j ; <font class="comment">// Switch rows</font>
03866     }
03867   }
03868 
03869   <font class="comment">// Multiply through by the correct factors</font>
03870   r = deg ;
03871   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> k=1;k&lt;=n;k++){
03872     <font class="keywordflow">for</font>(j=0;j&lt;=deg;j++)
03873       ders(k,j) *= r ;
03874     r *= deg-k ;
03875   }
03876 
03877 }
03878 
03879 
03894 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
03895 <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::decompose(NurbsCurveArray&lt;T,N&gt;&amp; c)<font class="keyword"> const </font>{
03896   <font class="keywordtype">int</font> i,m,a,b,nb,mult,j,r,save,s,k ;
03897   T numer,alpha ;
03898   T* alphas = (T*) alloca((deg_+1)*<font class="keyword">sizeof</font>(T)) ; <font class="comment">//Vector&lt;T&gt; alphas(deg+1) ;</font>
03899 
03900   <font class="comment">// all the curves will have the same vector</font>
03901   Vector&lt;T&gt; nU ;
03902   nU.resize(2*(deg_+1)) ;
03903   <font class="keywordflow">for</font>(i=0;i&lt;nU.n()/2;i++)
03904     nU[i] = 0 ;
03905   <font class="keywordflow">for</font>(i=nU.n()/2;i&lt;nU.n();i++)
03906     nU[i] = 1 ;
03907   
03908   c.resize(P.n()-deg_) ;
03909   <font class="keywordflow">for</font>(i=0;i&lt;c.n();i++){
03910     c[i].resize(deg_+1,deg_) ;
03911     c[i].U = nU ;
03912   }
03913   
03914   m = P.n()+deg_ ;
03915   a = deg_ ;
03916   b = deg_+1 ;
03917   nb = 0 ;
03918 
03919   <font class="keywordflow">for</font>(i=0;i&lt;=deg_;i++)
03920     c[nb].P[i] = P[i] ;
03921   <font class="keywordflow">while</font>(b&lt;m){
03922     i = b ;
03923     <font class="keywordflow">while</font>(b&lt;m &amp;&amp; U[b+1] &lt;= U[b]) b++ ;
03924     mult = b-i+1 ;
03925     <font class="keywordflow">if</font>(mult&lt;deg_){
03926       numer = U[b]-U[a] ; <font class="comment">// th enumerator of the alphas</font>
03927       <font class="keywordflow">for</font>(j=deg_;j&gt;mult;j--) <font class="comment">// compute and store the alphas</font>
03928         alphas[j-mult-1] = numer/(U[a+j]-U[a]) ;
03929       r = deg_-mult ; <font class="comment">// insert knot r times</font>
03930       <font class="keywordflow">for</font>(j=1;j&lt;=r;j++){
03931         save=r-j;
03932         s=mult+j; <font class="comment">// this many new points</font>
03933         <font class="keywordflow">for</font>(k=deg_;k&gt;=s;k--){
03934           alpha = alphas[k-s] ;
03935           c[nb].P[k] = alpha*c[nb].P[k] + (1.0-alpha)*c[nb].P[k-1] ;      
03936         }
03937         <font class="keywordflow">if</font>(b&lt;m) <font class="comment">// control point of</font>
03938           c[nb+1].P[save] = c[nb].P[deg_]; <font class="comment">// next segment</font>
03939       }
03940     }
03941     nb++ ;
03942     <font class="keywordflow">if</font>(b&lt;m){ <font class="comment">// initialize for next segment</font>
03943       <font class="keywordflow">for</font>(i=deg_-mult; i&lt;= deg_ ; i++)
03944         c[nb].P[i] = P[b-deg_+i];
03945       a=b ;
03946       b++ ;
03947     }
03948   }
03949   c.resize(nb) ;
03950 
03951 }
03952 
03953 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
03954 <font class="keyword">inline</font> Point_nD&lt;T,N&gt; project2D(<font class="keyword">const</font> HPoint_nD&lt;T,N&gt;&amp; p){
03955   Point_nD&lt;T,N&gt; pnt ;
03956   <font class="comment">//if(p.z()==0.0){</font>
03957     pnt.x() = p.x()/p.w() ;
03958     pnt.y() = p.y()/p.w() ;
03959     <font class="comment">//}</font>
03960     <font class="comment">//else{</font>
03961     <font class="comment">//pnt.x() = (p.x()/p.w())/absolute(p.z()) ;</font>
03962     <font class="comment">//pnt.y() = (p.y()/p.w())/absolute(p.z()) ;</font>
03963     <font class="comment">//}</font>
03964   <font class="keywordflow">return</font> pnt ;
03965 }
03966 
03967 <font class="keyword">const</font> <font class="keywordtype">float</font> offX = 50 ;
03968 <font class="keyword">const</font> <font class="keywordtype">float</font> offY = 70 ;
03969 
03970 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
03971 <font class="keyword">inline</font> <font class="keywordtype">void</font> movePsP(Point_nD&lt;T,N&gt; &amp;p, T magFact){
03972   p *= magFact ;
03973   p += Point_nD&lt;T,N&gt;(offX,offY,0) ;
03974   <font class="comment">//p = p*magFact+Point_nD&lt;T,N&gt;(offX,offY,0)  ;</font>
03975 }
03976 
03977 <font class="preprocessor">#ifdef HAVE_TEMPLATE_OF_TEMPLATE</font>
03978 <font class="preprocessor"></font><font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
03979 <font class="keyword">inline</font> <font class="keywordtype">void</font> movePsP(Point_nD&lt;T,2&gt; &amp;p, T magFact){
03980   p *= magFact ;
03981   p += Point_nD&lt;T,2&gt;(offX,offY) ;
03982   <font class="comment">//p = p*magFact+Point_nD&lt;T,N&gt;(offX,offY,0)  ;</font>
03983 }
03984 <font class="preprocessor">#else</font>
03985 <font class="preprocessor"></font>
03986 <font class="keyword">template</font> &lt;&gt;
03987 <font class="keyword">inline</font> <font class="keywordtype">void</font> movePsP(Point_nD&lt;float,2&gt; &amp;p, <font class="keywordtype">float</font> magFact){
03988   p *= magFact ;
03989   p += Point_nD&lt;float,2&gt;(offX,offY) ;
03990   <font class="comment">//p = p*magFact+Point_nD&lt;T,N&gt;(offX,offY,0)  ;</font>
03991 }
03992 
03993 <font class="keyword">template</font> &lt;&gt;
03994 <font class="keyword">inline</font> <font class="keywordtype">void</font> movePsP(Point_nD&lt;double,2&gt; &amp;p, <font class="keywordtype">double</font> magFact){
03995   p *= magFact ;
03996   p += Point_nD&lt;double,2&gt;(offX,offY) ;
03997   <font class="comment">//p = p*magFact+Point_nD&lt;double,N&gt;(offX,offY,0)  ;</font>
03998 }
03999 
04000 <font class="preprocessor">#endif</font>
04001 <font class="preprocessor"></font>
04026 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
04027 <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::writePS(<font class="keyword">const</font> <font class="keywordtype">char</font>* filename,<font class="keywordtype">int</font> cp,T magFact, T dash, <font class="keywordtype">bool</font> bOpen)<font class="keyword"> const </font>{
04028 
04029   ofstream fout(filename) ;  
04030 
04031   <font class="keywordflow">if</font>(!fout)
04032     <font class="keywordflow">return</font> 0 ;
04033 
04034   <font class="keywordflow">if</font>(deg_&lt;3){
04035     NurbsCurve&lt;T,N&gt; c3(*<font class="keyword">this</font>) ;
04036     c3.degreeElevate(3-deg_) ;
04037     <font class="keywordflow">return</font> c3.writePS(filename,cp,magFact,dash,bOpen) ;
04038   }
04039 
04040   NurbsCurveArray&lt;T,N&gt; Ca ;
04041   <font class="keywordflow">if</font> (bOpen)
04042     decompose(Ca) ;
04043   <font class="keywordflow">else</font>
04044     decomposeClosed(Ca) ;
04045 
04046   <font class="keywordtype">int</font> guess =0 ;
04047   <font class="keywordflow">if</font>(magFact&lt;= T() ){
04048     magFact = T(1) ;
04049     guess = 1 ;
04050   }
04051   
04052   Matrix&lt; Point_nD&lt;T,N&gt; &gt; pnts(Ca.n(),deg_+1) ;
04053   <font class="keywordtype">int</font> i,j ;
04054 
04055   <font class="comment">//HPoint_nD&lt;T,N&gt; tp ;</font>
04056 
04057   <font class="keywordflow">for</font>(i=0;i&lt;Ca.n();i++){
04058     <font class="keywordflow">for</font>(j=0;j&lt;deg_+1;j++){
04059       pnts(i,j) = project2D(Ca[i].P[j]) ;
04060     }
04061   }
04062 
04063   <font class="comment">// find bounding box parameters</font>
04064   T mx,my,Mx,My ;
04065   mx = Mx = pnts(0,0).x() ;
04066   my = My = pnts(0,0).y() ;
04067 
04068   <font class="keywordflow">for</font>(i=0;i&lt;Ca.n();i++){
04069     Point_nD&lt;T,N&gt; p ;
04070     <font class="keywordtype">int</font> step ;
04071     step = 8 ;
04072     <font class="keywordflow">for</font>(j=0;j&lt;=step;j++){
04073       T u ;
04074       u = (T)j/(T)step ;
04075       p = project2D(Ca[i](u)) ;
04076       <font class="keywordflow">if</font>(p.x() &lt; mx)
04077         mx = p.x() ;
04078       <font class="keywordflow">if</font>(p.x() &gt; Mx)
04079         Mx = p.x() ;
04080       <font class="keywordflow">if</font>(p.y() &lt; my)
04081         my = p.y() ;
04082       <font class="keywordflow">if</font>(p.y() &gt; My) 
04083         My = p.y() ;      
04084     }
04085   }
04086 
04087   <font class="keywordflow">if</font>(guess){
04088     <font class="comment">//magFact = minimum((T)500/(T)(Mx-mx),(T)700/(T)(My-my)) ;</font>
04089   }
04090 
04091   mx = mx*magFact+offX;
04092   my = my*magFact+offY;
04093   Mx = Mx*magFact+offX;
04094   My = My*magFact+offY;
04095   <font class="keywordflow">for</font>(i=0;i&lt;Ca.n();i++)
04096     <font class="keywordflow">for</font>(j=0;j&lt;deg_+1;j++)
04097         movePsP(pnts(i,j),magFact) ;
04098 
04099   fout &lt;&lt; <font class="stringliteral">"%!PS-Adobe-2.1\n%%Title: "</font> &lt;&lt; filename &lt;&lt; endl ;
04100   fout &lt;&lt; <font class="stringliteral">"%%Creator: NurbsCurve&lt;T,N&gt;::writePS\n"</font> ;
04101   fout &lt;&lt; <font class="stringliteral">"%%BoundingBox: "</font> &lt;&lt; mx &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; my &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; Mx &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; My &lt;&lt; endl ;
04102   fout &lt;&lt; <font class="stringliteral">"%%Pages: 0"</font> &lt;&lt; endl ;
04103   fout &lt;&lt; <font class="stringliteral">"%%EndComments"</font> &lt;&lt; endl ;
04104   fout &lt;&lt; <font class="stringliteral">"0 setlinewidth\n"</font> ;
04105   fout &lt;&lt; <font class="stringliteral">"0 setgray\n"</font> ;
04106   fout &lt;&lt; endl ;
04107 
04108   fout &lt;&lt; <font class="stringliteral">"newpath\n"</font> ;
04109   fout &lt;&lt; pnts(0,0).x() &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; pnts(0,0).y() &lt;&lt; <font class="stringliteral">" moveto\n"</font> ;
04110   <font class="keywordflow">for</font>(i=0;i&lt;Ca.n();i++){
04111     <font class="keywordflow">for</font>(j=1;j&lt;deg_+1;j++){
04112       fout &lt;&lt; pnts(i,j).x() &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; pnts(i,j).y() &lt;&lt; <font class="charliteral">' '</font> ;
04113     }
04114     fout &lt;&lt; <font class="stringliteral">"curveto\n"</font> ;
04115   }
04116   fout &lt;&lt; <font class="stringliteral">"stroke\n"</font> ;
04117 
04118   <font class="keywordflow">if</font>(cp&gt;0){ <font class="comment">// draw the control points of the original curve</font>
04119     Vector&lt; Point_nD&lt;T,N&gt; &gt; pts(P.n()) ;
04120     <font class="keywordflow">for</font>(i=0;i&lt;P.n();i++){
04121       pts[i] = project2D(P[i]) ;
04122       movePsP(pts[i],magFact) ;
04123       fout &lt;&lt; <font class="stringliteral">"newpath\n"</font> ;
04124       fout &lt;&lt; pts[i].x() &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; pts[i].y() &lt;&lt; <font class="stringliteral">"  3 0 360 arc\nfill\n"</font> ;
04125     }
04126     <font class="keywordflow">if</font>(dash&gt;0)
04127       fout &lt;&lt; <font class="stringliteral">"["</font> &lt;&lt; dash &lt;&lt; <font class="stringliteral">"] "</font> &lt;&lt; dash &lt;&lt; <font class="stringliteral">" setdash\n"</font> ;
04128     fout &lt;&lt; <font class="stringliteral">"newpath\n"</font> ;
04129     
04130     fout &lt;&lt; pts[0].x() &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; pts[0].y() &lt;&lt; <font class="stringliteral">" moveto\n"</font> ;
04131     <font class="keywordflow">for</font>(i=1;i&lt;P.n();i++)
04132       fout &lt;&lt; pts[i].x() &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; pts[i].y() &lt;&lt; <font class="stringliteral">" lineto\n"</font> ;
04133     fout &lt;&lt; <font class="stringliteral">"stroke\n"</font> ;
04134   }
04135   <font class="keywordflow">else</font>{
04136     <font class="keywordflow">if</font>(cp&lt;0){
04137       Vector&lt; Point_nD&lt;T,N&gt; &gt; pts(P.n()*Ca.n()) ;
04138       <font class="keywordtype">int</font> k=0 ;
04139       <font class="keywordflow">for</font>(i=0;i&lt;Ca.n();i++)
04140         <font class="keywordflow">for</font>(j=0;j&lt;deg_+1;j++){
04141           pts[k] = project2D(Ca[i].P[j]) ;
04142           movePsP(pts[k],magFact) ;
04143           fout &lt;&lt; <font class="stringliteral">"newpath\n"</font> ;
04144           fout &lt;&lt; pts[k].x() &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; pts[k].y() &lt;&lt; <font class="stringliteral">"  3 0 360 arc\nfill\n"</font> ;
04145           k++ ;
04146         }
04147       <font class="keywordflow">if</font>(dash&gt;0)
04148         fout &lt;&lt; <font class="stringliteral">"["</font> &lt;&lt; dash &lt;&lt; <font class="stringliteral">"] "</font> &lt;&lt; dash &lt;&lt; <font class="stringliteral">" setdash\n"</font> ;
04149       fout &lt;&lt; <font class="stringliteral">"newpath\n"</font> ;
04150       
04151       fout &lt;&lt; pts[0].x() &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; pts[0].y() &lt;&lt; <font class="stringliteral">" moveto\n"</font> ;
04152       <font class="keywordflow">for</font>(i=1;i&lt;k;i++)
04153         fout &lt;&lt; pts[i].x() &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; pts[i].y() &lt;&lt; <font class="stringliteral">" lineto\n"</font> ;
04154       fout &lt;&lt; <font class="stringliteral">"stroke\n"</font> ;      
04155     }
04156   }
04157 
04158   fout &lt;&lt; <font class="stringliteral">"showpage\n%%EOF\n"</font> ;
04159   <font class="keywordflow">return</font> 1 ;
04160 }
04161 
04195 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
04196 <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::writePSp(<font class="keyword">const</font> <font class="keywordtype">char</font>* filename,<font class="keyword">const</font> Vector&lt; Point_nD&lt;T,N&gt; &gt;&amp; points, <font class="keyword">const</font> Vector&lt; Point_nD&lt;T,N&gt; &gt;&amp; vectors, <font class="keywordtype">int</font> cp, T magFact, T dash, <font class="keywordtype">bool</font> bOpen)<font class="keyword"> const </font>{
04197   ofstream fout(filename) ;  
04198 
04199   <font class="keywordflow">if</font>(!fout)
04200     <font class="keywordflow">return</font> 0 ;
04201 
04202   <font class="keywordflow">if</font>(deg_&lt;3){
04203     NurbsCurve&lt;T,N&gt; c3(*<font class="keyword">this</font>) ;
04204     c3.degreeElevate(3-deg_) ;
04205     <font class="keywordflow">return</font> c3.writePSp(filename,points,vectors,cp,magFact,dash,bOpen) ;
04206   }
04207 
04208   <font class="comment">// extract the Bezier segments </font>
04209   NurbsCurveArray&lt;T,N&gt; Ca ;
04210   <font class="keywordflow">if</font> (bOpen)
04211     decompose(Ca) ;
04212   <font class="keywordflow">else</font>
04213     decomposeClosed(Ca) ;
04214 
04215   <font class="keywordtype">int</font> guess =0 ;
04216   <font class="keywordflow">if</font>(magFact&lt;=0){
04217     magFact = 1.0 ;
04218     guess = 1 ;
04219   }
04220   
04221   Matrix&lt; Point_nD&lt;T,N&gt; &gt; pnts(Ca.n(),deg_+1) ;
04222   <font class="keywordtype">int</font> i,j ;
04223   <font class="keywordflow">for</font>(i=0;i&lt;Ca.n();i++){
04224     <font class="keywordflow">for</font>(j=0;j&lt;deg_+1;j++){
04225       pnts(i,j) = project2D(Ca[i].P[j]) ;
04226     }
04227   }
04228 
04229 
04230   <font class="comment">// find bounding box parameters</font>
04231   T mx,my,Mx,My ;
04232   mx = Mx = pnts(0,0).x() ;
04233   my = My = pnts(0,0).y() ;
04234 
04235   <font class="keywordflow">for</font>(i=0;i&lt;Ca.n();i++){
04236     Point_nD&lt;T,N&gt; p ;
04237     <font class="keywordtype">int</font> step ;
04238     step = 8 ;
04239     <font class="keywordflow">for</font>(j=0;j&lt;=step;j++){
04240       T u ;
04241       u = (T)j/(T)step ;
04242       p = project2D(Ca[i](u)) ;
04243       <font class="keywordflow">if</font>(p.x() &lt; mx)
04244         mx = p.x() ;
04245       <font class="keywordflow">if</font>(p.x() &gt; Mx)
04246         Mx = p.x() ;
04247       <font class="keywordflow">if</font>(p.y() &lt; my)
04248         my = p.y() ;
04249       <font class="keywordflow">if</font>(p.y() &gt; My) 
04250         My = p.y() ;      
04251     }
04252   }
04253 
04254   <font class="keywordflow">if</font>(guess){
04255     magFact = minimum((T)500/(T)(Mx-mx),(T)700/(T)(My-my)) ;
04256   }
04257 
04258   mx = mx*magFact+offX;
04259   my = my*magFact+offY;
04260   Mx = Mx*magFact+offX;
04261   My = My*magFact+offY;
04262   <font class="keywordflow">for</font>(i=0;i&lt;Ca.n();i++)
04263     <font class="keywordflow">for</font>(j=0;j&lt;deg_+1;j++)
04264         movePsP(pnts(i,j),magFact) ;
04265 
04266   fout &lt;&lt; <font class="stringliteral">"%!PS-Adobe-2.1\n%%Title: "</font> &lt;&lt; filename &lt;&lt; endl ;
04267   fout &lt;&lt; <font class="stringliteral">"%%Creator: NurbsCurve&lt;T,N&gt;::writePS\n"</font> ;
04268   fout &lt;&lt; <font class="stringliteral">"%%BoundingBox: "</font> &lt;&lt; mx &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; my &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; Mx &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; My &lt;&lt; endl ;
04269   fout &lt;&lt; <font class="stringliteral">"%%Pages: 0"</font> &lt;&lt; endl ;
04270   fout &lt;&lt; <font class="stringliteral">"%%EndComments"</font> &lt;&lt; endl ;
04271   fout &lt;&lt; <font class="stringliteral">"0 setlinewidth\n"</font> ;
04272   fout &lt;&lt; <font class="stringliteral">"0 setgray\n"</font> ;
04273   fout &lt;&lt; endl ;
04274 
04275   fout &lt;&lt; <font class="stringliteral">"newpath\n"</font> ;
04276   fout &lt;&lt; pnts(0,0).x() &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; pnts(0,0).y() &lt;&lt; <font class="stringliteral">" moveto\n"</font> ;
04277   <font class="keywordflow">for</font>(i=0;i&lt;Ca.n();i++){
04278     <font class="keywordflow">for</font>(j=1;j&lt;deg_+1;j++){
04279       fout &lt;&lt; pnts(i,j).x() &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; pnts(i,j).y() &lt;&lt; <font class="charliteral">' '</font> ;
04280     }
04281     fout &lt;&lt; <font class="stringliteral">"curveto\n"</font> ;
04282   }
04283   fout &lt;&lt; <font class="stringliteral">"stroke\n"</font> ;
04284 
04285   <font class="keywordflow">if</font>(cp&gt;0){ <font class="comment">// draw the control points of the original curve</font>
04286     Vector&lt; Point_nD&lt;T,N&gt; &gt; pts(P.n()) ;
04287     <font class="keywordflow">for</font>(i=0;i&lt;P.n();i++){
04288       pts[i] = project2D(P[i]) ;
04289       movePsP(pts[i],magFact) ;
04290       fout &lt;&lt; <font class="stringliteral">"newpath\n"</font> ;
04291       fout &lt;&lt; pts[i].x() &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; pts[i].y() &lt;&lt; <font class="stringliteral">"  3 0 360 arc\nfill\n"</font> ;
04292     }
04293     <font class="keywordflow">if</font>(dash&gt;0)
04294       fout &lt;&lt; <font class="stringliteral">"["</font> &lt;&lt; dash &lt;&lt; <font class="stringliteral">"] "</font> &lt;&lt; dash &lt;&lt; <font class="stringliteral">" setdash\n"</font> ;
04295     fout &lt;&lt; <font class="stringliteral">"newpath\n"</font> ;
04296     
04297     fout &lt;&lt; pts[0].x() &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; pts[0].y() &lt;&lt; <font class="stringliteral">" moveto\n"</font> ;
04298     <font class="keywordflow">for</font>(i=1;i&lt;P.n();i++)
04299       fout &lt;&lt; pts[i].x() &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; pts[i].y() &lt;&lt; <font class="stringliteral">" lineto\n"</font> ;
04300     fout &lt;&lt; <font class="stringliteral">"stroke\n"</font> ;
04301   }
04302   <font class="keywordflow">else</font>{
04303     <font class="keywordflow">if</font>(cp&lt;0){
04304       Vector&lt; Point_nD&lt;T,N&gt; &gt; pts(P.n()*Ca.n()) ;
04305       <font class="keywordtype">int</font> k=0 ;
04306       <font class="keywordflow">for</font>(i=0;i&lt;Ca.n();i++)
04307         <font class="keywordflow">for</font>(j=0;j&lt;deg_+1;j++){
04308           pts[k] = project2D(Ca[i].P[j]) ;
04309           movePsP(pts[k],magFact) ;
04310           fout &lt;&lt; <font class="stringliteral">"newpath\n"</font> ;
04311           fout &lt;&lt; pts[k].x() &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; pts[k].y() &lt;&lt; <font class="stringliteral">"  3 0 360 arc\nfill\n"</font> ;
04312           k++ ;
04313         }
04314       <font class="keywordflow">if</font>(dash&gt;0)
04315         fout &lt;&lt; <font class="stringliteral">"["</font> &lt;&lt; dash &lt;&lt; <font class="stringliteral">"] "</font> &lt;&lt; dash &lt;&lt; <font class="stringliteral">" setdash\n"</font> ;
04316       fout &lt;&lt; <font class="stringliteral">"newpath\n"</font> ;
04317       
04318       fout &lt;&lt; pts[0].x() &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; pts[0].y() &lt;&lt; <font class="stringliteral">" moveto\n"</font> ;
04319       <font class="keywordflow">for</font>(i=1;i&lt;k;i++)
04320         fout &lt;&lt; pts[i].x() &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; pts[i].y() &lt;&lt; <font class="stringliteral">" lineto\n"</font> ;
04321       fout &lt;&lt; <font class="stringliteral">"stroke\n"</font> ;      
04322     }
04323   }
04324 
04325   <font class="keywordflow">for</font>(i=0;i&lt;points.n();++i){
04326     Point_nD&lt;T,N&gt; p ;
04327     p = points[i] ;
04328     movePsP(p,magFact) ;
04329     fout &lt;&lt; <font class="stringliteral">"newpath\n"</font> ;
04330     fout &lt;&lt; p.x() &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; p.y() &lt;&lt; <font class="stringliteral">"  3 0 360 arc\nfill\n"</font> ;
04331   }
04332 
04333   <font class="keywordflow">if</font>(vectors.n()==points.n()){
04334     <font class="keywordflow">for</font>(i=0;i&lt;points.n();++i){
04335       Point_nD&lt;T,N&gt; p,p2 ;
04336       p = points[i] ;
04337       p2 = points[i] + vectors[i] ;
04338       movePsP(p,magFact) ;
04339       movePsP(p2,magFact) ;
04340       fout &lt;&lt; <font class="stringliteral">"newpath\n"</font> ;
04341       fout &lt;&lt; p.x() &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; p.y() &lt;&lt; <font class="stringliteral">" moveto\n"</font> ;
04342       <font class="keywordflow">if</font>(dash&gt;0)
04343         fout &lt;&lt; <font class="stringliteral">"["</font> &lt;&lt; dash/2.0 &lt;&lt; <font class="stringliteral">"] "</font> &lt;&lt; dash/2.0 &lt;&lt; <font class="stringliteral">" setdash\n"</font> ;
04344       fout &lt;&lt; p2.x() &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; p2.y() &lt;&lt; <font class="stringliteral">" lineto\n"</font> ;
04345       fout &lt;&lt; <font class="stringliteral">"stroke\n"</font> ;
04346     }
04347   }
04348 
04349   fout &lt;&lt; <font class="stringliteral">"showpage\n%%EOF\n"</font> ;
04350   <font class="keywordflow">return</font> 1 ;
04351 }
04352 
04373 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
04374 <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::writeVRML(<font class="keyword">const</font> <font class="keywordtype">char</font>* filename,T radius,<font class="keywordtype">int</font> K, <font class="keyword">const</font> Color&amp; color,<font class="keywordtype">int</font> Nu,<font class="keywordtype">int</font> Nv, T u_s, T u_e)<font class="keyword"> const</font>{
04375   NurbsSurface&lt;T,N&gt; S ;
04376   NurbsCurve&lt;T,N&gt; <a class="code" href="classPLib_1_1NurbsCurve.html#l0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#l0">C</a> ;
04377   
04378   <a class="code" href="classPLib_1_1NurbsCurve.html#l0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#l0">C</a>.makeCircle(Point_nD&lt;T,N&gt;(0,0,0),Point_nD&lt;T,N&gt;(1,0,0),Point_nD&lt;T,N&gt;(0,0,1),radius,0,2*M_PI);
04379   S.sweep(*<font class="keyword">this</font>,<a class="code" href="classPLib_1_1NurbsCurve.html#l0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#l0">C</a>,K) ;
04380   <font class="keywordflow">return</font> S.writeVRML(filename,color,Nu,Nv,0,1,u_s,u_e) ;
04381 }
04382 
04403 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
04404 <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::writeVRML97(<font class="keyword">const</font> <font class="keywordtype">char</font>* filename,T radius,<font class="keywordtype">int</font> K, <font class="keyword">const</font> Color&amp; color,<font class="keywordtype">int</font> Nu,<font class="keywordtype">int</font> Nv, T u_s, T u_e)<font class="keyword"> const</font>{
04405   NurbsSurface&lt;T,N&gt; S ;
04406   NurbsCurve&lt;T,N&gt; <a class="code" href="classPLib_1_1NurbsCurve.html#l0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#l0">C</a> ;
04407   
04408   <a class="code" href="classPLib_1_1NurbsCurve.html#l0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#l0">C</a>.makeCircle(Point_nD&lt;T,N&gt;(0,0,0),Point_nD&lt;T,N&gt;(1,0,0),Point_nD&lt;T,N&gt;(0,0,1),radius,0,2*M_PI);
04409   S.sweep(*<font class="keyword">this</font>,<a class="code" href="classPLib_1_1NurbsCurve.html#l0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#l0">C</a>,K) ;
04410   <font class="keywordflow">return</font> S.writeVRML97(filename,color,Nu,Nv,0,1,u_s,u_e) ;
04411 }
04412 
04433 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
04434 <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::writeVRML(ostream &amp;fout,T radius,<font class="keywordtype">int</font> K, <font class="keyword">const</font> Color&amp; color,<font class="keywordtype">int</font> Nu,<font class="keywordtype">int</font> Nv, T u_s, T u_e)<font class="keyword"> const</font>{
04435   NurbsSurface&lt;T,N&gt; S ;
04436   NurbsCurve&lt;T,N&gt; <a class="code" href="classPLib_1_1NurbsCurve.html#l0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#l0">C</a> ;
04437   
04438   <a class="code" href="classPLib_1_1NurbsCurve.html#l0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#l0">C</a>.makeCircle(Point_nD&lt;T,N&gt;(0,0,0),Point_nD&lt;T,N&gt;(1,0,0),Point_nD&lt;T,N&gt;(0,0,1),radius,0,2*M_PI);
04439   S.sweep(*<font class="keyword">this</font>,<a class="code" href="classPLib_1_1NurbsCurve.html#l0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#l0">C</a>,K) ;
04440   <font class="keywordflow">return</font> S.writeVRML(fout,color,Nu,Nv,0,1,u_s,u_e) ;
04441 }
04442 
04463 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
04464 <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::writeVRML97(ostream &amp;fout,T radius,<font class="keywordtype">int</font> K, <font class="keyword">const</font> Color&amp; color,<font class="keywordtype">int</font> Nu,<font class="keywordtype">int</font> Nv, T u_s, T u_e)<font class="keyword"> const</font>{
04465   NurbsSurface&lt;T,N&gt; S ;
04466   NurbsCurve&lt;T,N&gt; <a class="code" href="classPLib_1_1NurbsCurve.html#l0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#l0">C</a> ;
04467   
04468   <a class="code" href="classPLib_1_1NurbsCurve.html#l0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#l0">C</a>.makeCircle(Point_nD&lt;T,N&gt;(0,0,0),Point_nD&lt;T,N&gt;(1,0,0),Point_nD&lt;T,N&gt;(0,0,1),radius,0,2*M_PI);
04469   S.sweep(*<font class="keyword">this</font>,<a class="code" href="classPLib_1_1NurbsCurve.html#l0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#l0">C</a>,K) ;
04470   <font class="keywordflow">return</font> S.writeVRML97(fout,color,Nu,Nv,0,1,u_s,u_e) ;
04471 }
04472 
04485 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
04486 <font class="keywordtype">void</font> to3D(<font class="keyword">const</font> NurbsCurve&lt;T,2&gt;&amp; c2d, NurbsCurve&lt;T,3&gt;&amp; c3d){
04487   c3d.resize(c2d.ctrlPnts().n(),c2d.degree()) ; 
04488 
04489   c3d.modKnot(c2d.knot()) ; 
04490   HPoint_nD&lt;T,3&gt; p(0) ; 
04491   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=c2d.ctrlPnts().n()-1;i&gt;=0;--i){
04492     p.x() = c2d.ctrlPnts()[i].x() ; 
04493     p.y() = c2d.ctrlPnts()[i].y() ; 
04494     p.w() = c2d.ctrlPnts()[i].w() ; 
04495     c3d.modCP(i,p) ; 
04496   }
04497 }
04498 
04499 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
04500 <font class="keywordtype">void</font> to3D(<font class="keyword">const</font> NurbsCurve&lt;T,3&gt;&amp; c2d, NurbsCurve&lt;T,3&gt;&amp; c3d){
04501   c3d = c2d ; 
04502 }
04503 
04521 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
04522 <font class="keywordtype">void</font> to2D(<font class="keyword">const</font> NurbsCurve&lt;T,3&gt;&amp; c3d, NurbsCurve&lt;T,2&gt;&amp; c2d){
04523   c2d.resize(c3d.ctrlPnts().n(),c3d.degree()) ; 
04524 
04525   c2d.modKnot(c3d.knot()) ; 
04526   HPoint_nD&lt;T,2&gt; p(0) ; 
04527   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=c3d.ctrlPnts().n()-1;i&gt;=0;--i){
04528     p.x() = c3d.ctrlPnts()[i].x() ; 
04529     p.y() = c3d.ctrlPnts()[i].y() ; 
04530     p.w() = c3d.ctrlPnts()[i].w() ; 
04531     c2d.modCP(i,p) ; 
04532   }
04533 }
04534 
04562 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
04563 <font class="keywordtype">void</font> knotAveraging(<font class="keyword">const</font> Vector&lt;T&gt;&amp; uk, <font class="keywordtype">int</font> deg, Vector&lt;T&gt;&amp; U){
04564   U.resize(uk.n()+deg+1) ;
04565 
04566   <font class="keywordtype">int</font> j ;
04567   <font class="keywordflow">for</font>(j=1;j&lt;uk.n()-deg;++j){
04568     U[j+deg] = 0.0 ;
04569     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=j;i&lt;j+deg;++i)
04570       U[j+deg] += uk[i] ;
04571     U[j+deg] /= (T)deg ;
04572   }
04573   <font class="keywordflow">for</font>(j=0;j&lt;=deg;++j)
04574     U[j] = 0.0 ;
04575   <font class="keywordflow">for</font>(j=U.n()-deg-1;j&lt;U.n();++j)
04576     U[j] = 1.0 ;
04577 }
04578 
04579 
04580 
04595 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
04596 <font class="keywordtype">void</font> averagingKnots(<font class="keyword">const</font> Vector&lt;T&gt;&amp; U, <font class="keywordtype">int</font> deg, Vector&lt;T&gt;&amp; uk){
04597   uk.resize(U.n()-deg-1) ;
04598 
04599   <font class="keywordtype">int</font> i,k ;
04600 
04601   uk[0] = U[0] ;
04602   uk[uk.n()-1] = U[U.n()-1] ;
04603 
04604   <font class="keywordflow">for</font>(k=1;k&lt;uk.n()-1;++k){
04605     uk[k] = 0.0 ;
04606     <font class="keywordflow">for</font>(i=k+1;i&lt;k+deg+1;++i)
04607       uk[k] += U[i] ;
04608     uk[k] /= deg ;
04609   }
04610 }
04611 
04627 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
04628 <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::movePoint(T u, <font class="keyword">const</font> Point_nD&lt;T,N&gt;&amp; delta) {
04629   BasicArray&lt; Point_nD&lt;T,N&gt; &gt; d(1) ;
04630   d[0] = delta ;
04631   <font class="keywordflow">return</font> movePoint(u,d) ;
04632 }
04633 
04654 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
04655 <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::movePoint(T u, <font class="keyword">const</font> BasicArray&lt; Point_nD&lt;T,N&gt; &gt;&amp; delta) {
04656   <font class="keywordtype">int</font> i,j ;
04657 
04658   <font class="comment">// setup B</font>
04659   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> B ;
04660   
04661   <font class="keywordtype">int</font> n,m ; <font class="comment">// n is the number of rows, m the number of columns</font>
04662 
04663   m = deg_ + 1 ;
04664   n = delta.n() ;
04665 
04666   B.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a8'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a8">resize</a>(n,m) ;
04667   
04668   <font class="keywordtype">int</font> span = <a class="code" href="classPLib_1_1NurbsCurve.html#a32" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a32">findSpan</a>(u) ;
04669 
04670   n = 0 ;
04671   
04672   Matrix&lt;T&gt; R ;
04673 
04674   <a class="code" href="classPLib_1_1NurbsCurve.html#a29" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a29">dersBasisFuns</a>(delta.n()-1,u,span,R) ;
04675 
04676 
04677   <font class="keywordflow">for</font>(i=0;i&lt;delta.n();++i){
04678     <font class="keywordflow">if</font>(delta[i].x()==0.0 &amp;&amp; delta[i].y()==0.0 &amp;&amp; delta[i].z()==0.0)
04679       <font class="keywordflow">continue</font> ;
04680     <font class="keywordflow">for</font>(j=0;j&lt;m;++j){
04681       B(n,j) = (double)R(i,j) ;
04682     }
04683     ++n ;
04684   }
04685 
04686   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> A  ;
04687   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> Bt(transpose(B)) ;
04688   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> BBt ;
04689 
04690   BBt = inverse(B*Bt) ;
04691   A = Bt*BBt ;
04692 
04693   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> dD ;
04694 
04695   dD.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a8'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a8">resize</a>(delta.n(),N) ;
04696   <font class="keywordflow">for</font>(i=0;i&lt;delta.n();++i){
04697     <font class="keyword">const</font> Point_nD&lt;T,N&gt;&amp; d = delta[i] ; <font class="comment">// this makes the SGI compiler happy</font>
04698     <font class="keywordflow">for</font>(j=0;j&lt;N;++j)
04699       dD(i,j) = (double)d.data[j] ;
04700   }
04701 
04702   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> dP ;
04703 
04704   dP = A*dD ;
04705 
04706   <font class="keywordflow">for</font>(i=0;i&lt;m;++i){
04707     P[span-deg_+i].x() += dP(i,0)*P[span-deg_+i].w() ;
04708     P[span-deg_+i].y() += dP(i,1)*P[span-deg_+i].w() ;
04709     P[span-deg_+i].z() += dP(i,2)*P[span-deg_+i].w() ;
04710   }
04711 
04712   <font class="keywordflow">return</font> 1 ;
04713 }
04714 
04747 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
04748 <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::movePoint(<font class="keyword">const</font> BasicArray&lt;T&gt;&amp; ur, <font class="keyword">const</font> BasicArray&lt; Point_nD&lt;T,N&gt; &gt;&amp; D) {
04749   BasicArray&lt;int&gt; fixCP(0) ;
04750   BasicArray&lt;int&gt; Dr(D.n()) ;
04751   BasicArray&lt;int&gt; Dk(D.n()) ;
04752 
04753   <font class="keywordflow">if</font>(ur.n() != D.n()){
04754 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
04755 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>(ur.n(),D.n()) ;
04756 <font class="preprocessor">#else</font>
04757 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"movePoint(ur,D)"</font>);
04758     err &lt;&lt; <font class="stringliteral">"The two input vectors are not of the same size\n"</font> ;
04759     err &lt;&lt; <font class="stringliteral">"ur.n()= "</font> &lt;&lt; ur.n() &lt;&lt; <font class="stringliteral">", D.n() = "</font> &lt;&lt; D.n() &lt;&lt; endl ;
04760     err.fatal() ;
04761 <font class="preprocessor">#endif</font>
04762 <font class="preprocessor"></font>  }
04763   
04764   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=0;i&lt;Dr.n();++i){
04765     Dr[i] = i ;
04766   }
04767   Dk.reset(0) ;
04768   <font class="keywordflow">return</font> movePoint(ur,D,Dr,Dk,fixCP) ;
04769 }
04770 
04811 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
04812 <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::movePoint(<font class="keyword">const</font> BasicArray&lt;T&gt;&amp; ur, <font class="keyword">const</font> BasicArray&lt; Point_nD&lt;T,N&gt; &gt;&amp; D, <font class="keyword">const</font> <a class="code" href="classPLib_1_1BasicArray.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html">BasicArray_INT</a>&amp; Dr, <font class="keyword">const</font> <a class="code" href="classPLib_1_1BasicArray.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html">BasicArray_INT</a>&amp; Dk) {
04813   <a class="code" href="classPLib_1_1BasicArray.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html">BasicArray_INT</a> fixCP(0) ;
04814 
04815   <font class="keywordflow">if</font>(D.n() != Dr.<a class="code" href="classPLib_1_1BasicArray.html#a0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a0">n</a>() ){
04816 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
04817 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>(D.n(),Dr.<a class="code" href="classPLib_1_1BasicArray.html#a0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a0">n</a>()) ;
04818 <font class="preprocessor">#else</font>
04819 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"movePoint(ur,D,Dr,Dk)"</font>);
04820     err &lt;&lt; <font class="stringliteral">"The D,Dr,Dk vectors are not of the same size\n"</font> ;
04821     err &lt;&lt; <font class="stringliteral">"D.n()= "</font> &lt;&lt; D.n() &lt;&lt; <font class="stringliteral">", Dr.n() = "</font> &lt;&lt; Dr.<a class="code" href="classPLib_1_1BasicArray.html#a0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a0">n</a>() 
04822         &lt;&lt; <font class="stringliteral">", Dk.n() = "</font> &lt;&lt; Dk.<a class="code" href="classPLib_1_1BasicArray.html#a0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a0">n</a>() &lt;&lt; endl ;
04823     err.fatal() ;
04824 <font class="preprocessor">#endif</font>
04825 <font class="preprocessor"></font>  }
04826 
04827   <font class="keywordflow">if</font>( D.n() !=Dk.<a class="code" href="classPLib_1_1BasicArray.html#a0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a0">n</a>()){
04828 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
04829 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>(D.n(),Dk.<a class="code" href="classPLib_1_1BasicArray.html#a0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a0">n</a>()) ;
04830 <font class="preprocessor">#else</font>
04831 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"movePoint(ur,D,Dr,Dk)"</font>);
04832     err &lt;&lt; <font class="stringliteral">"The D,Dr,Dk vectors are not of the same size\n"</font> ;
04833     err &lt;&lt; <font class="stringliteral">"D.n()= "</font> &lt;&lt; D.n() &lt;&lt; <font class="stringliteral">", Dr.n() = "</font> &lt;&lt; Dr.<a class="code" href="classPLib_1_1BasicArray.html#a0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a0">n</a>() 
04834         &lt;&lt; <font class="stringliteral">", Dk.n() = "</font> &lt;&lt; Dk.<a class="code" href="classPLib_1_1BasicArray.html#a0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a0">n</a>() &lt;&lt; endl ;
04835     err.fatal() ;
04836 <font class="preprocessor">#endif</font>
04837 <font class="preprocessor"></font>  }  
04838 
04839   <font class="keywordflow">return</font> movePoint(ur,D,Dr,Dk,fixCP) ;
04840 }
04841 
04887 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
04888 <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::movePoint(<font class="keyword">const</font> BasicArray&lt;T&gt;&amp; ur, <font class="keyword">const</font> BasicArray&lt; Point_nD&lt;T,N&gt; &gt;&amp; D, <font class="keyword">const</font> <a class="code" href="classPLib_1_1BasicArray.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html">BasicArray_INT</a>&amp; Dr, <font class="keyword">const</font> <a class="code" href="classPLib_1_1BasicArray.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html">BasicArray_INT</a>&amp; Dk, <font class="keyword">const</font> <a class="code" href="classPLib_1_1BasicArray.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html">BasicArray_INT</a>&amp; fixCP) {
04889   <font class="keywordtype">int</font> i,j,n ;
04890 
04891   <font class="keywordflow">if</font>(D.n() != Dr.<a class="code" href="classPLib_1_1BasicArray.html#a0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a0">n</a>() ){
04892 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
04893 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>(D.n(),Dr.<a class="code" href="classPLib_1_1BasicArray.html#a0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a0">n</a>()) ;
04894 <font class="preprocessor">#else</font>
04895 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"movePoint(ur,D,Dr,Dk)"</font>);
04896     err &lt;&lt; <font class="stringliteral">"The D,Dr,Dk vectors are not of the same size\n"</font> ;
04897     err &lt;&lt; <font class="stringliteral">"D.n()= "</font> &lt;&lt; D.n() &lt;&lt; <font class="stringliteral">", Dr.n() = "</font> &lt;&lt; Dr.<a class="code" href="classPLib_1_1BasicArray.html#a0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a0">n</a>() 
04898         &lt;&lt; <font class="stringliteral">", Dk.n() = "</font> &lt;&lt; Dk.<a class="code" href="classPLib_1_1BasicArray.html#a0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a0">n</a>() &lt;&lt; endl ;
04899     err.fatal() ;
04900 <font class="preprocessor">#endif</font>
04901 <font class="preprocessor"></font>  }
04902 
04903   <font class="keywordflow">if</font>( D.n() !=Dk.<a class="code" href="classPLib_1_1BasicArray.html#a0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a0">n</a>()){
04904 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
04905 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>(D.n(),Dk.<a class="code" href="classPLib_1_1BasicArray.html#a0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a0">n</a>()) ;
04906 <font class="preprocessor">#else</font>
04907 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"movePoint(ur,D,Dr,Dk)"</font>);
04908     err &lt;&lt; <font class="stringliteral">"The D,Dr,Dk vectors are not of the same size\n"</font> ;
04909     err &lt;&lt; <font class="stringliteral">"D.n()= "</font> &lt;&lt; D.n() &lt;&lt; <font class="stringliteral">", Dr.n() = "</font> &lt;&lt; Dr.<a class="code" href="classPLib_1_1BasicArray.html#a0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a0">n</a>() 
04910         &lt;&lt; <font class="stringliteral">", Dk.n() = "</font> &lt;&lt; Dk.<a class="code" href="classPLib_1_1BasicArray.html#a0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a0">n</a>() &lt;&lt; endl ;
04911     err.fatal() ;
04912 <font class="preprocessor">#endif</font>
04913 <font class="preprocessor"></font>  }  
04914 
04915   <font class="comment">// setup B</font>
04916   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> B ;
04917   
04918   B.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a8'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a8">resize</a>(D.n(),P.n()) ;
04919   
04920   <font class="keywordtype">int</font> span ;
04921 
04922   Matrix&lt;T&gt; R ;
04923 
04924   B.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a11'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a11">reset</a>(0.0) ;
04925 
04926   <font class="keywordflow">for</font>(i=0;i&lt;D.n();++i){
04927     span = <a class="code" href="classPLib_1_1NurbsCurve.html#a32" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a32">findSpan</a>(ur[Dr[i]]) ;
04928     <a class="code" href="classPLib_1_1NurbsCurve.html#a29" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a29">dersBasisFuns</a>(Dk[i],ur[Dr[i]],span,R) ;
04929     <font class="keywordflow">for</font>(j=0;j&lt;=deg_;++j){
04930       B(i,span-deg_+j) = (double)R(Dk[i],j) ;
04931     }
04932   }
04933 
04934   <font class="comment">// optimize B</font>
04935   <a class="code" href="classPLib_1_1BasicArray.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html">BasicArray_INT</a> remove(B.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1">cols</a>()) ;
04936   <a class="code" href="classPLib_1_1BasicArray.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html">BasicArray_INT</a> map(B.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1">cols</a>()) ;
04937   remove.<a class="code" href="classPLib_1_1BasicArray.html#a15" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a15">reset</a>((<font class="keywordtype">int</font>)1.0) ;
04938 
04939   <font class="keywordflow">for</font>(j=0;j&lt;B.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1">cols</a>();++j){
04940     <font class="keywordflow">for</font>(i=0;i&lt;B.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>();++i)
04941       <font class="keywordflow">if</font>((B(i,j)*B(i,j))&gt;1e-10){
04942         remove[j] = 0 ;
04943         <font class="keywordflow">break</font> ;
04944       }
04945   }
04946 
04947   <font class="keywordflow">for</font>(i=0;i&lt;fixCP.<a class="code" href="classPLib_1_1BasicArray.html#a0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a0">n</a>();++i){
04948     remove[fixCP[i]] = 1 ;
04949   }
04950 
04951   n = 0 ;
04952   <font class="keywordflow">for</font>(i=0;i&lt;B.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a1">cols</a>();++i){
04953     <font class="keywordflow">if</font>(!remove[i]){
04954       map[n] = i ;
04955       ++n ;
04956     }
04957   }
04958 
04959   map.<a class="code" href="classPLib_1_1BasicArray.html#a9" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a9">resize</a>(n) ;
04960 
04961   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> Bopt(B.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>(),n) ;
04962   <font class="keywordflow">for</font>(j=0;j&lt;n;++j){
04963     <font class="keywordflow">for</font>(i=0;i&lt;B.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>();++i)
04964       Bopt(i,j) = B(i,map[j]) ;
04965   }
04966 
04967   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> A  ;
04968   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> Bt(transpose(Bopt)) ;
04969   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> BBt ;
04970 
04971   BBt = inverse(Bopt*Bt) ;
04972 
04973   A = Bt*BBt ;
04974 
04975   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> dD ;
04976 
04977   dD.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a8'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a8">resize</a>(D.n(),N) ;
04978   <font class="keywordflow">for</font>(i=0;i&lt;D.n();++i){
04979     <font class="keyword">const</font> Point_nD&lt;T,N&gt;&amp; d = D[i] ; <font class="comment">// this makes the SGI compiler happy</font>
04980     <font class="keywordflow">for</font>(j=0;j&lt;N;++j)
04981       dD(i,j) = (double)d.data[j] ;
04982   }
04983 
04984   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> dP ;
04985 
04986   dP = A*dD ;
04987 
04988   <font class="keywordflow">for</font>(i=0;i&lt;map.<a class="code" href="classPLib_1_1BasicArray.html#a0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#a0">n</a>();++i){
04989     P[map[i]].<a class="code" href="classPLib_1_1BasicArray.html#n4" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1BasicArray.html#n4">x</a>() += dP(i,0)*P[map[i]].w() ;
04990     P[map[i]].y() += dP(i,1)*P[map[i]].w() ;
04991     P[map[i]].z() += dP(i,2)*P[map[i]].w() ;
04992   }
04993 
04994   <font class="keywordflow">return</font> 1 ;
04995 }
04996 
05011 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
05012 <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::splitAt(T u, NurbsCurve&lt;T,N&gt;&amp; cl, NurbsCurve&lt;T,N&gt;&amp; cu)<font class="keyword"> const </font>{
05013   <font class="keywordflow">if</font>(u&lt;= U[deg_])
05014     <font class="keywordflow">return</font> 0 ;
05015   <font class="keywordflow">if</font>(u&gt;= U[U.n()-deg_-1])
05016     <font class="keywordflow">return</font> 0 ;
05017 
05018   <font class="comment">// get the multiplicity at u</font>
05019   <font class="keywordtype">int</font> s,j,i ;
05020   <font class="keywordtype">int</font> span = <a class="code" href="classPLib_1_1NurbsCurve.html#a32" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a32">findSpan</a>(u) ;
05021 
05022   <font class="keywordflow">if</font>(absolute(u-U[span])&lt;1e-6)
05023     s = <a class="code" href="classPLib_1_1NurbsCurve.html#a34" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a34">findMult</a>(span) ;
05024   <font class="keywordflow">else</font>
05025     s = 0 ;
05026 
05027   BasicArray&lt;T&gt; X(deg_+1-s) ;
05028   X.reset(u) ;
05029 
05030   cl = *<font class="keyword">this</font> ;
05031   <font class="keywordflow">if</font>(X.n()&gt;0)
05032     cl.refineKnotVector(X) ;
05033 
05034   span = cl.findSpan(u)-deg_ ;
05035   <font class="comment">// span is the begining of the upper curve</font>
05036   cu.resize(cl.P.n()-span,deg_) ;
05037   <font class="keywordflow">for</font>(i=cl.P.n()-1,j=cu.P.n()-1;j&gt;=0;--j,--i){
05038     cu.P[j] = cl.P[i] ;
05039   }
05040 
05041   <font class="keywordflow">for</font>(i=cl.U.n()-1,j=cu.U.n()-1;j&gt;=0;--j,--i){
05042     cu.U[j] = cl.U[i] ;
05043   }
05044   cl.resize(span,deg_) ;
05045 
05046   <font class="keywordflow">return</font> 1 ;
05047 }
05048 
05064 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
05065 <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::mergeOf(<font class="keyword">const</font> NurbsCurve&lt;T,N&gt;&amp; cl, <font class="keyword">const</font> NurbsCurve&lt;T,N&gt; &amp;cu){
05066   <font class="keywordflow">if</font>(cl.deg_ != cu.deg_){
05067 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
05068 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>();
05069 <font class="preprocessor">#else</font>
05070 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"NurbsCurve&lt;T,N&gt;::mergeOf"</font>);
05071     err &lt;&lt; <font class="stringliteral">" The two curves are not of the same degree\n"</font> ;
05072     err.warning() ;
05073     <font class="keywordflow">return</font> 0 ;
05074 <font class="preprocessor">#endif</font>
05075 <font class="preprocessor"></font>  }
05076   <font class="keywordflow">if</font>((cl.U[cl.U.n()-1]-cu.U[0])*(cl.U[cl.U.n()-1]-cu.U[0])&gt;1e-8){
05077 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
05078 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>();
05079 <font class="preprocessor">#else</font>
05080 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"NurbsCurve&lt;T,N&gt;::mergeOf"</font>);
05081     err &lt;&lt; <font class="stringliteral">" The two knot vectors are not compatible.\n"</font> ;
05082     err &lt;&lt; <font class="stringliteral">"The first one is "</font> &lt;&lt; cl.U &lt;&lt; endl ;
05083     err &lt;&lt; <font class="stringliteral">"The second is    "</font> &lt;&lt; cu.U &lt;&lt; endl ;
05084     err.warning() ;
05085     <font class="keywordflow">return</font> 0 ;
05086 <font class="preprocessor">#endif</font>
05087 <font class="preprocessor"></font>  }
05088   <font class="keywordflow">if</font>(norm2(cl.P[cl.P.n()-1]-cu.P[0])&gt;1e-8){
05089 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
05090 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>();
05091 <font class="preprocessor">#else</font>
05092 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"NurbsCurve&lt;T,N&gt;::mergeOf"</font>);
05093     err &lt;&lt; <font class="stringliteral">" The end control points are NOT the same.\n"</font> ;
05094     err &lt;&lt; <font class="stringliteral">" cl.P[n-1] = "</font> &lt;&lt; cl.P[cl.P.n()-1] &lt;&lt; endl ;
05095     err &lt;&lt; <font class="stringliteral">" cu.P[0] = "</font> &lt;&lt; cu.P[0] &lt;&lt; endl ;
05096     err.warning() ;
05097     <font class="keywordflow">return</font> 0 ;
05098 <font class="preprocessor">#endif</font>
05099 <font class="preprocessor"></font>  }
05100   <a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">resize</a>(cl.P.n()+cu.P.n(),cl.deg_) ;
05101 
05102   <font class="keywordtype">int</font> i ;
05103   <font class="keywordflow">for</font>(i=0;i&lt;cl.P.n();++i)
05104     P[i] = cl.P[i] ;
05105   <font class="keywordflow">for</font>(;i&lt;P.n();++i)
05106     P[i] = cu.P[i-cl.P.n()] ;
05107 
05108   <font class="keywordflow">for</font>(i=0;i&lt;cl.U.n();++i)
05109     U[i] = cl.U[i] ;
05110   <font class="keywordflow">for</font>(;i&lt;U.n();++i)
05111     U[i] = cu.U[i-cl.U.n()+deg_+1] ;
05112 
05113   <font class="keywordflow">return</font> 1 ;
05114 }
05115 
05136 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
05137 <font class="keywordtype">int</font> findSpan(T u, <font class="keyword">const</font> Vector&lt;T&gt;&amp; U, <font class="keywordtype">int</font> deg) {
05138   <font class="keywordflow">if</font>(u&gt;=U[U.n()-deg-1]) 
05139     <font class="keywordflow">return</font> U.n()-deg-1 ;
05140   <font class="keywordflow">if</font>(u&lt;=U[deg])
05141     <font class="keywordflow">return</font> deg ;
05142   <font class="comment">//AF</font>
05143   <font class="keywordtype">int</font> low = 0 ;
05144   <font class="keywordtype">int</font> high = U.n()-deg ;
05145   <font class="keywordtype">int</font> mid = (low+high)/2 ;
05146 
05147   <font class="keywordflow">while</font>(u&lt;U[mid] || u&gt;= U[mid+1]){
05148     <font class="keywordflow">if</font>(u&lt;U[mid])
05149       high = mid ;
05150     <font class="keywordflow">else</font>
05151       low = mid ;
05152     mid = (low+high)/2 ;
05153   }
05154   <font class="keywordflow">return</font> mid ;
05155  
05156 }
05157 
05158 
05174 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
05175 <a class="code" href="classBasicList.html" tppabs="http://libnurbs.sourceforge.net/docs/classBasicList.html">BasicList&lt;Point_nD&lt;T,N&gt;</a> &gt; NurbsCurve&lt;T,N&gt;::tesselate(T tolerance,<a class="code" href="classBasicList.html" tppabs="http://libnurbs.sourceforge.net/docs/classBasicList.html">BasicList&lt;T&gt;</a> *uk)<font class="keyword"> const </font>{
05176   <a class="code" href="classBasicList.html" tppabs="http://libnurbs.sourceforge.net/docs/classBasicList.html">BasicList&lt;Point_nD&lt;T,N&gt;</a> &gt; list,list2 ;
05177 
05178   NurbsCurveArray&lt;T,N&gt; ca ;
05179   decompose(ca) ;
05180 
05181   <font class="keywordflow">if</font>(ca.n()==1){
05182     <font class="comment">// get the number of steps </font>
05183     T u = U[0] ;
05184     Point_nD&lt;T,N&gt; maxD(0) ;
05185     Point_nD&lt;T,N&gt; prev ;
05186 
05187     Vector&lt; Point_nD&lt;T,N&gt; &gt; ders(2) ;
05188 
05189     <a class="code" href="classPLib_1_1NurbsCurve.html#a17" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a17">deriveAt</a>(u,1,ders) ;
05190     
05191     prev = ders[1] ;
05192 
05193     <font class="keywordtype">int</font> i ;
05194     <font class="keywordflow">for</font>(i=1;i&lt;11;++i){
05195       u = T(i)/T(10)*(U[U.n()-1]-U[0]) + U[0] ;
05196       <a class="code" href="classPLib_1_1NurbsCurve.html#a17" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a17">deriveAt</a>(u,1,ders) ;
05197       Point_nD&lt;T,N&gt; delta = ders[1]-prev ;
05198       delta.x() = absolute(delta.x()) ;
05199       delta.y() = absolute(delta.y()) ;
05200       delta.z() = absolute(delta.z()) ;
05201       maxD = maximumRef(maxD,delta) ;
05202       prev = ders[1] ;
05203     }
05204     
05205     <font class="keyword">const</font> T sqr2 = T(1.414241527) ;
05206 
05207     <font class="keywordtype">int</font> n = (int)rint(sqr2*norm(maxD)/tolerance) ;
05208 
05209     n+=2 ;
05210     <font class="keywordflow">if</font>(n&lt;3) n = 3 ;
05211 
05212     <font class="keywordflow">for</font>(i=0;i&lt;n;++i){
05213       u = (U[U.n()-deg_-1]-U[deg_])*T(i)/T(n-1) + U[deg_] ;
05214       list.<a class="code" href="classBasicList.html#a6" tppabs="http://libnurbs.sourceforge.net/docs/classBasicList.html#a6">add</a>(<a class="code" href="classPLib_1_1ParaCurve.html#a3" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1ParaCurve.html#a3">pointAt</a>(u)) ;
05215       <font class="keywordflow">if</font>(uk)
05216         uk-&gt;<a class="code" href="classBasicList.html#a6" tppabs="http://libnurbs.sourceforge.net/docs/classBasicList.html#a6">add</a>(u) ;
05217     }
05218 
05219     <font class="keywordflow">return</font> list ;
05220   }
05221   <font class="keywordflow">else</font>{
05222     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=0;i&lt;ca.n();++i){
05223       list2 = ca[i].tesselate(tolerance,uk) ;
05224 
05225       <font class="comment">// remove the last point from the list to elliminate</font>
05226       list.<a class="code" href="classBasicList.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classBasicList.html#a10">erase</a>((<a class="code" href="structBasicNode.html" tppabs="http://libnurbs.sourceforge.net/docs/structBasicNode.html">BasicNode</a>&lt;Point_nD&lt;T,N&gt; &gt;*)list.<a class="code" href="classBasicList.html#a4" tppabs="http://libnurbs.sourceforge.net/docs/classBasicList.html#a4">last</a>()) ;
05227       list.<a class="code" href="classBasicList.html#a8" tppabs="http://libnurbs.sourceforge.net/docs/classBasicList.html#a8">addElements</a>(list2) ;      
05228     }
05229   }
05230   <font class="keywordflow">return</font> list ;
05231 }
05232 
05261 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
05262 <font class="keywordtype">int</font> maxInfluence(<font class="keywordtype">int</font> i, <font class="keyword">const</font> Vector&lt;T&gt;&amp; U, <font class="keywordtype">int</font> p, T &amp;u){
05263   <font class="keywordflow">if</font>(i&gt;U.n()-p-2)
05264     <font class="keywordflow">return</font> 0 ;
05265   <font class="keywordflow">switch</font>(p){
05266   <font class="keywordflow">case</font> 1: u = U[i+1] ; <font class="keywordflow">return</font> 1 ; 
05267   <font class="keywordflow">case</font> 2: { 
05268     T A = U[i] + U[i+1] - U[i+2] - U[i+3] ;
05269     <font class="keywordflow">if</font>(A&gt;=0){
05270       u = U[i] ;
05271       <font class="keywordflow">return</font> 1 ;
05272     }
05273     <font class="keywordflow">else</font>{
05274       u = (U[i]*U[i+1] - U[i+2]*U[i+3])/A ;
05275       <font class="keywordflow">return</font> 1 ;
05276     }
05277   }
05278   <font class="keywordflow">case</font> 3:{
05279     <font class="keywordtype">double</font> A = U[i]-U[i+3] ;
05280     <font class="keywordflow">if</font>(A&gt;=0){ <font class="comment">// 4 knots at the same place from U[i] to U[i+3]</font>
05281       u = U[i] ;
05282       <font class="keywordflow">return</font> 1 ;
05283     }
05284     A = U[i+1]-U[i+3] ;
05285     <font class="keywordflow">if</font>(A&gt;=0){ <font class="comment">// three knots are equal </font>
05286       u = U[i+1] ;
05287       <font class="keywordflow">return</font> 1 ;
05288     }
05289     <font class="comment">// there are 4 points of possible interest</font>
05290     <font class="comment">// the 'good' one lie between U[i+1] and U[i+3]</font>
05291     <font class="keywordtype">double</font> a,b,c,d,e,X ;
05292     a = U[i] ;
05293     b = U[i+1] ;
05294     c = U[i+2] ;
05295     d = U[i+3] ;
05296     e = U[i+4] ;
05297 
05298     <font class="keywordtype">double</font> t1,t2,t3,t4,t5,t6,t7,t8,t9,t10,t11,t12,t13,t15,t16,t18;
05299     <font class="keywordtype">double</font> t21,t22,t24,t25,t27,t28,t31,t32,t34,t35,t45,t46 ,t49 ,t52 ,t56;
05300     <font class="keywordtype">double</font> t63 ,t66 ,t69 ,t88 ,t107,t110 ;
05301     <font class="keywordtype">double</font> t115,t116,t117,t118,t119,t120,t121,t122,t124,t125,t127;
05302     <font class="keywordtype">double</font> t133,t135,t136,t143,t151,t154 ;
05303     <font class="keywordtype">double</font> t14,t17,t19,t20,t26,t29,t30,t33,t36,t37,t38,t39,t47,t55,t57 ;
05304     <font class="keywordtype">double</font> t59,t62,t64,t65,t67,t70,t72,t73,t75,t76,t77,t78,t79,t80 ;
05305     <font class="keywordtype">double</font> t81,t82,t83,t84,t85,t86,t87,t90,t91,t92,t93,t95,t96 ;
05306     <font class="keywordtype">double</font> t97,t99,t101 ;
05307 
05308     t1 = b*e;
05309     t2 = b*b;
05310     t3 = b*a;
05311     t4 = b*d;
05312     t5 = b*c;
05313     t6 = d*e;
05314     t7 = c*d;
05315     t8 = c*e;
05316     t9 = c*a;
05317     t10 = a*e;
05318     t11 = d*a;
05319     t12 = a*a;
05320     t13 = -t1+t2+t3-t4-t5+t6+t7+t8-t9-t10-t11+t12;
05321     t14 = 1/t13;
05322     t15 = t2*a;
05323     t16 = t3*e;
05324     t17 = t3*c;
05325     t18 = t7*e;
05326     t19 = t3*d;
05327     t20 = t12*b;
05328     t21 = t2*t12;
05329     t22 = e*e;
05330     t24 = c*c;
05331     t25 = t24*t22;
05332     t26 = t25*t11;
05333     t27 = t12*t22;
05334     t28 = t27*t5;
05335     t29 = t24*t12;
05336     t30 = t29*t6;
05337     t31 = t27*t7;
05338     t32 = d*d;
05339     t33 = t32*t12;
05340     t34 = t33*t5;
05341     t35 = t33*t8;
05342     t36 = t29*t4;
05343     t37 = t33*t1;
05344     t38 = t12*a;
05345     t39 = t38*b;
05346     t45 = t21*t22-t26-t28+t30+t31-t34+t35-t36-t37+t39*t7+
05347           t39*t8-t38*c*t6+t39*t6;
05348     t46 = t2*b;
05349     t47 = t46*a;
05350     t49 = t15*t18;
05351     t52 = t3*t22*c*d;
05352     t55 = t24*d*e*t3;
05353     t56 = t2*t22;
05354     t57 = t56*t7;
05355     t59 = c*t32*t16;
05356     t62 = t7*e*t12*b;
05357     t63 = t56*t9;
05358     t64 = t56*t11;
05359     t65 = t24*t32;
05360     t66 = t65*t3;
05361     t67 = t46*c;
05362     t69 = t2*t32;
05363     t70 = t69*t9;
05364     t72 = t69*t8;
05365     t73 = t47*t8-3.0*t49+2.0*t52+2.0*t55+t57+2.0*t59-3.0*t62-t63-t64+t66+
05366           t67*t11-t70+t47*t6+t72;
05367     t75 = t2*t24;
05368     t76 = t75*t10;
05369     t77 = t69*t10;
05370     t78 = t75*t11;
05371     t79 = t32*t22;
05372     t80 = t79*t9;
05373     t81 = t79*t3;
05374     t82 = t75*t6;
05375     t83 = t25*t3;
05376     t84 = t65*t10;
05377     t85 = t65*t1;
05378     t86 = t79*t5;
05379     t87 = t25*t4;
05380     t88 = t27*t4;
05381     t90 = -t76-t77-t78-t80+t81+t82+t83-t84-t85-t86-t87-t88-t67*t6;
05382     t91 = t29*t1;
05383     t92 = t21*t8;
05384     t93 = t21*t6;
05385     t95 = t21*t7;
05386     t96 = t21*t24;
05387     t97 = t46*t12;
05388     t99 = t2*t38;
05389     t101 = t65*t22;
05390     t107 = -t91+2.0*t92+2.0*t93+t46*t38+2.0*t95+t96-t97*c-t99*c+t101+t21*t32-
05391             t99*d-t99*e-t97*e-t97*d;
05392     t110 = sqrt(t45+t73+t90+t107);
05393 
05394     X = t14*(2.0*t15-2.0*t16-2.0*t17+2.0*t18-2.0*t19+2.0*t20+2.0*t110)/2;
05395 
05396     <font class="keywordflow">if</font>(c-b &gt; 0){      
05397 
05398       <font class="comment">// X might be near U[i+2] but due to floating point error, it won't</font>
05399       <font class="comment">// be detected. It happens during tests, so it's possible...</font>
05400       <font class="comment">/*</font>
05401 <font class="comment">      if(absolute(X-c)&lt;0.0001*c){</font>
05402 <font class="comment">        Error error("maxInfluence");</font>
05403 <font class="comment">        error &lt;&lt; "A numerical error in computing the point of maximal influence" ;</font>
05404 <font class="comment">        error.warning() ;</font>
05405 <font class="comment">        u = X ;</font>
05406 <font class="comment">        return 1 ;</font>
05407 <font class="comment">      }</font>
05408 <font class="comment">      */</font>
05409 
05410       <font class="keywordflow">if</font>(X&gt; b &amp;&amp; X&lt;=c + 1e-6 ){ <font class="comment">// adding 1e-6 because of float-&gt;double conversions</font>
05411         u = (T)X ;
05412         <font class="keywordflow">return</font> 1 ;
05413       }
05414 
05415       X = t14*(2.0*t15-2.0*t16-2.0*t17+2.0*t18-2.0*t19+2.0*t20-2.0*t110)/2;
05416       <font class="keywordflow">if</font>(X&gt;b &amp;&amp; X&lt;=c){
05417         u = (T)X ;
05418         <font class="keywordflow">return</font> 1 ;
05419       }
05420     }
05421 
05422     t115 = -t9-t32-t6+t1-t3+t4+t10+t11+t8-t5-t22+t7;
05423     t116 = 1/t115;
05424     t117 = t6*a;
05425     t118 = t4*e;
05426     t119 = d*t22;
05427     t120 = t32*e;
05428     t121 = -t26+t28+t30-t31+t34-t35-t36-t37+2.0*t49-3.0*t52+2.0*t55-t57-3.0*
05429       t59;
05430     t122 = 2.0*t62+t63-t64+t66+t70-t72-t76-t77-t78+2.0*t80+2.0*t81+t82+t83-
05431       t84;
05432     t124 = t32*d;
05433     t125 = t124*b;
05434     t127 = t124*t22;
05435     t133 = t22*e;
05436     t135 = -t85+2.0*t86-t87-t88-t91-t125*t9-t127*c+t125*t8+t125*t10+t124*a*t8
05437       +t124*t133-t92+t93;
05438     t136 = t133*b;
05439     t143 = t32*t133;
05440     t151 = -t95+t136*t7-t136*t9+t133*c*t11+t136*t11+t69*t22+t96+t101-t143*c-b
05441       *t32*t133-t125*t22-t143*a-t127*a+t79*t12;
05442     t154 = sqrt(t121+t122+t135+t151);
05443 
05444 
05445     
05446     X=t116*(2.0*t117+2.0*t118-2.0*t17-2.0*t119-2.0*t120+2.0*t18+2.0*t154)/2.0;
05447 
05448     <font class="keywordflow">if</font>(X&gt;=c - 1e-6 &amp;&amp; X&lt;d){
05449       u = (T)X ;
05450       <font class="keywordflow">return</font> 1 ;
05451     }
05452 
05453     X=t116*(2.0*t117+2.0*t118-2.0*t17-2.0*t119-2.0*t120+2.0*t18-2.0*t154)/2.0;
05454 
05455     <font class="keywordflow">if</font>(X&gt;=c &amp;&amp; X&lt;d){
05456       u = (T)X ;
05457       <font class="keywordflow">return</font> 1 ;
05458     }
05459 
05460 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
05461 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsComputationError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsComputationError.html">NurbsComputationError</a>();
05462 <font class="preprocessor">#else</font>
05463 <font class="preprocessor"></font>    Error error(<font class="stringliteral">"maxInfluence"</font>) ;
05464     error &lt;&lt; <font class="stringliteral">"It seems the program couldn't find a proper maxInfluence point\n."</font> ;
05465     error &lt;&lt; <font class="stringliteral">"so far u is set to "</font> &lt;&lt; u &lt;&lt; endl ; 
05466     error &lt;&lt; <font class="stringliteral">"and the input arguments were \n"</font> ;
05467     error &lt;&lt; <font class="stringliteral">"i = "</font> &lt;&lt; i &lt;&lt; endl ; 
05468     error &lt;&lt; <font class="stringliteral">"U = "</font> &lt;&lt; U &lt;&lt; endl ; 
05469     error &lt;&lt; <font class="stringliteral">"p = "</font> &lt;&lt; p &lt;&lt; endl ; 
05470     error.warning() ; 
05471     <font class="keywordflow">return</font> 0 ; 
05472 <font class="preprocessor">#endif</font>
05473 <font class="preprocessor"></font>  }
05474   <font class="keywordflow">default</font>:{
05475 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
05476 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>();
05477 <font class="preprocessor">#else</font>
05478 <font class="preprocessor"></font>    Error error(<font class="stringliteral">"maxInfluence"</font>);
05479     error &lt;&lt; <font class="stringliteral">"The point of maximal influence is only computed for a degree of 3 or lower."</font> ;
05480     error &lt;&lt; <font class="stringliteral">"The degree given was "</font> &lt;&lt; p &lt;&lt; endl ; 
05481     error.warning() ;
05482     <font class="keywordflow">return</font> 0 ;
05483 <font class="preprocessor">#endif</font>
05484 <font class="preprocessor"></font>  }
05485   }
05486   <font class="keywordflow">return</font> 0;
05487 }
05488 
05527 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
05528 T nurbsBasisFun(T u, <font class="keywordtype">int</font> i, <font class="keywordtype">int</font> p, <font class="keyword">const</font> Vector&lt;T&gt;&amp; U) {
05529   T Nip ;
05530   T saved,Uleft,Uright,temp ;
05531   
05532   <font class="keywordflow">if</font>(p&lt;1){
05533 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
05534 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>();
05535 <font class="preprocessor">#else</font>
05536 <font class="preprocessor"></font>    Error error(<font class="stringliteral">"nurbsBasisFun"</font>) ;
05537     error &lt;&lt; <font class="stringliteral">"You need to specify a valid degree for the basis function!\n"</font> ;
05538     error &lt;&lt; <font class="stringliteral">"p = "</font> &lt;&lt; p &lt;&lt; <font class="stringliteral">" but it requires a value &gt;0.\n"</font> ;
05539     error.fatal() ; 
05540 <font class="preprocessor">#endif</font>
05541 <font class="preprocessor"></font>  }
05542 
05543   <font class="keywordflow">if</font>((i==0 &amp;&amp; u == U[p]) ||
05544      (i == U.n()-p-2 &amp;&amp; u==U[U.n()-p-1])){
05545     Nip = 1.0 ;
05546     <font class="keywordflow">return</font> Nip ;
05547   }
05548   <font class="keywordflow">if</font>(u&lt;U[i] || u&gt;=U[i+p+1]){
05549     Nip = 0.0 ;
05550     <font class="keywordflow">return</font> Nip;
05551   }
05552 
05553   T* N = (T*) alloca((p+1)*<font class="keyword">sizeof</font>(T)) ; <font class="comment">// Vector&lt;T&gt; N(p+1) ;</font>
05554 
05555   <font class="keywordtype">int</font> j ;
05556   <font class="keywordflow">for</font>(j=0;j&lt;=p;j++){
05557     <font class="keywordflow">if</font>(u&gt;=U[i+j] &amp;&amp; u&lt;U[i+j+1]) 
05558       N[j] = 1.0 ;
05559     <font class="keywordflow">else</font>
05560       N[j] = 0.0 ;
05561   }
05562   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> k=1; k&lt;=p ; k++){
05563     <font class="keywordflow">if</font>(N[0] == 0.0)
05564       saved = 0.0 ;
05565     <font class="keywordflow">else</font>
05566       saved = ( (u-U[i])*N[0])/(U[i+k]-U[i]) ;
05567     <font class="keywordflow">for</font>(j=0;j&lt;p-k+1;j++){
05568       Uleft = U[i+j+1] ;
05569       Uright = U[i+j+k+1] ;
05570       <font class="keywordflow">if</font>(N[j+1]==0.0){
05571         N[j] = saved ;
05572         saved = 0.0 ;
05573       }
05574       <font class="keywordflow">else</font> {
05575         temp = N[j+1]/(Uright-Uleft) ;
05576         N[j] = saved+(Uright-u)*temp ;
05577         saved = (u-Uleft)*temp ;
05578       }
05579     }
05580   }
05581   Nip = N[0] ;
05582 
05583   <font class="keywordflow">return</font> Nip ;  
05584 }
05585 
05586 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
05587 <font class="keyword">struct </font>LengthData {
05588   <font class="keywordtype">int</font> span ;
05589   <font class="keyword">const</font> NurbsCurve&lt;T,N&gt;* c ; 
05590   LengthData(<font class="keyword">const</font> NurbsCurve&lt;T,N&gt;* curve): c(curve) { }
05591 };
05592 
05593 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
05594 <font class="keyword">struct </font>OpLengthFcn : <font class="keyword">public</font> ClassPOvoid&lt;T&gt; {
05595   T operator()(T a, <font class="keywordtype">void</font>* pnt){
05596     LengthData&lt;T,N&gt;* p = (LengthData&lt;T,N&gt;*)pnt ;
05597     <font class="keywordflow">return</font> (p-&gt;c)-&gt;lengthF(a,p-&gt;span) ; 
05598   }
05599 };
05600 
05601 
05626 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
05627 T NurbsCurve&lt;T,N&gt;::length(T eps,<font class="keywordtype">int</font> n)<font class="keyword"> const </font>{
05628   T l = T() ;
05629   T err ; 
05630 
05631   <font class="keyword">static</font> Vector&lt;T&gt; bufFcn ;
05632 
05633   <font class="keywordflow">if</font>(bufFcn.n() != n){
05634     bufFcn.resize(n) ;
05635     intccini(bufFcn) ;
05636   }
05637 
05638   LengthData&lt;T,N&gt; data(<font class="keyword">this</font>) ; 
05639   OpLengthFcn&lt;T,N&gt; op;
05640 
05641   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=deg_;i&lt;P.n();++i){
05642     <font class="keywordflow">if</font>(U[i] &gt;= U[i+1])
05643       <font class="keywordflow">continue</font> ;
05644     data.span = i ; 
05645     l += intcc((ClassPOvoid&lt;T&gt;*)&amp;op,(<font class="keywordtype">void</font>*)&amp;data,U[i],U[i+1],eps,bufFcn,err) ;
05646   }
05647   <font class="keywordflow">return</font> l ; 
05648 }
05649 
05677 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
05678 T NurbsCurve&lt;T,N&gt;::lengthIn(T us, T ue,T eps, <font class="keywordtype">int</font> n)<font class="keyword"> const </font>{
05679   T l = T() ;
05680   T err ; 
05681 
05682   <font class="keyword">static</font> Vector&lt;T&gt; bufFcn ;
05683 
05684   <font class="keywordflow">if</font>(bufFcn.n() != n){
05685     bufFcn.resize(n) ;
05686     intccini(bufFcn) ;
05687   }
05688 
05689   LengthData&lt;T,N&gt; data(<font class="keyword">this</font>) ; 
05690   OpLengthFcn&lt;T,N&gt; op;
05691 
05692   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=deg_;i&lt;P.n();++i){
05693     <font class="keywordflow">if</font>(U[i] &gt;= U[i+1])
05694       <font class="keywordflow">continue</font> ;
05695     data.span = i ; 
05696     <font class="keywordflow">if</font>(i&lt;<a class="code" href="classPLib_1_1NurbsCurve.html#a32" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a32">findSpan</a>(us))
05697       <font class="keywordflow">continue</font> ; 
05698     <font class="keywordflow">if</font>(us&gt;=U[i] &amp;&amp; ue&lt;=U[i+<a class="code" href="classPLib_1_1NurbsCurve.html#a34" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a34">findMult</a>(i)]){
05699       l = intcc((ClassPOvoid&lt;T&gt;*)&amp;op,(<font class="keywordtype">void</font>*)&amp;data,us,ue,eps,bufFcn,err) ;
05700       <font class="keywordflow">break</font> ;
05701     }
05702     <font class="keywordflow">if</font>(us&gt;=U[i]){
05703       l += intcc((ClassPOvoid&lt;T&gt;*)&amp;op,(<font class="keywordtype">void</font>*)&amp;data,us,U[i+<a class="code" href="classPLib_1_1NurbsCurve.html#a34" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a34">findMult</a>(i)],eps,bufFcn,err) ;
05704       <font class="keywordflow">continue</font> ;
05705     }
05706     <font class="keywordflow">if</font>(ue&lt;=U[i+<a class="code" href="classPLib_1_1NurbsCurve.html#a34" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a34">findMult</a>(i)]){
05707       l += intcc((ClassPOvoid&lt;T&gt;*)&amp;op,(<font class="keywordtype">void</font>*)&amp;data,U[i],ue,eps,bufFcn,err) ;
05708       <font class="keywordflow">break</font> ;
05709     }
05710     l += intcc((ClassPOvoid&lt;T&gt;*)&amp;op,(<font class="keywordtype">void</font>*)&amp;data,U[i],U[i+<a class="code" href="classPLib_1_1NurbsCurve.html#a34" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a34">findMult</a>(i)],eps,bufFcn,err) ;
05711   }
05712   <font class="keywordflow">return</font> l ; 
05713 }
05714 
05715 <font class="comment">// the definitions are in f_nurbs.cpp and d_nurbs.cpp</font>
05716 
05717 
05731 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
05732 T NurbsCurve&lt;T,N&gt;::lengthF(T u)<font class="keyword"> const </font>{
05733   Point_nD&lt;T,N&gt; dd = firstDn(u) ; 
05734   T tmp = sqrt(dd.x()*dd.x()+dd.y()*dd.y()+dd.z()*dd.z()) ;
05735   <font class="keywordflow">return</font> tmp ; 
05736 }
05737 
05752 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
05753 T NurbsCurve&lt;T,N&gt;::lengthF(T u, <font class="keywordtype">int</font> span)<font class="keyword"> const </font>{
05754   Point_nD&lt;T,N&gt; dd = firstDn(u,span) ; 
05755   T tmp = sqrt(dd.x()*dd.x()+dd.y()*dd.y()+dd.z()*dd.z()) ;
05756   <font class="keywordflow">return</font> tmp ; 
05757 }
05758 
05759 
05774 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
05775 <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::makeLine(<font class="keyword">const</font> Point_nD&lt;T,N&gt;&amp; P0, <font class="keyword">const</font> Point_nD&lt;T,N&gt;&amp; P1, <font class="keywordtype">int</font> d) {
05776   <font class="keywordflow">if</font>(d&lt;2)
05777     d = 2 ;
05778   <a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">resize</a>(2,1) ;
05779   P[0] = HPoint_nD&lt;T,N&gt;(P0) ;
05780   P[1] = HPoint_nD&lt;T,N&gt;(P1) ;
05781   U[0] = U[1] = 0 ; 
05782   U[2] = U[3] = 1 ;
05783   degreeElevate(d-1) ;
05784 }
05785 
05799 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> D&gt;
05800 HPoint_nD&lt;T,D&gt; NurbsCurve&lt;T,D&gt;::firstD(T u)<font class="keyword"> const </font>{
05801   <font class="keywordtype">int</font> span = <a class="code" href="classPLib_1_1NurbsCurve.html#a32" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a32">findSpan</a>(u) ; 
05802   <font class="keywordtype">int</font> i ; 
05803 
05804   <font class="keyword">static</font> Vector&lt;T&gt; N ;
05805 
05806   nurbsBasisFuns(u,span,deg_-1,U,N) ;
05807 
05808   HPoint_nD&lt;T,D&gt; Cd(0,0,0,0) ;
05809   HPoint_nD&lt;T,D&gt; Qi ;
05810 
05811   <font class="keywordflow">for</font>(i=deg_-1;i&gt;=0;--i){
05812     <font class="keywordtype">int</font> j = span-deg_+i ; 
05813     Qi = (P[j+1]-P[j]);
05814     Qi *= T(deg_)/(U[j+deg_+1]-U[j+1]) ; 
05815     Cd += N[i]*Qi ; 
05816   }
05817 
05818   <font class="keywordflow">return</font> Cd ;
05819 }
05820 
05836 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> D&gt;
05837 HPoint_nD&lt;T,D&gt; NurbsCurve&lt;T,D&gt;::firstD(T u, <font class="keywordtype">int</font> span)<font class="keyword"> const </font>{
05838   <font class="keywordtype">int</font> i ; 
05839 
05840   <font class="keyword">static</font> Vector&lt;T&gt; N ;
05841 
05842   nurbsBasisFuns(u,span,deg_-1,U,N) ;
05843 
05844   HPoint_nD&lt;T,D&gt; Cd(0,0,0,0) ;
05845   HPoint_nD&lt;T,D&gt; Qi ;
05846 
05847   <font class="keywordflow">for</font>(i=deg_-1;i&gt;=0;--i){
05848     <font class="keywordtype">int</font> j = span-deg_+i ; 
05849     Qi = (P[j+1]-P[j]);
05850     Qi *= T(deg_)/(U[j+deg_+1]-U[j+1]) ; 
05851     Cd += N[i]*Qi ; 
05852   }
05853 
05854   <font class="keywordflow">return</font> Cd ;
05855 }
05856 
05857 
05872 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
05873 Point_nD&lt;T,N&gt; NurbsCurve&lt;T,N&gt;::firstDn(T u)<font class="keyword"> const </font>{
05874   <font class="keywordtype">int</font> span = <a class="code" href="classPLib_1_1NurbsCurve.html#a32" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a32">findSpan</a>(u) ; 
05875   Point_nD&lt;T,N&gt; <a class="code" href="classPLib_1_1NurbsCurve.html#l1" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#l1">Cp</a> ; 
05876   HPoint_nD&lt;T,N&gt; Cd ; 
05877   Cd = firstD(u,span) ;
05878 
05879   Point_nD&lt;T,N&gt; pd(Cd.projectW()) ;
05880   T w = Cd.w() ;
05881   Cd = <a class="code" href="classPLib_1_1NurbsCurve.html#a14" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a14">hpointAt</a>(u,span) ; 
05882   pd -= w*project(Cd) ;
05883   pd /= Cd.w() ;
05884 
05885   <font class="keywordflow">return</font> pd ;
05886 }
05887 
05901 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
05902 Point_nD&lt;T,N&gt; NurbsCurve&lt;T,N&gt;::firstDn(T u, <font class="keywordtype">int</font> span)<font class="keyword"> const </font>{
05903   <font class="keywordtype">int</font> i ; 
05904   Point_nD&lt;T,N&gt; <a class="code" href="classPLib_1_1NurbsCurve.html#l1" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#l1">Cp</a> ; 
05905   HPoint_nD&lt;T,N&gt; Cd ; 
05906   Cd = firstD(u,span) ;
05907 
05908   Point_nD&lt;T,N&gt; pd(Cd.projectW()) ;
05909   T w = Cd.w() ;
05910   Cd = <a class="code" href="classPLib_1_1NurbsCurve.html#a14" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a14">hpointAt</a>(u,span) ; 
05911   pd -= w*project(Cd) ;
05912   pd /= Cd.w() ;
05913 
05914   <font class="keywordflow">return</font> pd ;
05915 }
05916 
05943 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
05944 <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::leastSquaresClosed(<font class="keyword">const</font> Vector&lt; Point_nD&lt;T,N&gt; &gt;&amp; Qw, <font class="keywordtype">int</font> degC, <font class="keywordtype">int</font> nCP){
05945 
05946   Vector&lt;T&gt; ub;
05947   Vector&lt;T&gt; Uk;
05948   chordLengthParamClosed(Qw,ub,degC) ;
05949   <font class="keywordflow">return</font> leastSquaresClosed(Qw,degC,nCP,ub);
05950 }
05951 
05980 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
05981 <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::leastSquaresClosed(<font class="keyword">const</font> Vector&lt; Point_nD&lt;T,N&gt; &gt;&amp; Qw, <font class="keywordtype">int</font> degC, <font class="keywordtype">int</font> nCP, <font class="keyword">const</font> Vector&lt;T&gt;&amp; ub){
05982   Vector&lt;T&gt; Uk;
05983   knotApproximationClosed(Uk,ub,nCP+degC-1,degC);
05984   <font class="keywordflow">return</font> leastSquaresClosed(Qw,degC,nCP,ub,Uk);
05985 }
05986 
06014 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
06015 <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::leastSquaresClosedH(<font class="keyword">const</font> Vector&lt; HPoint_nD&lt;T,N&gt; &gt;&amp; Qw, <font class="keywordtype">int</font> degC, <font class="keywordtype">int</font> nCP, <font class="keyword">const</font> Vector&lt;T&gt;&amp; ub){
06016 
06017   Vector&lt;T&gt; Uk;
06018   knotApproximationClosed(Uk,ub,nCP+degC-1,degC);
06019 
06020   <font class="keywordflow">return</font> leastSquaresClosedH(Qw,degC,nCP,ub,Uk);
06021 }
06022 
06051 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> D&gt;
06052 <font class="keywordtype">int</font> NurbsCurve&lt;T,D&gt;::leastSquaresClosed(<font class="keyword">const</font> Vector&lt; Point_nD&lt;T,D&gt; &gt;&amp; Qw, <font class="keywordtype">int</font> degC, <font class="keywordtype">int</font> nCP, <font class="keyword">const</font> Vector&lt;T&gt;&amp; ub, <font class="keyword">const</font> Vector&lt;T&gt;&amp; knots){
06053   <a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">resize</a>(nCP+degC,degC)  ;
06054 
06055   <font class="keywordtype">int</font> n  = P.n()-1;
06056   <font class="keywordtype">int</font> iN = nCP-1;
06057   <font class="keywordtype">int</font> iM = Qw.n()-degC-1;
06058   <font class="keywordtype">int</font> p  = degC ;
06059 
06060   <font class="keywordflow">if</font>(ub.n() != Qw.n()){
06061 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
06062 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>(ub.n(),Qw.n());
06063 <font class="preprocessor">#else</font>
06064 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"leastSquaresClosed"</font>);
06065     err &lt;&lt; <font class="stringliteral">"leastSquaresCurveC\n"</font> ;
06066     err &lt;&lt; <font class="stringliteral">"ub size is different than Qw's\n"</font> ;
06067     err.fatal();
06068 <font class="preprocessor">#endif</font>
06069 <font class="preprocessor"></font>  }
06070 
06071   <font class="keywordflow">if</font>( knots.n() != U.n()){
06072 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
06073 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>(knots.n(),U.n());
06074 <font class="preprocessor">#else</font>
06075 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"leastSquaresClosed"</font>);
06076     err &lt;&lt; <font class="stringliteral">"The knot vector supplied doesn't have the proper size.\n"</font> ;
06077     err &lt;&lt; <font class="stringliteral">"It should be n+degC+1 = "</font> &lt;&lt; U.n() &lt;&lt; <font class="stringliteral">" and it is "</font> &lt;&lt; knots.n() &lt;&lt; endl ;
06078     err.fatal() ;
06079 <font class="preprocessor">#endif</font>
06080 <font class="preprocessor"></font>  }
06081 
06082   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> N(iM+1,iN+1);
06083   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> A(iN+1,iN+1);
06084   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> R(iN+1,D);
06085   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> Pi(iN+1,D);
06086 
06087   <font class="comment">// Load knot vector</font>
06088   U = knots;
06089 
06090   <font class="comment">// Form matrix N (Eq. 9.66) p. 411</font>
06091   N = 0;
06092   <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i=0; i&lt;=n; i++)
06093     <font class="keywordflow">for</font> (<font class="keywordtype">int</font> k=0; k&lt;=iM; k++)
06094       N(k,i%(iN+1)) += <a class="code" href="classPLib_1_1NurbsCurve.html#a27" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a27">basisFun</a>(ub[k],i,p) ;
06095 
06096   <font class="comment">// Form R (Eq. 9.67)</font>
06097   R.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a11'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a11">reset</a>(0.0);
06098   <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i=0; i&lt;=iN; i++)
06099     <font class="keywordflow">for</font> (<font class="keywordtype">int</font> k=0; k&lt;=iM; k++){
06100       <font class="keyword">const</font> Point_nD&lt;T,D&gt;&amp; qp = Qw[k] ; <font class="comment">// this makes the SGI compiler happy</font>
06101       <font class="keyword">const</font> <font class="keywordtype">double</font>&amp;  Nki = N(k,i);
06102       <font class="keywordflow">for</font> (<font class="keywordtype">int</font> j=0; j&lt;D; j++)
06103         R(i,j) +=  Nki * qp.data[j] ;
06104     }
06105 
06106   <font class="comment">// The system to solve</font>
06107   A = N.<a class="code" href="classPLib_1_1Matrix.html#a16" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html#a16">transpose</a>() * N ;
06108   solve(A,R,Pi);
06109 
06110   <font class="comment">// Update control points</font>
06111   <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i=0; i&lt;= n; i++)
06112     <font class="keywordflow">for</font> (<font class="keywordtype">int</font> k=0; k&lt;D; k++){
06113       P[i].data[k] = Pi(i%(iN+1),k) ;
06114       P[i].w()     = 1.0;
06115     }
06116   <font class="keywordflow">return</font> 1;
06117 }
06118 
06119 
06148 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> D&gt;
06149 <font class="keywordtype">int</font> NurbsCurve&lt;T,D&gt;::leastSquaresClosedH(<font class="keyword">const</font> Vector&lt; HPoint_nD&lt;T,D&gt; &gt;&amp; Qw, <font class="keywordtype">int</font> degC, <font class="keywordtype">int</font> nCP, <font class="keyword">const</font> Vector&lt;T&gt;&amp; ub, <font class="keyword">const</font> Vector&lt;T&gt;&amp; knots){
06150 
06151   <a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">resize</a>(nCP+degC,degC)  ;
06152 
06153   <font class="keywordtype">int</font> n  = P.n()-1;
06154   <font class="keywordtype">int</font> iN = nCP-1;
06155   <font class="keywordtype">int</font> iM = Qw.n()-degC-1;
06156   <font class="keywordtype">int</font> p  = degC ;
06157 
06158 
06159   <font class="keywordflow">if</font>(ub.n() != Qw.n()){
06160 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
06161 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>(ub.n(),Qw.n());
06162 <font class="preprocessor">#else</font>
06163 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"leastSquaresClosedH"</font>);
06164     err &lt;&lt; <font class="stringliteral">"leastSquaresCurveC\n"</font> ;
06165     err &lt;&lt; <font class="stringliteral">"ub size is different than Qw's\n"</font> ;
06166     err.fatal();
06167 <font class="preprocessor">#endif</font>
06168 <font class="preprocessor"></font>  }
06169 
06170   <font class="keywordflow">if</font>( knots.n() != U.n()){
06171 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
06172 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>(knots.n(),U.n());
06173 <font class="preprocessor">#else</font>
06174 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"leastSquaresClosed"</font>);
06175     err &lt;&lt; <font class="stringliteral">"The knot vector supplied doesn't have the proper size.\n"</font> ;
06176     err &lt;&lt; <font class="stringliteral">"It should be n+degC+1 = "</font> &lt;&lt; U.n() &lt;&lt; <font class="stringliteral">" and it is "</font> &lt;&lt; knots.n() &lt;&lt; endl ;
06177     err.fatal() ;
06178 <font class="preprocessor">#endif</font>
06179 <font class="preprocessor"></font>  }
06180 
06181   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> N(iM+1,iN+1);
06182   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> A(iN+1,iN+1);
06183   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> R(iN+1,D+1);
06184   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> Pi(iN+1,D+1);
06185 
06186   <font class="comment">// Load knot vector</font>
06187   U = knots;
06188 
06189   <font class="comment">// Form matrix N (Eq. 9.66) p. 411</font>
06190   N = 0;
06191   <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i=0; i&lt;=n; i++)
06192     <font class="keywordflow">for</font> (<font class="keywordtype">int</font> k=0; k&lt;=iM; k++)
06193       N(k,i%(iN+1)) += <a class="code" href="classPLib_1_1NurbsCurve.html#a27" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a27">basisFun</a>(ub[k],i,p) ;
06194 
06195   <font class="comment">// Form R (Eq. 9.67)</font>
06196   R.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a11'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a11">reset</a>(0.0);
06197   <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i=0; i&lt;=iN; i++)
06198     <font class="keywordflow">for</font> (<font class="keywordtype">int</font> k=0; k&lt;=iM; k++){
06199       <font class="keyword">const</font> HPoint_nD&lt;T,D&gt;&amp; qp = Qw[k] ; <font class="comment">// this makes the SGI compiler happy</font>
06200       <font class="keyword">const</font> <font class="keywordtype">double</font>&amp;  Nki = N(k,i);
06201       <font class="keywordflow">for</font> (<font class="keywordtype">int</font> j=0; j&lt;D+1; j++)
06202         R(i,j) +=  Nki * qp.data[j] ;
06203     }
06204 
06205   <font class="comment">// The system to solve</font>
06206   A = N.<a class="code" href="classPLib_1_1Matrix.html#a16" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html#a16">transpose</a>() * N ;
06207   solve(A,R,Pi);
06208 
06209   <font class="comment">// Update control points</font>
06210   <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i=0; i&lt;= n; i++)
06211     <font class="keywordflow">for</font> (<font class="keywordtype">int</font> k=0; k&lt;D+1; k++){
06212       P[i].data[k] = Pi(i%(iN+1),k) ;
06213       <font class="comment">//P[i].w()     = 1.0;</font>
06214     }
06215   <font class="keywordflow">return</font> 1;
06216 }
06217 
06218 
06233 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
06234 T chordLengthParamClosed(<font class="keyword">const</font> Vector&lt; Point_nD&lt;T,N&gt; &gt;&amp; Qw, Vector&lt;T&gt; &amp;ub,<font class="keywordtype">int</font> deg){
06235 
06236   <font class="keywordtype">int</font> i ;
06237   T d = 0.0 ;
06238 
06239   ub.resize(Qw.n()) ;
06240   ub[0] = 0 ; 
06241   <font class="keywordflow">for</font>(i=1;i&lt;=ub.n()-deg;i++){
06242     d += norm(Qw[i]-Qw[i-1]) ;
06243   }
06244   <font class="keywordflow">if</font>(d&gt;0){
06245     <font class="keywordflow">for</font>(i=1;i&lt;ub.n();++i)
06246       ub[i] = ub[i-1] + norm(Qw[i]-Qw[i-1]);    
06247     <font class="comment">// Normalization</font>
06248     <font class="keywordflow">for</font>(i=0;i&lt;ub.n();++i)
06249       ub[i]/=  d;
06250   }
06251   <font class="keywordflow">else</font>
06252     <font class="keywordflow">for</font>(i=1;i&lt;ub.n();++i)
06253       ub[i] = (T)(i)/(T)(ub.n()-2) ;
06254 
06255   <font class="keywordflow">return</font> d ;
06256 }
06257 
06272 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
06273 T chordLengthParamClosedH(<font class="keyword">const</font> Vector&lt; HPoint_nD&lt;T,N&gt; &gt;&amp; Qw, Vector&lt;T&gt; &amp;ub,<font class="keywordtype">int</font> deg){
06274 
06275   <font class="keywordtype">int</font> i ;
06276   T d = 0.0 ;
06277 
06278   ub.resize(Qw.n()) ;
06279   ub[0] = 0 ; 
06280   <font class="keywordflow">for</font>(i=1;i&lt;ub.n()-deg+1;i++){
06281     d += norm(Qw[i]-Qw[i-1]) ;
06282   }
06283   <font class="keywordflow">if</font>(d&gt;0){
06284     <font class="keywordflow">for</font>(i=1;i&lt;ub.n();++i)
06285       ub[i] = ub[i-1] + norm(Qw[i]-Qw[i-1]);    
06286     <font class="comment">// Normalization</font>
06287     <font class="keywordflow">for</font>(i=0;i&lt;ub.n();++i)
06288       ub[i]/=ub[ub.n()-deg] ;
06289   }
06290   <font class="keywordflow">else</font>
06291     <font class="keywordflow">for</font>(i=1;i&lt;ub.n();++i)
06292       ub[i] = (T)(i)/(T)(ub.n()-deg) ;
06293 
06294   <font class="keywordflow">return</font> d ;
06295 }
06296 
06297 
06308 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
06309 <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::refineKnotVectorClosed(<font class="keyword">const</font> Vector&lt;T&gt;&amp; X){
06310 
06311   <font class="keywordtype">int</font> n = P.n()-1 ;
06312   <font class="keywordtype">int</font> p = deg_ ;
06313   <font class="keywordtype">int</font> m = n+p+1 ;
06314   <font class="keywordtype">int</font> a,b ;
06315   <font class="keywordtype">int</font> r = X.n()-1 ;
06316 
06317 
06318   NurbsCurve&lt;T,N&gt; c(*<font class="keyword">this</font>) ;
06319   <a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">resize</a>(r+1+n+1,p) ;
06320   a = c.findSpan(X[0]) ;
06321   b = c.findSpan(X[r]) ;
06322   ++b ;
06323   <font class="keywordtype">int</font> j ;
06324 
06325   <font class="keywordflow">for</font>(j=0; j&lt;=a-p ; j++)
06326     P[j] = c.P[j] ;
06327   <font class="keywordflow">for</font>(j = b-1 ; j&lt;=n ; j++)
06328     P[j+r+1] = c.P[j] ;
06329   <font class="keywordflow">for</font>(j=0; j&lt;=a ; j++)
06330     U[j] = c.U[j] ;
06331   <font class="keywordflow">for</font>(j=b+p ; j&lt;=m ; j++)
06332     U[j+r+1] = c.U[j] ;
06333 
06334   <font class="keywordtype">int</font> i = b+p-1 ; 
06335   <font class="keywordtype">int</font> k = b+p+r ;
06336   <font class="keywordflow">for</font>(j=r; j&gt;=0 ; j--){
06337     <font class="keywordflow">while</font>(X[j] &lt;= c.U[i] &amp;&amp; i&gt;a){
06338       <font class="keywordtype">int</font> ind = i-p-1;
06339       <font class="keywordflow">if</font> (ind&lt;0)
06340         ind += n + 1 ;
06341       P[k-p-1] = c.P[ind] ;
06342       U[k] = c.U[i] ;
06343       --k ;
06344       --i ;
06345     }
06346     P[k-p-1] = P[k-p] ;
06347     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> l=1; l&lt;=p ; l++){
06348       <font class="keywordtype">int</font> ind = k-p+l ;
06349       T alpha = U[k+l] - X[j] ;
06350       <font class="keywordflow">if</font>(alpha==0.0)
06351         P[ind-1] = P[ind] ;
06352       <font class="keywordflow">else</font> {
06353         alpha /= U[k+l]-c.U[i-p+l] ;
06354         P[ind-1] = alpha*P[ind-1] + (1.0-alpha)*P[ind] ;
06355       }
06356     }
06357     U[k] = X[j] ;
06358     --k ;
06359   }
06360 }
06361 
06362 
06378 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
06379 <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::globalInterpClosed(<font class="keyword">const</font> Vector&lt; Point_nD&lt;T,N&gt; &gt;&amp; Qw, <font class="keywordtype">int</font> d){
06380   Vector&lt;T&gt; ub ;
06381   Vector&lt;T&gt; Uc;
06382 
06383   chordLengthParamClosed(Qw,ub,d) ;  
06384   knotAveragingClosed(ub,d,Uc);
06385 
06386   globalInterpClosed(Qw,ub,Uc,d) ;
06387 }
06388 
06407 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> D&gt;
06408 <font class="keywordtype">void</font> NurbsCurve&lt;T,D&gt;::globalInterpClosedH(<font class="keyword">const</font> Vector&lt; HPoint_nD&lt;T,D&gt; &gt;&amp; Qw, <font class="keywordtype">int</font> d){
06409 
06410   Vector&lt;T&gt; ub ;
06411   Vector&lt;T&gt; Uc;
06412 
06413   chordLengthParamClosedH(Qw,ub,d) ;  
06414   knotAveragingClosed(ub,d,Uc);
06415   globalInterpClosedH(Qw,ub,Uc,d);
06416 
06417 }
06418 
06436 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> D&gt;
06437 <font class="keywordtype">void</font> NurbsCurve&lt;T,D&gt;::globalInterpClosed(<font class="keyword">const</font> Vector&lt; Point_nD&lt;T,D&gt; &gt;&amp; Qw, <font class="keyword">const</font> Vector&lt;T&gt;&amp; ub, <font class="keywordtype">int</font> d){
06438 
06439   Vector&lt;T&gt; Uc;
06440   knotAveragingClosed(ub,d,Uc);
06441   globalInterpClosed(Qw,ub,Uc,d);
06442 }
06443 
06461 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> D&gt;
06462 <font class="keywordtype">void</font> NurbsCurve&lt;T,D&gt;::globalInterpClosedH(<font class="keyword">const</font> Vector&lt; HPoint_nD&lt;T,D&gt; &gt;&amp; Qw, <font class="keyword">const</font> Vector&lt;T&gt;&amp; ub, <font class="keywordtype">int</font> d){
06463 
06464   Vector&lt;T&gt; Uc;
06465   knotAveragingClosed(ub,d,Uc);
06466   globalInterpClosedH(Qw,ub,Uc,d);
06467 }
06468 
06487 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> D&gt;
06488 <font class="keywordtype">void</font> NurbsCurve&lt;T,D&gt;::globalInterpClosed(<font class="keyword">const</font> Vector&lt; Point_nD&lt;T,D&gt; &gt;&amp; Qw,
06489                         <font class="keyword">const</font> Vector&lt;T&gt;&amp; ub, <font class="keyword">const</font> Vector&lt;T&gt;&amp; Uc, <font class="keywordtype">int</font> d){
06490   <font class="keywordtype">int</font> i,j ;
06491 
06492   <a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">resize</a>(Qw.n(),d) ;
06493 
06494   <font class="keywordtype">int</font> iN = Qw.n() - d - 1;
06495   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> A(iN+1,iN+1) ;
06496   
06497   <font class="keywordflow">if</font>(Uc.n() != U.n()){
06498 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
06499 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>(Uc.n(),U.n());
06500 <font class="preprocessor">#else</font>
06501 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"globalInterpClosedH"</font>);
06502     err &lt;&lt; <font class="stringliteral">"Invalid dimension for the given Knot vector.\n"</font> ;
06503     err &lt;&lt; <font class="stringliteral">"U required = "</font> &lt;&lt; U.n() &lt;&lt; <font class="stringliteral">", U given = "</font> &lt;&lt; Uc.n() &lt;&lt; endl ;
06504     err.fatal() ;
06505 <font class="preprocessor">#endif</font>
06506 <font class="preprocessor"></font>  }
06507   U = Uc ;
06508 
06509   <font class="comment">// Initialize the basis matrix A</font>
06510   Vector&lt;T&gt; N(d+1) ;
06511 
06512   <font class="keywordflow">for</font>(i=0;i&lt;=iN;i++){
06513     <font class="keywordtype">int</font> span = <a class="code" href="classPLib_1_1NurbsCurve.html#a32" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a32">findSpan</a>(ub[i]);
06514     <a class="code" href="classPLib_1_1NurbsCurve.html#a28" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a28">basisFuns</a>(ub[i],span,N) ;
06515     <font class="keywordflow">for</font>(j=span-d;j&lt;=span;j++) 
06516       A(i,j%(iN+1)) = (double)N[j-span+d] ;
06517   }
06518 
06519   <font class="comment">// Init matrix for LSE</font>
06520   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> qq(iN+1,D) ;
06521   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> xx(iN+1,D) ;
06522   <font class="keywordflow">for</font>(i=0;i&lt;=iN ;i++)
06523     <font class="keywordflow">for</font>(j=0; j&lt;D;j++)
06524       qq(i,j) = (double)Qw[i].data[j] ;
06525 
06526   <font class="comment">// AF: "solve" calls LU decomposition if A is square. I opted for</font>
06527   <font class="comment">// using the SVD routine which works better when the system of</font>
06528   <font class="comment">// equations is very large (more than 50 points). Probably since in</font>
06529   <font class="comment">// this cases the system matrix A is very sparse.</font>
06530   SVDMatrix&lt;double&gt; svd(A) ;
06531   svd.solve(qq,xx) ;
06532 
06533   <font class="comment">// Store the data</font>
06534   <font class="keywordflow">for</font>(i=0;i&lt;xx.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>();i++){
06535     <font class="keywordflow">for</font>(j=0;j&lt;D;j++)
06536       P[i].data[j] = (T)xx(i,j) ;
06537     P[i].w() = 1.0 ; 
06538   }
06539   
06540   <font class="comment">// Wrap around of control points</font>
06541   <font class="keywordflow">for</font>(i=0;i&lt;d;i++){
06542     <font class="keywordflow">for</font>(j=0;j&lt;D;j++)
06543       P[xx.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>()+i].data[j] = (T)xx(i,j) ;
06544   }
06545 }
06546 
06565 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> D&gt;
06566 <font class="keywordtype">void</font> NurbsCurve&lt;T,D&gt;::globalInterpClosedH(<font class="keyword">const</font> Vector&lt; HPoint_nD&lt;T,D&gt; &gt;&amp; Qw,
06567                                           <font class="keyword">const</font> Vector&lt;T&gt;&amp; ub, <font class="keyword">const</font> Vector&lt;T&gt;&amp; Uc, <font class="keywordtype">int</font> d){
06568   <font class="keywordtype">int</font> i,j ;
06569 
06570   <a class="code" href="classPLib_1_1NurbsCurve.html#a10" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a10">resize</a>(Qw.n(),d) ;
06571 
06572   <font class="keywordtype">int</font> iN = Qw.n() - d - 1;
06573   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> A(iN+1,iN+1) ;
06574   
06575   <font class="keywordflow">if</font>(Uc.n() != U.n()){
06576 <font class="preprocessor">#ifdef USE_EXCEPTION</font>
06577 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> <a class="code" href="classNurbsInputError.html" tppabs="http://libnurbs.sourceforge.net/docs/classNurbsInputError.html">NurbsInputError</a>(Uc.n(),U.n());
06578 <font class="preprocessor">#else</font>
06579 <font class="preprocessor"></font>    Error err(<font class="stringliteral">"globalInterpClosedH"</font>);
06580     err &lt;&lt; <font class="stringliteral">"Invalid dimension for the given Knot vector.\n"</font> ;
06581     err &lt;&lt; <font class="stringliteral">"U required = "</font> &lt;&lt; U.n() &lt;&lt; <font class="stringliteral">", U given = "</font> &lt;&lt; Uc.n() &lt;&lt; endl ;
06582     err.fatal() ;
06583 <font class="preprocessor">#endif</font>
06584 <font class="preprocessor"></font>  }
06585   U = Uc ;
06586 
06587   <font class="comment">// Initialize the basis matrix A</font>
06588   Vector&lt;T&gt; N(d+1) ;
06589 
06590   <font class="keywordflow">for</font>(i=0;i&lt;=iN;i++){
06591     <font class="keywordtype">int</font> span = <a class="code" href="classPLib_1_1NurbsCurve.html#a32" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a32">findSpan</a>(ub[i]);
06592     <a class="code" href="classPLib_1_1NurbsCurve.html#a28" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a28">basisFuns</a>(ub[i],span,N) ;
06593     <font class="keywordflow">for</font>(j=span-d;j&lt;=span;j++) 
06594       A(i,j%(iN+1)) = (double)N[j-span+d] ;
06595   }
06596 
06597   <font class="comment">// Init matrix for LSE</font>
06598   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> qq(iN+1,D+1) ;
06599   <a class="code" href="classPLib_1_1Matrix.html" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Matrix.html">Matrix_DOUBLE</a> xx(iN+1,D+1) ;
06600   <font class="keywordflow">for</font>(i=0;i&lt;=iN ;i++)
06601     <font class="keywordflow">for</font>(j=0; j&lt;D+1;j++)
06602       qq(i,j) = (double)Qw[i].data[j] ;
06603 
06604   <font class="comment">// AF: "solve" calls LU decomposition if A is square. I opted for</font>
06605   <font class="comment">// using the SVD routine which works better when the system of</font>
06606   <font class="comment">// equations is very large (more than 50 points). Probably since in</font>
06607   <font class="comment">// this cases the system matrix A is very sparse.</font>
06608   SVDMatrix&lt;double&gt; svd(A) ;
06609   svd.solve(qq,xx) ;
06610 
06611   <font class="comment">// Store the data</font>
06612   <font class="keywordflow">for</font>(i=0;i&lt;xx.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>();i++){
06613     <font class="keywordflow">for</font>(j=0;j&lt;D+1;j++)
06614       P[i].data[j] = (T)xx(i,j) ;
06615   }
06616   
06617   <font class="comment">// Wrap around of control points</font>
06618   <font class="keywordflow">for</font>(i=0;i&lt;d;i++){
06619     <font class="keywordflow">for</font>(j=0;j&lt;D+1;j++)
06620       P[xx.<a class="code" href="javascript:if(confirm('http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0'" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1Basic2DArray.html#a0">rows</a>()+i].data[j] = (T)xx(i,j) ;
06621   }
06622 }
06623 
06635 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> D&gt;
06636 <font class="keywordtype">void</font> NurbsCurve&lt;T,D&gt;::decomposeClosed(NurbsCurveArray&lt;T,D&gt;&amp; c)<font class="keyword"> const </font>{
06637 
06638   <font class="keywordtype">int</font> ix,b,nb,mult,j ;
06639   Vector&lt;T&gt; alphas(deg_+1) ;
06640   Vector&lt;T&gt; Uexpanded(U.n()+2*deg_) ;
06641   Vector&lt; HPoint_nD&lt;T,D&gt; &gt; Pexpanded(P.n()+2*deg_) ;
06642 
06643   <font class="keywordtype">int</font> N = P.n() - deg_ - 1;
06644   <font class="keywordtype">int</font> i ; 
06645 
06646   <font class="comment">// Left side</font>
06647   <font class="keywordflow">for</font> (i=0; i&lt;deg_; i++){
06648     Pexpanded[i] = P[P.n()-2*deg_+i] ;
06649     Uexpanded[i] = U[N+1-deg_+i] - 1     ;
06650   }
06651 
06652   <font class="comment">// Copy</font>
06653   <font class="keywordflow">for</font> (i=0; i&lt;P.n(); i++)
06654     Pexpanded[i+deg_] = P[i] ;
06655   <font class="keywordflow">for</font> (i=0; i&lt;U.n(); i++)
06656     Uexpanded[i+deg_] = U[i] ;
06657   
06658   <font class="comment">// Right side</font>
06659   <font class="keywordflow">for</font> (i=0; i&lt;deg_; i++){
06660     Pexpanded[i+deg_+P.n()] = P[deg_+i] ;
06661     Uexpanded[i+deg_+U.n()] = 1 + U[2*deg_+1+i] ;
06662   }
06663   <font class="comment">// Now do the decomposition</font>
06664   Vector&lt;T&gt; nU ;
06665   nU.resize(2*(deg_+1)) ;
06666   <font class="keywordflow">for</font>(i=0;i&lt;nU.n()/2;i++)
06667     nU[i] = 0 ;
06668   <font class="keywordflow">for</font>(i=nU.n()/2;i&lt;nU.n();i++)
06669     nU[i] = 1 ;
06670   
06671   c.resize(P.n()) ;
06672 
06673   <font class="keywordflow">for</font>(i=0;i&lt;c.n();i++){
06674     c[i].resize(deg_+1,deg_) ;
06675     c[i].U = nU ;
06676   }
06677     
06678   Vector&lt;T&gt; X(Uexpanded.n()*deg_) ;
06679 
06680   <font class="comment">// Construct the refinement vector</font>
06681   ix= 0;
06682   i = 0;
06683   b = 2*deg_;
06684 
06685   <font class="keywordflow">while</font> ( b &lt; U.n() ) {
06686     i = b;
06687     <font class="keywordflow">while</font>( b &lt; Uexpanded.n()-1 &amp;&amp; Uexpanded[b+1] &lt;= Uexpanded[b] ) b++ ;
06688     mult = b-i+1 ;
06689 
06690     <font class="keywordflow">if</font>(mult&lt;deg_){
06691       <font class="keywordflow">for</font>(j=deg_;j&gt;=mult;j--) {
06692         X[ix] = Uexpanded[b] ;
06693         ix++ ;
06694       }
06695     }
06696     b++;
06697   }
06698 
06699   X.resize(ix);
06700 
06701   NurbsCurve&lt;T,D&gt; cl = <a class="code" href="classPLib_1_1NurbsCurve.html#a0" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a0">NurbsCurve</a>(Pexpanded,Uexpanded,deg_);
06702   cl.refineKnotVectorClosed(X) ;
06703 
06704   <font class="comment">// The number of Bezier segments coincides with the number of</font>
06705   <font class="comment">// distinct control points in a closed curve</font>
06706   nb = P.n()-deg_;
06707 
06708   c.resize(nb);
06709   <font class="keywordflow">for</font> (i=0; i&lt;c.n(); i++)
06710     <font class="keywordflow">for</font> (<font class="keywordtype">int</font> k=0; k&lt;=deg_; k++)
06711       c[i].P[k] = cl.P[i*(deg_+1)+k+2*deg_];
06712 }
06713 
06726 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
06727 <font class="keywordtype">void</font> knotAveragingClosed(<font class="keyword">const</font> Vector&lt;T&gt;&amp; uk, <font class="keywordtype">int</font> deg, Vector&lt;T&gt;&amp; U){
06728 
06729   U.resize(uk.<a class="code" href="classBasicList.html#n2" tppabs="http://libnurbs.sourceforge.net/docs/classBasicList.html#n2">n</a>()+deg+1) ;
06730 
06731   <font class="keywordtype">int</font> i, j ;
06732   <font class="keywordtype">int</font> index;
06733   <font class="keywordtype">int</font> iN = uk.<a class="code" href="classBasicList.html#n2" tppabs="http://libnurbs.sourceforge.net/docs/classBasicList.html#n2">n</a>() - deg - 1;
06734   <font class="keywordtype">int</font> n  = uk.<a class="code" href="classBasicList.html#n2" tppabs="http://libnurbs.sourceforge.net/docs/classBasicList.html#n2">n</a>() - 1;
06735   <font class="keywordtype">int</font> m  = U.n()  - 1;
06736  
06737   <font class="comment">// Build temporary average sequence</font>
06738   <font class="comment">// Data stored in range U[deg+1 .. n]</font>
06739   <font class="keywordflow">for</font> (j=0; j&lt;=iN; j++) { 
06740     index = j+deg+1;
06741     U[index] = 0.0;
06742     <font class="keywordflow">for</font> (i=j; i&lt;=j+deg-1; i++) 
06743       U[index] += uk[i];
06744     U[index] /= deg;
06745   }
06746 
06747   <font class="comment">// Now make the left and right periodic extensions</font>
06748   <font class="comment">// Left </font>
06749   <font class="keywordflow">for</font> (j=0; j&lt;deg; j++)    U[j] = U[j+iN+1] - 1;       
06750   <font class="comment">// Right</font>
06751   <font class="keywordflow">for</font> (j=n+1; j&lt;=m; j++)   U[j] = 1 + U[j-(iN+1)];
06752   
06753 }
06754 
06769 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
06770 <font class="keywordtype">void</font> knotApproximationClosed( Vector&lt;T&gt;&amp; U, <font class="keyword">const</font>  Vector&lt;T&gt;&amp; ub, <font class="keywordtype">int</font> n, <font class="keywordtype">int</font> p){
06771 
06772   <font class="keywordtype">int</font> i, j;  
06773   <font class="keywordtype">int</font> iN = n - p ;
06774   U.resize(n+p+2) ;
06775   T d = ub.n()/(T)(n-p+1) ;
06776   T alpha;
06777 
06778   U = 0 ;
06779   <font class="comment">// Initialize the internal knots</font>
06780   <font class="keywordflow">for</font> ( j=1; j&lt;= n-p ; j++) {
06781     i          = int(j*d);
06782     alpha      = j*d - i;
06783     U[p+j]     = (1-alpha)*ub[i-1] + alpha*ub[i] ;
06784   }
06785 
06786   <font class="comment">// Now make the left and right periodic extensions</font>
06787   <font class="comment">// Left </font>
06788   <font class="keywordflow">for</font> (j=0; j&lt;p; j++)       U[j] = U[j+iN+1] - 1;       
06789   <font class="comment">// Right</font>
06790   <font class="keywordflow">for</font> (j=n+1; j&lt;U.n(); j++)   U[j] = 1 + U[j-(iN+1)];
06791 }
06792 
06805 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
06806 <font class="keywordtype">void</font> wrapPointVector(<font class="keyword">const</font> Vector&lt;Point_nD&lt;T,N&gt; &gt;&amp; Q, <font class="keywordtype">int</font> d, Vector&lt;Point_nD&lt;T,N&gt; &gt;&amp; Qw){
06807   <font class="keywordtype">int</font> i ;
06808 
06809   Qw = Q;
06810   Qw.resize(Q.n()+d);
06811   
06812   <font class="keywordflow">for</font> (i=0; i&lt;d; i++)
06813     Qw[i+Q.n()] = Q[i];
06814 
06815 } 
06816 
06829 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
06830 <font class="keywordtype">void</font> wrapPointVectorH(<font class="keyword">const</font> Vector&lt;HPoint_nD&lt;T,N&gt; &gt;&amp; Q, <font class="keywordtype">int</font> d, Vector&lt;HPoint_nD&lt;T,N&gt; &gt;&amp; Qw){
06831   <font class="keywordtype">int</font> i ;
06832 
06833   Qw = Q;
06834   Qw.resize(Q.n()+d);
06835   
06836   <font class="keywordflow">for</font> (i=0; i&lt;d; i++)
06837     Qw[i+Q.n()] = Q[i];
06838 
06839 } 
06840 
06859 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
06860 <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::writeDisplayLINE(<font class="keyword">const</font> <font class="keywordtype">char</font>* filename, <font class="keywordtype">int</font> iNu, <font class="keyword">const</font> Color&amp; color,T fA)<font class="keyword"> const </font>
06861 <font class="keyword"></font>{
06862 
06863   <font class="keywordtype">int</font> i;
06864   <font class="comment">// COnvert the curve to 3D if it is not</font>
06865   NurbsCurve&lt;T,3&gt; curve3D;
06866   to3D(*<font class="keyword">this</font>,curve3D);
06867   <font class="comment">// Output it</font>
06868   T fDu = 1/T(iNu);
06869   ofstream fout(filename) ;
06870   <font class="keywordflow">if</font>(!fout)
06871     <font class="keywordflow">return</font> 0 ;
06872   <font class="comment">// Save the object type</font>
06873   <font class="keyword">const</font> <font class="keywordtype">char</font> LINE = <font class="charliteral">'l'</font>+ (<font class="charliteral">'A'</font> - <font class="charliteral">'a'</font>);
06874   fout &lt;&lt; LINE &lt;&lt; <font class="charliteral">' '</font>;       ;
06875   T fThickness = T(1.);
06876   <font class="comment">// Save surface properties</font>
06877   fout &lt;&lt; fThickness &lt;&lt; <font class="charliteral">' '</font> 
06878        &lt;&lt; iNu &lt;&lt; endl;
06879   <font class="comment">// Fill points </font>
06880   Point_nD&lt;T,3&gt; p;
06881   <font class="keywordflow">for</font> (T u = 0; u&lt;1-fDu/2; u+=fDu, i++){
06882     p = T(-1)*curve3D.pointAt(u);
06883     fout &lt;&lt; p.x() &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; p.z() &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; p.y() &lt;&lt; endl;
06884   }
06885   <font class="comment">// New line</font>
06886   fout &lt;&lt; endl ;
06887   <font class="comment">// Elements</font>
06888   fout &lt;&lt; 1 &lt;&lt; endl ;
06889   <font class="comment">// New line</font>
06890   fout &lt;&lt; endl ;
06891   <font class="comment">// Surface color RGBA (one color for the whole surface)</font>
06892   T fR= T(color.r)/255;
06893   T fG= T(color.g)/255;
06894   T fB= T(color.b)/255;
06895   <font class="comment">// Colour flag = ONE_COLOUR </font>
06896   fout &lt;&lt; 0 &lt;&lt; <font class="charliteral">' '</font> ;
06897   <font class="comment">// The colour </font>
06898   fout &lt;&lt; fR &lt;&lt; <font class="charliteral">' '</font>
06899        &lt;&lt; fG &lt;&lt; <font class="charliteral">' '</font>
06900        &lt;&lt; fB &lt;&lt; <font class="charliteral">' '</font>
06901        &lt;&lt; fA &lt;&lt; endl;
06902   <font class="comment">// New line</font>
06903   fout &lt;&lt; endl ;
06904   fout &lt;&lt; iNu &lt;&lt; endl;
06905   <font class="comment">// New line</font>
06906   fout &lt;&lt; endl ;
06907   <font class="comment">// Save the dummy integers </font>
06908   <font class="keywordflow">for</font> (i=0; i&lt;iNu; i++)
06909     fout &lt;&lt; i &lt;&lt; <font class="charliteral">' '</font>;
06910   fout &lt;&lt; endl ;
06911   <font class="keywordflow">return</font> 1;
06912 }
06913 
06934 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
06935 <font class="keywordtype">int</font> NurbsCurve&lt;T,N&gt;::writeDisplayLINE(<font class="keyword">const</font> <font class="keywordtype">char</font>* filename,<font class="keyword">const</font> Color&amp; color, <font class="keywordtype">int</font> iNu,T u_s, T u_e)<font class="keyword"> const </font>
06936 <font class="keyword"></font>{
06937 
06938   <font class="keywordtype">int</font> i;
06939   T fDu  = (u_e-u_s)/iNu;
06940   ofstream fout(filename) ;
06941   <font class="keywordflow">if</font>(!fout)
06942     <font class="keywordflow">return</font> 0 ;
06943 
06944   <font class="comment">// Save the object type</font>
06945   <font class="keyword">const</font> <font class="keywordtype">char</font> LINE = <font class="charliteral">'l'</font>+ (<font class="charliteral">'A'</font> - <font class="charliteral">'a'</font>);
06946   fout &lt;&lt; LINE &lt;&lt; <font class="charliteral">' '</font>;       ;
06947 
06948   <font class="keywordtype">float</font> fThickness = 1;
06949   <font class="comment">// Save surface properties</font>
06950   fout &lt;&lt; fThickness &lt;&lt; <font class="charliteral">' '</font> 
06951        &lt;&lt; iNu &lt;&lt; endl;
06952 
06953   <font class="comment">// Fill points </font>
06954   NurbsCurve&lt;T,3&gt; Curve;
06955   to3D(*<font class="keyword">this</font>,Curve);
06956   Point_nD&lt;T,3&gt; p;
06957   T  u ;
06958   <font class="keywordflow">for</font> ( u = u_s; u&lt;u_e-fDu/2; u+=fDu, i++){
06959     <font class="comment">// Requires sign inversion and swap of y-z</font>
06960     p = -1.0*Curve.pointAt(u);
06961     fout &lt;&lt; p.x() &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; p.z() &lt;&lt; <font class="charliteral">' '</font> &lt;&lt; p.y() &lt;&lt; endl;
06962   }
06963 
06964   <font class="comment">// New line</font>
06965   fout &lt;&lt; endl ;
06966   <font class="comment">// Elements</font>
06967   fout &lt;&lt; 1 &lt;&lt; endl ;
06968   <font class="comment">// New line</font>
06969   fout &lt;&lt; endl ;
06970   <font class="comment">// Surface color RGBA (one color for the whole line)</font>
06971   <font class="keywordtype">float</font> fR=color.r/255.0;
06972   <font class="keywordtype">float</font> fG=color.g/255.0;
06973   <font class="keywordtype">float</font> fB=color.b/255.0;
06974   <font class="keywordtype">float</font> fA=1;
06975   <font class="comment">/* Colour flag = ONE_COLOUR */</font>
06976   fout &lt;&lt; 0 &lt;&lt; <font class="charliteral">' '</font> ;
06977   <font class="comment">/* The colour */</font>
06978   fout &lt;&lt; fR &lt;&lt; <font class="charliteral">' '</font>
06979        &lt;&lt; fG &lt;&lt; <font class="charliteral">' '</font>
06980        &lt;&lt; fB &lt;&lt; <font class="charliteral">' '</font>
06981        &lt;&lt; fA &lt;&lt; endl;
06982   
06983   <font class="comment">// New line</font>
06984   fout &lt;&lt; endl ;
06985 
06986   fout &lt;&lt; iNu &lt;&lt; endl;
06987 
06988   <font class="comment">// New line</font>
06989   fout &lt;&lt; endl ;
06990 
06991   <font class="comment">// Save the dummy integers </font>
06992   <font class="keywordflow">for</font> (i=0; i&lt;iNu; i++)
06993     fout &lt;&lt; i &lt;&lt; <font class="charliteral">' '</font>;
06994   fout &lt;&lt; endl ;
06995 
06996   <font class="keywordflow">return</font> 1;
06997 }
06998 
07011 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
07012 <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::setTangent(T u, <font class="keyword">const</font> Point_nD&lt;T,N&gt;&amp; T0) {
07013   Point_nD&lt;T,N&gt; ders = <a class="code" href="classPLib_1_1NurbsCurve.html#a20" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a20">derive3D</a>(u,1) ;
07014 
07015   BasicArray&lt;Point_nD&lt;T,N&gt; &gt; D(2) ;
07016   BasicArray&lt;int&gt; dr(2) ;
07017   BasicArray&lt;int&gt; dk(2) ;
07018   BasicArray&lt;T&gt; ur(1) ;
07019  
07020   ur[0] = u ;
07021   dr[0] = 0 ; 
07022   dr[1] = 0 ; 
07023   dk[0] = 0 ;
07024   dk[1] = 1 ;
07025   D[0] = Point_nD&lt;T,N&gt;(0) ;
07026 
07027   T length = ders.norm() ;
07028 
07029   D[1] = T0 - ders/length ;
07030   D[1] *= length ;
07031 
07032   movePoint(ur,D,dr,dk) ;
07033 
07034 }
07035 
07048 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
07049 <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::setTangentAtEnd(<font class="keyword">const</font> Point_nD&lt;T,N&gt;&amp; T0, <font class="keyword">const</font> Point_nD&lt;T,N&gt;&amp; T1) {
07050   Point_nD&lt;T,N&gt; ders0 = <a class="code" href="classPLib_1_1NurbsCurve.html#a20" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a20">derive3D</a>(U[deg_],1) ;
07051   Point_nD&lt;T,N&gt; ders1 = <a class="code" href="classPLib_1_1NurbsCurve.html#a20" tppabs="http://libnurbs.sourceforge.net/docs/classPLib_1_1NurbsCurve.html#a20">derive3D</a>(U[P.n()],1) ;
07052 
07053   BasicArray&lt;Point_nD&lt;T,N&gt; &gt; D(4) ;
07054   BasicArray&lt;int&gt; dr(4) ;
07055   BasicArray&lt;int&gt; dk(4) ;
07056   BasicArray&lt;T&gt; ur(2) ;
07057  
07058   ur[0] = U[deg_] ;
07059   ur[1] = U[P.n()] ;
07060   D[0] = D[1] = Point_nD&lt;T,N&gt;(0) ;
07061   dr[0] = 0 ;
07062   dr[1] = 1 ;
07063   dr[2] = 0 ;
07064   dr[3] = 1 ;
07065   dk[0] = dk[1] = 0 ;
07066   dk[2] = dk[3] = 1 ;
07067 
07068   T length = ders0.norm() ;
07069 
07070   D[2] = T0 - ders0/length ;
07071   D[2] *= length ;
07072 
07073   length = ders1.norm();
07074   D[3] = T1 - ders1/length ;
07075   D[3] *= length ;
07076 
07077   movePoint(ur,D,dr,dk) ;
07078 
07079 }
07080 
07081 
07091 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
07092 <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::clamp(){
07093   NurbsCurve&lt;T,N&gt; nc(*<font class="keyword">this</font>) ;
07094 
07095   <font class="keywordtype">int</font> n1 =  nc.knotInsertion(U[deg_],deg_,*<font class="keyword">this</font>);
07096   <font class="keywordtype">int</font> n2 =  knotInsertion(U[P.n()],deg_,nc);
07097   
07098   <font class="keywordflow">if</font>(n1 || n2 ){
07099     U.resize(nc.U.n()-n1-n2) ;
07100     P.resize(U.n()-deg_-1) ;
07101     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=U.n()-1;i&gt;=0;--i){
07102       U[i] = nc.U[i+deg_] ;
07103       <font class="keywordflow">if</font>(i&lt;P.n())
07104         P[i] = nc.P[i+deg_] ; 
07105     }
07106   }
07107 
07108 }
07109 
07119 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keywordtype">int</font> N&gt;
07120 <font class="keywordtype">void</font> NurbsCurve&lt;T,N&gt;::unclamp(){
07121   <font class="keywordtype">int</font> n = P.n()-1 ;
07122   <font class="keywordtype">int</font> i,j ;
07123   <font class="keywordflow">for</font>(i=0;i&lt;=deg_-2;++i){
07124     U[deg_-i-1] = U[deg_-i] - (U[n-i+1]-U[n-i]) ;
07125     <font class="keywordtype">int</font> k=deg_-1 ;
07126     <font class="keywordflow">for</font>(j=i;j&gt;=0;--j){
07127       T alpha = (U[deg_]-U[k])/(U[deg_+j+1]-U[k]);
07128       P[j] = (P[j]-alpha*P[j+1])/(T(1)-alpha);
07129       --k ;
07130     }    
07131   }
07132   U[0] = U[1] - (U[n-deg_+2]-U[n-deg_+1]) ; <font class="comment">// set first knot</font>
07133   <font class="keywordflow">for</font>(i=0;i&lt;=deg_-2;++i){
07134     U[n+i+2] = U[n+i+1] + (U[deg_+i+1]-U[deg_+i]);
07135     <font class="keywordflow">for</font>(j=i;j&gt;=0;--j){
07136       T alpha = (U[n+1]-U[n-j])/(U[n-j+i+2]-U[n-j]);
07137       P[n-j] = (P[n-j]-(1.0-alpha)*P[n-j-1])/alpha ;
07138     }
07139   }
07140   U[n+deg_+1] = U[n+deg_] + (U[2*deg_]-U[2*deg_-1]); <font class="comment">// set last knot</font>
07141 }
07142 
07143 } <font class="comment">// end namespace</font>
07144 
07145 
07146 <font class="preprocessor">#endif //  PLIB_NURBS_SOURCE</font>
</pre></div><hr><address><small>Generated on Tue Jun 24 13:26:57 2003 for NURBS++ by
<a href="javascript:if(confirm('http://www.doxygen.org/index.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.doxygen.org/index.html'" tppabs="http://www.doxygen.org/index.html">
<img src="doxygen.gif" tppabs="http://libnurbs.sourceforge.net/docs/doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
