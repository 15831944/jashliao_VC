<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<!-- saved from url=(0077)http://darkranger.no-ip.org/archives/v5/document/develop/libcurl_tutorial.htm -->
<html lang="zh-tw"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>用 libcurl 撰寫 HTTP 存取程式：以 Yahoo! 線上字典為範例</title><link rel="stylesheet" id="coToolbarStyle" href="chrome-extension://cjabmdjcfcfdmffimndhafhblfmpjdpe/toolbar/styles/placeholder.css" type="text/css"><script type="text/javascript" id="cosymantecbfw_removeToolbar">(function () {				var toolbarElement = {},					parent = {},					interval = 0,					retryCount = 0,					isRemoved = false;				if (window.location.protocol === 'file:') {					interval = window.setInterval(function () {						toolbarElement = document.getElementById('coFrameDiv');						if (toolbarElement) {							parent = toolbarElement.parentNode;							if (parent) {								parent.removeChild(toolbarElement);								isRemoved = true;								if (document.body && document.body.style) {									document.body.style.setProperty('margin-top', '0px', 'important');								}							}						}						retryCount += 1;						if (retryCount > 10 || isRemoved) {							window.clearInterval(interval);						}					}, 10);				}			})();</script><script type="text/javascript" id="waxCS">var WAX = function () { var _arrInputs; return { getElement: function (i) { return _arrInputs[i]; }, setElement: function(i){ _arrInputs=i; } } }(); function waxGetElement(i) { return WAX.getElement(i); } function coSetPageData(t, d){ if('wax'==t) { WAX.setElement(d);} }</script><script type="text/javascript" id="waxCS">var WAX = function () { var _arrInputs; return { getElement: function (i) { return _arrInputs[i]; }, setElement: function(i){ _arrInputs=i; } } }(); function waxGetElement(i) { return WAX.getElement(i); } function coSetPageData(t, d){ if('wax'==t) { WAX.setElement(d);} }</script></head><body style="color: white; background-color: black;" alink="white" link="white" vlink="white"><div style="text-align: center;"><font size="+1"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(255, 255, 0);"><br>用 libcurl 撰寫 HTTP 存取程式：以 Yahoo! 奇摩字典為範例</span><br><br style="font-family: Helvetica,Arial,sans-serif;"></font><div style="text-align: right;"><font style="font-style: italic;" size="+1"><span style="font-family: Helvetica,Arial,sans-serif;">Last Update : 09 / 17 / 2007 By DarkRanger .</span></font><br style="font-family: Helvetica,Arial,sans-serif;"><br style="font-family: Helvetica,Arial,sans-serif;"><div style="text-align: left;"><table style="text-align: left; width: 1000px;" border="0" cellpadding="2" cellspacing="2"><tbody><tr><td><span style="color: rgb(255, 255, 0); font-family: Helvetica,Arial,sans-serif;"></span><a style="text-decoration: underline; color: yellow; font-family: Helvetica,Arial,sans-serif;" href="http://darkranger.no-ip.org/archives/v5/document/develop/libcurl_tutorial.htm#1">前言</a><br style="color: yellow; font-family: Helvetica,Arial,sans-serif;"><br style="color: yellow; font-family: Helvetica,Arial,sans-serif;"><a style="text-decoration: underline; color: yellow; font-family: Helvetica,Arial,sans-serif;" href="http://darkranger.no-ip.org/archives/v5/document/develop/libcurl_tutorial.htm#2">在 Dev-C++ 開發環境使用 libcurl 函式庫</a><br style="color: yellow; font-family: Helvetica,Arial,sans-serif;"><br style="color: yellow; font-family: Helvetica,Arial,sans-serif;"><a style="text-decoration: underline; color: yellow; font-family: Helvetica,Arial,sans-serif;" href="http://darkranger.no-ip.org/archives/v5/document/develop/libcurl_tutorial.htm#3">Yahoo! 奇摩字典的資料傳送分析</a><br style="color: yellow; font-family: Helvetica,Arial,sans-serif;"><br style="color: yellow; font-family: Helvetica,Arial,sans-serif;"><a style="text-decoration: underline; color: yellow; font-family: Helvetica,Arial,sans-serif;" href="http://darkranger.no-ip.org/archives/v5/document/develop/libcurl_tutorial.htm#4">程式碼的撰寫</a><br style="color: yellow; font-family: Helvetica,Arial,sans-serif;"><br style="color: yellow; font-family: Helvetica,Arial,sans-serif;"><a href="http://darkranger.no-ip.org/archives/v5/document/develop/libcurl_tutorial.htm#5" style="text-decoration: underline; color: yellow; font-family: Helvetica,Arial,sans-serif;">完整程式碼範例</a><br style="color: yellow; font-family: Helvetica,Arial,sans-serif;"><br style="color: yellow; font-family: Helvetica,Arial,sans-serif;"><a style="text-decoration: underline; color: yellow; font-family: Helvetica,Arial,sans-serif;" href="http://darkranger.no-ip.org/archives/v5/document/develop/libcurl_tutorial.htm#6">執行測試</a><br style="color: yellow; font-family: Helvetica,Arial,sans-serif;"><br style="color: yellow; font-family: Helvetica,Arial,sans-serif;"><a style="text-decoration: underline; color: yellow; font-family: Helvetica,Arial,sans-serif;" href="http://darkranger.no-ip.org/archives/v5/document/develop/libcurl_tutorial.htm#7">結語</a><br style="color: yellow; font-family: Helvetica,Arial,sans-serif;"><br><span style="color: rgb(255, 255, 0);"></span><span style="color: rgb(255, 255, 0); font-family: Helvetica,Arial,sans-serif;"><br><br><a name="1"></a>前言</span><br style="font-family: Helvetica,Arial,sans-serif;"><br style="font-family: Helvetica,Arial,sans-serif;"><span style="font-family: Helvetica,Arial,sans-serif;">先來談談為什麼會有這篇文章：話說 &nbsp;PCMan 開發了一個名叫 &nbsp;<a style="color: rgb(51, 255, 51);" href="http://rt.openfoundry.org/Foundry/Project/?Queue=848" target="_blank">GNetDict</a>（最早叫做 YKDict）的線上字典查詢工具，使用 python + pygtk + gtkhtml2 開發，而支援的作業系統為 Linux。DR 認為這個工具實在是非常的方便，Windows 上也該要有一個，於是就打算利用 <a style="color: rgb(51, 255, 51);" href="http://www.wxwidgets.org/" target="_blank">wxWidgets</a> + <a style="color: rgb(51, 255, 51);" href="http://curl.haxx.se/" target="_blank">libcurl</a> 撰寫一個跨平台且依賴性較低的版本。然而寫著寫著，DR&nbsp;在網路討論區上赫然發現已經有類似的工具了，那就是：<a style="color: rgb(51, 255, 51);" href="http://onlinedic.sourceforge.net/" target="_blank">onlineDic</a>，而且 onlineDic 實做出來的功能已經比 DR 預想的目標還要好上許多。結果……當然是有點小失望啦，不過換個想法，也不算是做了白工，已經研究過的部份倒是可以寫篇文章，於是這篇 libcurl 範例文章就誕生了。<br><br>在這篇文章中 DR 會示範如何利用 libcurl 向 Yahoo! 奇摩字典傳送字典查詢的要求，並接收查詢結果。</span><br style="font-family: Helvetica,Arial,sans-serif;"><br style="font-family: Helvetica,Arial,sans-serif;"><span style="font-family: Helvetica,Arial,sans-serif;">也許哪天寫點關於 wxWidgets 的東西</span><span style="font-family: Helvetica,Arial,sans-serif;">……</span><br style="font-family: Helvetica,Arial,sans-serif;"><br style="font-family: Helvetica,Arial,sans-serif;"><span style="color: rgb(255, 255, 0); font-family: Helvetica,Arial,sans-serif;"><a name="2"></a>在 </span><span style="color: rgb(255, 255, 0); font-family: Helvetica,Arial,sans-serif;">Dev-C++ 開發環境使用 libcurl 函式庫</span><br style="font-family: Helvetica,Arial,sans-serif;"><br style="font-family: Helvetica,Arial,sans-serif;"><span style="font-family: Helvetica,Arial,sans-serif;"></span>流程如下：<br><br><span style="font-family: Helvetica,Arial,sans-serif;">(1) 首先在 cURL 的<a style="color: rgb(51, 255, 51);" href="http://curl.haxx.se/download.html" target="_blank">官方網站</a>下載 Win32 - Generic（2000/XP）的 libcurl 套件，由於要存取的 Yahoo! 奇摩字典網站並沒有使用 SSL（HTTPS），所以可以選擇不支援 SSL 的版本。</span><br style="font-family: Helvetica,Arial,sans-serif;"><br style="font-family: Helvetica,Arial,sans-serif;"><span style="font-family: Helvetica,Arial,sans-serif;">(2) 檔案下載後解開來，將 <span style="color: rgb(51, 255, 51);">include</span> 和 <span style="color: rgb(51, 255, 51);">lib</span> 目錄裡的所有東西分別丟到 Dev-C++ 的<span style="color: rgb(51, 255, 51);"> include</span> 和 <span style="color: rgb(51, 255, 51);">lib</span>目錄裡。</span><br style="font-family: Helvetica,Arial,sans-serif;"><br style="font-family: Helvetica,Arial,sans-serif;"><span style="font-family: Helvetica,Arial,sans-serif;">(3) 將 lib目錄中的<span style="color: rgb(51, 255, 51);"> libcurl-4.dll</span> 先複製一份到你所要存放 Project 的目錄。</span><br style="font-family: Helvetica,Arial,sans-serif;"><br style="font-family: Helvetica,Arial,sans-serif;"><span style="font-family: Helvetica,Arial,sans-serif;">(4) 啟動 Dev-C++ 並新增 Project，然後在 Dev-C++ 的選單：</span><span style="color: rgb(51, 255, 51); font-family: Helvetica,Arial,sans-serif;">Project→Project Options→Parameters→Linker</span><span style="font-family: Helvetica,Arial,sans-serif;"> 中加入 <span style="color: rgb(51, 255, 51);">-lcurl</span></span><br><br>(5) 最後在程式碼中加入標頭檔即可：<br><br><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">#include &lt;curl/curl.h&gt;</span><br><br><span style="font-family: Helvetica,Arial,sans-serif; color: yellow;"><a name="3"></a>Yahoo! 奇摩字典的資料傳送分析</span><br><br><span style="font-family: Helvetica,Arial,sans-serif;">在開始進行程式碼撰寫之前，必須先瞭解要傳送什麼資料給網站，才能接受到正確的結果。所以請先至 <a style="color: rgb(51, 255, 51);" href="http://tw.dictionary.yahoo.com/" target="_blank">Yahoo! 奇摩字典</a>瞭解一下它是怎麼運作的，可以先試著打一個單字，比方說：unix，然後按下『搜尋』，這時候網址列就會跑出以下結果：</span><br style="font-family: Helvetica,Arial,sans-serif;"><br style="font-family: Helvetica,Arial,sans-serif;"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">http://tw.dictionary.yahoo.com/search?ei=UTF-8&amp;p=unix</span><br style="font-family: Helvetica,Arial,sans-serif;"><br style="font-family: Helvetica,Arial,sans-serif;"><span style="font-family: Helvetica,Arial,sans-serif;">從網址列可以得知：負責字典搜尋的函式是『<span style="color: rgb(51, 255, 51);">search</span>』，而傳送的的資料名稱是『<span style="color: rgb(51, 255, 51);">ei</span>』和『<span style="color: rgb(51, 255, 51);">p</span>』。看樣子 ei 的值應該是固定的，也就是 UTF-8，而 p 值就是欲查詢的單字了，你也可以把網址列的結果和網頁的原始碼對照確認一下。</span><br><br>瞭解其資料傳送的方式後，就可以進行程式碼的撰寫了。<br style="font-family: Helvetica,Arial,sans-serif;"><br style="font-family: Helvetica,Arial,sans-serif;"><span style="color: rgb(255, 255, 0); font-family: Helvetica,Arial,sans-serif;"><a name="4"></a>程式碼的撰寫</span><br style="font-family: Helvetica,Arial,sans-serif;"><br style="font-family: Helvetica,Arial,sans-serif;"><span style="font-family: Helvetica,Arial,sans-serif;">首先宣告 CURL 變數並啟動 session：</span><br style="font-family: Helvetica,Arial,sans-serif;"><br style="font-family: Helvetica,Arial,sans-serif;"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">CURL *curl;</span><br style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">curl = curl_easy_init();</span><br style="font-family: Helvetica,Arial,sans-serif;"><br style="font-family: Helvetica,Arial,sans-serif;"><span style="font-family: Helvetica,Arial,sans-serif;">然後設定 URL：</span><br style="font-family: Helvetica,Arial,sans-serif;"><br style="font-family: Helvetica,Arial,sans-serif;"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">curl_easy_setopt(curl, CURLOPT_URL, "tw.dictionary.yahoo.com/search");</span><br style="font-family: Helvetica,Arial,sans-serif;"><br style="font-family: Helvetica,Arial,sans-serif;"><span style="font-family: Helvetica,Arial,sans-serif;">向 URL 傳送資料，假設要搜尋「BSD」這個字：</span><br style="font-family: Helvetica,Arial,sans-serif;"><br style="font-family: Helvetica,Arial,sans-serif;"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">curl_easy_setopt(curl, CURLOPT_POSTFIELDS, ei=UTF-8&amp;p=BSD);</span><br style="font-family: Helvetica,Arial,sans-serif;"><br style="font-family: Helvetica,Arial,sans-serif;"><span style="font-family: Helvetica,Arial,sans-serif;">接收回應資料，也就是搜尋結果：</span><br style="font-family: Helvetica,Arial,sans-serif;"><br style="font-family: Helvetica,Arial,sans-serif;"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">curl_easy_perform(curl);</span><br style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);"><br style="font-family: Helvetica,Arial,sans-serif;"><span style="font-family: Helvetica,Arial,sans-serif;">最後別忘了把 session 關閉：</span><br style="font-family: Helvetica,Arial,sans-serif;"><br style="font-family: Helvetica,Arial,sans-serif;"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">curl_easy_cleanup(curl);</span><br style="font-family: Helvetica,Arial,sans-serif;"><br><span style="color: yellow;"><a name="5"></a>完整程式碼範例</span><br><br>以下是完整的程式碼，可以順利編譯與使用：<br><br><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">#include &lt;stdio.h&gt;</span><br style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">#include &lt;stdlib.h&gt;</span><br style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">#include &lt;curl/curl.h&gt;</span><br style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);"><br style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">int main(int argc, char *argv[])</span><br style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">{</span><br style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">&nbsp; char POST[255] = "" ;</span><br style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">&nbsp; CURL *curl;</span><br style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">&nbsp; CURLcode res;</span><br style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">&nbsp;&nbsp;&nbsp; </span><br style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">&nbsp; curl = curl_easy_init();</span><br style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">&nbsp;&nbsp;&nbsp; </span><br style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">&nbsp; sprintf(POST,"ei=UTF-8&amp;p=%s",argv[1]);</span><br style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">&nbsp;&nbsp;&nbsp; </span><br style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">&nbsp; curl_easy_setopt(curl, CURLOPT_URL, "tw.dictionary.yahoo.com/search");</span><br style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">&nbsp; curl_easy_setopt(curl, CURLOPT_POSTFIELDS, POST);</span><br style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">&nbsp; res = curl_easy_perform(curl);</span><br style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);"><br style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">&nbsp; curl_easy_cleanup(curl);</span><br style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">&nbsp; return 0;</span><br style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">}</span><br><br style="font-family: Helvetica,Arial,sans-serif;"><span style="color: yellow;"><a name="6"></a>執行測試</span><br><br><span style="font-family: Helvetica,Arial,sans-serif;">將以上的完整程式碼編譯好後，假設檔名為 curl-test.exe，欲搜尋的單字為 blizzard，只要執行以下指令：</span><br style="font-family: Helvetica,Arial,sans-serif;"><br style="font-family: Helvetica,Arial,sans-serif;"><span style="font-family: Helvetica,Arial,sans-serif; color: rgb(51, 255, 51);">curl-test.exe blizzard &gt; result.html</span><br style="font-family: Helvetica,Arial,sans-serif;"><br style="font-family: Helvetica,Arial,sans-serif;"><span style="font-family: Helvetica,Arial,sans-serif;">再把 result.html 打開來就可看到單字的查詢結果了。</span><br><br>注意：請記得將 <span style="font-family: Helvetica,Arial,sans-serif;"><span style="color: rgb(51, 255, 51);">libcurl-4.dll <span style="color: white;">和</span></span></span>執行檔放在同個目錄下，否則會無法執行。<br><br><span style="color: yellow;"><a name="7"></a>結語</span><br><br><span style="font-family: Helvetica,Arial,sans-serif;">libcurl 為通訊協定的程式撰寫提供了一個跨平台且更為簡易的方案，有需要的開發者可以多多注意一下。</span><br><br>官方網站（以及套件裡）有許多的文件與參考範例。<br><span style="font-family: Helvetica,Arial,sans-serif;"><br><br><br><br></span><font style="font-family: Helvetica,Arial,sans-serif;" color="#00ff00" face="新細明體">→</font><a style="text-decoration: underline; font-family: Helvetica,Arial,sans-serif; color: rgb(255, 255, 0);" href="http://darkranger.no-ip.org/index.htm">Back to DarkRanger.no-ip.org</a></td></tr></tbody></table></div></div></div></body><div id="coFrameDiv" style="height:0px;display:none;"><iframe id="coToolbarFrame" src="./用 libcurl 撰寫 HTTP 存取程式：以 Yahoo! 線上字典為範例_files/placeholder.html" style="height:0px;width:100%;display:none;"></iframe></div></html>